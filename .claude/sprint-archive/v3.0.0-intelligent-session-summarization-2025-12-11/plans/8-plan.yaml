# Discovery Plan: Story 8 - Extraction Priority Algorithm
# Generated: 2025-12-11
# Status: Ready for Implementation

story:
  id: "8"
  title: "Extraction Priority Algorithm"
  type: feature
  dependency: "Story 2 (Activity Vector Model) - COMPLETED"

discovery_summary:
  date: "2025-12-11"
  codebase_analysis:
    - "ActivityVector class exists in activity_vector.py with 8 dimensions"
    - "ActivityDetector class exists in activity_detector.py for signal detection"
    - "SessionSummary dataclass has extraction-target fields (completed_tasks, key_decisions, errors_resolved, etc.)"
    - "No existing extraction_priority module - new file to create"
    - "Story 9 (Dynamic Prompt Generation) depends on this as downstream consumer"

  dependency_status:
    story_2:
      status: completed
      provides:
        - "ActivityVector.DIMENSIONS class constant (list of 8 dimension names)"
        - "ActivityVector.to_dict() method for accessing dimension values"
        - "ActivityVector.from_signals() factory method"
        - "getattr(activity, dimension) pattern for accessing dimension values"

  integration_points:
    - module: "graphiti_core/session_tracking/__init__.py"
      action: "Export new classes and functions"
    - module: "graphiti_core/session_tracking/prompt_builder.py"
      consumer: "Story 9 - will use get_extraction_fields() and compute_extraction_priority()"
    - module: "graphiti_core/session_tracking/summarizer.py"
      consumer: "Story 11 - will integrate priority-based extraction"

implementation_plan:
  file_to_create: "graphiti_core/session_tracking/extraction_priority.py"

  components:
    - name: "EXTRACTION_AFFINITIES"
      type: "dict[str, dict[str, float]]"
      description: "Mapping of extraction fields to activity dimension weights"
      fields_to_support:
        - "completed_tasks"
        - "key_decisions"
        - "errors_resolved"
        - "discoveries"
        - "config_changes"
        - "test_results"
        - "files_modified"
        - "next_steps"
        - "blocked_items"
        - "documentation_referenced"

    - name: "compute_extraction_priority"
      type: "function"
      signature: "(field: str, activity: ActivityVector) -> float"
      algorithm: |
        1. Get affinities for the field from EXTRACTION_AFFINITIES
        2. If no affinities defined, return 0.5 (neutral priority)
        3. Sum of (activity_dimension_value * affinity_weight) for each dimension
        4. Normalize by sum of affinity weights
        5. Return normalized priority (0.0-1.0)
      edge_cases:
        - "Unknown field -> 0.5"
        - "Empty affinities -> 0.5"
        - "Zero activity vector -> 0.0"

    - name: "get_extraction_fields"
      type: "function"
      signature: "(activity: ActivityVector, threshold: float = 0.3) -> list[str]"
      algorithm: |
        1. Compute priority for all fields in EXTRACTION_AFFINITIES
        2. Filter fields with priority >= threshold
        3. Sort by priority descending
        4. Return list of field names
      returns: "list[str] - field names sorted by priority (highest first)"

    - name: "get_extraction_priorities"
      type: "function"
      signature: "(activity: ActivityVector, threshold: float = 0.3) -> list[tuple[str, float]]"
      description: "Get field names with their priority scores for prompt building"
      algorithm: |
        1. Compute priority for all fields in EXTRACTION_AFFINITIES
        2. Filter fields with priority >= threshold
        3. Sort by priority descending
        4. Return list of (field_name, priority) tuples
      purpose: "Story 9 needs priority scores for prompt ordering"

  affinity_matrix:
    completed_tasks:
      building: 1.0
      fixing: 0.8
      configuring: 0.7
      refactoring: 0.9
      testing: 0.6
    key_decisions:
      building: 1.0
      configuring: 0.9
      refactoring: 0.8
      fixing: 0.6
      exploring: 0.5
    errors_resolved:
      fixing: 1.0
      configuring: 0.7
      testing: 0.5
    discoveries:
      exploring: 1.0
      reviewing: 0.8
      documenting: 0.5
    config_changes:
      configuring: 1.0
      fixing: 0.4
    test_results:
      testing: 1.0
      fixing: 0.7
      building: 0.6
    files_modified:
      building: 0.9
      fixing: 0.8
      refactoring: 0.9
      configuring: 0.6
    next_steps:
      building: 0.8
      exploring: 0.7
      fixing: 0.6
    blocked_items:
      fixing: 0.9
      configuring: 0.7
      building: 0.5
    documentation_referenced:
      documenting: 1.0
      exploring: 0.7
      reviewing: 0.5

  tests_required:
    - name: "test_compute_extraction_priority_basic"
      purpose: "Verify priority computation for known field/activity combination"
      scenario: "fixing=0.9 activity -> errors_resolved priority ~0.9"

    - name: "test_compute_extraction_priority_mixed_activity"
      purpose: "Verify weighted combination for multi-dimensional activity"
      scenario: "fixing=0.8, configuring=0.7 -> errors_resolved priority"

    - name: "test_compute_extraction_priority_unknown_field"
      purpose: "Verify default behavior for unknown fields"
      expected: "Returns 0.5"

    - name: "test_get_extraction_fields_debugging_session"
      purpose: "Verify field ordering for debugging-heavy session"
      scenario: "fixing=0.9, testing=0.5 -> errors_resolved first"

    - name: "test_get_extraction_fields_exploration_session"
      purpose: "Verify field ordering for exploration session"
      scenario: "exploring=0.9, reviewing=0.7 -> discoveries first"

    - name: "test_get_extraction_fields_threshold_filtering"
      purpose: "Verify fields below threshold are excluded"
      scenario: "threshold=0.3 excludes low-priority fields"

    - name: "test_get_extraction_priorities_returns_scores"
      purpose: "Verify Story 9 integration point"
      scenario: "Returns tuples with priority scores"

  acceptance_criteria_mapping:
    "P0_affinities": "EXTRACTION_AFFINITIES constant"
    "P0_compute_priority": "compute_extraction_priority() function"
    "P0_get_fields": "get_extraction_fields() function"
    "P1_unit_tests": "test_extraction_priority.py with debugging/exploration scenarios"
    "P1_threshold": "threshold parameter in get_extraction_fields()"

exports_to_add:
  - "EXTRACTION_AFFINITIES"
  - "compute_extraction_priority"
  - "get_extraction_fields"
  - "get_extraction_priorities"

notes:
  - "Pattern follows ActivityVector/ActivityDetector architecture"
  - "Uses Pydantic for type validation (not needed for simple dict/functions)"
  - "Story 9 will import get_extraction_fields() and get_extraction_priorities()"
  - "Default threshold 0.3 matches ActivityVector.DEFAULT_THRESHOLD"
