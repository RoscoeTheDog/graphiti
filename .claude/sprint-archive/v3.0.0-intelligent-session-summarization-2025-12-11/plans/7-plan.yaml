# Plan: 7
# Generated by: discovery:7.d
# Timestamp: 2025-12-12T01:36:00Z

story_id: "7"
title: "Unified Tool Classifier"
created: "2025-12-12T01:36:00Z"
created_by: "discovery:7.d"

# Analysis Summary
analysis:
  summary: "Create UnifiedToolClassifier facade that routes tool classification to ToolClassifier (MCP/native tools) or BashAnalyzer (bash commands), with session-level aggregation into ActivityVector"
  complexity: "medium"
  estimated_files: 2
  estimated_tokens: 8000
  risk_factors:
    - "Union type handling for ToolClassification vs BashCommandClassification"
    - "Signal aggregation normalization for large sessions"
    - "Async/sync interface consistency with existing classifiers"

# Files to Create
files_to_create:
  - path: "graphiti_core/session_tracking/unified_classifier.py"
    purpose: "Unified classifier facade routing to ToolClassifier and BashAnalyzer with session-level aggregation"
    pattern_source: "graphiti_core/session_tracking/tool_classifier.py"
    estimated_lines: 250
    classes:
      - name: "UnifiedToolClassifier"
        methods:
          - "classify_message(message: dict) -> ToolClassification | BashCommandClassification"
          - "classify_session(messages: list[dict]) -> tuple[ActivityVector, list[ToolClassification | BashCommandClassification]]"
        dependencies:
          - "ToolClassifier"
          - "BashAnalyzer"
          - "ActivityVector"
          - "ToolClassification"
          - "BashCommandClassification"

  - path: "tests/session_tracking/test_unified_classifier.py"
    purpose: "Comprehensive tests for UnifiedToolClassifier including routing, aggregation, and edge cases"
    pattern_source: "tests/session_tracking/test_tool_classifier.py"
    estimated_lines: 300

# Files to Modify
files_to_modify:
  - path: "graphiti_core/session_tracking/__init__.py"
    changes:
      - "Add import for UnifiedToolClassifier"
      - "Add UnifiedToolClassifier to __all__ exports"
    lines_affected: 4

# Integration Points
integration:
  - file: "graphiti_core/session_tracking/__init__.py"
    type: "export"
    description: "Export UnifiedToolClassifier for external use"

  - file: "graphiti_core/session_tracking/activity_detector.py"
    type: "potential_integration"
    description: "ActivityDetector could use UnifiedToolClassifier for tool-based signal enrichment (Story 11)"

# Patterns to Follow
patterns:
  - source: "graphiti_core/session_tracking/tool_classifier.py"
    pattern: "Pydantic models for classification results, type hints, docstrings with Examples"

  - source: "graphiti_core/session_tracking/bash_analyzer.py"
    pattern: "Cache support via optional cache_path parameter, LLM client injection pattern"

  - source: "tests/session_tracking/test_tool_classifier.py"
    pattern: "Pytest fixtures, parametrized tests, separate test classes per feature area"

# Test Requirements
test_requirements:
  unit:
    - "test_classify_message_routes_bash_to_bash_analyzer"
    - "test_classify_message_routes_mcp_tools_to_tool_classifier"
    - "test_classify_message_routes_native_tools_to_tool_classifier"
    - "test_classify_session_returns_activity_vector_and_classifications"
    - "test_classify_session_aggregates_signals_correctly"
    - "test_classify_session_handles_empty_messages"
    - "test_classify_session_filters_non_tool_messages"
    - "test_classify_message_handles_missing_params"
    - "test_activity_vector_normalization_large_sessions"
  integration:
    - "test_end_to_end_mixed_tool_session"
    - "test_integration_with_activity_detector"
    - "test_unified_classifier_with_llm_fallback"
    - "test_unified_classifier_with_cache"
  edge_cases:
    - "test_empty_tool_name"
    - "test_nested_bash_commands"
    - "test_unknown_tool_fallback"
    - "test_signal_capping_at_1_0"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-7.1"
    text: "(P0) UnifiedToolClassifier class combining ToolClassifier and BashAnalyzer"
    priority: "P0"
    implementation:
      file: "graphiti_core/session_tracking/unified_classifier.py"
      class: "UnifiedToolClassifier"
      details: "Class that holds references to ToolClassifier and BashAnalyzer instances"
    tests:
      - "test_unified_classifier_instantiation"
      - "test_unified_classifier_has_tool_classifier"
      - "test_unified_classifier_has_bash_analyzer"

  - id: "AC-7.2"
    text: "(P0) classify_message() routes based on tool type (bash vs MCP vs native)"
    priority: "P0"
    implementation:
      file: "graphiti_core/session_tracking/unified_classifier.py"
      method: "classify_message"
      details: |
        Check if tool_name.lower() == 'bash':
          - Extract command from params['command']
          - Route to BashAnalyzer.classify(command)
        Else:
          - Route to ToolClassifier.classify(tool_name, params)
    tests:
      - "test_classify_message_routes_bash_to_bash_analyzer"
      - "test_classify_message_routes_mcp_tools_to_tool_classifier"
      - "test_classify_message_routes_native_tools_to_tool_classifier"

  - id: "AC-7.3"
    text: "(P0) classify_session() returns tuple of (ActivityVector, list[ToolClassification])"
    priority: "P0"
    implementation:
      file: "graphiti_core/session_tracking/unified_classifier.py"
      method: "classify_session"
      details: |
        1. Filter messages to tool messages (role == 'tool' or has tool_calls)
        2. For each tool call, call classify_message()
        3. Aggregate activity_signals from all classifications
        4. Create ActivityVector.from_signals(aggregate)
        5. Return (activity_vector, classifications_list)
    tests:
      - "test_classify_session_returns_activity_vector_and_classifications"
      - "test_classify_session_aggregates_signals_correctly"
      - "test_classify_session_handles_empty_messages"

  - id: "AC-7.4"
    text: "(P1) Integration with ActivityDetector for tool-based signals"
    priority: "P1"
    implementation:
      file: "graphiti_core/session_tracking/activity_detector.py"
      details: |
        (Deferred to Story 11 - Summarizer Integration)
        ActivityDetector can optionally accept UnifiedToolClassifier
        and incorporate tool signals into its detection
    tests:
      - "test_integration_with_activity_detector"

  - id: "AC-7.5"
    text: "(P1) End-to-end test classifying mixed tool session"
    priority: "P1"
    implementation:
      file: "tests/session_tracking/test_unified_classifier.py"
      details: "Integration test with realistic session containing Bash, MCP, and native tools"
    tests:
      - "test_end_to_end_mixed_tool_session"

# Implementation Notes
implementation_notes:
  routing_logic: |
    The key routing decision is based on tool_name:
    - If tool_name.lower() == "bash": use BashAnalyzer
    - Otherwise: use ToolClassifier

    This simple check covers all cases because:
    - Claude Code native "Bash" tool always has name "Bash"
    - MCP tools have names like "mcp__server__tool"
    - Native tools have names like "Read", "Write", "Glob"

  message_format: |
    Input messages should have structure:
    {
      "name": "tool_name",
      "params": {"param1": "value1", ...}
    }

    For Bash specifically:
    {
      "name": "Bash",
      "params": {"command": "git status"}
    }

  signal_aggregation: |
    When aggregating signals from multiple classifications:
    1. Sum signals per dimension across all classifications
    2. Pass to ActivityVector.from_signals() which normalizes by max value
    3. This ensures the most prominent activity becomes 1.0

  async_sync_consideration: |
    ToolClassifier.classify() is sync, but classify_batch() is async
    BashAnalyzer.classify() is sync, but classify_batch() is async

    For UnifiedToolClassifier:
    - classify_message() can be sync (single tool)
    - classify_session() should be async (potential batch operations)

    However, for simplicity in v1, we can make both sync and iterate.
    Async optimization can be added later if needed.

# Dependencies
dependencies:
  internal:
    - story: "5"
      module: "graphiti_core.session_tracking.tool_classifier"
      classes: ["ToolClassifier", "ToolClassification", "ToolIntent", "ToolDomain"]
    - story: "6"
      module: "graphiti_core.session_tracking.bash_analyzer"
      classes: ["BashAnalyzer", "BashCommandClassification"]
    - module: "graphiti_core.session_tracking.activity_vector"
      classes: ["ActivityVector"]
    - module: "graphiti_core.session_tracking.types"
      classes: ["SessionMessage", "ToolCall", "MessageRole"]
  external:
    - "pydantic (BaseModel, Field)"
    - "typing (Union, TYPE_CHECKING)"
    - "logging"

# Downstream Impact
downstream:
  - story: "11"
    title: "Summarizer Integration"
    impact: "Will use UnifiedToolClassifier to incorporate tool signals into session summarization"
