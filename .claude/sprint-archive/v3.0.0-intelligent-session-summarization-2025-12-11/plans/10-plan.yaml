# Plan: 10
# Generated by: discovery:10.d
# Timestamp: 2025-12-11T20:30:00Z

story_id: "10"
title: "Enhanced Markdown Rendering"
created: "2025-12-11T20:30:00Z"
created_by: "discovery:10.d"

# Analysis Summary
analysis:
  summary: "Enhance SessionSummary.to_markdown() to render activity profile, config changes table, and test results sections"
  complexity: "medium"
  estimated_files: 2
  estimated_tokens: 8000
  risk_factors:
    - "Activity profile requires integration with ActivityVector (from Story 2)"
    - "Config changes and test results need new schema fields in SessionSummarySchema"
    - "Markdown table formatting must handle edge cases (empty values, long strings)"

# Files to Create
files_to_create: []

# Files to Modify
files_to_modify:
  - path: "graphiti_core/session_tracking/summarizer.py"
    changes:
      - "Add ConfigChange model (Pydantic) for structured config tracking"
      - "Add TestResults model (Pydantic) for test outcome tracking"
      - "Add activity_profile, config_changes, test_results fields to SessionSummarySchema"
      - "Update SessionSummary dataclass with new fields"
      - "Enhance to_markdown() to render activity profile header"
      - "Add config changes markdown table rendering"
      - "Add test results section rendering"
      - "Update SUMMARIZATION_PROMPT to extract new fields"
    lines_affected: 120

  - path: "graphiti_core/session_tracking/handoff_exporter.py"
    changes:
      - "Update HandoffSummarySchema with activity_profile, config_changes, test_results fields"
      - "Update HandoffSummary dataclass with new fields"
      - "Update to_markdown() to render new sections (consistency with summarizer.py)"
    lines_affected: 60

# Integration Points
integration:
  - file: "graphiti_core/session_tracking/activity_vector.py"
    type: "import"
    description: "Import ActivityVector to access activity_profile property for markdown rendering"

  - file: "graphiti_core/session_tracking/summarizer.py"
    type: "schema"
    description: "SessionSummarySchema extends with new fields, backward compatible via default_factory"

# Patterns to Follow
patterns:
  - source: "graphiti_core/session_tracking/summarizer.py:31-47"
    pattern: "Use Pydantic BaseModel for structured data (DecisionRecord, ErrorResolution pattern)"

  - source: "graphiti_core/session_tracking/summarizer.py:130-144"
    pattern: "Conditional section rendering in to_markdown() (only show if data exists)"

  - source: "graphiti_core/session_tracking/summarizer.py:101-171"
    pattern: "Markdown structure: header -> sections with --- dividers -> context footer"

# Test Requirements
test_requirements:
  unit:
    - "ConfigChange model serialization/deserialization with Pydantic"
    - "TestResults model serialization/deserialization with Pydantic"
    - "SessionSummarySchema with activity_profile, config_changes, test_results fields"
    - "to_markdown() renders activity profile in header (if present)"
    - "to_markdown() renders config changes as markdown table (if present)"
    - "to_markdown() renders test results section (if present)"
    - "to_markdown() gracefully handles missing optional fields (backward compatibility)"

  integration:
    - "SessionSummarizer generates markdown with all enhanced fields from sample session"
    - "HandoffExporter generates consistent markdown format with summarizer"
    - "Activity profile correctly extracts from ActivityVector.activity_profile property"

  security:
    - "Config changes table escapes markdown special characters (pipes, asterisks)"
    - "No exposure of sensitive data in config change 'before' values"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-10.1"
    text: "(P0) Markdown includes 'Activity Profile' section with dominant activities"
    implementation: "files_to_modify[summarizer.py] - Add activity_profile to header"
    tests: "unit[to_markdown() renders activity profile]"

  - id: "AC-10.2"
    text: "(P0) Key decisions render with rationale and alternatives considered"
    implementation: "ALREADY IMPLEMENTED in Story 1 (lines 130-136)"
    tests: "Story 1 test coverage"

  - id: "AC-10.3"
    text: "(P0) Errors resolved render with root cause, fix, and verification"
    implementation: "ALREADY IMPLEMENTED in Story 1 (lines 138-144)"
    tests: "Story 1 test coverage"

  - id: "AC-10.4"
    text: "(P1) Config changes render as markdown table"
    implementation: "files_to_modify[summarizer.py] - Add ConfigChange model and table rendering"
    tests: "unit[to_markdown() renders config changes table]"

  - id: "AC-10.5"
    text: "(P1) Test results render with pass/fail counts and coverage"
    implementation: "files_to_modify[summarizer.py] - Add TestResults model and section rendering"
    tests: "unit[to_markdown() renders test results]"

# Detailed Implementation Plan
implementation_details:
  phase_1_models:
    description: "Create new Pydantic models for config changes and test results"
    location: "graphiti_core/session_tracking/summarizer.py (after ErrorResolution, before SessionSummarySchema)"
    code:
      ConfigChange: |
        class ConfigChange(BaseModel):
            """Structured record of a configuration change made during a session."""

            file: str = Field(description='Configuration file path')
            setting: str = Field(description='Setting name that was changed')
            change: str = Field(description='Description of change (e.g., "60 -> 3600")')
            reason: str = Field(description='Why this change was made')

      TestResults: |
        class TestResults(BaseModel):
            """Structured record of test execution results."""

            framework: str = Field(description='Test framework used (e.g., pytest, jest)')
            passed: int = Field(description='Number of tests passed')
            failed: int = Field(description='Number of tests failed')
            coverage: float | None = Field(
                default=None, description='Code coverage percentage (0-100)'
            )

  phase_2_schema:
    description: "Add new fields to SessionSummarySchema and SessionSummary"
    location: "graphiti_core/session_tracking/summarizer.py"
    changes:
      SessionSummarySchema:
        - "Add activity_profile: str | None after objective"
        - "Add config_changes: list[ConfigChange] after errors_resolved"
        - "Add test_results: TestResults | None after config_changes"
      SessionSummary:
        - "Add activity_profile: str | None field"
        - "Add config_changes: list[ConfigChange] field"
        - "Add test_results: TestResults | None field"

  phase_3_markdown_header:
    description: "Update to_markdown() to include activity profile in header"
    location: "graphiti_core/session_tracking/summarizer.py:105-109"
    change_type: "insert_after"
    original_line: "**Objective**: {self.objective}"
    new_content: |
      if self.activity_profile:
          markdown_header = f"""**Activity Profile**: {self.activity_profile}
      **Outcome**: {self.status.lower()}

      ## Objective
      {self.objective}
      """
      else:
          markdown_header = f"""**Objective**: {self.objective}"""

  phase_4_config_table:
    description: "Add config changes markdown table rendering"
    location: "graphiti_core/session_tracking/summarizer.py (after errors_resolved section)"
    new_section: |
      if self.config_changes:
          markdown += '\n---\n\n## Configuration Changes\n\n'
          markdown += '| File | Setting | Change | Reason |\n'
          markdown += '|------|---------|--------|--------|\n'
          for config in self.config_changes:
              # Escape pipe characters in cell content
              file = config.file.replace('|', '\\|')
              setting = config.setting.replace('|', '\\|')
              change = config.change.replace('|', '\\|')
              reason = config.reason.replace('|', '\\|')
              markdown += f'| {file} | {setting} | {change} | {reason} |\n'

  phase_5_test_results:
    description: "Add test results section rendering"
    location: "graphiti_core/session_tracking/summarizer.py (after config_changes section)"
    new_section: |
      if self.test_results:
          markdown += '\n---\n\n## Test Results\n\n'
          total = self.test_results.passed + self.test_results.failed
          markdown += f'- **Framework**: {self.test_results.framework}\n'
          markdown += f'- **Results**: {self.test_results.passed}/{total} passed'
          if self.test_results.failed > 0:
              markdown += f' ({self.test_results.failed} failed)'
          markdown += '\n'
          if self.test_results.coverage is not None:
              markdown += f'- **Coverage**: {self.test_results.coverage:.1f}%\n'

  phase_6_prompt:
    description: "Update SUMMARIZATION_PROMPT to extract new fields"
    location: "graphiti_core/session_tracking/summarizer.py (SUMMARIZATION_PROMPT)"
    additions:
      - "Add instruction to extract activity profile from session (optional)"
      - "Add instruction to extract config changes as structured list (optional)"
      - "Add instruction to extract test results if tests were run (optional)"
    example_additions: |
      10. **Activity Profile** (optional): What type of work was primarily done?
          - Example: "fixing (0.80), configuring (0.70), testing (0.50)"
          - Leave null if unclear

      11. **Configuration Changes** (optional): Were any configuration files modified?
          For each change, provide:
          - file: Configuration file path (e.g., ".env", "config.py")
          - setting: Setting name (e.g., "JWT_EXPIRY")
          - change: What changed (e.g., "60 -> 3600")
          - reason: Why it was changed (e.g., "Fix timeout - was ambiguous units")

      12. **Test Results** (optional): Were tests executed during this session?
          If yes, provide:
          - framework: Test framework name (e.g., "pytest", "jest")
          - passed: Number of tests that passed
          - failed: Number of tests that failed
          - coverage: Code coverage percentage (e.g., 87.3) or null

  phase_7_handoff_sync:
    description: "Update HandoffExporter to match new schema"
    location: "graphiti_core/session_tracking/handoff_exporter.py"
    changes:
      - "Add ConfigChange and TestResults models (same as summarizer.py)"
      - "Add fields to HandoffSummarySchema"
      - "Add fields to HandoffSummary dataclass"
      - "Update to_markdown() with same rendering logic"

# Backward Compatibility
backward_compatibility:
  strategy: "All new fields are optional with default values"
  details:
    - "activity_profile: str | None = None (defaults to None if not provided)"
    - "config_changes: list[ConfigChange] = Field(default_factory=list)"
    - "test_results: TestResults | None = None"
  impact: "Existing sessions without new fields will render markdown without new sections"

# Example Output
example_markdown: |
  # Session 042: Fix JWT Authentication Timeout

  **Status**: completed
  **Created**: 2025-12-11 15:30
  **Activity Profile**: fixing (0.80), configuring (0.70), testing (0.50)
  **Outcome**: completed

  ## Objective
  Resolve JWT authentication timeout causing 401 errors after config migration

  ---

  ## Completed

  - Fixed token expiry configuration
  - Added explicit time unit documentation

  ---

  ## Blocked

  None

  ---

  ## Next Steps

  - Add config schema validation to CI pipeline

  ---

  ## Key Decisions

  - **Explicit time units**: Added EXPIRY_UNIT setting to prevent unit ambiguity
    - Rationale: Code-enforced validation prevents human error
    - Alternatives: Document-only fix, use ISO 8601 duration format

  ---

  ## Errors Resolved

  ### 401 Unauthorized after ~1 minute
  - **Root Cause**: `JWT_EXPIRY=60` interpreted as 60 seconds (was meant to be minutes)
  - **Fix**: Changed to `JWT_EXPIRY=3600` (explicit seconds)
  - **Verification**: Tested token validity over 30 minutes

  ---

  ## Configuration Changes

  | File | Setting | Change | Reason |
  |------|---------|--------|--------|
  | `.env` | `JWT_EXPIRY` | `60` -> `3600` | Fix timeout - was ambiguous units |

  ---

  ## Test Results

  - **Framework**: pytest
  - **Results**: 12/12 passed
  - **Coverage**: 87.3%

  ---

  ## Context

  **Files Modified/Created**:
  - `.env`
  - `config.py`
  - `tests/test_auth.py`
