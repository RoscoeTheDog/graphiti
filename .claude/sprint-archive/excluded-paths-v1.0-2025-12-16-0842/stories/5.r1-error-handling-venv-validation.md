# Story 5.r1: Fix Error Handling - Venv Validation

**Type**: remediation
**Remediation Type**: bug_fix
**Parent**: Story 5
**Priority**: P0
**Created**: 2025-12-14T17:00:00Z

---

## Context

**Original Story**: 5 - Bootstrap Service Update
**Current Status**: unassigned
**Issue**: Service managers don't raise VenvCreationError when venv is missing - tests expect error propagation but current implementation silently falls back to sys.executable

**Test Failures**:
- `test_windows_service_handles_venv_missing_gracefully` (FAILED)
- `test_launchd_service_handles_venv_missing_gracefully` (FAILED)
- `test_systemd_service_handles_venv_missing_gracefully` (FAILED)

**Codebase Analysis**:
- Current implementation: `mcp_server/daemon/windows_service.py` lines 39-44
- Pattern: try/except catches VenvCreationError and falls back to sys.executable
- Expected behavior: Propagate VenvCreationError to caller (DaemonManager validates venv exists before instantiating service managers)

---

## Remediation Goal

Remove fallback behavior in service manager constructors - let VenvCreationError propagate to caller. The venv MUST exist before service managers are instantiated (DaemonManager.install() ensures this in its workflow).

---

## Remediation Actions

### 1. Fix WindowsServiceManager Constructor

**File**: `mcp_server/daemon/windows_service.py`
**Change**: Remove try/except fallback in `__init__`, propagate VenvCreationError

**Current Code** (lines 39-44):
```python
try:
    self.python_exe = self.venv_manager.get_python_executable()
except VenvCreationError:
    # Fallback to sys.executable if venv not available
    # (will be created by DaemonManager.install() before service installation)
    self.python_exe = Path(sys.executable)
```

**Fixed Code**:
```python
# Get venv Python executable - raise VenvCreationError if venv doesn't exist
# (DaemonManager.install() ensures venv exists before instantiating service managers)
self.python_exe = self.venv_manager.get_python_executable()
```

**Rationale**: DaemonManager.install() creates venv BEFORE instantiating service managers. If venv doesn't exist at this point, it's a legitimate error that should halt installation.

### 2. Fix LaunchdServiceManager Constructor

**File**: `mcp_server/daemon/launchd_service.py`
**Change**: Remove try/except fallback in `__init__`, propagate VenvCreationError

**Pattern**: Same as WindowsServiceManager - search for try/except block around `get_python_executable()` and remove fallback logic.

```python
# Before (fallback pattern):
try:
    self.python_exe = self.venv_manager.get_python_executable()
except VenvCreationError:
    self.python_exe = Path(sys.executable)

# After (propagate error):
self.python_exe = self.venv_manager.get_python_executable()
```

### 3. Fix SystemdServiceManager Constructor

**File**: `mcp_server/daemon/systemd_service.py`
**Change**: Remove try/except fallback in `__init__`, propagate VenvCreationError

**Pattern**: Same as above - remove fallback to sys.executable, let VenvCreationError propagate.

### 4. Update Comments

**All three files**: Update docstrings/comments to reflect error propagation behavior:

```python
def __init__(self, venv_manager: Optional[VenvManager] = None):
    """Initialize service manager.

    Args:
        venv_manager: Optional VenvManager instance. If None, creates default instance.

    Raises:
        VenvCreationError: If venv doesn't exist at ~/.graphiti/.venv
    """
```

---

## Testing

**Existing Tests (should now pass)**:
- File: `tests/daemon/test_service_venv_integration.py`
- Tests: All 3 `test_*_service_handles_venv_missing_gracefully` tests

**Test Pattern** (what tests verify):
```python
mock_venv = Mock(spec=VenvManager)
mock_venv.get_python_executable.side_effect = VenvCreationError("Venv does not exist")

# Should raise VenvCreationError (not fall back to sys.executable)
with pytest.raises(VenvCreationError):
    service_manager = WindowsServiceManager(venv_manager=mock_venv)
```

**Expected Result**: Tests raise VenvCreationError as expected (no silent fallback)

---

## Acceptance Criteria

- [ ] **(P0) AC-5.r1.1**: WindowsServiceManager raises VenvCreationError if venv missing (no fallback)
- [ ] **(P0) AC-5.r1.2**: LaunchdServiceManager raises VenvCreationError if venv missing (no fallback)
- [ ] **(P0) AC-5.r1.3**: SystemdServiceManager raises VenvCreationError if venv missing (no fallback)
- [ ] **(P0) AC-5.r1.4**: All 3 error handling tests pass (test_*_handles_venv_missing_gracefully)
- [ ] **(P1) AC-5.r1.5**: Docstrings updated to document VenvCreationError in Raises section

---

## Verification

1. Run error handling tests: `pytest tests/daemon/test_service_venv_integration.py -k "handles_venv_missing" -v`
2. Verify 3/3 tests pass (Windows, macOS, Linux service managers)
3. Verify no AttributeError crashes (error propagates cleanly)
4. Check docstrings include Raises section

---

## Notes

- **Remediation Type**: bug_fix (P0 - tests failing)
- **Auto-Created**: 2025-12-14T17:00:00Z
- **Created From**: Test failure analysis for Story 5.t
- **Original Request**: "Story 5.t failed with 64% test pass rate - fix error handling tests"
- **Root Cause**: Service managers had defensive fallback to sys.executable, but tests expect strict venv validation
- **Fix Strategy**: Remove fallback, propagate error (aligns with DaemonManager.install() workflow)

---

**Created**: 2025-12-14T17:00:00Z
