# Story 4.r1: Fix Test Failures in PATH Integration

**Type**: remediation
**Remediation Type**: bug_fix
**Parent**: Story 4.t
**Priority**: P0
**Created**: 2025-12-14 19:30

---

## Context

**Original Story**: 4.t - PATH Integration Testing
**Current Status**: failed (6 of 14 non-skipped tests failed)
**Issue**: Module-level import mocking failures and print assertion issues

**Test Failures**:
1. `test_detect_shell_defaults_to_bash` - Cannot patch `pwd` module (Unix-only import)
2. `test_configure_windows_path_with_consent` - Cannot patch `winreg` module (Windows-only import)
3. `test_configure_windows_path_already_present` - Cannot patch `winreg` module
4. `test_configure_windows_path_permission_error` - Cannot patch `winreg` module
5. `test_display_instructions_when_already_configured` - Print call signature mismatch
6. `test_display_windows_instructions_consent_declined` - Print call signature mismatch

**Root Cause**: The `pwd` and `winreg` modules are imported inside functions (conditional imports for platform compatibility), but tests attempt to patch them at module level, causing `AttributeError: module does not have the attribute`.

---

## Remediation Goal

Fix all 6 failing tests by properly handling conditional imports in mocking strategy and correcting print call assertions.

---

## Remediation Actions

### 1. Fix `pwd` Module Mocking Strategy

**File**: `tests/daemon/test_path_integration.py`
**Lines**: 163-169
**Change**: Use `patch.dict` to mock module import and handle ImportError gracefully

**Current Code (Failing)**:
```python
@patch("os.environ", {})
def test_detect_shell_defaults_to_bash(self):
    """Test shell detection defaults to bash when detection fails."""
    with patch("mcp_server.daemon.path_integration.pwd", None):
        integration = PathIntegration()
        shell = integration.detect_shell()
        assert shell == "bash"
```

**Fixed Code**:
```python
@patch("os.environ", {})
def test_detect_shell_defaults_to_bash(self):
    """Test shell detection defaults to bash when detection fails."""
    # Mock pwd.getpwuid to raise exception (simulates unavailable pwd module)
    def mock_getpwuid_error(uid):
        raise ImportError("pwd module not available")

    with patch("pwd.getpwuid", side_effect=mock_getpwuid_error):
        integration = PathIntegration()
        shell = integration.detect_shell()
        assert shell == "bash"
```

**Rationale**: Since `pwd` is imported inside the `detect_shell()` function with try/except, we need to mock the actual function call to raise an exception, not patch the module attribute.

---

### 2. Fix `winreg` Module Mocking Strategy

**File**: `tests/daemon/test_path_integration.py`
**Lines**: 215-233, 246-267, 268-283
**Change**: Import `winreg` at test module level for Windows, mock at function level

**Current Code (3 tests failing)**:
```python
@pytest.mark.skipif(sys.platform != "win32", reason="Windows-specific test")
@patch("mcp_server.daemon.path_integration.winreg")
def test_configure_windows_path_with_consent(self, mock_winreg, tmp_path):
    # ... test body ...
```

**Fixed Code**:
```python
@pytest.mark.skipif(sys.platform != "win32", reason="Windows-specific test")
def test_configure_windows_path_with_consent(self, tmp_path):
    """Test Windows registry modification with user consent."""
    bin_path = tmp_path / "bin"
    bin_path.mkdir()

    # Mock winreg at import level
    with patch("winreg.OpenKey") as mock_open_key, \
         patch("winreg.QueryValueEx") as mock_query, \
         patch("winreg.SetValueEx") as mock_set, \
         patch("winreg.CloseKey") as mock_close:

        mock_key = MagicMock()
        mock_open_key.return_value = mock_key
        mock_query.return_value = (r"C:\existing\path", None)

        integration = PathIntegration(bin_path=bin_path)
        success, msg = integration.configure_windows_path(consent=True)

        assert success is True
        assert "Successfully added" in msg
        mock_set.assert_called_once()
```

**Apply same fix pattern to**:
- `test_configure_windows_path_already_present` (lines 246-267)
- `test_configure_windows_path_permission_error` (lines 268-283)

**Rationale**: Patching individual `winreg` functions avoids module-level attribute errors while still mocking the Windows registry operations.

---

### 3. Fix Print Call Assertions

**File**: `tests/daemon/test_path_integration.py`
**Lines**: 301, 320
**Change**: Handle empty print calls (separator lines) correctly

**Current Code (Failing)**:
```python
# Line 301
printed_text = " ".join(str(call[0][0]) for call in mock_print.call_args_list)
```

**Fixed Code**:
```python
# Line 301
printed_text = " ".join(
    str(call[0][0]) if call[0] else ""
    for call in mock_print.call_args_list
)
```

**Apply to both tests**:
- `test_display_instructions_when_already_configured` (line 301)
- `test_display_windows_instructions_consent_declined` (line 320)

**Rationale**: The `display_instructions()` method calls `print()` without arguments for blank lines, creating `call[0] = ()` which causes `IndexError: tuple index out of range` when accessing `call[0][0]`.

---

## Testing

**Run all tests**:
```bash
pytest tests/daemon/test_path_integration.py -v
```

**Expected Results**:
- All 22 tests should pass (14 non-skipped + 8 skipped)
- 0 failures
- Test pass rate: 100%

**Specific verification**:
```bash
# Test each fixed test individually
pytest tests/daemon/test_path_integration.py::TestShellDetection::test_detect_shell_defaults_to_bash -v
pytest tests/daemon/test_path_integration.py::TestWindowsRegistry::test_configure_windows_path_with_consent -v
pytest tests/daemon/test_path_integration.py::TestWindowsRegistry::test_configure_windows_path_already_present -v
pytest tests/daemon/test_path_integration.py::TestWindowsRegistry::test_configure_windows_path_permission_error -v
pytest tests/daemon/test_path_integration.py::TestInstructionDisplay::test_display_instructions_when_already_configured -v
pytest tests/daemon/test_path_integration.py::TestInstructionDisplay::test_display_windows_instructions_consent_declined -v
```

---

## Acceptance Criteria

- [ ] **(P0) AC-4.r1.1**: `test_detect_shell_defaults_to_bash` passes without AttributeError
- [ ] **(P0) AC-4.r1.2**: All 3 Windows registry tests pass without AttributeError
- [ ] **(P0) AC-4.r1.3**: Both print assertion tests pass without IndexError
- [ ] **(P0) AC-4.r1.4**: Overall test pass rate for `test_path_integration.py` is 100% (14 of 14 non-skipped tests)
- [ ] **(P0) AC-4.r1.5**: No new test failures introduced

---

## Verification

1. **Clean test run**: `pytest tests/daemon/test_path_integration.py -v --tb=short`
2. **Check test count**: Should show "14 passed, 8 skipped" (Windows) or "8 passed, 14 skipped" (Unix)
3. **Verify no regressions**: `pytest tests/daemon/ -v` (all daemon tests should pass)
4. **Integration check**: `pytest tests/daemon/test_venv_integration.py -v` (should not be affected)

---

## Notes

- **Remediation Type**: bug_fix (test infrastructure issues, not production code bugs)
- **Auto-Created**: 2025-12-14 19:30
- **Created From**: Natural language request + test failure analysis
- **Original Request**: "Story 4.t failed with 57% test pass rate (6 of 14 non-skipped tests failed). Create a remediation story and fix the issues."
- **Pattern**: Conditional imports require import-level mocking, not module-attribute mocking
- **Cross-platform note**: Tests use `pytest.mark.skipif` to skip platform-specific tests (Unix tests on Windows, Windows tests on Unix)

---

**Created**: 2025-12-14T19:30:00Z
