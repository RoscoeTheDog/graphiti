# Plan: 1
# Generated by: discovery:1.d
# Timestamp: 2025-12-15T04:45:00Z

story_id: "1"
title: "Session Tracking Excluded Paths"
created: "2025-12-15T04:45:00Z"
created_by: "discovery:1.d"

# Analysis Summary
analysis:
  summary: "Add excluded_paths configuration to SessionTrackingConfig with glob pattern support and platform-agnostic path matching to enable dual-track architecture (Temporal orchestrator + BMAD agents)"
  complexity: "low"
  estimated_files: 4
  estimated_tokens: 3500
  risk_factors:
    - "Path normalization complexity across Windows/Unix/MSYS platforms"
    - "Glob pattern matching edge cases (recursive patterns, escaping)"
    - "Configuration schema regeneration must not break existing configs"

# Files to Create
files_to_create: []  # No new files needed, only modifications

# Files to Modify
files_to_modify:
  - path: "graphiti_core/config/session_tracking.py"
    changes:
      - "Add excluded_paths: List[str] field to SessionTrackingConfig"
      - "Add Field with default_factory=list and descriptive documentation"
      - "Include examples in field description (absolute, relative, glob patterns)"
    lines_affected: 10

  - path: "graphiti_core/session_tracking/session_manager.py"
    changes:
      - "Add _is_path_excluded(session_path: Path) -> bool method"
      - "Implement glob pattern matching using pathlib.PurePath.match()"
      - "Add platform-agnostic path comparison (normalize to UNIX format for comparison)"
      - "Handle both absolute and relative-to-watch_path formats"
      - "Update _start_tracking_session() to check exclusions before processing"
      - "Add DEBUG log when session is skipped due to exclusion"
      - "Add INFO log during daemon startup showing excluded paths"
    lines_affected: 50

  - path: "graphiti.config.schema.json"
    changes:
      - "Regenerate schema from SessionTrackingConfig using Pydantic"
      - "Ensure excluded_paths appears in session_tracking section"
      - "Validate schema structure (type: array, items: string)"
    lines_affected: 15

  - path: "CONFIGURATION.md"
    changes:
      - "Add excluded_paths field documentation to Session Tracking section"
      - "Include field description table (name, type, default, description)"
      - "Add example configuration showing Temporal server exclusion pattern"
      - "Document path format requirements (absolute vs relative, glob patterns)"
      - "Add note about platform-agnostic path matching"
    lines_affected: 25

# Integration Points
integration:
  - file: "graphiti_core/session_tracking/session_manager.py"
    type: "config"
    description: "Read excluded_paths from unified_config.session_tracking at initialization"

  - file: "mcp_server/graphiti_mcp_server.py"
    type: "initialization"
    description: "SessionManager will automatically read excluded_paths from unified_config (no changes needed to MCP server initialization)"

# Patterns to Follow
patterns:
  - source: "graphiti_core/config/session_tracking.py"
    pattern: "Use Pydantic Field with default_factory for list fields (see keep_length_days pattern)"

  - source: "graphiti_core/session_tracking/path_resolver.py"
    pattern: "Use PathResolver.normalize_path() for platform-agnostic path comparison (UNIX format for hashing/comparison)"

  - source: "mcp_server/export_helpers.py:_resolve_absolute_path"
    pattern: "Handle MSYS/WSL path formats for Windows compatibility"

  - source: "graphiti_core/session_tracking/filter_config.py"
    pattern: "Use Union[bool, str] type pattern for flexible configuration options (if needed for future extension)"

# Test Requirements
test_requirements:
  unit:
    - "Test empty excluded_paths (no exclusions, all sessions tracked)"
    - "Test absolute path exclusion (exact match)"
    - "Test relative path exclusion (relative to watch_path)"
    - "Test glob pattern matching (simple wildcard: **/temporal-*/**)"
    - "Test glob pattern matching (multi-level: **/orchestrator/**/sessions/**)"
    - "Test platform-specific path normalization (Windows backslashes vs Unix forward slashes)"
    - "Test _is_path_excluded() returns True for matching paths"
    - "Test _is_path_excluded() returns False for non-matching paths"
    - "Test case sensitivity (Unix: sensitive, Windows: insensitive)"

  integration:
    - "Test SessionManager skips sessions under excluded paths"
    - "Test SessionManager still tracks sessions NOT under excluded paths"
    - "Test daemon startup logs excluded paths at INFO level"
    - "Test session skip logged at DEBUG level with path details"
    - "Test excluded_paths configuration loaded from graphiti.config.json"
    - "Test configuration with multiple exclusion patterns"
    - "Test Temporal server exclusion use case (real-world pattern)"

  security:
    - "Test path traversal prevention (../ patterns rejected or normalized safely)"
    - "Test absolute path outside watch_path doesn't cause errors"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-1"
    text: "Add excluded_paths: List[str] to SessionTrackingConfig"
    implementation: "files_to_modify[0] (graphiti_core/config/session_tracking.py)"
    tests: "test_requirements.unit[0-1]"

  - id: "AC-2"
    text: "Default value: [] (empty list, no exclusions)"
    implementation: "files_to_modify[0] (graphiti_core/config/session_tracking.py)"
    tests: "test_requirements.unit[0]"

  - id: "AC-3"
    text: "Update graphiti.config.schema.json to include new field"
    implementation: "files_to_modify[2] (graphiti.config.schema.json)"
    tests: "test_requirements.integration[4]"

  - id: "AC-4"
    text: "Paths support both absolute and relative-to-watch_path formats"
    implementation: "files_to_modify[1] (session_manager.py:_is_path_excluded)"
    tests: "test_requirements.unit[1-2]"

  - id: "AC-5"
    text: "Support glob patterns (e.g., **/temporal-*-server/**)"
    implementation: "files_to_modify[1] (session_manager.py:_is_path_excluded)"
    tests: "test_requirements.unit[3-4]"

  - id: "AC-6"
    text: "Platform-agnostic path comparison (normalize slashes)"
    implementation: "files_to_modify[1] (session_manager.py:_is_path_excluded)"
    tests: "test_requirements.unit[5-8]"

  - id: "AC-7"
    text: "Implement path matching in SessionManager._start_tracking_session()"
    implementation: "files_to_modify[1] (session_manager.py:_start_tracking_session)"
    tests: "test_requirements.integration[0-1]"

  - id: "AC-8"
    text: "Skip session tracking for JSONL files under excluded paths"
    implementation: "files_to_modify[1] (session_manager.py:_start_tracking_session)"
    tests: "test_requirements.integration[0]"

  - id: "AC-9"
    text: "Log when a session is skipped due to exclusion (DEBUG level)"
    implementation: "files_to_modify[1] (session_manager.py:_start_tracking_session)"
    tests: "test_requirements.integration[3]"

  - id: "AC-10"
    text: "Log excluded paths on daemon startup (INFO level)"
    implementation: "files_to_modify[1] (session_manager.py:start or __init__)"
    tests: "test_requirements.integration[2]"

  - id: "AC-11"
    text: "Update CONFIGURATION.md with new field"
    implementation: "files_to_modify[3] (CONFIGURATION.md)"
    tests: "test_requirements.integration[4]"

  - id: "AC-12"
    text: "Add example showing Temporal server exclusion"
    implementation: "files_to_modify[3] (CONFIGURATION.md)"
    tests: "test_requirements.integration[6]"

# Implementation Notes

## Path Matching Logic

The _is_path_excluded() method will:

1. Normalize session_path to UNIX format (using PathResolver.normalize_path())
2. Normalize watch_path to UNIX format (for relative path calculation)
3. For each pattern in excluded_paths:
   a. If pattern is absolute: Match directly against normalized session_path
   b. If pattern is relative: Calculate session_path relative to watch_path, then match
   c. Use pathlib.PurePath.match() for glob pattern matching
   d. Return True on first match (short-circuit)
4. Return False if no matches

## Example Usage

```json
{
  "session_tracking": {
    "enabled": true,
    "watch_path": "~/.claude/projects",
    "excluded_paths": [
      "**/temporal-*-server/**",
      "/absolute/path/to/exclude",
      "relative/path/from/watch_path"
    ]
  }
}
```

## Platform Considerations

- Windows: Backslashes normalized to forward slashes for comparison
- Unix: Forward slashes used natively
- MSYS/Git Bash: /c/Users/... normalized to C:/Users/... then to C:/Users/...
- Case sensitivity: Preserved (Unix: case-sensitive, Windows: case-insensitive via OS)

## Performance

- Excluded paths checked on session start (not per-message)
- Glob matching is O(n) where n = number of exclusion patterns
- Expected n < 10 for typical use cases
- Negligible impact on session tracking performance
