# Plan: 3
# Generated by: discovery:3.d
# Timestamp: 2025-12-14T18:30:00Z

story_id: "3"
title: "CLI Wrapper Script Generation"
created: "2025-12-14T18:30:00Z"
created_by: "discovery:3.d"

# Analysis Summary
analysis:
  summary: "Create platform-specific wrapper scripts in ~/.graphiti/bin/ that invoke venv Python without requiring activation. Uses existing patterns from VenvManager for path handling."
  complexity: "medium"
  estimated_files: 2
  estimated_tokens: 8000
  risk_factors:
    - "Platform-specific path handling (Windows vs Unix)"
    - "File permissions on Unix (executable bit)"
    - "PATH conflicts if user has multiple graphiti installations"

# Files to Create
files_to_create:
  - path: "mcp_server/daemon/wrapper_generator.py"
    purpose: "Generates platform-specific wrapper scripts for CLI commands"
    pattern_source: "mcp_server/daemon/venv_manager.py"
    estimated_lines: 250
    responsibilities:
      - "Create ~/.graphiti/bin/ directory"
      - "Generate Windows .cmd batch files"
      - "Generate Unix shell scripts with executable permissions"
      - "Use absolute paths to venv Python"
      - "Handle platform detection (sys.platform)"
      - "Validate wrapper script creation"

# Files to Modify
files_to_modify:
  - path: "mcp_server/daemon/manager.py"
    changes:
      - "Import WrapperGenerator class"
      - "Add wrapper generation step after package installation in install() method"
      - "Add validation check for wrapper scripts in status() method"
      - "Add wrapper cleanup in uninstall() method"
    lines_affected: 30
    location: "DaemonManager class"

# Integration Points
integration:
  - file: "mcp_server/daemon/manager.py"
    type: "import"
    description: "Import WrapperGenerator and integrate into install workflow"

  - file: "mcp_server/daemon/venv_manager.py"
    type: "pattern"
    description: "Follow platform detection pattern (sys.platform == 'win32' checks)"

  - file: "mcp_server/pyproject.toml"
    type: "reference"
    description: "Wrapper scripts must match entry points: graphiti-mcp, graphiti-bootstrap, graphiti-mcp-daemon"

# Patterns to Follow
patterns:
  - source: "mcp_server/daemon/venv_manager.py"
    pattern: "Platform-specific path handling using sys.platform and Path objects"
    example: |
      if sys.platform == "win32":
          python_exe = self.venv_path / "Scripts" / "python.exe"
      else:
          python_exe = self.venv_path / "bin" / "python"

  - source: "mcp_server/daemon/venv_manager.py"
    pattern: "Validation methods that check file existence and report detailed errors"
    example: |
      if not wrapper_path.exists():
          raise WrapperGenerationError(f"Wrapper not found: {wrapper_path}")

  - source: "mcp_server/daemon/manager.py"
    pattern: "Step-by-step install workflow with [OK]/[FAILED] status messages"
    example: |
      print("Creating wrapper scripts...")
      success, msg = wrapper_gen.generate_wrappers()
      if success:
          print(f"[OK] {msg}")
      else:
          print(f"[FAILED] {msg}")

# Test Requirements
test_requirements:
  unit:
    - "Test wrapper generation on Windows platform (mock sys.platform)"
    - "Test wrapper generation on Unix platform (mock sys.platform)"
    - "Test wrapper script content validation (correct Python path)"
    - "Test bin directory creation (idempotent)"
    - "Test executable permissions on Unix scripts"
    - "Test error handling when venv doesn't exist"
    - "Test cleanup of existing wrappers"

  integration:
    - "Test full install workflow includes wrapper generation"
    - "Test wrapper scripts execute successfully after install"
    - "Test wrappers invoke correct venv Python (not system Python)"
    - "Test wrappers pass command-line arguments correctly"
    - "Test status command reports wrapper script existence"
    - "Test uninstall removes wrapper scripts"

  security:
    - "Test wrappers use absolute paths (no PATH injection)"
    - "Test file permissions prevent unauthorized modification"
    - "Test wrapper scripts reject malicious arguments"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-3.1"
    text: "Creates ~/.graphiti/bin/ directory"
    implementation: "files_to_create[0]: wrapper_generator.py (create_bin_directory method)"
    tests: "test_requirements.unit[3]"

  - id: "AC-3.2"
    text: "Generates wrapper scripts for: graphiti-mcp, graphiti-mcp-daemon, graphiti-bootstrap"
    implementation: "files_to_create[0]: wrapper_generator.py (generate_wrappers method)"
    tests: "test_requirements.integration[0,1]"

  - id: "AC-3.3"
    text: "Windows: Creates .cmd batch files"
    implementation: "files_to_create[0]: wrapper_generator.py (generate_windows_wrapper method)"
    tests: "test_requirements.unit[0]"

  - id: "AC-3.4"
    text: "Unix: Creates shell scripts with executable permissions"
    implementation: "files_to_create[0]: wrapper_generator.py (generate_unix_wrapper method)"
    tests: "test_requirements.unit[1,4]"

  - id: "AC-3.5"
    text: "Wrapper scripts use absolute path to ~/.graphiti/.venv/ Python"
    implementation: "files_to_create[0]: wrapper_generator.py (get_python_path method)"
    tests: "test_requirements.unit[2], test_requirements.integration[2]"

# Implementation Details

## Wrapper Script Templates

### Windows (.cmd)
# Template stored in wrapper_generator.py
template_windows: |
  @echo off
  REM Graphiti {command_name} wrapper
  REM Auto-generated by graphiti-mcp daemon install
  "{python_path}" -m {module_path} %*

### Unix (shell)
# Template stored in wrapper_generator.py
template_unix: |
  #!/bin/bash
  # Graphiti {command_name} wrapper
  # Auto-generated by graphiti-mcp daemon install
  "{python_path}" -m {module_path} "$@"

## Command Mapping
commands:
  - name: "graphiti-mcp"
    module: "mcp_server.graphiti_mcp_server"
    description: "Main MCP server"

  - name: "graphiti-bootstrap"
    module: "mcp_server.daemon.bootstrap"
    description: "Bootstrap service"

  - name: "graphiti-mcp-daemon"
    module: "mcp_server.daemon.manager"
    description: "Daemon manager CLI"

## Directory Structure
output_structure: |
  ~/.graphiti/
  ├── .venv/              # Created by Story 1
  │   ├── Scripts/        # Windows
  │   │   └── python.exe
  │   └── bin/            # Unix
  │       └── python
  └── bin/                # Created by Story 3
      ├── graphiti-mcp.cmd              # Windows
      ├── graphiti-mcp                  # Unix
      ├── graphiti-bootstrap.cmd        # Windows
      ├── graphiti-bootstrap            # Unix
      ├── graphiti-mcp-daemon.cmd       # Windows
      └── graphiti-mcp-daemon           # Unix

# Dependencies
dependencies:
  required_stories:
    - "2": "Package Installation to Dedicated Venv (venv must exist and have mcp_server installed)"

  required_modules:
    - "pathlib.Path": "Cross-platform path handling"
    - "sys.platform": "Platform detection"
    - "os.chmod": "Unix executable permissions"
    - "subprocess": "Wrapper validation (optional)"

# Error Handling Strategy
error_handling:
  venv_missing:
    check: "VenvManager.detect_venv() returns False"
    action: "Raise WrapperGenerationError with detailed message"

  bin_creation_failed:
    check: "Path.mkdir() raises exception"
    action: "Catch and re-raise with context about permissions"

  wrapper_write_failed:
    check: "Path.write_text() raises exception"
    action: "Catch and re-raise with context about disk space/permissions"

  chmod_failed_unix:
    check: "os.chmod() raises exception on Unix"
    action: "Warn but don't fail (wrapper may still work if already executable)"

# Success Criteria
success_criteria:
  - "All wrapper scripts created in ~/.graphiti/bin/"
  - "Windows: .cmd files have correct batch syntax"
  - "Unix: Shell scripts have executable permissions (0o755)"
  - "All wrappers use absolute path to venv Python"
  - "Wrappers successfully invoke their respective modules"
  - "Integration with DaemonManager.install() workflow"
  - "Status command reports wrapper existence"
  - "Uninstall removes all wrappers"

# Token Budget Estimate
token_budget:
  discovery: 15000
  implementation: 20000
  testing: 18000
  total: 53000
