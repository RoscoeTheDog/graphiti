# Plan: 2
# Generated by: discovery:2.d
# Timestamp: 2025-12-13T02:39:00Z

story_id: "2"
title: "Remove Session Manager Time-Based Logic"
created: "2025-12-13T02:39:00Z"
created_by: "discovery:2.d"

# Analysis Summary
analysis:
  summary: "Remove time-based session tracking logic (inactivity detection, periodic checking) from SessionManager class and MCP server, as turn-based architecture eliminates need for time-based session boundaries."
  complexity: "medium"
  estimated_files: 4
  estimated_tokens: 8000
  risk_factors:
    - "Tests depend on inactivity_timeout parameter - must be refactored or removed"
    - "MCP server initialization code must be updated to not start periodic checker"
    - "SessionManager.__init__ signature change affects all instantiation sites"

# Files to Create
files_to_create: []

# Files to Modify
files_to_modify:
  - path: "graphiti_core/session_tracking/session_manager.py"
    changes:
      - "Remove inactivity_timeout parameter from __init__"
      - "Remove check_inactive_sessions() method (lines 139-158)"
      - "Remove last_activity tracking from ActiveSession dataclass (line 46)"
      - "Remove last_activity updates in _read_new_messages() (line 349)"
      - "Remove last_activity initialization in _start_tracking_session() (line 317)"
      - "Update class docstring to remove inactivity detection references"
    lines_affected: 80

  - path: "mcp_server/graphiti_mcp_server.py"
    changes:
      - "Remove check_inactive_sessions_periodically() function (lines 2444-2475)"
      - "Remove _inactivity_checker_task initialization in session tracking init (lines 2737-2741)"
      - "Remove global _inactivity_checker_task variable declaration"
      - "Remove check_interval config reference (line 2738)"
    lines_affected: 40

  - path: "tests/session_tracking/test_periodic_checker.py"
    changes:
      - "Remove entire test file - all tests validate time-based logic being removed"
    lines_affected: 209

  - path: "tests/test_session_file_monitoring.py"
    changes:
      - "Remove inactivity_timeout parameter from all SessionManager instantiations"
      - "Remove test_session_inactivity_detection() test method (lines ~225-265)"
      - "Remove test_inactivity_timeout_closes_session() test method (lines ~267-290)"
    lines_affected: 70

# Integration Points
integration:
  - file: "graphiti_core/session_tracking/session_manager.py"
    type: "signature_change"
    description: "SessionManager.__init__ signature changes - affects all call sites"

  - file: "mcp_server/graphiti_mcp_server.py"
    type: "initialization"
    description: "Remove periodic checker task creation from session tracking initialization"

  - file: "tests/"
    type: "test_cleanup"
    description: "Remove or update tests that rely on inactivity_timeout or check_inactive_sessions()"

# Patterns to Follow
patterns:
  - source: ".claude/sprint/stories/1-remove-deprecated-config-parameters.md"
    pattern: "Configuration parameter removal - similar to Story 1's removal of config fields"

  - source: "graphiti_core/session_tracking/session_manager.py"
    pattern: "Class method removal with docstring updates"

# Test Requirements
test_requirements:
  unit:
    - "Verify SessionManager instantiates without inactivity_timeout parameter"
    - "Verify check_inactive_sessions() method no longer exists"
    - "Verify ActiveSession no longer tracks last_activity"
    - "Verify check_inactive_sessions_periodically() function removed from MCP server"

  integration:
    - "Verify MCP server starts without periodic checker task"
    - "Verify session tracking works without time-based logic"
    - "Verify existing tests pass after parameter removal"

  security:
    - "Verify no orphaned tasks remain after periodic checker removal"
    - "Verify session cleanup still works without time-based inactivity detection"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-2.1"
    text: "(P0) Remove inactivity_timeout usage from SessionManager.__init__"
    implementation: "files_to_modify[0] (session_manager.py line 64)"
    tests: "test_requirements.unit[0]"

  - id: "AC-2.2"
    text: "(P0) Remove check_inactive_sessions_periodically function"
    implementation: "files_to_modify[1] (graphiti_mcp_server.py lines 2444-2475)"
    tests: "test_requirements.unit[3]"

  - id: "AC-2.3"
    text: "(P1) Remove _check_session_inactivity method if present"
    implementation: "files_to_modify[0] (check_inactive_sessions method removal)"
    tests: "test_requirements.unit[1]"

  - id: "AC-2.4"
    text: "(P2) Evaluate if SessionManager class is still needed or can be simplified"
    implementation: "files_to_modify[0] (analysis during implementation)"
    tests: "test_requirements.integration[1]"
