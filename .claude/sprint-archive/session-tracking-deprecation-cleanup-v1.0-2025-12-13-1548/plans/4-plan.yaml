# Plan: 4
# Generated by: discovery:4.d
# Timestamp: 2025-12-13T03:15:00Z

story_id: "4"
title: "Clean Up MCP Server Session Initialization"
created: "2025-12-13T03:15:00Z"
created_by: "discovery:4.d"

# Analysis Summary
analysis:
  summary: "Remove orphaned references to deprecated time-based session tracking infrastructure in MCP server. Story 2 removed the functionality but left cleanup code referencing never-initialized variables. No functional changes needed to initialize_session_tracking - it's already clean."
  complexity: "low"
  estimated_files: 1
  estimated_tokens: 1500
  risk_factors:
    - "Very low risk - removing dead code only"
    - "No functional logic changes"
    - "Cleanup from Story 2's incomplete removal"

# Files to Create
files_to_create: []

# Files to Modify
files_to_modify:
  - path: "mcp_server/graphiti_mcp_server.py"
    changes:
      - "Remove global _inactivity_checker_task variable (around line 106-112 section, not present in current code)"
      - "Remove _inactivity_checker_task cleanup code in run_mcp_server() shutdown (lines 2816-2825)"
      - "Update global variable declaration in shutdown (line 2816) - remove _inactivity_checker_task from list"
      - "Remove associated logging statements for inactivity checker (lines 2820, 2825)"
    lines_affected: 15
    notes: "This is orphaned cleanup code from Story 2. The _inactivity_checker_task variable is never initialized anywhere but shutdown code tries to clean it up. Safe to remove entirely."

# Integration Points
integration:
  - file: "mcp_server/graphiti_mcp_server.py"
    type: "cleanup"
    description: "Remove orphaned shutdown code for deprecated periodic checker task"

  - file: "initialize_session_tracking()"
    type: "no_changes_needed"
    description: "Function is already clean - no time-based logic, no periodic tasks, properly uses config-driven approach"

# Patterns to Follow
patterns:
  - source: ".claude/sprint/stories/2-remove-session-manager-time-based-logic.md"
    pattern: "Complete the cleanup started in Story 2 by removing orphaned shutdown code"

  - source: "mcp_server/graphiti_mcp_server.py"
    pattern: "Clean shutdown handler pattern - only clean up resources that actually exist"

# Test Requirements
test_requirements:
  unit:
    - "Verify MCP server starts successfully"
    - "Verify no references to _inactivity_checker_task remain"
    - "Verify no references to check_inactive_sessions_periodically remain"
    - "Verify initialize_session_tracking() works as before (no functional changes)"

  integration:
    - "Verify MCP server starts and stops cleanly"
    - "Verify session tracking initialization works without deprecated references"
    - "Verify shutdown completes without errors"

  security:
    - "Verify no resource leaks in shutdown path"
    - "Verify all active tasks are properly cleaned up on shutdown"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-4.1"
    text: "(P0) Remove check_inactive_sessions_periodically call from server startup"
    implementation: "ALREADY COMPLETE - removed in Story 2"
    tests: "test_requirements.unit[2]"

  - id: "AC-4.2"
    text: "(P0) Remove check_interval usage from session tracking initialization"
    implementation: "ALREADY COMPLETE - no current usage found"
    tests: "test_requirements.unit[3]"

  - id: "AC-4.3"
    text: "(P1) Simplify initialize_session_tracking function"
    implementation: "NO CHANGES NEEDED - function is already clean and focused"
    tests: "test_requirements.integration[1]"

  - id: "AC-4.4"
    text: "(P1) Remove related logging statements referencing deprecated params"
    implementation: "files_to_modify[0] - remove inactivity checker logging (lines 2820, 2825)"
    tests: "test_requirements.integration[2]"

# Discovery Notes
discovery_notes:
  - "Story 2 removed check_inactive_sessions_periodically() function successfully"
  - "Story 2 removed check_interval from configuration"
  - "Story 2 left orphaned cleanup code in shutdown handler (lines 2816-2825)"
  - "_inactivity_checker_task is never initialized but shutdown tries to clean it up"
  - "initialize_session_tracking() is already clean - no changes needed"
  - "This is primarily a cleanup story completing Story 2's work"

# Implementation Strategy
implementation_strategy:
  approach: "surgical_removal"
  steps:
    - "Remove orphaned _inactivity_checker_task cleanup block (lines 2818-2825)"
    - "Update global variable declaration in shutdown (line 2816) to remove _inactivity_checker_task"
    - "Verify no other references to deprecated variables remain"
    - "Run sanity checks to ensure clean startup/shutdown"
  estimated_time: "15 minutes"
