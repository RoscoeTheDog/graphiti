# Plan: 4
# Generated by: discovery:4.d
# Timestamp: 2025-12-09T08:15:00Z

story_id: "4"
title: "Episode Metadata Builder"
created: "2025-12-09T08:15:00Z"
created_by: "discovery:4.d"

# Analysis Summary
analysis:
  summary: "Create build_episode_metadata_header() function to generate YAML frontmatter with namespace metadata for episodes. This is a straightforward function with clear spec requirements - no external dependencies or complex patterns needed."
  complexity: "low"
  estimated_files: 3
  estimated_tokens: 8000
  risk_factors:
    - "YAML formatting edge cases with special characters in paths"
    - "Timezone handling for indexed_at field"

# Files to Create
files_to_create:
  - path: "graphiti_core/session_tracking/metadata.py"
    purpose: "Episode metadata header generation module - contains build_episode_metadata_header() function"
    pattern_source: "graphiti_core/session_tracking/summarizer.py"
    estimated_lines: 80
    contents_summary: |
      - build_episode_metadata_header() function
      - YAML frontmatter generation
      - ISO8601 timestamp formatting
      - Optional project_path handling

  - path: "tests/session_tracking/test_metadata.py"
    purpose: "Unit tests for metadata module - comprehensive coverage of header generation"
    pattern_source: "tests/session_tracking/test_path_resolver.py"
    estimated_lines: 150
    contents_summary: |
      - Test valid YAML output
      - Test required fields presence
      - Test optional project_path inclusion/exclusion
      - Test edge cases (special characters, empty values)
      - Test ISO8601 timestamp format

# Files to Modify
files_to_modify:
  - path: "graphiti_core/session_tracking/__init__.py"
    changes:
      - "Add import for build_episode_metadata_header from .metadata"
      - "Add build_episode_metadata_header to __all__ list"
    lines_affected: 4

# Integration Points
integration:
  - file: "graphiti_core/session_tracking/graphiti_storage.py"
    type: "import"
    description: "Import build_episode_metadata_header (Story 5 will use this)"
    note: "Integration happens in Story 5 - Graphiti Storage Integration"

# Patterns to Follow
patterns:
  - source: "graphiti_core/session_tracking/summarizer.py"
    pattern: "Data class with to_markdown() method - follow similar structure for YAML generation"
  - source: "tests/session_tracking/test_path_resolver.py"
    pattern: "Test class organization with TestClassName pattern, pytest fixtures"

# Function Specification
function_spec:
  name: "build_episode_metadata_header"
  module: "graphiti_core/session_tracking/metadata.py"
  signature: |
    def build_episode_metadata_header(
        project_namespace: str,
        project_path: Optional[str],
        hostname: str,
        session_file: str,
        message_count: int,
        duration_minutes: int,
        include_project_path: bool = True
    ) -> str:
  docstring: |
    Build YAML frontmatter header for episode content.

    Generates metadata header that prepends episode body with project
    namespace tagging for cross-project knowledge sharing.

    Args:
        project_namespace: Hash derived from project path (for filtering)
        project_path: Human-readable project directory path
        hostname: Machine hostname for multi-machine disambiguation
        session_file: Original JSONL filename
        message_count: Number of messages in session
        duration_minutes: Approximate session duration
        include_project_path: Whether to include project_path in output

    Returns:
        YAML frontmatter string to prepend to episode body.
        Format: "---\n{yaml_content}---\n\n"
  output_format: |
    ---
    graphiti_session_metadata:
      version: "2.0"
      project_namespace: "a1b2c3d4e5f6g7h8"
      project_path: "/home/user/my-awesome-project"  # omitted if include_project_path=False
      hostname: "DESKTOP-ABC123"
      indexed_at: "2025-12-08T15:30:00Z"
      session_file: "session-abc123.jsonl"
      message_count: 47
      duration_minutes: 23
    ---

  implementation_notes:
    - "Use yaml.dump() with default_flow_style=False for human-readable output"
    - "Remove None values before serializing"
    - "Use datetime.now(timezone.utc).isoformat() for indexed_at"
    - "Quote version as string '2.0' to avoid YAML float interpretation"

# Test Requirements
test_requirements:
  unit:
    - "test_generates_valid_yaml_frontmatter: Output should be parseable by yaml.safe_load()"
    - "test_includes_version_2_0: version field should be '2.0' string"
    - "test_includes_required_fields: project_namespace, hostname, indexed_at, session_file, message_count, duration_minutes"
    - "test_project_path_included_by_default: When include_project_path=True"
    - "test_project_path_excluded_when_false: When include_project_path=False, no project_path key"
    - "test_project_path_none_excluded: When project_path is None, no project_path key regardless of flag"
    - "test_indexed_at_is_iso8601: timestamp should match ISO8601 format with timezone"
    - "test_special_characters_in_path: Paths with spaces, quotes handled correctly"
    - "test_output_ends_with_double_newline: Format should be '---\\n{yaml}---\\n\\n'"
  integration: []
  security: []

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-4.1"
    priority: "P0"
    text: "Function generates valid YAML frontmatter with version '2.0'"
    implementation: "files_to_create[0]: metadata.py - YAML header with version: '2.0'"
    tests: "test_requirements.unit[0,1]"
  - id: "AC-4.2"
    priority: "P0"
    text: "Includes required fields: project_namespace, hostname, indexed_at, session_file, message_count, duration_minutes"
    implementation: "files_to_create[0]: metadata.py - all fields in graphiti_session_metadata dict"
    tests: "test_requirements.unit[2]"
  - id: "AC-4.3"
    priority: "P1"
    text: "project_path included only when include_project_path=True"
    implementation: "files_to_create[0]: metadata.py - conditional inclusion of project_path"
    tests: "test_requirements.unit[3,4,5]"
  - id: "AC-4.4"
    priority: "P0"
    text: "Output parseable as YAML with standard library"
    implementation: "files_to_create[0]: metadata.py - yaml.dump() generates valid YAML"
    tests: "test_requirements.unit[0]"
  - id: "AC-4.5"
    priority: "P1"
    text: "Unit tests verify header format and field presence"
    implementation: "files_to_create[1]: test_metadata.py - comprehensive test suite"
    tests: "test_requirements.unit[*]"

# Dependencies
dependencies:
  runtime:
    - "pyyaml (already in dependencies)"
    - "datetime (stdlib)"
  upstream_stories: []
  downstream_stories:
    - "Story 5: Graphiti Storage Integration (will call build_episode_metadata_header)"
