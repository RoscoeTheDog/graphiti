# Plan: 9
# Generated by: discovery:9.d
# Timestamp: 2025-12-10T02:30:00Z

story_id: "9"
title: "Integration Tests for Cross-Project Search"
created: "2025-12-10T02:30:00Z"
created_by: "discovery:9.d"

# Analysis Summary
analysis:
  summary: "Story 9 requires integration tests to verify cross-project search behavior and namespace filtering. The codebase already has: (1) MCP server search_memory_nodes with project_namespaces parameter, (2) namespace_filter.py with extract/filter utilities, (3) SessionTrackingConfig with cross_project_search/trusted_namespaces fields. Tests must verify end-to-end behavior mocking Graphiti search results."
  complexity: "medium"
  estimated_files: 1
  estimated_tokens: 2500
  risk_factors:
    - "Need to properly mock Graphiti._search results with realistic node structures"
    - "Must test post-filtering logic in search_memory_nodes"
    - "YAML frontmatter parsing in results needs careful test data setup"

# Files to Create
files_to_create:
  - path: "tests/session_tracking/test_cross_project_search.py"
    purpose: "Integration tests for cross-project search behavior and namespace filtering"
    template: "pytest async test module with fixtures"
    estimated_lines: 400
    contents:
      - "TestCrossProjectSearchEnabled: Search returns results from multiple namespaces"
      - "TestCrossProjectSearchDisabled: Search filters to current project only (with warning)"
      - "TestTrustedNamespacesFilter: Search filters to trusted namespaces only"
      - "TestMetadataHeaderParseable: Episode YAML frontmatter is correctly parsed"
      - "TestNamespaceExtractionFromResults: extract_namespace_from_content works on search results"

# Files to Modify
files_to_modify: []

# Existing Test Coverage (DISCOVERY FINDING)
existing_coverage:
  - path: "tests/mcp_server/test_namespace_filter.py"
    covers:
      - "extract_namespace_from_content() unit tests"
      - "filter_by_namespace() unit tests"
      - "get_effective_group_id() unit tests"
    tests_count: 27
    note: "Unit tests exist but integration tests needed for full search flow"

  - path: "tests/mcp/test_session_tracking_tools.py"
    covers:
      - "session_tracking_status() MCP tool tests"
      - "session_tracking_sync_history() MCP tool tests"
    tests_count: 10
    note: "Does not cover search_memory_nodes namespace filtering"

  - path: "tests/session_tracking/test_graphiti_storage.py"
    covers:
      - "store_session() with namespace parameters"
      - "Metadata header prepending"
      - "Source description with namespace prefix"
    tests_count: 30
    note: "Storage tests exist; retrieval/search tests needed"

# Integration Points
integration:
  - component: "mcp_server.graphiti_mcp_server.search_memory_nodes"
    description: "Main search function with namespace filtering"
    test_focus: "Verify post-filtering based on project_namespaces and config"
    mocking_required:
      - "graphiti_client._search (AsyncMock)"
      - "unified_config.session_tracking (Mock)"

  - component: "mcp_server.namespace_filter"
    description: "Namespace extraction and filtering utilities"
    test_focus: "Verify integration with search results"
    mocking_required: []

# Patterns to Follow
patterns:
  - source: "tests/mcp/test_session_tracking_tools.py"
    pattern: "Mock mcp_server module globals (session_manager, unified_config) with context managers"
  - source: "tests/session_tracking/test_graphiti_storage.py"
    pattern: "Use parse_yaml_frontmatter helper for YAML validation"
  - source: "tests/session_tracking/test_metadata.py"
    pattern: "Use pytest.fixture for reusable test data (sample episodes)"

# Test Requirements (from story file)
test_requirements:
  unit: []
  integration:
    - test_name: "test_cross_project_search_enabled"
      priority: "P0"
      acceptance_criteria: "(P0) Test: cross_project_search=true returns results from multiple projects"
      implementation: |
        - Mock Graphiti._search to return episodes from 3 different namespaces (proj_a, proj_b, proj_c)
        - Set config.cross_project_search=True, trusted_namespaces=None
        - Call search_memory_nodes with query
        - Verify all 3 results returned (no filtering)
        - Verify namespaces can be extracted from returned nodes

    - test_name: "test_cross_project_search_disabled"
      priority: "P0"
      acceptance_criteria: "(P0) Test: cross_project_search=false returns only current project"
      implementation: |
        - Mock Graphiti._search to return episodes from 3 different namespaces
        - Set config.cross_project_search=False
        - Call search_memory_nodes WITHOUT project_namespaces (tests warning case)
        - Verify warning logged about no project_namespaces provided
        - For actual filtering, must provide project_namespaces parameter
        - Call again with project_namespaces=["proj_a"]
        - Verify only proj_a results returned

    - test_name: "test_trusted_namespaces_filter"
      priority: "P1"
      acceptance_criteria: "(P1) Test: trusted_namespaces filters to specified projects"
      implementation: |
        - Mock Graphiti._search to return episodes from 3 namespaces
        - Set config.trusted_namespaces=["proj_a", "proj_b"]
        - Call search_memory_nodes (no project_namespaces override)
        - Verify only proj_a and proj_b results returned
        - Verify proj_c is excluded

    - test_name: "test_metadata_header_parseable"
      priority: "P1"
      acceptance_criteria: "(P1) Test: metadata header present and parseable in indexed episodes"
      implementation: |
        - Mock Graphiti._search to return nodes with realistic YAML frontmatter
        - Verify yaml.safe_load can parse frontmatter from node.summary
        - Verify graphiti_session_metadata contains project_namespace
        - Verify other required fields (version, hostname, indexed_at)

    - test_name: "test_uses_mock_graphiti"
      priority: "P1"
      acceptance_criteria: "(P1) Tests use mock Graphiti instance (no real Neo4j required)"
      implementation: |
        - ALL tests must use AsyncMock for graphiti_client
        - No network calls or database connections
        - Verify by running tests without Neo4j running

  security: []

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-9.1"
    text: "(P0) Test: cross_project_search=true returns results from multiple projects"
    implementation: "tests/session_tracking/test_cross_project_search.py::TestCrossProjectSearchEnabled"
    tests: "2-3 tests covering enabled case with multiple namespaces"
    status: "PLANNED"

  - id: "AC-9.2"
    text: "(P0) Test: cross_project_search=false returns only current project"
    implementation: "tests/session_tracking/test_cross_project_search.py::TestCrossProjectSearchDisabled"
    tests: "2-3 tests covering disabled case and warning"
    status: "PLANNED"

  - id: "AC-9.3"
    text: "(P1) Test: trusted_namespaces filters to specified projects"
    implementation: "tests/session_tracking/test_cross_project_search.py::TestTrustedNamespacesFilter"
    tests: "2-3 tests covering trusted namespace filtering"
    status: "PLANNED"

  - id: "AC-9.4"
    text: "(P1) Test: metadata header present and parseable in indexed episodes"
    implementation: "tests/session_tracking/test_cross_project_search.py::TestMetadataHeaderParseable"
    tests: "2-3 tests covering YAML parsing of results"
    status: "PLANNED"

  - id: "AC-9.5"
    text: "(P1) Tests use mock Graphiti instance (no real Neo4j required)"
    implementation: "All tests use AsyncMock/MagicMock"
    tests: "Verified by fixture design and no external dependencies"
    status: "PLANNED"

# Fixtures Required
fixtures:
  - name: "mock_graphiti_client"
    purpose: "Mock Graphiti client with AsyncMock for _search"
    scope: "function"
    template: |
      @pytest.fixture
      def mock_graphiti_client():
          mock = MagicMock()
          mock._search = AsyncMock()
          return mock

  - name: "sample_episodes_multi_namespace"
    purpose: "Sample search results with different namespaces"
    scope: "function"
    template: |
      @pytest.fixture
      def sample_episodes_multi_namespace():
          def create_episode(namespace, content):
              node = MagicMock()
              node.uuid = f"uuid-{namespace}"
              node.name = f"Session from {namespace}"
              node.summary = f'''---
      graphiti_session_metadata:
        version: "2.0"
        project_namespace: {namespace}
        hostname: TEST-HOST
        indexed_at: "2025-12-10T00:00:00Z"
      ---

      {content}
      '''
              node.labels = ["EpisodicNode"]
              node.group_id = "TEST-HOST__global"
              node.created_at = datetime.now(timezone.utc)
              node.attributes = {"project_namespace": namespace}
              return node

          return [
              create_episode("proj_a", "Auth with JWT"),
              create_episode("proj_b", "Auth with OAuth"),
              create_episode("proj_c", "Auth with SAML"),
          ]

  - name: "mock_session_tracking_config"
    purpose: "Mock SessionTrackingConfig with configurable fields"
    scope: "function"
    template: |
      @pytest.fixture
      def mock_session_tracking_config():
          config = MagicMock()
          config.cross_project_search = True
          config.trusted_namespaces = None
          config.group_id = None
          return config

# Discovery Conclusion
discovery_conclusion:
  result: "NEW_TESTS_REQUIRED"
  summary: "Integration tests are needed to verify cross-project search behavior. Unit tests exist for individual components (namespace_filter.py) but no integration tests verify the full flow through search_memory_nodes with namespace filtering."
  implementation_action: "CREATE_TEST_FILE"
  testing_action: "RUN_NEW_TESTS"
  new_code_required: true
  estimated_effort: "~2,500 tokens for test file creation"
  recommended_commands:
    - "pytest tests/session_tracking/test_cross_project_search.py -v"
    - "pytest tests/session_tracking/test_cross_project_search.py tests/mcp_server/test_namespace_filter.py -v"
