# Plan: Story 2
# Generated by: discovery:2.d
# Timestamp: 2025-12-09T02:05:00Z

story_id: "2"
title: "JSON Schema and Config File Updates"
created: "2025-12-09T02:05:00Z"
created_by: "discovery:2.d"

# Analysis Summary
analysis:
  summary: "Update JSON schema with all new session_tracking fields from Pydantic model, then update config file with sensible defaults"
  complexity: "medium"
  estimated_files: 2
  estimated_tokens: 8000
  risk_factors:
    - "Schema must match Pydantic model descriptions exactly"
    - "Nested config objects (filter, resilience) require $defs references"
    - "trusted_namespaces array requires regex pattern validation in schema"

# Files to Create
files_to_create: []

# Files to Modify
files_to_modify:
  - path: "graphiti.config.schema.json"
    changes:
      - "Add FilterConfig to $defs with properties: tool_calls, tool_content, user_messages, agent_messages"
      - "Add RetryQueueConfig to $defs with properties: max_retries, retry_delays_seconds, max_queue_size, persist_to_disk"
      - "Add SessionNotificationsConfig to $defs with properties: on_permanent_failure, notification_method, webhook_url"
      - "Add SessionTrackingResilienceConfig to $defs with properties: on_llm_unavailable, retry_queue, notifications"
      - "Update SessionTrackingConfig.$defs to add keep_length_days, filter, resilience"
      - "Add group_id (string|null, default null) with description from Pydantic"
      - "Add cross_project_search (boolean, default true) with description from Pydantic"
      - "Add trusted_namespaces (array|null with pattern ^[a-f0-9]+$) with description from Pydantic"
      - "Add include_project_path (boolean, default true) with description from Pydantic"
    lines_affected: 200

  - path: "graphiti.config.json"
    changes:
      - "Add group_id: null to session_tracking"
      - "Add cross_project_search: true to session_tracking"
      - "Add trusted_namespaces: null to session_tracking"
      - "Add include_project_path: true to session_tracking"
    lines_affected: 10

# Integration Points
integration: []

# Patterns to Follow
patterns:
  - source: "graphiti.config.schema.json"
    pattern: "Existing $defs structure for nested configs (e.g., Neo4jConfig, LLMConfig)"
  - source: "mcp_server/unified_config.py"
    pattern: "Field descriptions from Pydantic models must be copied verbatim to JSON schema"

# Test Requirements
test_requirements:
  unit:
    - "Validate updated schema loads without JSON parse errors"
    - "Validate graphiti.config.json validates against updated schema"
    - "Validate trusted_namespaces pattern rejects invalid format (non-hex)"
    - "Validate trusted_namespaces pattern accepts valid hex hashes"
  integration:
    - "Load GraphitiConfig from updated graphiti.config.json"
    - "Verify all new fields have expected default values"
    - "Verify config with trusted_namespaces=['a1b2c3d4'] loads correctly"
    - "Verify config with trusted_namespaces=['invalid!'] raises validation error"
  security: []

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-2.1"
    priority: "P0"
    text: "JSON schema updated with all new session_tracking fields"
    implementation: "files_to_modify[0] - graphiti.config.schema.json"
    tests:
      - "test_requirements.unit[0] - Schema loads without errors"
      - "test_requirements.integration[0-1] - Config loads with correct defaults"

  - id: "AC-2.2"
    priority: "P0"
    text: "Field descriptions match Pydantic model docstrings"
    implementation: "files_to_modify[0] - Copy descriptions from unified_config.py verbatim"
    tests:
      - "Manual verification - compare schema descriptions to Pydantic Field descriptions"

  - id: "AC-2.3"
    priority: "P1"
    text: "Example config file shows sensible defaults"
    implementation: "files_to_modify[1] - graphiti.config.json"
    tests:
      - "test_requirements.integration[1] - All new fields have expected default values"

  - id: "AC-2.4"
    priority: "P1"
    text: "Schema validates correctly against updated config"
    implementation: "Both files - schema must validate config"
    tests:
      - "test_requirements.unit[1] - Config validates against schema"
      - "test_requirements.integration[2-3] - trusted_namespaces validation"

# Implementation Notes
notes:
  - "The current schema was likely auto-generated before Story 1 added new fields"
  - "JSON Schema requires explicit $defs for nested Pydantic models"
  - "trusted_namespaces uses regex pattern ^[a-f0-9]+$ for hex validation"
  - "The 'filter' nested config references FilterConfig from graphiti_core.session_tracking.filter_config"
  - "Consider using JSON Schema draft-07 for better validation support"

# Dependencies
dependencies:
  - story_id: "1"
    status: "completed"
    description: "Configuration Schema Updates - added new fields to SessionTrackingConfig"
