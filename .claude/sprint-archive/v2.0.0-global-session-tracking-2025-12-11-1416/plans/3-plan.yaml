# Plan: 3
# Generated by: discovery:3.d
# Timestamp: 2025-12-08T22:50:00Z

story_id: "3"
title: "Path Resolver Enhancements"
created: "2025-12-08T22:50:00Z"
created_by: "discovery:3.d"

# Analysis Summary
analysis:
  summary: "Add two helper methods to ClaudePathResolver for global group ID generation and project path reverse-lookup. Simple string formatting for global ID; hash scanning for reverse lookup."
  complexity: "low"
  estimated_files: 2
  estimated_tokens: 3500
  risk_factors:
    - "Reverse lookup may be slow for many projects (O(n) where n = project count)"
    - "Edge case: hash collision (extremely rare, negligible risk)"

# Files to Create
files_to_create: []  # No new files needed

# Files to Modify
files_to_modify:
  - path: "graphiti_core/session_tracking/path_resolver.py"
    changes:
      - "Add get_global_group_id(hostname: str) -> str method (~10 lines)"
      - "Add get_project_path_from_hash(project_hash: str) -> Optional[str] method (~30 lines)"
    lines_affected: 40

# Integration Points
integration:
  - file: "graphiti_core/session_tracking/path_resolver.py"
    type: "method_addition"
    description: "Add both new methods to ClaudePathResolver class after existing methods"

# Patterns to Follow
patterns:
  - source: "graphiti_core/session_tracking/path_resolver.py"
    pattern: "Follow existing method structure: docstring with Args/Returns, type hints, logging on error"
  - source: "graphiti_core/session_tracking/path_resolver.py:190-214"
    pattern: "Use list_all_projects() pattern for iterating projects and handling errors"
  - source: "graphiti_core/session_tracking/path_resolver.py:49-75"
    pattern: "Follow get_project_hash() pattern for caching and hash computation"

# Implementation Details
implementation:
  get_global_group_id:
    signature: "def get_global_group_id(self, hostname: str) -> str"
    docstring: "Generate the global group ID for this machine."
    logic: "return f\"{hostname}__global\""
    lines: 10
    complexity: "trivial"

  get_project_path_from_hash:
    signature: "def get_project_path_from_hash(self, project_hash: str) -> Optional[str]"
    docstring: "Reverse-lookup project path from hash by scanning known projects."
    logic: |
      1. Build reverse cache if not exists: {hash -> path}
      2. Iterate list_all_projects() and compute hash for each
      3. Store in reverse cache for future lookups
      4. Return path if found, None otherwise
    lines: 30
    complexity: "low"
    notes:
      - "Use self._reverse_hash_cache: Dict[str, str] for caching"
      - "Initialize cache lazily on first call"
      - "Return native OS path format"

# Test Requirements
test_requirements:
  unit:
    - "test_get_global_group_id: Verify format '{hostname}__global'"
    - "test_get_global_group_id_special_chars: Verify works with special hostname chars"
    - "test_get_project_path_from_hash_found: Verify returns path when hash exists"
    - "test_get_project_path_from_hash_not_found: Verify returns None for unknown hash"
    - "test_get_project_path_from_hash_caching: Verify reverse cache is populated"
    - "test_get_project_path_returns_native_format: Verify Windows backslash / Unix forward slash"
  integration:
    - "test_global_group_id_used_by_session_manager: Integration with Story 6"
  security: []

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-3.1"
    priority: "P0"
    text: "get_global_group_id(hostname: str) -> str method returns {hostname}__global"
    implementation: "path_resolver.py:get_global_group_id"
    tests: "test_get_global_group_id, test_get_global_group_id_special_chars"

  - id: "AC-3.2"
    priority: "P1"
    text: "get_project_path_from_hash(project_hash: str) -> Optional[str] method implemented"
    implementation: "path_resolver.py:get_project_path_from_hash"
    tests: "test_get_project_path_from_hash_found, test_get_project_path_from_hash_not_found, test_get_project_path_from_hash_caching"

  - id: "AC-3.3"
    priority: "P0"
    text: "Methods follow existing code patterns in path_resolver.py"
    implementation: "path_resolver.py (both methods)"
    tests: "Code review - verify docstring format, type hints, error handling"

  - id: "AC-3.4"
    priority: "P1"
    text: "Unit tests cover both methods"
    implementation: "tests/session_tracking/test_path_resolver.py"
    tests: "All unit tests listed above"

# Dependencies
dependencies:
  upstream: []
  downstream:
    - story_id: "6"
      title: "Session Manager Updates"
      uses: "get_global_group_id(), get_project_path_from_hash()"

# Notes
notes:
  - "Both methods are self-contained additions with no breaking changes"
  - "Reverse lookup is O(n) but n is typically small (<10 projects)"
  - "Can optimize later with persistent reverse-hash file if needed"
