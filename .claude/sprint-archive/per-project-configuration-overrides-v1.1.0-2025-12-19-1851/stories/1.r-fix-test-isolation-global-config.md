# Story 1.r: Fix Test Isolation - Global Config Singleton Pollution

**Type**: remediation
**Remediation Type**: bug_fix
**Parent**: Story 1
**Priority**: P1
**Created**: 2025-12-18 19:01

---

## Context

**Original Story**: 1 - Add ProjectOverride Schema and Deep Merge Logic
**Current Status**: completed
**Issue**: Validation testing failed with 59.26% pass rate (below 90% threshold)

**Root Cause Analysis**:
The test `test_config_loads_from_file` in `tests/test_unified_config.py` fails when run after `test_get_config_reload_with_project_path` in `tests/test_project_overrides.py` due to global singleton state pollution.

**Flow**:
1. `test_get_config_reload_with_project_path` calls `set_config(config)` with `default_model="gpt-4.1-mini"` (line 657)
2. This sets the global `_config_instance` singleton in `mcp_server/unified_config.py`
3. The test does NOT reset the singleton after completion
4. `test_config_loads_from_file` calls `get_config()` WITHOUT `reload=True`
5. `get_config()` returns the cached singleton from the previous test
6. Test expects `gpt-4o-mini` (from fixture) but gets `gpt-4.1-mini` (from polluted singleton)

**Evidence**:
- Test passes when run individually: `pytest tests/test_unified_config.py::test_config_loads_from_file -v` → PASS
- Test fails when run together: `pytest tests/test_project_overrides.py tests/test_unified_config.py -v` → FAIL

---

## Remediation Goal

Fix test isolation by ensuring `test_config_loads_from_file` properly reloads config from file instead of using cached singleton.

---

## Remediation Actions

### 1. Add reload=True to test_config_loads_from_file

**File**: `tests/test_unified_config.py`
**Line**: 113
**Change**: Add `reload=True` parameter to `get_config()` call

```python
# Before (line 113):
config = get_config()

# After:
config = get_config(reload=True)
```

**Rationale**:
- The test's purpose is to verify config loads FROM FILE correctly
- Using `reload=True` ensures fresh load from file regardless of previous test state
- This is the most targeted fix - doesn't require changes to fixtures or global setup

### 2. (Alternative - More Robust) Add reset_config fixture

If broader test isolation is needed in the future, add a fixture to `tests/conftest.py`:

**File**: `tests/conftest.py`
**Change**: Add fixture to reset global config singleton

```python
@pytest.fixture(autouse=True)
def reset_global_config():
    """Reset global config singleton before and after each test."""
    import mcp_server.unified_config as uc
    uc._config_instance = None
    yield
    uc._config_instance = None
```

**Note**: This alternative is more comprehensive but may impact test performance.
The primary fix (Option 1) is recommended for now.

---

## Testing

**Verification Command**:
```bash
# Run both test files together to verify no state pollution
pytest tests/test_project_overrides.py tests/test_unified_config.py -v --tb=short

# Expected: All tests pass (77/77)
```

**New/Updated Tests**: None required - existing test will pass after fix

---

## Acceptance Criteria

- [ ] **(P1) AC-1.r.1**: `test_config_loads_from_file` passes when run after `test_project_overrides.py` tests
- [ ] **(P1) AC-1.r.2**: All 77 tests pass when running `pytest tests/test_project_overrides.py tests/test_unified_config.py -v`
- [ ] **(P1) AC-1.r.3**: Test pass rate for Story 1 validation >= 90%

---

## Verification

1. Run combined test suite: `pytest tests/test_project_overrides.py tests/test_unified_config.py -v`
2. Verify 77/77 tests pass
3. Re-run validation: `/sprint:VALIDATE --stories 1`
4. Confirm pass rate >= 90%

---

## Notes

- **Remediation Type**: bug_fix (test isolation failure)
- **Auto-Created**: 2025-12-18 19:01
- **Created From**: Sprint validation failure analysis
- **Original Request**: "Story -1.t CRITICAL: Test pass rate 59.26% (below 90% threshold)"
- **Handoff Reference**: s022-sprint-orchestrate-v110-per-project.md

---

**Created**: 2025-12-18T19:01:00Z
