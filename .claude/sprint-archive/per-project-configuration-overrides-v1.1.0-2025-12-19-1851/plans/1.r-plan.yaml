# Plan: 1.r
# Generated by: discovery:1.r.d
# Timestamp: 2025-12-18T19:30:00Z

story_id: "1.r"
title: "Fix Test Isolation - Global Config Singleton Pollution"
created: "2025-12-18T19:30:00Z"
created_by: "discovery:1.r.d"

# Analysis Summary
analysis:
  summary: "Fix test isolation by adding reload=True to test_config_loads_from_file to ensure fresh config load from file regardless of previous test state"
  complexity: "low"
  estimated_files: 1
  estimated_tokens: 500
  risk_factors:
    - "Minimal risk - targeted one-line fix to test file only"
    - "No production code changes required"
    - "Alternative fixture-based approach available if needed"

# Files to Create
files_to_create: []

# Files to Modify
files_to_modify:
  - path: "tests/test_unified_config.py"
    changes:
      - "Line 113: Change get_config() to get_config(reload=True)"
    lines_affected: 1

# Integration Points
integration: []

# Patterns to Follow
patterns:
  - source: "mcp_server/unified_config.py"
    pattern: "get_config(reload=True) pattern for forcing fresh config load from file"
  - source: "tests/test_unified_config.py"
    pattern: "Existing test patterns using reload parameter"
  - source: "tests/test_project_overrides.py"
    pattern: "Test patterns that modify global config singleton via set_config()"

# Test Requirements
test_requirements:
  unit:
    - "test_config_loads_from_file passes when run individually"
    - "test_config_loads_from_file passes after test_project_overrides.py tests"
  integration:
    - "All 77 tests pass when running pytest tests/test_project_overrides.py tests/test_unified_config.py -v"
    - "No test order dependencies detected"
  security: []

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-1.r.1"
    text: "test_config_loads_from_file passes when run after test_project_overrides.py tests"
    implementation: "files_to_modify[0] - Add reload=True parameter"
    tests: "test_requirements.integration[1] - Combined test suite verification"
  - id: "AC-1.r.2"
    text: "All 77 tests pass when running pytest tests/test_project_overrides.py tests/test_unified_config.py -v"
    implementation: "files_to_modify[0] - Add reload=True parameter"
    tests: "test_requirements.integration[1] - Combined test suite verification"
  - id: "AC-1.r.3"
    text: "Test pass rate for Story 1 validation >= 90%"
    implementation: "files_to_modify[0] - Add reload=True parameter"
    tests: "test_requirements.integration[1] - Re-run /sprint:VALIDATE --stories 1"

# Implementation Details
implementation_notes: |
  ROOT CAUSE:
  - test_get_config_reload_with_project_path calls set_config() which sets global _config_instance
  - test_config_loads_from_file calls get_config() WITHOUT reload=True
  - get_config() returns cached singleton from previous test instead of loading from file
  - Test expects gpt-4o-mini (from fixture) but gets gpt-4.1-mini (from polluted singleton)

  FIX:
  - Add reload=True parameter to get_config() call in test_config_loads_from_file (line 113)
  - This ensures fresh load from file regardless of previous test state
  - Aligns with test's purpose: verify config loads FROM FILE correctly

  ALTERNATIVE (if needed):
  - Add reset_config fixture to tests/conftest.py
  - Use @pytest.fixture(autouse=True) to reset _config_instance before/after each test
  - More comprehensive but may impact test performance
  - Recommended only if broader test isolation issues are discovered

# Dependencies
dependencies:
  - "mcp_server/unified_config.py - get_config() function with reload parameter"
  - "tests/test_unified_config.py - test_config_loads_from_file function"
  - "pytest test framework"

# Verification Steps
verification:
  - "Run individual test: pytest tests/test_unified_config.py::test_config_loads_from_file -v"
  - "Run combined suite: pytest tests/test_project_overrides.py tests/test_unified_config.py -v"
  - "Verify 77/77 tests pass"
  - "Re-run validation: /sprint:VALIDATE --stories 1"
  - "Confirm pass rate >= 90%"
