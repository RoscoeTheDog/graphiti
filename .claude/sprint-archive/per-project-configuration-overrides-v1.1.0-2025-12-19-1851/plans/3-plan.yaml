# Plan: 3
# Generated by: discovery:3.d
# Timestamp: 2025-12-18T18:15:00Z

story_id: "3"
title: "Implement CLI Command - config effective"
created: "2025-12-18T18:15:00Z"
created_by: "discovery:3.d"

# Analysis Summary
analysis:
  summary: "Create new CLI command 'graphiti-mcp config effective' that displays merged configuration for a project directory. Add subcommand to main graphiti-mcp CLI with support for --project, --diff, --json flags. Use get_effective_config() from Story 2 to compute merged config. Implement multiple output formats: human-readable with highlighting, diff mode showing overridden values, and machine-readable JSON."
  complexity: "medium"
  estimated_files: 3
  estimated_tokens: 6000
  risk_factors:
    - "Need to create new CLI command structure (may need to refactor entry point)"
    - "Output formatting must handle nested config objects (llm, embedder, etc.)"
    - "Diff mode requires comparing global vs effective config to identify overrides"
    - "Color output must handle non-TTY environments gracefully"
    - "Must handle case where current directory is not a project"

# Dependencies
dependencies:
  - story_id: "2"
    status: "completed"
    provided: ["get_effective_config() method", "normalize_project_path()", "GraphitiConfig.model_dump()"]

# Files to Create/Modify
files_to_modify:
  - path: "mcp_server/config_cli.py"
    status: "new"
    changes:
      - "Create new CLI module for config commands"
      - "Add cmd_effective() function for effective config command"
      - "Add _format_config_human() helper for readable output"
      - "Add _format_config_diff() helper for diff output"
      - "Add _format_config_json() helper for JSON output"
      - "Add _highlight_overridden() helper to mark overridden values"
      - "Add main() function as CLI entry point"
    lines_affected: 250

  - path: "mcp_server/pyproject.toml"
    status: "existing"
    changes:
      - "Add new script entry: graphiti-mcp-config = \"mcp_server.config_cli:main\""
    lines_affected: 1

  - path: "tests/test_config_cli.py"
    status: "new"
    changes:
      - "Add TestConfigEffective test class"
      - "Add test_effective_no_project_flag_uses_cwd()"
      - "Add test_effective_with_project_flag()"
      - "Add test_effective_no_override_shows_global()"
      - "Add test_effective_with_override_shows_merged()"
      - "Add test_effective_diff_shows_overrides_only()"
      - "Add test_effective_json_outputs_valid_json()"
      - "Add test_effective_colored_output_in_tty()"
      - "Add test_effective_no_color_in_non_tty()"
      - "Add test_effective_handles_missing_config_file()"
    lines_affected: 300

# Key Implementation Details
implementation:
  cli_structure:
    entry_point: "graphiti-mcp-config"
    command: "config effective"
    description: "Show effective configuration for a project"
    flags:
      - name: "--project"
        type: "str"
        default: "cwd"
        description: "Project path (default: current directory)"
      - name: "--diff"
        type: "bool"
        default: false
        description: "Show only overridden values"
      - name: "--json"
        type: "bool"
        default: false
        description: "Output as JSON"

  cmd_effective:
    signature: "def cmd_effective(args: argparse.Namespace) -> None"
    algorithm:
      - "Get project_path from args.project or os.getcwd()"
      - "Load global config using GraphitiConfig.from_file()"
      - "Get effective config using config.get_effective_config(project_path)"
      - "Check if args.json: format as JSON and print"
      - "Check if args.diff: format as diff (global vs effective) and print"
      - "Otherwise: format as human-readable and print"
    error_handling:
      - "If config file not found: print error and exit(1)"
      - "If project_path invalid: print error and exit(1)"
      - "Catch JSON errors and config validation errors"

  format_config_human:
    signature: "def _format_config_human(config: GraphitiConfig, global_config: GraphitiConfig, project_path: str) -> str"
    purpose: "Format config as human-readable output with highlighting"
    approach:
      - "Print header with project path"
      - "Print each section (database, llm, embedder, etc.)"
      - "For each value, compare with global_config"
      - "If value differs: highlight with color/marker (e.g., [OVERRIDE])"
      - "If value matches: show normally"
      - "Mask sensitive values (API keys, passwords)"
    example_output: |
      Effective Configuration for Project: /c/Users/Admin/myproject
      ============================================================

      Database:
        backend: neo4j
        uri: neo4j+s://example.databases.neo4j.io

      LLM:
        provider: anthropic [OVERRIDE]
        default_model: claude-3-5-sonnet-20241022 [OVERRIDE]
        small_model: claude-3-5-haiku-20241022
        temperature: 0.7

      Embedder:
        provider: openai
        model: text-embedding-3-small

  format_config_diff:
    signature: "def _format_config_diff(effective: GraphitiConfig, global_config: GraphitiConfig) -> str"
    purpose: "Show only overridden values with before/after"
    approach:
      - "Compare effective vs global config recursively"
      - "For each differing value: print before → after"
      - "Skip sections with no overrides"
    example_output: |
      Configuration Overrides for Project: /c/Users/Admin/myproject
      ==============================================================

      LLM:
        provider: openai → anthropic
        default_model: gpt-4o → claude-3-5-sonnet-20241022

      Session Tracking:
        enabled: true → false

  format_config_json:
    signature: "def _format_config_json(config: GraphitiConfig) -> str"
    purpose: "Output config as JSON for machine consumption"
    approach:
      - "Call config.model_dump() to get dict"
      - "Use json.dumps() with indent=2"
      - "Return JSON string"

  color_support:
    approach: "Use sys.stdout.isatty() to detect TTY"
    implementation:
      - "If TTY: use ANSI color codes (green for override, yellow for sensitive)"
      - "If not TTY: use plain text markers [OVERRIDE]"
    libraries: "No external dependencies (use built-in ANSI codes)"

# Integration Points
integration:
  - file: "mcp_server/unified_config.py"
    type: "import"
    description: "Import GraphitiConfig, get_config(), normalize_project_path()"

  - file: "mcp_server/unified_config.py"
    type: "method"
    description: "Call get_effective_config(project_path) to get merged config"

  - file: "mcp_server/session_tracking_cli.py"
    type: "reference"
    description: "Use as reference for CLI patterns (find_config_file, load_config, argparse structure)"

# Patterns to Follow
patterns:
  - source: "mcp_server/session_tracking_cli.py"
    pattern: "Use argparse with subparsers for commands, set_defaults(func=cmd_func)"

  - source: "mcp_server/session_tracking_cli.py"
    pattern: "Print status with symbols [OK], [ERROR], [WARNING]"

  - source: "mcp_server/session_tracking_cli.py"
    pattern: "Handle missing config with helpful error message"

  - source: "mcp_server/unified_config.py"
    pattern: "Use normalize_project_path() for consistent path handling"

# Test Requirements
test_requirements:
  unit:
    - "test_effective_no_project_flag_uses_cwd: No --project flag → uses os.getcwd()"
    - "test_effective_with_project_flag: --project /path → uses /path"
    - "test_effective_no_override_shows_global: Project not in overrides → effective == global"
    - "test_effective_with_override_shows_merged: Project in overrides → effective has merged values"
    - "test_effective_highlights_overridden: Output marks overridden values with [OVERRIDE]"
    - "test_effective_masks_sensitive: API keys and passwords shown as ***REDACTED***"
    - "test_effective_diff_shows_overrides_only: --diff flag → only shows changed values"
    - "test_effective_diff_format: --diff output shows before → after format"
    - "test_effective_json_outputs_valid_json: --json flag → valid JSON output"
    - "test_effective_json_parseable: --json output can be parsed with json.loads()"
    - "test_effective_colored_output_in_tty: sys.stdout.isatty() == True → ANSI codes used"
    - "test_effective_no_color_in_non_tty: sys.stdout.isatty() == False → plain text markers"

  integration:
    - "test_effective_end_to_end_no_override: Run command in directory without override → shows global config"
    - "test_effective_end_to_end_with_override: Run command in project with override → shows merged config"
    - "test_effective_end_to_end_diff: Run with --diff → shows only overrides"
    - "test_effective_end_to_end_json: Run with --json → outputs parseable JSON"

  edge_cases:
    - "test_effective_handles_missing_config_file: No config file → error message and exit(1)"
    - "test_effective_handles_invalid_project_path: Invalid path → error message and exit(1)"
    - "test_effective_handles_empty_override: Override exists but all None → shows global config"
    - "test_effective_handles_relative_path: --project ./myproject → normalizes correctly"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-1 (P0)"
    text: "graphiti-mcp config effective shows merged config for current directory"
    implementation: "files_to_modify[0] - Create config_cli.py with cmd_effective(), default to cwd"
    tests: "test_requirements.unit[0], test_requirements.integration[0-1]"

  - id: "AC-2 (P0)"
    text: "--project PATH option specifies target project"
    implementation: "implementation.cmd_effective - Add --project flag to argparse, pass to get_effective_config()"
    tests: "test_requirements.unit[1], test_requirements.integration[1]"

  - id: "AC-3 (P1)"
    text: "--diff flag shows only overridden values with before/after"
    implementation: "implementation.format_config_diff - Compare effective vs global, show diffs"
    tests: "test_requirements.unit[6-7], test_requirements.integration[2]"

  - id: "AC-4 (P1)"
    text: "--json flag outputs machine-readable JSON"
    implementation: "implementation.format_config_json - Use model_dump() and json.dumps()"
    tests: "test_requirements.unit[8-9], test_requirements.integration[3]"

  - id: "AC-5 (P1)"
    text: "Output highlights which values are overridden vs inherited"
    implementation: "implementation.format_config_human - Compare with global config, mark overrides"
    tests: "test_requirements.unit[4]"

  - id: "AC-6 (P2)"
    text: "Colored terminal output for better readability"
    implementation: "implementation.color_support - Use ANSI codes if TTY, plain text otherwise"
    tests: "test_requirements.unit[10-11]"

# Implementation Notes
implementation_notes:
  - "Use argparse for CLI parsing (consistent with session_tracking_cli.py)"
  - "Entry point should be graphiti-mcp-config in pyproject.toml"
  - "Alternative: Add 'config' subcommand to existing graphiti-mcp CLI (requires refactoring)"
  - "Recommendation: Create separate config_cli.py with own entry point (cleaner, less risk)"
  - "Use sys.stdout.isatty() to detect TTY for color support"
  - "ANSI color codes: \\033[92m (green), \\033[93m (yellow), \\033[0m (reset)"
  - "Mask sensitive values: Replace with '***REDACTED***' (pattern: api_key, password, secret, token)"
  - "Compare effective vs global by converting both to dict and recursively comparing"
  - "Handle nested config objects (llm.provider, database.neo4j.uri, etc.)"
  - "Default to current directory if --project not specified"
  - "Normalize project path using normalize_project_path() before calling get_effective_config()"
  - "Print helpful error if config file not found (similar to session_tracking_cli.py)"
  - "Consider adding --no-color flag to force plain text output (P2)"

# Alternative Approaches Considered
alternatives:
  - approach: "Add 'config' subcommand to existing graphiti-mcp CLI"
    pros:
      - "Single entry point for all commands"
      - "Consistent with typical CLI patterns (git config, docker config)"
    cons:
      - "Requires refactoring graphiti_mcp_server.py (higher risk)"
      - "May conflict with existing CLI structure"
      - "More complex implementation"
    decision: "Rejected - separate entry point is cleaner and lower risk"

  - approach: "Use external library for colored output (e.g., colorama, rich)"
    pros:
      - "Better color support across platforms"
      - "Rich output formatting options"
    cons:
      - "Additional dependency"
      - "Overkill for simple color highlighting"
    decision: "Rejected - use built-in ANSI codes for simplicity"

# Edge Cases to Handle
edge_cases:
  - case: "Config file not found"
    handling: "Print error message: 'No config file found. Run graphiti-mcp-session-tracking enable to create one.'"

  - case: "Project path not in project_overrides"
    handling: "get_effective_config() returns global config → display global config (expected behavior)"

  - case: "Override exists but all fields None"
    handling: "Effective config == global config → display global config with no [OVERRIDE] markers"

  - case: "Current directory is not a project"
    handling: "Still use current directory path for lookup → if no override, show global config"

  - case: "Relative path in --project"
    handling: "Convert to absolute using Path.resolve() before normalizing"

  - case: "Non-TTY output (pipe to file)"
    handling: "sys.stdout.isatty() == False → use plain text markers instead of ANSI codes"

  - case: "Nested override (llm.provider changed but llm.temperature inherited)"
    handling: "Mark only llm.provider as [OVERRIDE], show llm.temperature without marker"

  - case: "Sensitive value in override"
    handling: "Mask with ***REDACTED*** in all output formats (human, diff, json should have option)"

# Success Criteria
success_criteria:
  - "All P0 acceptance criteria tests pass"
  - "All P1 acceptance criteria tests pass"
  - "Command works with no flags (uses cwd, shows human-readable output)"
  - "Command works with --project flag"
  - "Command works with --diff flag"
  - "Command works with --json flag"
  - "Output correctly highlights overridden values"
  - "Color output works in TTY, plain text in non-TTY"
  - "Handles missing config file gracefully"
  - "Code passes type checking (mypy)"
  - "Code passes linting (ruff)"
  - "Test coverage >80% for new code"
  - "Documentation added to CLI docstrings"

# CLI Design Examples
cli_examples:
  basic_usage:
    command: "graphiti-mcp config effective"
    description: "Show effective config for current directory"
    expected_behavior: "Uses os.getcwd() as project_path, displays merged config"

  with_project_flag:
    command: "graphiti-mcp config effective --project /home/user/myproject"
    description: "Show effective config for specific project"
    expected_behavior: "Uses /home/user/myproject as project_path"

  diff_mode:
    command: "graphiti-mcp config effective --diff"
    description: "Show only overridden values"
    expected_behavior: "Compares effective vs global, shows differences only"

  json_output:
    command: "graphiti-mcp config effective --json"
    description: "Output as JSON"
    expected_behavior: "Prints effective config as JSON (for scripts/tools)"

  combined_flags:
    command: "graphiti-mcp config effective --project /path --diff --json"
    description: "Diff mode with JSON output for specific project"
    expected_behavior: "Shows overrides as JSON for specified project"

# Future Enhancements (Not in Scope)
future_enhancements:
  - "Add --validate flag to check config for errors"
  - "Add --set flag to modify config values"
  - "Add 'config list' subcommand to show all project overrides"
  - "Add 'config remove' subcommand to delete project overrides"
  - "Add --format flag to support YAML output"
  - "Add --no-color flag to force plain text output"
  - "Add config file path to output header"
  - "Add timestamp of last config modification"
