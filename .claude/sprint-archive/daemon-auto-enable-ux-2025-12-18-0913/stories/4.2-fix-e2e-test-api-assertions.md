---
description: Fix E2E Test API Assertions
---

# Story 4.2: Fix E2E Test API Assertions

**Type**: Remediation
**Status**: unassigned
**Parent**: 4
**Created**: 2025-12-17T18:16:05
**Issue Type**: Test-API-Mismatch

---

## Remediation Purpose

This remediation story addresses test failures in story 4.1.t where E2E tests assumed incorrect API contracts.

**Issue Category**: test_failure
**Detected By**: Story 4.1.t testing phase
**Affects Stories**: 4.1.t, 4.t

---

## Issue Description

E2E tests fail (42.9% pass rate) due to API contract mismatches:

1. **install() return type mismatch**: Tests expect `dict` with `'success'` key, but `DaemonManager.install()` returns `bool`
2. **Package installation path issues**: VenvManager cannot locate `mcp_server` package during test execution

### Failed Tests (4 of 7)
- `test_fresh_install_flow` - TypeError: 'bool' object is not subscriptable (line 159)
- `test_reinstall_idempotent` - TypeError: 'bool' object is not subscriptable (line 284)
- `test_health_check_timing` - Cannot find mcp_server package
- `test_daemon_status_command` - ModuleNotFoundError: No module named 'mcp_server'

---

## Remediation Steps

1. [ ] Fix `test_fresh_install_flow` - Change `assert install_result['success']` to `assert install_result` (bool assertion)
2. [ ] Fix `test_reinstall_idempotent` - Change `assert first_install['success']` to `assert first_install` (bool assertion)
3. [ ] Fix `test_health_check_timing` - Add proper mcp_server package path to test fixture setup
4. [ ] Fix `test_daemon_status_command` - Ensure mcp_server module is importable in test venv
5. [ ] Update any other assertions expecting dict from install() to handle bool

---

## Acceptance Criteria

- [ ] AC-4.2.1: All E2E tests pass (7/7) or skip gracefully
- [ ] AC-4.2.2: Test pass rate >= 90%
- [ ] AC-4.2.3: No TypeError for install() return type
- [ ] AC-4.2.4: mcp_server package importable in test environment
- [ ] AC-4.2.5: Story 4.1.t and 4.t unblocked

---

## Implementation Notes

### Root Cause

The E2E tests were written assuming `DaemonManager.install()` would return a dict structure:
```python
{'success': bool, 'error': Optional[str]}
```

However, the actual implementation returns a simple `bool`:
```python
def install(self) -> bool:
```

Additionally, the package installation tests assume mcp_server is installed as a package, but the test venv doesn't have it available.

### Fix Strategy

**For API mismatch:**
- Update tests to assert directly on bool return value
- Pattern: `assert install_result` instead of `assert install_result['success']`
- For error messages, use try/except with the actual exception

**For package installation:**
- Add pip install of current directory (mcp_server) to test fixture
- Or mock the package import for tests that don't need it

### Verification

1. Run: `pytest mcp_server/tests/test_daemon_e2e_validation.py -v`
2. Verify: >= 90% pass rate (at least 6/7 tests passing)
3. Check: No TypeError or ModuleNotFoundError exceptions

---

## Metadata

**Blocks Stories**: 4.1.t, 4.t
**Priority**: P0
**Estimated Tokens**: 800
