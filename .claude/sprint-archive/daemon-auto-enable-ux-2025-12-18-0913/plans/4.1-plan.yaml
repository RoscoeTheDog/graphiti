# Plan: 4.1
# Generated by: discovery:4.1.d
# Timestamp: 2025-12-17T02:15:00Z

story_id: "4.1"
title: "Fix E2E Test Fixtures VenvCreationError"
created: "2025-12-17T02:15:00Z"
created_by: "discovery:4.1.d"

# Analysis Summary
analysis:
  summary: "Add session-scoped venv setup fixture and fix API method name mismatches to eliminate VenvCreationError in E2E test fixtures"
  complexity: "low"
  estimated_files: 1
  estimated_tokens: 4000
  risk_factors:
    - "Test fixture dependency order must be correct"
    - "Venv creation may fail on some platforms - needs graceful skip"
    - "Cleanup logic must be best-effort to avoid test failures"

# Files to Create
files_to_create: []

# Files to Modify
files_to_modify:
  - path: "mcp_server/tests/test_daemon_e2e_validation.py"
    changes:
      - "Add session-scoped ensure_venv_exists fixture after line 22 (after pytestmark)"
      - "Update daemon_manager fixture (lines 38-57) to depend on ensure_venv_exists"
      - "Update clean_daemon_state fixture (lines 60-79) to depend on ensure_venv_exists"
      - "Replace all get_status() calls with status() throughout file"
      - "Add proper error handling for status() calls in fixtures"
    lines_affected: 70

# Integration Points
integration:
  - file: "mcp_server/daemon/venv_manager.py"
    type: "import"
    description: "Import VenvManager for session-scoped venv creation"
  - file: "mcp_server/daemon/manager.py"
    type: "import"
    description: "Import DaemonManager for daemon operations (already imported)"

# Patterns to Follow
patterns:
  - source: "mcp_server/tests/test_daemon_e2e_validation.py"
    pattern: "Existing pytest fixtures using try-except for graceful error handling"
  - source: "mcp_server/daemon/venv_manager.py"
    pattern: "VenvManager.detect_venv() and create_venv() methods for venv lifecycle"
  - source: "pytest documentation"
    pattern: "Session-scoped fixtures for shared test resources"

# Test Requirements
test_requirements:
  unit:
    - "Verify ensure_venv_exists fixture creates venv if missing"
    - "Verify ensure_venv_exists fixture detects existing venv and skips creation"
    - "Verify daemon_manager fixture initializes without VenvCreationError"
    - "Verify clean_daemon_state fixture handles missing daemon gracefully"
  integration:
    - "All 7 E2E tests pass (or skip gracefully with appropriate platform markers)"
    - "Test pass rate reaches ≥90%"
    - "No VenvCreationError in test output"
    - "Session-scoped venv is created only once per test session"
  security: []

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-4.1.1"
    text: "ensure_venv_exists fixture creates venv if missing before tests run"
    implementation: "files_to_modify[0] - Add session-scoped fixture"
    tests: "test_requirements.unit[0,1] + test_requirements.integration[3]"

  - id: "AC-4.1.2"
    text: "daemon_manager fixture initializes without VenvCreationError"
    implementation: "files_to_modify[0] - Update daemon_manager fixture"
    tests: "test_requirements.unit[2] + test_requirements.integration[2]"

  - id: "AC-4.1.3"
    text: "All 6 previously failing E2E tests now pass (or skip gracefully)"
    implementation: "files_to_modify[0] - All fixture updates"
    tests: "test_requirements.integration[0,1]"

  - id: "AC-4.1.4"
    text: "API method names corrected (get_status → status)"
    implementation: "files_to_modify[0] - Replace all get_status() calls"
    tests: "test_requirements.integration[0] - Tests use correct API"

  - id: "AC-4.1.5"
    text: "Test pass rate for Story 4.t reaches ≥90%"
    implementation: "files_to_modify[0] - All changes combined"
    tests: "test_requirements.integration[1]"

# Implementation Details
implementation_details:
  ensure_venv_exists_fixture:
    location: "After line 22 (after pytestmark declaration)"
    scope: "session"
    behavior: |
      1. Create VenvManager instance
      2. Check if venv exists using detect_venv()
      3. If missing, create venv using create_venv()
      4. If creation fails, skip tests with pytest.skip()
      5. Yield venv_manager instance
      6. No cleanup (venv persists across tests)
    error_handling: "Graceful skip if venv creation fails"

  daemon_manager_fixture_updates:
    location: "Lines 38-57"
    changes:
      - "Add ensure_venv_exists parameter"
      - "Wrap status() call in try-except (may fail if daemon not installed)"
      - "Change get_status() to status()"
      - "Best-effort cleanup in finally block"

  clean_daemon_state_fixture_updates:
    location: "Lines 60-79"
    changes:
      - "Add ensure_venv_exists parameter"
      - "Wrap status() calls in try-except"
      - "Change get_status() to status()"

  api_method_fixes:
    locations:
      - "Line 47: initial_status = manager.get_status()"
      - "Line 54: current_status = manager.get_status()"
      - "Line 116: status_before = daemon_manager.get_status()"
      - "Line 259: status = daemon_manager.get_status()"
      - "Line 383: api_status = daemon_manager.get_status()"
    replacement: "status()"

# Verification Steps
verification:
  - step: "Run pytest on test_daemon_e2e_validation.py"
    command: "cd mcp_server/tests && pytest test_daemon_e2e_validation.py -v --tb=short"
    expected: "No VenvCreationError in output, 7/7 tests pass or skip"

  - step: "Check test pass rate"
    command: "pytest test_daemon_e2e_validation.py --tb=line -q"
    expected: "Pass rate ≥90%"

  - step: "Verify session-scoped behavior"
    command: "pytest test_daemon_e2e_validation.py -v -s"
    expected: "Venv created only once (see session setup logs)"

# Dependencies
dependencies:
  required_before_implementation:
    - "VenvManager class exists and has detect_venv(), create_venv() methods"
    - "DaemonManager class exists and has status() method (not get_status)"
    - "pytest framework installed"

  blocks_stories:
    - "4.1.t (Testing phase cannot run until implementation complete)"
    - "4.t (E2E validation tests blocked by fixture errors)"

# Risk Mitigation
risks:
  - risk: "Venv creation may fail on CI/CD environments with restricted permissions"
    mitigation: "Use pytest.skip() to gracefully skip tests instead of failing"

  - risk: "Fixture dependency order may cause issues if not defined correctly"
    mitigation: "Use explicit ensure_venv_exists parameter in dependent fixtures"

  - risk: "Status() calls may fail if daemon was never installed"
    mitigation: "Wrap all status() calls in try-except with pass for best-effort handling"

# Notes
notes:
  - "The root cause is DaemonManager.__init__() creates VenvManager instance, but venv doesn't exist until tests create it"
  - "Session-scoped fixture solves chicken-and-egg problem by creating venv once before any daemon operations"
  - "API method name mismatch (get_status vs status) is a separate but related issue that also breaks tests"
  - "All changes are isolated to test file - no production code changes needed"
