# Story 1.i.1: Fix Implementation Location for Metadata Schema Extension

**Type**: remediation
**Remediation Type**: validation_failure
**Parent**: Story 1.i
**Priority**: P0
**Created**: 2025-12-20T01:50:00Z

---

## Context

**Original Story**: 1.i - Implementation: Metadata Schema Extension
**Current Status**: completed (but implementation in wrong location)
**Validation Failure**: Story -1.i detected implementation files were created in global commands directory instead of project repository

**Issue**: Implementation files were created in `~/.claude/resources/commands/sprint/queue_helpers/` instead of the project repository at `resources/commands/sprint/queue_helpers/`. This means:
- Implementation is not tracked in git
- Implementation is not deployed when project is cloned
- Implementation is not available to CI/CD pipelines
- Schema validation logic is completely missing from project's core.py and __init__.py

**Codebase Analysis**:
- Current implementation location: `~/.claude/resources/commands/sprint/queue_helpers/test_reconciliation.py` (291 lines)
- Target location: `resources/commands/sprint/queue_helpers/test_reconciliation.py`
- Integration points: `resources/commands/sprint/queue_helpers/core.py` (set_metadata function, lines 76-115)
- Export point: `resources/commands/sprint/queue_helpers/__init__.py`

---

## Remediation Goal

Copy implementation files from global commands directory to project repository and integrate schema validation into the project's core.py and __init__.py, making the implementation available to all users and CI/CD pipelines.

---

## Remediation Actions

### 1. Copy test_reconciliation.py to Project Repository

**File**: `resources/commands/sprint/queue_helpers/test_reconciliation.py`
**Action**: Copy from global directory

```bash
# Copy implementation file from global to project
cp ~/.claude/resources/commands/sprint/queue_helpers/test_reconciliation.py \
   resources/commands/sprint/queue_helpers/test_reconciliation.py

# Verify file was copied
test -f resources/commands/sprint/queue_helpers/test_reconciliation.py && echo "File copied successfully"

# Verify file is tracked in git (should show as untracked)
git status resources/commands/sprint/queue_helpers/test_reconciliation.py
```

**Rationale**: The implementation exists and is working, it just needs to be relocated to the correct directory where it can be version-controlled and deployed with the project.

---

### 2. Integrate Schema Validation into core.py

**File**: `resources/commands/sprint/queue_helpers/core.py`
**Change**: Add schema validation in set_metadata() function

The current set_metadata() function (lines 76-115) accepts any metadata key/value without validation. We need to add validation for test_reconciliation and reconciliation schemas.

**Location**: After line 91 (after the story existence check), add validation logic:

```python
def set_metadata(
    queue: dict[str, Any],
    story_id: str,
    key: str,
    value: Any
) -> dict[str, Any]:
    """Set metadata value for a story with schema validation."""
    # ... existing validation code ...

    # Find the story in the queue
    if story_id not in queue['stories']:
        raise ValueError(f"Story {story_id} not found in queue")

    # Schema validation for specific metadata keys
    if key == "test_reconciliation":
        from .test_reconciliation import validate_test_reconciliation
        is_valid, error = validate_test_reconciliation(value)
        if not is_valid:
            raise ValueError(f"Invalid test_reconciliation schema: {error}")

    if key == "reconciliation":
        from .test_reconciliation import validate_reconciliation
        is_valid, error = validate_reconciliation(value)
        if not is_valid:
            raise ValueError(f"Invalid reconciliation schema: {error}")

    # Make a copy of the queue to avoid mutation
    new_queue = queue.copy()
    story = new_queue['stories'][story_id]

    # Initialize metadata if it doesn't exist
    if 'metadata' not in story:
        story['metadata'] = {}

    # Set metadata value (now validated)
    story['metadata'][key] = value

    return new_queue
```

**Rationale**: This adds schema validation at the point where metadata is written to the queue, ensuring that invalid data cannot be stored. The validation is only triggered for the specific keys that have schemas, maintaining backwards compatibility with existing metadata keys.

---

### 3. Export Schema Functions from __init__.py

**File**: `resources/commands/sprint/queue_helpers/__init__.py`
**Change**: Add exports for test_reconciliation module

Add to the imports section:

```python
# Existing imports
from .core import (
    get_story,
    set_metadata,
    # ... other core exports ...
)

# Add new imports for test_reconciliation
from .test_reconciliation import (
    validate_test_reconciliation,
    validate_reconciliation,
    TestReconciliationMetadata,
    ReconciliationMetadata,
)
```

Add to the `__all__` list:

```python
__all__ = [
    # ... existing exports ...
    "validate_test_reconciliation",
    "validate_reconciliation",
    "TestReconciliationMetadata",
    "ReconciliationMetadata",
]
```

**Rationale**: This makes the schema validation functions and TypedDict types available when importing from the queue_helpers package, enabling external code to validate metadata before submission.

---

### 4. Stage and Commit Implementation Files

**Action**: Track files in git and commit

```bash
# Stage the new implementation file
git add resources/commands/sprint/queue_helpers/test_reconciliation.py

# Stage the modified files
git add resources/commands/sprint/queue_helpers/core.py
git add resources/commands/sprint/queue_helpers/__init__.py

# Verify what will be committed
git diff --cached --stat

# Commit with descriptive message
git commit -m "$(cat <<'EOF'
fix(sprint): Relocate metadata schema implementation to project repository

Remediation for Story 1.i validation failure (-1.i).

Changes:
- Copy test_reconciliation.py from global commands to project repository
- Integrate schema validation into core.py set_metadata() function
- Export schema functions from __init__.py

Files:
- Created: resources/commands/sprint/queue_helpers/test_reconciliation.py (291 lines)
- Modified: resources/commands/sprint/queue_helpers/core.py (+20 lines)
- Modified: resources/commands/sprint/queue_helpers/__init__.py (+5 lines)

This fixes the critical validation failure where implementation was created
in the wrong location (~/.claude/resources/) instead of the project repository.

Remediation Story: 1.i.1
Parent Story: 1.i
Validation Story: -1.i

Generated with Claude Code (https://claude.com/claude-code)

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
EOF
)"
```

**Rationale**: This ensures the implementation is tracked in version control and includes a comprehensive commit message that explains the remediation and references the validation failure.

---

### 5. Update Story 1.i Status and Metadata

**File**: `.claude/sprint/.queue.json`
**Change**: Update Story 1.i metadata to record remediation

```bash
# Use queue_helpers to update metadata
python -m resources.commands.sprint.queue_helpers set-metadata \
    --story-id "1.i" \
    --key "remediation_applied" \
    --value "1.i.1" \
    --json
```

**Rationale**: Record that remediation was applied to Story 1.i, creating an audit trail.

---

## Testing

**Verification Tests**:

### Test 1: File Existence in Project
```bash
# Verify test_reconciliation.py exists in project repository
test -f resources/commands/sprint/queue_helpers/test_reconciliation.py
echo "Exit code: $?"  # Should be 0

# Verify file is tracked in git
git ls-files resources/commands/sprint/queue_helpers/test_reconciliation.py
# Should output: resources/commands/sprint/queue_helpers/test_reconciliation.py
```

### Test 2: Schema Validation Works
```python
# Test that schema validation rejects invalid data
from resources.commands.sprint.queue_helpers import validate_test_reconciliation

# Invalid: missing required field
invalid_data = {
    "failed_test_id": "test-1-001",
    "test_file": "tests/test_foo.py"
    # Missing: failure_summary, original_story_id
}
is_valid, error = validate_test_reconciliation(invalid_data)
assert not is_valid, "Should reject invalid data"
assert "failure_summary" in error or "original_story_id" in error

# Valid: all required fields present
valid_data = {
    "failed_test_id": "test-1-001",
    "test_file": "tests/test_foo.py",
    "failure_summary": "AssertionError: expected 5 got 3",
    "original_story_id": "1.i"
}
is_valid, error = validate_test_reconciliation(valid_data)
assert is_valid, f"Should accept valid data, got error: {error}"
```

### Test 3: core.py Integration
```python
# Test that set_metadata() calls validation
from resources.commands.sprint.queue_helpers import set_metadata
import json

# Load queue
with open('.claude/sprint/.queue.json') as f:
    queue = json.load(f)

# Try to set invalid test_reconciliation metadata
try:
    set_metadata(queue, "1.i", "test_reconciliation", {"invalid": "data"})
    assert False, "Should have raised ValueError for invalid schema"
except ValueError as e:
    assert "Invalid test_reconciliation schema" in str(e)

# Try to set valid test_reconciliation metadata
valid_metadata = {
    "failed_test_id": "test-1-001",
    "test_file": "tests/test_foo.py",
    "failure_summary": "Test failure",
    "original_story_id": "1.i"
}
updated_queue = set_metadata(queue, "1.i", "test_reconciliation", valid_metadata)
assert updated_queue['stories']['1.i']['metadata']['test_reconciliation'] == valid_metadata
```

### Test 4: Exports Available
```python
# Test that __init__.py exports are available
from resources.commands.sprint.queue_helpers import (
    validate_test_reconciliation,
    validate_reconciliation,
    TestReconciliationMetadata,
    ReconciliationMetadata,
)

# Should not raise ImportError
assert callable(validate_test_reconciliation)
assert callable(validate_reconciliation)
assert TestReconciliationMetadata is not None
assert ReconciliationMetadata is not None
```

### Test 5: Backwards Compatibility
```python
# Test that existing metadata operations still work
from resources.commands.sprint.queue_helpers import set_metadata
import json

with open('.claude/sprint/.queue.json') as f:
    queue = json.load(f)

# Setting arbitrary metadata (not test_reconciliation or reconciliation) should work
updated_queue = set_metadata(queue, "1.i", "custom_field", "custom_value")
assert updated_queue['stories']['1.i']['metadata']['custom_field'] == "custom_value"
```

---

## Acceptance Criteria

- [ ] **(P0) AC-1.i.1.1**: test_reconciliation.py exists in project repository at `resources/commands/sprint/queue_helpers/test_reconciliation.py` (verified by `git ls-files`)
- [ ] **(P0) AC-1.i.1.2**: core.py contains schema validation logic in set_metadata() function (verified by reading file)
- [ ] **(P0) AC-1.i.1.3**: __init__.py exports schema validation functions (verified by import test)
- [ ] **(P0) AC-1.i.1.4**: Schema validation correctly rejects invalid test_reconciliation data (verified by Test 2)
- [ ] **(P0) AC-1.i.1.5**: Schema validation correctly accepts valid test_reconciliation data (verified by Test 2)
- [ ] **(P0) AC-1.i.1.6**: Schema validation correctly rejects invalid reconciliation data (verified by Test 2)
- [ ] **(P0) AC-1.i.1.7**: Schema validation correctly accepts valid reconciliation data (verified by Test 2)
- [ ] **(P0) AC-1.i.1.8**: Backwards compatibility maintained - existing metadata keys work without schema validation (verified by Test 5)
- [ ] **(P0) AC-1.i.1.9**: All files committed to git with proper commit message (verified by git log)

---

## Verification Steps

1. **File Relocation Verification**:
   ```bash
   # Verify file exists in project
   ls -la resources/commands/sprint/queue_helpers/test_reconciliation.py

   # Verify file is tracked in git
   git ls-files | grep test_reconciliation.py

   # Verify file has expected line count (should be ~291 lines)
   wc -l resources/commands/sprint/queue_helpers/test_reconciliation.py
   ```

2. **Integration Verification**:
   ```bash
   # Verify core.py has validation logic (should find imports and validation calls)
   grep -n "from .test_reconciliation import" resources/commands/sprint/queue_helpers/core.py
   grep -n "validate_test_reconciliation" resources/commands/sprint/queue_helpers/core.py
   grep -n "validate_reconciliation" resources/commands/sprint/queue_helpers/core.py

   # Verify __init__.py has exports (should find imports and __all__ entries)
   grep -n "from .test_reconciliation import" resources/commands/sprint/queue_helpers/__init__.py
   grep -n "validate_test_reconciliation" resources/commands/sprint/queue_helpers/__init__.py
   ```

3. **Functional Verification**:
   ```bash
   # Run all verification tests (Tests 1-5 above)
   # Each test should pass without errors
   ```

4. **Git Verification**:
   ```bash
   # Verify commit includes all expected files
   git log -1 --stat | grep -E "(test_reconciliation|core\.py|__init__\.py)"

   # Should show:
   # resources/commands/sprint/queue_helpers/test_reconciliation.py | 291 +++++++++++++++
   # resources/commands/sprint/queue_helpers/core.py                |  20 +-
   # resources/commands/sprint/queue_helpers/__init__.py            |   5 +
   ```

---

## Notes

- **Remediation Type**: validation_failure (Check I failure from Story -1.i)
- **Auto-Created**: 2025-12-20T01:50:00Z
- **Created From**: Validation failure report (validation-results/-1.i-results.md)
- **Original Request**: Fix implementation location for Story 1.i
- **Root Cause**: Implementation created in global commands directory (~/.claude/resources/) instead of project repository
- **Impact**: Critical - without this remediation, the implementation is not available to other users or CI/CD
- **Blocks**: Story -1.t (Validate Testing: Metadata Schema Extension) cannot proceed until this remediation is complete

**Original Validation Findings**:
- Finding 1: Wrong directory for implementation
- Finding 2: Schema validation not integrated into core.py
- Finding 3: Exports missing from __init__.py
- Finding 4: 0/4 acceptance criteria met for Story 1.i
- Finding 5: Misleading commit message (claimed implementation but only touched .queue.json)

**Remediation Strategy**:
- Copy working implementation from global to project (no rewrite needed)
- Integrate schema validation at the correct insertion point in core.py
- Add proper exports to __init__.py
- Comprehensive testing to ensure all acceptance criteria are met
- Proper git tracking and commit message

---

**Created**: 2025-12-20T01:50:00Z
**Estimated Effort**: 1-2 hours
**Risk Level**: Low (implementation already exists and works, just needs relocation)
