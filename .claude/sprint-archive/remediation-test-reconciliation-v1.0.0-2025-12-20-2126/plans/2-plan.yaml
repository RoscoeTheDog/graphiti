# Plan: 2
# Generated by: discovery:2.d
# Timestamp: 2025-12-20T06:30:00Z

story_id: "2"
title: "Test Identity Capture in REMEDIATE"
created: "2025-12-20T06:30:00Z"
created_by: "discovery:2.d"

# Analysis Summary
analysis:
  summary: "Extend REMEDIATE command (Workflow B - Sprint Fragmentation mode) to capture test identity when creating remediation stories for Check D (test pass rate) failures. Populate test_reconciliation metadata block created in Story 1."
  complexity: "medium"
  estimated_files: 2
  estimated_tokens: 12000
  risk_factors:
    - "Must preserve existing REMEDIATE workflows (natural language + sprint fragmentation)"
    - "Check D failure detection requires parsing validate_test_pass_rates.py output"
    - "Test file extraction depends on test-results artifact structure"
    - "Manual reconciliation flags (--supersedes-tests, --retest-mode) are user-facing API changes"

# Files to Create
files_to_create: []

# Files to Modify
files_to_modify:
  - path: "~/.claude/commands/sprint/REMEDIATE.md"
    changes:
      - "Add Check D failure detection section in Workflow B (after STEP 4)"
      - "Add test identity extraction logic from validation failure details"
      - "Populate test_reconciliation metadata when creating remediation stories for Check D"
      - "Add --supersedes-tests flag with required --supersession-reason parameter"
      - "Add --retest-mode flag to force retest instead of propagate"
      - "Document manual reconciliation workflow (automation not yet implemented)"
    lines_affected: 150

  - path: "~/.claude/resources/commands/sprint/create_remediation_stories.py"
    changes:
      - "Add test_reconciliation parameter to remediation story creation"
      - "Extract test files from Check D failure details (JSON structure)"
      - "Populate failed_test_id, test_file, failure_summary, original_story_id fields"
      - "Set reconciliation_status to 'pending' by default"
      - "Add CLI arguments: --supersedes-tests, --supersession-reason, --retest-mode"
      - "Validate supersession-reason is required when supersedes-tests is set"
    lines_affected: 100

# Integration Points
integration:
  - file: "~/.claude/commands/sprint/REMEDIATE.md"
    type: "workflow"
    description: "Workflow B (Sprint Fragmentation) - Check D detection branch after STEP 4"

  - file: "~/.claude/resources/commands/sprint/create_remediation_stories.py"
    type: "import"
    description: "Import test_reconciliation schema from queue_helpers.test_reconciliation"

  - file: "~/.claude/resources/commands/sprint/create_remediation_stories.py"
    type: "validation"
    description: "Call validate_test_reconciliation() before creating remediation story"

  - file: "~/.claude/resources/commands/sprint/validate_test_pass_rates.py"
    type: "data_source"
    description: "Parse JSON output to extract failed test details (test IDs, files, thresholds)"

  - file: ".claude/sprint/test-results/{story_id}-results.json"
    type: "artifact"
    description: "Source of test failure details (test IDs, commands, thresholds, original failures)"

# Patterns to Follow
patterns:
  - source: "~/.claude/commands/sprint/REMEDIATE.md (Workflow B)"
    pattern: "Pre-flight checks + issue detection -> remediation map -> Python delegation"

  - source: "~/.claude/resources/commands/sprint/create_remediation_stories.py"
    pattern: "Metadata schema validation before queue updates (similar to Story 1 implementation)"

  - source: "~/.claude/resources/commands/sprint/queue_helpers/test_reconciliation.py"
    pattern: "test_reconciliation schema with required fields: failed_test_id, test_file, failure_summary, original_story_id"

# Test Requirements
test_requirements:
  unit:
    - "Test REMEDIATE detects Check D failures from validation results"
    - "Test test identity extraction from validate_test_pass_rates.py JSON output"
    - "Test test_reconciliation metadata population with valid fields"
    - "Test test_reconciliation metadata validation rejects incomplete data"
    - "Test --supersedes-tests flag requires --supersession-reason"
    - "Test --supersedes-tests flag without reason raises validation error"
    - "Test --retest-mode flag sets correct reconciliation metadata"
    - "Test backwards compatibility - existing REMEDIATE workflows unaffected"

  integration:
    - "Test REMEDIATE --validate creates remediation stories with test_reconciliation metadata for Check D failures"
    - "Test created remediation story has all required test_reconciliation fields populated"
    - "Test queue_helpers.py can read test_reconciliation metadata from remediation stories"
    - "Test REMEDIATE with --supersedes-tests creates story with supersession metadata"
    - "Test REMEDIATE with --retest-mode creates story with retest flag"

  security:
    - "Test test file paths are validated and cannot escape project root"
    - "Test test IDs are sanitized to prevent injection"
    - "Test failure summary is safely stored (no code execution)"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-2.1"
    text: "(P0) REMEDIATE.md updated to populate test_reconciliation metadata block"
    implementation: "files_to_modify[0] - REMEDIATE.md Workflow B Check D detection"
    tests: "test_requirements.unit[0-2], test_requirements.integration[0-1]"

  - id: "AC-2.2"
    text: "(P0) Test files extracted from failure details and stored in metadata"
    implementation: "files_to_modify[1] - create_remediation_stories.py extraction logic"
    tests: "test_requirements.unit[1-3], test_requirements.integration[1-2]"

  - id: "AC-2.3"
    text: "--supersedes-tests flag supported with required --supersession-reason"
    implementation: "files_to_modify[0-1] - CLI argument parsing and validation"
    tests: "test_requirements.unit[4-5], test_requirements.integration[3]"

  - id: "AC-2.4"
    text: "--retest-mode flag supported to force retest instead of propagate"
    implementation: "files_to_modify[0-1] - CLI argument and metadata flag"
    tests: "test_requirements.unit[6], test_requirements.integration[4]"

  - id: "AC-2.5"
    text: "Manual reconciliation still required (automation not yet implemented)"
    implementation: "files_to_modify[0] - Documentation section in REMEDIATE.md"
    tests: "test_requirements.integration[0] - verify no automatic reconciliation"

# Implementation Details
implementation_approach:
  check_d_detection:
    description: "Detect Check D failures in Workflow B pre-flight checks"
    location: "REMEDIATE.md STEP 4 - after Check D filesystem integrity"
    logic: |
      1. Run validate_test_pass_rates.py for each story in REMEDIATION_MAP
      2. Parse JSON output for failures (P0 < 100% OR P1 < 90%)
      3. Extract failed test details: test IDs, files, thresholds
      4. Add to REMEDIATION_MAP with issue type "check_d_failure"

  test_identity_extraction:
    description: "Extract test identity from validation failure details"
    location: "create_remediation_stories.py - remediation story creation"
    fields:
      failed_test_id: "Extract from test-results artifact (test ID format: test-{story_id}-{number})"
      test_file: "Extract from test-results artifact (relative path from project root)"
      failure_summary: "Extract from validate_test_pass_rates.py output (threshold violation message)"
      original_story_id: "Parent story ID from REMEDIATION_MAP"
      reconciliation_status: "Default to 'pending'"

  metadata_population:
    description: "Populate test_reconciliation metadata in remediation story"
    location: "create_remediation_stories.py - story metadata construction"
    validation: "Call validate_test_reconciliation() before queue update"
    schema_source: "queue_helpers.test_reconciliation (from Story 1)"

  cli_flags:
    supersedes_tests:
      description: "Mark remediation as superseding original test (test no longer valid)"
      required_with: "--supersession-reason"
      metadata_effect: "Set reconciliation_status='superseded', add supersession_reason to metadata"
    retest_mode:
      description: "Force retest instead of propagating advisory (test should pass after fix)"
      metadata_effect: "Set retest_flag=true in metadata"

  manual_reconciliation:
    description: "User must manually reconcile test failures"
    documentation_location: "REMEDIATE.md - Manual Reconciliation section"
    workflow: |
      1. User runs REMEDIATE --validate
      2. Check D failures detected, remediation stories created with test_reconciliation metadata
      3. User runs /sprint:NEXT to execute remediation stories
      4. User manually decides:
         - Fix code to pass test (default)
         - Supersede test with --supersedes-tests + reason
         - Defer test with --retest-mode
      5. Automation (Story 3+) will handle propagation in future stories

# Data Sources
data_sources:
  validation_output:
    file: "validate_test_pass_rates.py --json output"
    structure:
      valid: "boolean - true if pass rates meet thresholds"
      failures: "array of test failure objects"
      failure_object:
        test_id: "string - unique test identifier"
        test_file: "string - relative path to test file"
        priority: "string - P0, P1, P2"
        pass_rate: "float - actual pass rate (0.0-1.0)"
        threshold: "float - required threshold (0.9 or 1.0)"
        failure_reason: "string - description of threshold violation"

  test_results_artifact:
    file: ".claude/sprint/test-results/{story_id}-results.json"
    structure:
      story_id: "string"
      tests_run: "integer"
      tests_passed: "integer"
      tests_failed: "integer"
      failures: "array of failure detail objects"
      failure_detail:
        test_id: "string"
        test_file: "string"
        test_command: "string - command used to run test"
        error_output: "string - test failure message"
        priority: "string - P0, P1, P2"

# Backwards Compatibility
backwards_compatibility:
  natural_language_mode: "Unaffected - Workflow A does not use validation checks"
  sprint_fragmentation_mode: "Enhanced - Workflow B gains Check D detection without breaking existing checks"
  existing_remediation_stories: "Compatible - test_reconciliation metadata is optional (Story 1 schema design)"
  existing_cli_flags: "Compatible - new flags are optional, existing flags unchanged"

# Edge Cases
edge_cases:
  - case: "Check D passes but test file is missing"
    handling: "No remediation created (validation passed)"

  - case: "Check D fails but test-results artifact is missing"
    handling: "Create remediation with minimal metadata (failed_test_id='unknown', test_file='unknown')"

  - case: "Multiple tests fail for same story"
    handling: "Create separate remediation story for each failed test (one-to-one mapping)"

  - case: "--supersedes-tests without --supersession-reason"
    handling: "Validation error - halt execution, prompt user for reason"

  - case: "Both --supersedes-tests and --retest-mode provided"
    handling: "Validation error - mutually exclusive flags"

# Future Stories (Dependencies)
future_dependencies:
  - story: "3 - Overlap Calculation Algorithm"
    dependency: "Uses test_reconciliation metadata to calculate test overlap between remediations and validations"

  - story: "4 - Reconciliation Application Functions"
    dependency: "Applies test reconciliation decisions (propagate advisory, retest, supersede)"

  - story: "6 - Remediation Testing Trigger"
    dependency: "Triggers retesting after remediation completes (uses retest_mode flag)"
