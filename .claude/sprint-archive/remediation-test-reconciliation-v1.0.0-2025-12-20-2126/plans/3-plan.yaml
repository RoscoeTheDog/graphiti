# Plan: 3
# Generated by: discovery:3.d
# Timestamp: 2025-12-20T14:30:00Z

story_id: "3"
title: "Overlap Calculation Algorithm"
created: "2025-12-20T14:30:00Z"
created_by: "discovery:3.d"

# Analysis Summary
analysis:
  summary: "Implement test file overlap calculation algorithm to determine reconciliation mode (propagate vs retest vs no_match) based on test file similarity between original validation and new validation runs."
  complexity: "medium"
  estimated_files: 3
  estimated_tokens: 12000
  risk_factors:
    - "Algorithm must handle edge cases (empty lists, identical lists, no overlap)"
    - "Threshold values (0.95, 0.50) are critical for correct mode determination"
    - "Test parameter comparison must be comprehensive and reliable"

# Files to Create
files_to_create:
  - path: "resources/commands/sprint/queue_helpers/overlap.py"
    purpose: "Implement overlap calculation and test parameter comparison functions"
    pattern_source: "resources/commands/sprint/queue_helpers/test_reconciliation.py"
    estimated_lines: 300

# Files to Modify
files_to_modify:
  - path: "resources/commands/sprint/queue_helpers/__init__.py"
    changes:
      - "Import overlap calculation functions (calculate_test_overlap, same_test_parameters)"
      - "Export overlap functions for use by reconciliation application logic"
    lines_affected: 5

# Integration Points
integration:
  - file: "resources/commands/sprint/queue_helpers/test_reconciliation.py"
    type: "dependency"
    description: "Uses test_reconciliation metadata schema for input data"

  - file: "resources/commands/sprint/queue_helpers/reconciliation.py"
    type: "consumer"
    description: "Overlap functions will be called by reconciliation application logic (Story 4)"

# Algorithm Design
algorithm:
  calculate_test_overlap:
    description: "Calculate ratio of matching test files between two test file lists"
    inputs:
      - name: "original_test_files"
        type: "list[str]"
        description: "List of test file paths from original validation run"
      - name: "new_test_files"
        type: "list[str]"
        description: "List of test file paths from new validation run"
    outputs:
      - name: "overlap_ratio"
        type: "float"
        description: "Ratio of matching files (0.0 to 1.0)"
        range: "[0.0, 1.0]"
    algorithm_steps:
      - "Convert both lists to sets for efficient comparison"
      - "Calculate intersection (matching files)"
      - "Calculate union (all unique files)"
      - "Return ratio: len(intersection) / len(union) if union not empty, else 1.0"
    edge_cases:
      - case: "Both lists empty"
        result: "Return 1.0 (perfect match, no tests to reconcile)"
      - case: "One list empty, other not"
        result: "Return 0.0 (no overlap)"
      - case: "Identical lists"
        result: "Return 1.0 (perfect match)"
      - case: "No common files"
        result: "Return 0.0 (no overlap)"
      - case: "Partial overlap"
        result: "Return calculated ratio"

  same_test_parameters:
    description: "Compare test parameters between two validation runs"
    inputs:
      - name: "original_params"
        type: "dict[str, Any]"
        description: "Test parameters from original validation (threshold, command, timeout, etc.)"
      - name: "new_params"
        type: "dict[str, Any]"
        description: "Test parameters from new validation"
    outputs:
      - name: "parameters_match"
        type: "bool"
        description: "True if all critical parameters match"
    compared_parameters:
      - "test_threshold: Minimum pass threshold for tests"
      - "test_command: Command used to run tests"
      - "test_timeout: Timeout for test execution"
      - "test_environment: Environment variables or config"
    algorithm_steps:
      - "Compare each critical parameter for equality"
      - "Return True only if ALL parameters match"
      - "Missing parameters treated as None for comparison"

  determine_reconciliation_mode:
    description: "Determine reconciliation mode based on overlap ratio"
    inputs:
      - name: "overlap_ratio"
        type: "float"
        description: "Overlap ratio from calculate_test_overlap()"
    outputs:
      - name: "mode"
        type: "str"
        description: "Reconciliation mode: 'propagate', 'retest', or 'no_match'"
    thresholds:
      - threshold: ">= 0.95"
        mode: "propagate"
        description: "Very high overlap - propagate results from original validation"
      - threshold: ">= 0.50 and < 0.95"
        mode: "retest"
        description: "Moderate overlap - rerun tests to verify results"
      - threshold: "< 0.50"
        mode: "no_match"
        description: "Low overlap - no reconciliation possible"

# Patterns to Follow
patterns:
  - source: "resources/commands/sprint/queue_helpers/test_reconciliation.py"
    pattern: "Module structure with typed functions and comprehensive validation"

  - source: "resources/commands/sprint/queue_helpers/test_reconciliation.py"
    pattern: "Type hints using typing module (list[str], dict[str, Any], tuple[bool, Optional[str]])"

  - source: "Python best practices"
    pattern: "Set operations for efficient list comparison (intersection, union)"

# Test Requirements
test_requirements:
  unit:
    - "Test calculate_test_overlap() with empty lists (both, one, neither)"
    - "Test calculate_test_overlap() with identical lists (ratio = 1.0)"
    - "Test calculate_test_overlap() with no overlap (ratio = 0.0)"
    - "Test calculate_test_overlap() with partial overlap (various ratios)"
    - "Test calculate_test_overlap() with different list sizes"
    - "Test same_test_parameters() with matching parameters"
    - "Test same_test_parameters() with mismatched parameters"
    - "Test same_test_parameters() with missing parameters"
    - "Test determine_reconciliation_mode() at threshold boundaries (0.50, 0.95)"
    - "Test determine_reconciliation_mode() for each mode (propagate, retest, no_match)"

  integration:
    - "Test overlap calculation with real test file paths"
    - "Test parameter comparison with realistic test metadata"
    - "Test mode determination workflow (calculate -> compare -> determine)"

  security:
    - "Test path traversal in test file paths (../../../etc/passwd)"
    - "Test malformed file paths (null bytes, special characters)"
    - "Test extremely large file lists (performance degradation)"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-3.1"
    text: "calculate_test_overlap() function returns ratio of matching test files"
    implementation: "files_to_create[0] - overlap.py implements calculate_test_overlap()"
    tests: "test_requirements.unit[0-5], test_requirements.integration[0]"

  - id: "AC-3.2"
    text: "same_test_parameters() function compares threshold, command, etc."
    implementation: "files_to_create[0] - overlap.py implements same_test_parameters()"
    tests: "test_requirements.unit[6-8], test_requirements.integration[1]"

  - id: "AC-3.3"
    text: "Overlap >= 0.95 qualifies for propagate mode"
    implementation: "files_to_create[0] - overlap.py implements determine_reconciliation_mode()"
    tests: "test_requirements.unit[9-10]"

  - id: "AC-3.4"
    text: "Overlap >= 0.50 and < 0.95 triggers retest mode"
    implementation: "files_to_create[0] - overlap.py implements determine_reconciliation_mode()"
    tests: "test_requirements.unit[9-10]"

  - id: "AC-3.5"
    text: "Overlap < 0.50 results in no_match (no reconciliation)"
    implementation: "files_to_create[0] - overlap.py implements determine_reconciliation_mode()"
    tests: "test_requirements.unit[9-10]"

  - id: "AC-3.6"
    text: "Unit tests for edge cases (empty lists, identical lists, partial overlap)"
    implementation: "Test file creation in testing phase"
    tests: "test_requirements.unit[all]"

# Implementation Notes
implementation_notes:
  - note: "Use set operations for efficient comparison (O(n) vs O(n^2))"
    rationale: "Large test file lists require efficient algorithms"

  - note: "Return 1.0 for empty lists (both empty) to indicate 'perfect match'"
    rationale: "Edge case: no tests to reconcile means no differences"

  - note: "Normalize file paths before comparison (forward/backslash, relative/absolute)"
    rationale: "Cross-platform compatibility and consistent comparison"

  - note: "Test parameter comparison must be order-independent for list/dict values"
    rationale: "Parameter order should not affect equality checks"

  - note: "Consider case-sensitivity in file path comparison"
    rationale: "Windows file paths are case-insensitive, Unix are case-sensitive"

# Dependencies
dependencies:
  - story_id: "1"
    type: "requires"
    reason: "Uses test_reconciliation metadata schema for test file data"

# Blocks
blocks:
  - story_id: "4"
    reason: "Reconciliation Application Functions need overlap calculation logic"
