# Plan: 6
# Generated by: discovery:6.d
# Timestamp: 2025-12-12T12:00:00Z

story_id: "6"
title: "Add Extraction Config to unified_config.py"
created: "2025-12-12T12:00:00Z"
created_by: "discovery:6.d"

# Analysis Summary
analysis:
  summary: "Integrate ExtractionConfig into GraphitiConfig as a new field with proper defaults, Field factory, and JSON schema compatibility."
  complexity: "low"
  estimated_files: 2
  estimated_tokens: 2000
  risk_factors:
    - "Must maintain backward compatibility with existing configs (no ExtractionConfig field)"
    - "Default template path must exist and be valid"
    - "JSON schema regeneration required for documentation"

# Files to Create
files_to_create: []

# Files to Modify
files_to_modify:
  - path: "mcp_server/unified_config.py"
    changes:
      - "Import ExtractionConfig from graphiti_core.extraction_config"
      - "Add 'extraction: ExtractionConfig' field to GraphitiConfig class with Field(default_factory=ExtractionConfig)"
      - "Position after session_tracking field (line 758) and before @classmethod methods"
    lines_affected: 5

  - path: "graphiti.config.schema.json"
    changes:
      - "Add ExtractionConfig schema definition to $defs section"
      - "Add extraction field to GraphitiConfig properties"
      - "Include preprocessing_prompt and preprocessing_mode with proper types and examples"
    lines_affected: 50

# Integration Points
integration:
  - file: "mcp_server/unified_config.py"
    type: "import"
    description: "Import ExtractionConfig from graphiti_core.extraction_config module"

  - file: "mcp_server/unified_config.py"
    type: "config"
    description: "Add extraction field to GraphitiConfig with default_factory pattern (matches other config fields)"

  - file: "graphiti.config.schema.json"
    type: "config"
    description: "Update JSON schema to include ExtractionConfig type definition and examples"

# Patterns to Follow
patterns:
  - source: "mcp_server/unified_config.py:744-761"
    pattern: "Field(default_factory=ConfigClass) pattern for nested config objects - ensures proper instantiation with defaults"

  - source: "graphiti_core/extraction_config.py:72-93"
    pattern: "Pydantic model_config with json_schema_extra examples - maintain consistency in JSON schema generation"

  - source: "mcp_server/unified_config.py:748-761"
    pattern: "Config field ordering - group related configs together, alphabetize within groups"

# Test Requirements
test_requirements:
  unit:
    - "Test GraphitiConfig instantiation with default ExtractionConfig"
    - "Test GraphitiConfig with explicit ExtractionConfig values"
    - "Test GraphitiConfig.from_file() with extraction config in JSON"
    - "Test GraphitiConfig.from_file() without extraction config (backward compatibility)"
    - "Test preprocessing_prompt validation (bool | str type)"
    - "Test preprocessing_mode validation (prepend | append literals)"
    - "Test default template path resolution ('default-session-turn.md')"

  integration:
    - "Test full config loading from graphiti.config.json with extraction section"
    - "Test config serialization to JSON includes extraction config"
    - "Test backward compatibility with old config files (no extraction field)"

  security:
    - "Test preprocessing_prompt with malicious template paths (path traversal prevention)"
    - "Test preprocessing_prompt with excessively long inline strings (DOS prevention)"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-6.1"
    text: "(P0) GraphitiConfig has `extraction: ExtractionConfig` field"
    implementation: "files_to_modify[0] - Add field to GraphitiConfig class"
    tests: "test_requirements.unit[0-1], test_requirements.integration[0]"

  - id: "AC-6.2"
    text: "(P0) Default ExtractionConfig uses 'default-session-turn.md' template"
    implementation: "files_to_modify[0] - Use Field(default_factory=ExtractionConfig) which has preprocessing_prompt=False by default"
    tests: "test_requirements.unit[0,6], test_requirements.integration[2]"
    note: "ExtractionConfig default is preprocessing_prompt=False, NOT the template. Template is opt-in via config."

  - id: "AC-6.3"
    text: "(P1) Config validates preprocessing_prompt values correctly"
    implementation: "files_to_modify[0] - ExtractionConfig already has validation via Pydantic Union[bool, str, None] type"
    tests: "test_requirements.unit[4], test_requirements.security[0-1]"

  - id: "AC-6.4"
    text: "(P1) JSON config example in graphiti.config.json schema works"
    implementation: "files_to_modify[1] - Add extraction config to JSON schema with examples"
    tests: "test_requirements.integration[0-1]"

# Implementation Notes
implementation_notes:
  - "ExtractionConfig default is preprocessing_prompt=False (disabled), not template-based"
  - "Users must explicitly set preprocessing_prompt='default-session-turn.md' to enable preprocessing"
  - "Field ordering: Place extraction after session_tracking (line 758) for logical grouping"
  - "JSON schema: Use Pydantic's model_json_schema() to generate accurate schema definition"
  - "Backward compatibility: Field(default_factory) ensures old configs without extraction field still work"
  - "Template validation deferred to Story 8 (TemplateResolver) - no path validation here"

# Risk Mitigation
risk_mitigation:
  - risk: "Breaking change for existing configs"
    mitigation: "Use Field(default_factory=ExtractionConfig) - missing field auto-instantiates with defaults"

  - risk: "Default template path doesn't exist"
    mitigation: "Template exists at graphiti_core/session_tracking/prompts/default-session-turn.md (verified in discovery)"

  - risk: "JSON schema out of sync"
    mitigation: "Regenerate schema from Pydantic model using model_json_schema() method"
