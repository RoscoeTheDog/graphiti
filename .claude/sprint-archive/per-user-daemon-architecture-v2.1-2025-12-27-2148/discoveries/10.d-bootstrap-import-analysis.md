# Discovery: Story 10.d - Bootstrap Module Invocation Analysis

**Date**: 2025-12-25
**Story**: 10 - Fix Bootstrap Module Invocation
**Phase**: Discovery (10.d)

---

## Problem Statement

The bootstrap module fails when invoked via `-m mcp_server.daemon.bootstrap` from a frozen installation because the frozen packages in `lib/` are not in `sys.path` before the module is imported.

---

## Current Architecture

### Frozen Installation Structure (Story 5)
```
{INSTALL}/              # Platform-specific (from paths.py)
  lib/
    mcp_server/
      __init__.py
      daemon/
        __init__.py
        bootstrap.py      # The module we need to run
        venv_manager.py
        paths.py
        ...
      graphiti_mcp_server.py
    graphiti_core/
      __init__.py
      ...
```

### Service Invocation (Current)
```bash
# Windows (via NSSM)
python -m mcp_server.daemon.bootstrap

# macOS (via launchd)
python -m mcp_server.daemon.bootstrap

# Linux (via systemd)
python -m mcp_server.daemon.bootstrap
```

### Bootstrap Import Dependencies
```python
# Line 18-27: Standard library imports (always available)
import json
import logging
import os
import signal
import subprocess
import sys
import time
from pathlib import Path
from typing import Optional

# Lines 28-33: Relative imports (REQUIRE mcp_server in sys.path)
from .venv_manager import (
    VenvManager,
    VenvCreationError,
    IncompatiblePythonVersionError,
)
from .paths import get_config_file, get_install_dir
```

---

## Root Cause Analysis

### Why `-m` Invocation Fails in Frozen Mode

1. **Python's Module Search Path**:
   - When Python runs `-m mcp_server.daemon.bootstrap`, it searches for `mcp_server` in `sys.path`
   - Default `sys.path` does NOT include `{INSTALL}/lib/`
   - Result: `ModuleNotFoundError: No module named 'mcp_server'`

2. **Relative Import Resolution**:
   - Lines 28-33 use relative imports (`from .venv_manager import ...`)
   - These imports execute DURING module load (before `main()` runs)
   - If `mcp_server` is not in `sys.path`, imports fail immediately
   - Result: Module cannot be imported at all

3. **Timing Issue**:
   - We need `lib/` in `sys.path` BEFORE Python tries to import the module
   - Cannot add to `sys.path` from within the module (too late - imports already executed)

### Why Direct Script Execution Fails

Running `python {INSTALL}/lib/mcp_server/daemon/bootstrap.py` directly has different issues:

1. **Module Not a Package**:
   - Direct execution treats `bootstrap.py` as a standalone script
   - Relative imports (`from .venv_manager`) fail: `ImportError: attempted relative import with no known parent package`

2. **Inconsistent `__file__` Resolution**:
   - When run directly: `__file__` = absolute path to script
   - When run via `-m`: `__file__` = resolved module path
   - Code using `Path(__file__).parent` may resolve differently

3. **Service Manager Incompatibility**:
   - Service managers (NSSM, systemd, launchd) expect module invocation (`-m`)
   - Direct script paths are fragile (platform-specific, harder to maintain)

---

## Solution Design: `_setup_frozen_path()` Function

### Objective
Add `{INSTALL}/lib/` to `sys.path` BEFORE any relative imports execute.

### Implementation Strategy

**Location**: Top of `bootstrap.py`, BEFORE any relative imports (line 18, before imports)

**Detection Logic**:
1. Check if running from frozen installation:
   - Option A: `sys.frozen` attribute (PyInstaller/cx_Freeze)
   - Option B: Detect `lib/` directory structure
   - **Recommended**: Option B (we're not using PyInstaller, just copying files)

2. Determine base directory:
   - Development mode: `bootstrap.py` is in `{REPO}/mcp_server/daemon/`
   - Frozen mode: `bootstrap.py` is in `{INSTALL}/lib/mcp_server/daemon/`

3. Construct `lib_path`:
   - Development: No action (packages already importable from repo root)
   - Frozen: `{INSTALL}/lib/` (4 levels up from bootstrap.py)

4. Add to `sys.path`:
   - Use `sys.path.insert(0, str(lib_path))` to prioritize frozen packages
   - Check if already present to avoid duplicates

### Proposed Implementation

```python
#!/usr/bin/env python3
"""
Graphiti Bootstrap Service
...
"""

# CRITICAL: Setup frozen package path BEFORE any relative imports
import sys
from pathlib import Path


def _setup_frozen_path():
    """
    Ensure frozen packages in lib/ are importable.

    This function MUST be called before any relative imports.

    Detection:
    - Frozen mode: bootstrap.py is in {INSTALL}/lib/mcp_server/daemon/
    - Development mode: bootstrap.py is in {REPO}/mcp_server/daemon/

    Strategy:
    - Check if lib/ directory exists 4 levels up from bootstrap.py
    - If exists AND contains mcp_server/, assume frozen installation
    - Add lib/ to sys.path[0] to prioritize frozen packages
    """
    # Get current file's directory
    # bootstrap.py location: mcp_server/daemon/bootstrap.py
    bootstrap_dir = Path(__file__).parent.resolve()  # .../mcp_server/daemon/

    # Calculate potential lib/ directory
    # Frozen: .../lib/mcp_server/daemon/ -> .../lib/
    potential_lib = bootstrap_dir.parent.parent  # Go up 2 levels: daemon -> mcp_server -> lib

    # Check if this looks like a frozen installation
    # Criteria: potential_lib is named 'lib' AND contains mcp_server/ directory
    if potential_lib.name == "lib" and (potential_lib / "mcp_server").is_dir():
        # Frozen installation detected
        lib_path = potential_lib

        # Add to sys.path if not already present
        lib_path_str = str(lib_path)
        if lib_path_str not in sys.path:
            sys.path.insert(0, lib_path_str)
            # Optional: Log this (but logging not yet configured)
            # print(f"Frozen mode: Added {lib_path} to sys.path", file=sys.stderr)
    else:
        # Development mode: packages importable from repo root
        # No action needed
        pass


# Call setup function IMMEDIATELY
_setup_frozen_path()

# NOW safe to do relative imports
import json
import logging
import os
import signal
import subprocess
import time
from typing import Optional

from .venv_manager import (
    VenvManager,
    VenvCreationError,
    IncompatiblePythonVersionError,
)
from .paths import get_config_file, get_install_dir
```

### Why This Works

1. **Executes Before Imports**:
   - Function is defined and called before line 28 (first relative import)
   - `sys.path` is modified before Python tries to resolve `from .venv_manager`

2. **Platform-Agnostic**:
   - Uses `Path` for cross-platform compatibility
   - No hardcoded paths or platform checks
   - Works on Windows, macOS, Linux

3. **Development-Safe**:
   - Detection logic distinguishes frozen vs development
   - In development mode, does nothing (no side effects)
   - In frozen mode, adds lib/ to sys.path

4. **Minimal Dependencies**:
   - Only uses `sys` and `pathlib.Path` (both in stdlib)
   - No external dependencies before imports work

---

## Imports Requiring Frozen Path

### Category 1: Relative Imports (Lines 28-33)
**Affected by this issue**: YES - require `mcp_server` in `sys.path`

```python
from .venv_manager import (
    VenvManager,
    VenvCreationError,
    IncompatiblePythonVersionError,
)
from .paths import get_config_file, get_install_dir
```

**Fix**: `_setup_frozen_path()` ensures these imports succeed

### Category 2: Standard Library Imports (Lines 18-27)
**Affected by this issue**: NO - always available

```python
import json
import logging
import os
import signal
import subprocess
import sys
import time
from pathlib import Path
from typing import Optional
```

**Fix**: None needed (stdlib always in sys.path)

### Category 3: Runtime Imports (None in bootstrap.py)
**Affected by this issue**: N/A

No dynamic imports or imports inside functions that would execute after `_setup_frozen_path()`.

---

## Testing Strategy

### Test Case 1: Frozen Installation - Module Invocation
```bash
# Setup
cd {INSTALL}
export PYTHONPATH=""  # Ensure lib/ not in path

# Test
python -m mcp_server.daemon.bootstrap

# Expected: Bootstrap service starts successfully
# Actual (without fix): ModuleNotFoundError: No module named 'mcp_server'
# Actual (with fix): Service starts, imports succeed
```

### Test Case 2: Development Mode - Module Invocation
```bash
# Setup
cd {REPO}

# Test
python -m mcp_server.daemon.bootstrap

# Expected: Bootstrap service starts successfully
# Actual: Should work in both cases (no regression)
```

### Test Case 3: Import Resolution Verification
```python
# In frozen mode, verify sys.path contains lib/
import sys
print([p for p in sys.path if 'lib' in p])

# Expected output (frozen): ['{INSTALL}/lib', ...]
# Expected output (dev): [] (or repo root)
```

---

## Alternatives Considered

### Alternative 1: Modify Service Manager Command
**Option**: Add `lib/` to `PYTHONPATH` in service configuration

**Example** (systemd):
```ini
Environment="PYTHONPATH={INSTALL}/lib"
ExecStart=python -m mcp_server.daemon.bootstrap
```

**Rejected because**:
- Requires changes in 3 service managers (Windows, macOS, Linux)
- Harder to maintain (3 files vs 1 file)
- More error-prone (platform-specific syntax)
- Doesn't solve the core issue (module should be self-contained)

### Alternative 2: Use `__main__.py` Wrapper
**Option**: Create `lib/mcp_server/daemon/__main__.py` to setup path

**Example**:
```python
# lib/mcp_server/daemon/__main__.py
import sys
from pathlib import Path

lib_path = Path(__file__).parent.parent.parent
sys.path.insert(0, str(lib_path))

from .bootstrap import main
main()
```

**Rejected because**:
- Requires additional file (complexity)
- Invocation changes to `python -m mcp_server.daemon` (not `bootstrap`)
- Less obvious what's happening (indirect)

### Alternative 3: Absolute Imports
**Option**: Change relative imports to absolute imports

**Example**:
```python
# Instead of: from .venv_manager import VenvManager
# Use: from mcp_server.daemon.venv_manager import VenvManager
```

**Rejected because**:
- Doesn't solve the root problem (mcp_server still not in sys.path)
- Still requires `_setup_frozen_path()` anyway
- Makes code less Pythonic (relative imports are preferred in packages)

---

## Recommendation

**Implement `_setup_frozen_path()` function** as described in Solution Design.

**Rationale**:
1. ✅ Minimal code changes (single function in single file)
2. ✅ Self-contained solution (no external dependencies)
3. ✅ Platform-agnostic (works everywhere)
4. ✅ Development-safe (no impact on dev mode)
5. ✅ Maintainable (single point of truth)

**Next Steps**:
1. Proceed to implementation phase (Story 10.i)
2. Add `_setup_frozen_path()` to bootstrap.py (line 18, before imports)
3. Test in both frozen and development modes
4. Verify service managers work correctly
