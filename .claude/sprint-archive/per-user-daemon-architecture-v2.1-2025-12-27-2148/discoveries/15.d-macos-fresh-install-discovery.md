# Discovery: macOS Fresh Install Test

**Story**: 15.d - macOS Fresh Install Test Discovery
**Created**: 2025-12-25
**Status**: Discovery Complete

## Executive Summary

This discovery phase identifies requirements, success criteria, and potential issues for end-to-end testing of fresh v2.1 installation on macOS. The test will verify the complete installation workflow including LaunchAgent registration, frozen package deployment, and MCP server functionality.

**Key Finding**: macOS uses Apple's launchd system for user-level daemons via LaunchAgents, with specific path conventions across multiple Library directories.

---

## 1. Test Environment Requirements

### 1.1 Platform Requirements

**Minimum Configuration**:
- macOS Version: 12.0 (Monterey) or newer
- Python Version: 3.10 or newer (compatible with graphiti-core)
- Architecture: Intel (x86_64) or Apple Silicon (arm64)
- User Privileges: Standard user (no admin required)

**Recommended Configuration**:
- macOS Version: 13.0 (Ventura) or 14.0 (Sonoma)
- Python Version: 3.11 or 3.12
- Architecture: Both Intel and Apple Silicon should be tested
- Disk Space: 1GB free (500MB for installation + overhead)

**Rationale**: macOS 12+ provides consistent launchd behavior. Python 3.10+ required for graphiti-core dependencies.

### 1.2 Pre-Test Environment Setup

**Clean State Verification**:
```bash
# 1. Check for existing installation
ls -la ~/Library/Application\ Support/Graphiti/
# Should not exist on fresh install

# 2. Check for existing LaunchAgent
ls -la ~/Library/LaunchAgents/com.graphiti.bootstrap.plist
# Should not exist on fresh install

# 3. Check for old v2.0 installation (if testing migration)
ls -la ~/.graphiti/
# Should not exist on fresh macOS test

# 4. Verify Python version
python3 --version
# Should be 3.10 or newer

# 5. Check available disk space
df -h ~
# Should have at least 1GB free
```

**Test User Profile**:
- **Option 1 (Recommended)**: Create new macOS user account for isolated testing
- **Option 2**: Use existing account but manually clean Graphiti directories first
- **Option 3**: Use macOS VM snapshot for repeatable testing

---

## 2. Expected File Locations (v2.1 Architecture)

### 2.1 Installation Directory (Frozen Packages)

**Location**: `~/Library/Application Support/Graphiti/`

**Purpose**: Executables, frozen packages, and runtime binaries

**Expected Structure**:
```
~/Library/Application Support/Graphiti/
├── bin/
│   ├── python                    # Python symlink to venv
│   ├── python3                   # Python3 symlink to venv
│   ├── graphiti-mcp              # CLI wrapper script
│   └── activate                  # Venv activation script
├── lib/
│   ├── mcp_server/               # Frozen mcp_server package
│   │   ├── __init__.py
│   │   ├── graphiti_mcp_server.py
│   │   ├── daemon/
│   │   │   ├── __init__.py
│   │   │   ├── bootstrap.py
│   │   │   ├── launchd_service.py
│   │   │   ├── paths.py
│   │   │   └── installer.py
│   │   └── config/
│   │       └── __init__.py
│   ├── graphiti_core/            # Frozen graphiti_core package
│   │   ├── __init__.py
│   │   └── [graphiti core modules]
│   └── PACKAGE_MANIFEST.json     # Package deployment metadata
├── VERSION                        # Installed version (e.g., "0.24.3")
└── INSTALL_INFO                   # Installation metadata
```

**Verification Command**:
```bash
# Check directory exists
ls -la ~/Library/Application\ Support/Graphiti/

# Verify structure
tree -L 2 ~/Library/Application\ Support/Graphiti/

# Check VERSION file
cat ~/Library/Application\ Support/Graphiti/VERSION

# Verify package manifest
cat ~/Library/Application\ Support/Graphiti/lib/PACKAGE_MANIFEST.json | python3 -m json.tool
```

### 2.2 Configuration Directory

**Location**: `~/Library/Preferences/Graphiti/`

**Purpose**: User-editable configuration files

**Expected Structure**:
```
~/Library/Preferences/Graphiti/
└── graphiti.config.json          # Main configuration file
```

**Default Configuration Content** (from installer):
```json
{
  "daemon": {
    "enabled": false,
    "host": "127.0.0.1",
    "port": 8321,
    "config_poll_seconds": 5,
    "health_check_interval": 30
  },
  "neo4j": {
    "uri": "bolt://localhost:7687",
    "user": "neo4j",
    "password": ""
  },
  "openai": {
    "api_key": ""
  }
}
```

**Verification Command**:
```bash
# Check config directory
ls -la ~/Library/Preferences/Graphiti/

# Verify config file
cat ~/Library/Preferences/Graphiti/graphiti.config.json | python3 -m json.tool

# Check permissions (should be user read/write)
ls -l ~/Library/Preferences/Graphiti/graphiti.config.json
```

### 2.3 Log Directory (State)

**Location**: `~/Library/Logs/Graphiti/`

**Purpose**: Service logs and runtime data

**Expected Structure**:
```
~/Library/Logs/Graphiti/
├── bootstrap-stdout.log          # Bootstrap service stdout
├── bootstrap-stderr.log          # Bootstrap service stderr
└── data/                         # Runtime data (future)
    └── sessions/                 # Session storage (future)
```

**Verification Command**:
```bash
# Check log directory
ls -la ~/Library/Logs/Graphiti/

# Tail bootstrap logs
tail -n 50 ~/Library/Logs/Graphiti/bootstrap-stdout.log
tail -n 50 ~/Library/Logs/Graphiti/bootstrap-stderr.log

# Watch logs in real-time (during testing)
tail -f ~/Library/Logs/Graphiti/bootstrap-stdout.log
```

### 2.4 LaunchAgent Plist

**Location**: `~/Library/LaunchAgents/com.graphiti.bootstrap.plist`

**Purpose**: launchd service definition for bootstrap service

**Expected Content**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.graphiti.bootstrap</string>
    <key>ProgramArguments</key>
    <array>
        <string>~/Library/Application Support/Graphiti/bin/python</string>
        <string>-m</string>
        <string>mcp_server.daemon.bootstrap</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>StandardOutPath</key>
    <string>~/Library/Logs/Graphiti/bootstrap-stdout.log</string>
    <key>StandardErrorPath</key>
    <string>~/Library/Logs/Graphiti/bootstrap-stderr.log</string>
    <key>WorkingDirectory</key>
    <string>~/Library/Application Support/Graphiti</string>
    <key>EnvironmentVariables</key>
    <dict>
        <key>PATH</key>
        <string>/usr/local/bin:/usr/bin:/bin</string>
        <key>PYTHONPATH</key>
        <string>~/Library/Application Support/Graphiti/lib</string>
    </dict>
</dict>
</plist>
```

**Verification Command**:
```bash
# Check plist exists
ls -la ~/Library/LaunchAgents/com.graphiti.bootstrap.plist

# Validate plist syntax
plutil -lint ~/Library/LaunchAgents/com.graphiti.bootstrap.plist

# Check plist content
cat ~/Library/LaunchAgents/com.graphiti.bootstrap.plist
```

**Path Resolution Note**: The plist uses `~` (tilde) in paths, which launchd expands to the user's home directory at runtime.

---

## 3. Test Success Criteria

### 3.1 Installation Phase Success

**Criteria**:
1. ✅ All directories created successfully (install, config, logs)
2. ✅ Frozen packages deployed to `lib/` directory
3. ✅ `VERSION` and `INSTALL_INFO` files created
4. ✅ `graphiti.config.json` created with valid JSON
5. ✅ LaunchAgent plist created and loaded
6. ✅ No errors in installer output

**Verification Commands**:
```bash
# 1. Verify directories exist
[ -d ~/Library/Application\ Support/Graphiti/bin ] && echo "✓ bin/" || echo "✗ bin/ missing"
[ -d ~/Library/Application\ Support/Graphiti/lib ] && echo "✓ lib/" || echo "✗ lib/ missing"
[ -d ~/Library/Preferences/Graphiti ] && echo "✓ config/" || echo "✗ config/ missing"
[ -d ~/Library/Logs/Graphiti ] && echo "✓ logs/" || echo "✗ logs/ missing"

# 2. Verify frozen packages
[ -d ~/Library/Application\ Support/Graphiti/lib/mcp_server ] && echo "✓ mcp_server/" || echo "✗ mcp_server/ missing"
[ -d ~/Library/Application\ Support/Graphiti/lib/graphiti_core ] && echo "✓ graphiti_core/" || echo "✗ graphiti_core/ missing"

# 3. Verify metadata files
[ -f ~/Library/Application\ Support/Graphiti/VERSION ] && echo "✓ VERSION" || echo "✗ VERSION missing"
[ -f ~/Library/Application\ Support/Graphiti/INSTALL_INFO ] && echo "✓ INSTALL_INFO" || echo "✗ INSTALL_INFO missing"

# 4. Verify config
[ -f ~/Library/Preferences/Graphiti/graphiti.config.json ] && echo "✓ config" || echo "✗ config missing"
python3 -m json.tool ~/Library/Preferences/Graphiti/graphiti.config.json > /dev/null 2>&1 && echo "✓ config valid JSON" || echo "✗ config invalid JSON"

# 5. Verify LaunchAgent
launchctl list | grep com.graphiti.bootstrap && echo "✓ LaunchAgent loaded" || echo "✗ LaunchAgent not loaded"
```

### 3.2 Service Lifecycle Success

**Criteria**:
1. ✅ LaunchAgent loads successfully via `launchctl load`
2. ✅ Bootstrap service starts automatically on plist load
3. ✅ Bootstrap process visible in `launchctl list`
4. ✅ Logs written to expected location
5. ✅ Service restarts after manual stop

**Verification Commands**:
```bash
# 1. Check service status
launchctl list | grep com.graphiti.bootstrap

# 2. Check process is running
ps aux | grep "mcp_server.daemon.bootstrap"

# 3. Verify logs exist and are recent
ls -lh ~/Library/Logs/Graphiti/bootstrap-stdout.log
tail -n 20 ~/Library/Logs/Graphiti/bootstrap-stdout.log

# 4. Test manual restart
launchctl stop com.graphiti.bootstrap
sleep 2
launchctl list | grep com.graphiti.bootstrap  # Should still be loaded
ps aux | grep "mcp_server.daemon.bootstrap"  # Should restart due to KeepAlive
```

### 3.3 MCP Server Functionality Success

**Criteria**:
1. ✅ MCP server starts when `daemon.enabled: true`
2. ✅ MCP server accessible on configured port (8321)
3. ✅ Health check endpoint responds
4. ✅ MCP server stops when `daemon.enabled: false`
5. ✅ No errors in MCP server logs

**Verification Commands**:
```bash
# 1. Enable daemon in config
# Edit ~/Library/Preferences/Graphiti/graphiti.config.json and set daemon.enabled: true

# 2. Wait for config poll (5 seconds) and check logs
sleep 6
tail -n 50 ~/Library/Logs/Graphiti/bootstrap-stdout.log | grep "Starting MCP server"

# 3. Check MCP server process
ps aux | grep graphiti_mcp_server

# 4. Test health check (requires health endpoint implementation)
curl -f http://127.0.0.1:8321/health && echo "✓ Health check passed" || echo "✗ Health check failed"

# 5. Disable daemon and verify shutdown
# Edit config and set daemon.enabled: false
sleep 6
ps aux | grep graphiti_mcp_server  # Should not be running
tail -n 50 ~/Library/Logs/Graphiti/bootstrap-stdout.log | grep "Stopping MCP server"
```

---

## 4. macOS-Specific Considerations

### 4.1 Permission Model

**User-Level LaunchAgents** (No Admin Required):
- LaunchAgents run with user privileges
- Stored in `~/Library/LaunchAgents/` (user-writable)
- Automatically loaded on user login
- No `sudo` required for installation or management

**Filesystem Permissions**:
- All installation paths are user-writable (`~/Library/...`)
- No system-level directories involved
- No elevated privileges needed

**Security & Privacy**:
- macOS Gatekeeper may require approval for unsigned executables
- Full Disk Access NOT required (using standard user directories)
- No System Extension approval needed

### 4.2 Path Handling Quirks

**Tilde Expansion in Plists**:
- Issue: `~` in plist paths requires special handling
- LaunchdServiceManager uses `~` prefix for paths
- launchd expands `~` to user home at runtime
- Alternative: Use absolute paths (but less portable)

**Space Handling**:
- "Application Support" directory contains space
- Paths must be properly escaped in plist
- Python's Path handles this automatically
- Verification: `ls "~/Library/Application Support/Graphiti"`

**Case Sensitivity**:
- macOS HFS+/APFS are case-insensitive by default
- Paths work with any casing: `graphiti` vs `Graphiti`
- Best practice: Use consistent casing in code

### 4.3 Service Management

**launchctl Commands**:
```bash
# Load LaunchAgent (starts service)
launchctl load ~/Library/LaunchAgents/com.graphiti.bootstrap.plist

# Unload LaunchAgent (stops service)
launchctl unload ~/Library/LaunchAgents/com.graphiti.bootstrap.plist

# Start service (if loaded but not running)
launchctl start com.graphiti.bootstrap

# Stop service (will restart due to KeepAlive)
launchctl stop com.graphiti.bootstrap

# Check service status
launchctl list | grep com.graphiti.bootstrap

# View service details
launchctl list com.graphiti.bootstrap
```

**Service Persistence**:
- LaunchAgents in `~/Library/LaunchAgents/` auto-load on user login
- KeepAlive ensures service restarts after crashes
- Service survives user logout/login cycles
- Removal requires manual `launchctl unload`

### 4.4 Logging and Debugging

**Log Locations**:
```bash
# Bootstrap service logs (defined in plist)
~/Library/Logs/Graphiti/bootstrap-stdout.log
~/Library/Logs/Graphiti/bootstrap-stderr.log

# System logs (for launchd errors)
log show --predicate 'process == "launchd"' --last 30m | grep graphiti

# Console.app (GUI log viewer)
# Open Console.app and search for "graphiti" or "com.graphiti.bootstrap"
```

**Common Issues**:
1. **Plist not loading**: Check plist syntax with `plutil -lint`
2. **Service not starting**: Check StandardErrorPath for Python errors
3. **Import errors**: Verify PYTHONPATH in plist includes `lib/` directory
4. **Path errors**: Ensure Python executable path is correct (use absolute path if `~` fails)

---

## 5. Test Execution Checklist

### 5.1 Pre-Installation Checks

- [ ] Verify Python 3.10+ installed: `python3 --version`
- [ ] Check disk space: `df -h ~` (>1GB free)
- [ ] Verify no existing installation: `ls ~/Library/Application\ Support/Graphiti/`
- [ ] Check for old v2.0 installation: `ls ~/.graphiti/`
- [ ] Document macOS version: `sw_vers`

### 5.2 Installation Phase

- [ ] Clone Graphiti repository to test location
- [ ] Navigate to repository root: `cd /path/to/graphiti`
- [ ] Run installer: `python3 -m mcp_server.daemon.installer`
- [ ] Verify no errors in installer output
- [ ] Check directories created (see 3.1)
- [ ] Verify frozen packages deployed (see 3.1)
- [ ] Check VERSION file exists and contains valid version
- [ ] Verify config file created with valid JSON

### 5.3 Service Registration Checks

- [ ] Verify plist created: `ls ~/Library/LaunchAgents/com.graphiti.bootstrap.plist`
- [ ] Validate plist syntax: `plutil -lint ~/Library/LaunchAgents/com.graphiti.bootstrap.plist`
- [ ] Check LaunchAgent loaded: `launchctl list | grep graphiti`
- [ ] Verify bootstrap process running: `ps aux | grep bootstrap`
- [ ] Check logs created: `ls ~/Library/Logs/Graphiti/`
- [ ] Tail logs for startup messages: `tail -f ~/Library/Logs/Graphiti/bootstrap-stdout.log`

### 5.4 MCP Server Functionality

- [ ] Enable daemon in config: Set `daemon.enabled: true`
- [ ] Wait 6 seconds for config poll
- [ ] Verify MCP server started in logs
- [ ] Check MCP process running: `ps aux | grep graphiti_mcp_server`
- [ ] Test health endpoint: `curl http://127.0.0.1:8321/health`
- [ ] Test MCP tools via Claude Desktop (if available)
- [ ] Disable daemon: Set `daemon.enabled: false`
- [ ] Verify MCP server stopped in logs

### 5.5 Service Lifecycle Testing

- [ ] Test manual service stop: `launchctl stop com.graphiti.bootstrap`
- [ ] Verify service restarts (KeepAlive behavior)
- [ ] Test user logout/login (service should restart)
- [ ] Test system reboot (service should auto-load)
- [ ] Verify logs persist across restarts

### 5.6 Cleanup Testing

- [ ] Run uninstaller (when implemented)
- [ ] Verify directories removed
- [ ] Check LaunchAgent unloaded and plist removed
- [ ] Confirm no orphaned processes

---

## 6. Known Risks and Mitigation

### 6.1 Python Path Resolution

**Risk**: Incorrect Python executable path in plist
**Impact**: Bootstrap service fails to start
**Detection**: Check stderr log: `No such file or directory`
**Mitigation**: Use absolute path from `which python3` if `~` fails
**Test**: Manually verify Python path before generating plist

### 6.2 PYTHONPATH Configuration

**Risk**: Frozen packages not in PYTHONPATH
**Impact**: `ImportError: No module named 'mcp_server'`
**Detection**: Check stderr log for import errors
**Mitigation**: Ensure `PYTHONPATH` in plist includes `lib/` directory
**Test**: Manually run bootstrap module with same PYTHONPATH

### 6.3 Space-in-Path Handling

**Risk**: macOS paths with spaces (e.g., "Application Support")
**Impact**: Plist parsing errors or path resolution failures
**Detection**: launchd errors in system log
**Mitigation**: Use Path objects (automatic escaping) and test plist syntax
**Test**: Validate plist with `plutil -lint` before load

### 6.4 LaunchAgent Load Timing

**Risk**: Service starts before Neo4j/dependencies ready
**Impact**: MCP server fails health check
**Detection**: Connection errors in logs
**Mitigation**: Bootstrap service waits for config (daemon.enabled)
**Test**: Verify bootstrap starts but doesn't start MCP until enabled

### 6.5 User Login Dependency

**Risk**: Service not starting on login
**Impact**: MCP server unavailable after reboot
**Detection**: `launchctl list` shows service not loaded
**Mitigation**: Ensure plist in correct location (`~/Library/LaunchAgents/`)
**Test**: Test logout/login and reboot scenarios

---

## 7. Success Metrics

### 7.1 Installation Success

- **Time to Install**: <2 minutes (frozen packages already available)
- **Installer Errors**: 0 errors or exceptions
- **Directory Creation**: 100% of expected directories created
- **Package Deployment**: 100% of packages deployed correctly

### 7.2 Service Reliability

- **Service Load Success**: 100% (plist loads without error)
- **Bootstrap Startup**: 100% (process starts and remains running)
- **MCP Server Startup**: 100% when `daemon.enabled: true`
- **Restart Success**: 100% (service recovers from manual stop)

### 7.3 User Experience

- **Manual Steps**: Minimal (ideally just run installer)
- **Configuration Clarity**: Config file location documented
- **Error Messages**: Clear and actionable
- **Log Accessibility**: Logs easy to find and tail

---

## 8. Test Environment Documentation

### 8.1 Test System Specification

**Example Test Configuration**:
```
macOS Version: 14.2.1 (Sonoma)
Hardware: MacBook Pro (M2 Pro, 2023)
Python Version: 3.11.6
Architecture: arm64 (Apple Silicon)
Disk Space: 250GB free
Test User: test-graphiti (clean user profile)
```

### 8.2 Test Execution Log Template

```markdown
## macOS Fresh Install Test - Execution Log

**Date**: YYYY-MM-DD
**Tester**: [Name]
**Environment**: [macOS version, Python version, architecture]

### Pre-Installation
- [ ] Python version: [version]
- [ ] macOS version: [version]
- [ ] Disk space: [GB free]
- [ ] Existing installation: [yes/no]

### Installation
- [ ] Installer command: [command]
- [ ] Installation duration: [seconds]
- [ ] Installer output: [success/errors]
- [ ] Directories created: [list]

### Service Registration
- [ ] Plist created: [yes/no]
- [ ] LaunchAgent loaded: [yes/no]
- [ ] Bootstrap running: [PID]
- [ ] Logs present: [yes/no]

### MCP Server Testing
- [ ] Daemon enabled: [timestamp]
- [ ] MCP server started: [timestamp]
- [ ] Health check: [pass/fail]
- [ ] Tools functional: [yes/no]

### Issues Encountered
[List any issues, errors, or unexpected behavior]

### Overall Result
- [ ] PASS - All criteria met
- [ ] FAIL - [list failures]
- [ ] PARTIAL - [list incomplete items]
```

---

## 9. References

### 9.1 Code References

- **LaunchdServiceManager**: `mcp_server/daemon/launchd_service.py`
- **Path Resolution**: `mcp_server/daemon/paths.py`
- **Bootstrap Service**: `mcp_server/daemon/bootstrap.py`
- **GraphitiInstaller**: `mcp_server/daemon/installer.py`

### 9.2 Documentation References

- **launchd Manual**: `man launchd.plist`
- **launchctl Commands**: `man launchctl`
- **Apple Developer Docs**: [Creating Launch Daemons and Agents](https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingLaunchdJobs.html)

### 9.3 Related Stories

- **Story 8**: Update LaunchdServiceManager (macOS) - COMPLETED
- **Story 10**: Fix Bootstrap Module Invocation - COMPLETED
- **Story 14**: Windows Fresh Install Test - Discovery phase

---

## 10. Next Steps

**Post-Discovery Actions**:
1. ✅ Create this discovery document (15.d)
2. ⏭️ Schedule implementation testing (15.i)
3. ⏭️ Prepare test macOS environment (clean user or VM)
4. ⏭️ Execute test checklist and document results
5. ⏭️ Update story status based on test outcomes

**Dependencies for Testing**:
- Story 8 (LaunchdServiceManager) - ✅ COMPLETED
- Story 10 (Bootstrap Module Invocation) - ✅ COMPLETED
- macOS test environment - ⏭️ PENDING SETUP

**Estimated Testing Duration**: 2-3 hours (including environment setup and documentation)

---

**Discovery Status**: ✅ Complete
**Ready for Implementation Testing**: Yes (pending test environment setup)
