# Discovery: Platform-Aware Path Conventions

**Story**: 1.d - Create Platform-Aware Path Resolution Module
**Phase**: Discovery
**Date**: 2025-12-25

## Executive Summary

This discovery analyzes platform-specific path conventions for professional application installation across Windows, macOS, and Linux. The findings will guide the implementation of `mcp_server/daemon/paths.py` for the Graphiti v2.1 per-user daemon architecture.

## Windows LOCALAPPDATA Conventions

### Overview

Windows applications can install in two main locations:
- **`C:\Program Files`**: Requires administrator privileges, installs for all users
- **`%LOCALAPPDATA%`**: No admin required, per-user installation

### The `%LOCALAPPDATA%\Programs` Convention

**Path**: `C:\Users\<username>\AppData\Local\Programs\`

**Key Characteristics**:
- **No UAC elevation required**: Users can install without admin rights
- **Per-user isolation**: Each user gets their own installation
- **No roaming**: Data stays local, doesn't sync across network/domain
- **Industry standard**: Used by many installers (Inno Setup `{userpf}`, Advanced Installer default)

### Directory Structure for Graphiti

```
%LOCALAPPDATA%\
├── Programs\
│   └── Graphiti\              # Application binaries (install_dir)
│       ├── graphiti_daemon.exe
│       ├── graphiti_mcp.exe
│       └── frozen_packages\
└── Graphiti\
    ├── config\                # Configuration files (config_dir)
    │   └── graphiti.config.json
    ├── state\                 # State/data files (state_dir)
    │   ├── daemon.pid
    │   └── version.txt
    └── logs\                  # Log files
        └── daemon.log
```

### Environment Variables

- **Primary**: `%LOCALAPPDATA%` → `C:\Users\<username>\AppData\Local`
- **Fallback**: `%USERPROFILE%\AppData\Local` (if LOCALAPPDATA not set)
- **Legacy**: `%APPDATA%` (roaming, avoid for large files)

### Best Practices

1. Use `%LOCALAPPDATA%\Programs` for executable binaries
2. Use `%LOCALAPPDATA%\<AppName>` for user data, config, logs
3. Set `PrivilegesRequired=lowest` to avoid UAC prompt
4. Store large files locally (no roaming overhead)
5. Per-user installations are suitable for applications that don't require system-wide access

**Sources**:
- [Microsoft Q&A: What is "%localappdata%\Programs"?](https://learn.microsoft.com/en-us/answers/questions/3235887/what-is-localappdataprograms)
- [Advanced Installer: AppData vs LocalAppData vs ProgramData](https://www.advancedinstaller.com/appdata-localappdata-programdata.html)

---

## macOS Library Directory Conventions

### Overview

macOS uses the `~/Library` directory for user-specific application data, with specific subdirectories for different purposes.

### Key Directories

#### 1. `~/Library/Application Support`
**Purpose**: Application data files and resources

**Characteristics**:
- Application-specific data needed for the app to run
- Configuration files (when not using NSUserDefaults/CFPreferences APIs)
- Resources external to the application bundle
- User-accessible and modifiable

**Graphiti Use**: Main installation directory for daemon binaries and frozen packages

#### 2. `~/Library/Preferences`
**Purpose**: Application preferences and settings

**Characteristics**:
- Settings stored in `.plist` files
- **Should NOT create files directly** - use NSUserDefaults or CFPreferences API
- System-managed, automatically synced via iCloud if enabled
- XML property list format

**Graphiti Use**: Configuration files (if using native APIs), otherwise use Application Support

#### 3. `~/Library/Logs`
**Purpose**: User-specific application logs

**Characteristics**:
- User-accessible log files
- Tracks user activity
- Separate from system logs (`/Library/Logs`, `/var/log`)
- Should implement log rotation to prevent disk bloat

**Graphiti Use**: Daemon logs, MCP server logs

### Directory Structure for Graphiti

```
~/Library/
├── Application Support/
│   └── Graphiti/              # Main installation (install_dir)
│       ├── bin/
│       │   ├── graphiti_daemon
│       │   └── graphiti_mcp
│       ├── frozen_packages/
│       └── config/            # Config files (config_dir)
│           └── graphiti.config.json
├── Preferences/
│   └── com.graphiti.daemon.plist  # (Optional, if using native APIs)
└── Logs/
    └── Graphiti/              # Log directory
        └── daemon.log
```

### Environment Variables

- **HOME**: User home directory (e.g., `/Users/<username>`)
- **No standard XDG variables**: macOS doesn't use XDG_* environment variables

### Best Practices

1. Use `~/Library/Application Support/<AppName>` for main installation
2. Use `~/Library/Logs/<AppName>` for logs
3. Don't create `.plist` files manually in Preferences (use native APIs or Application Support)
4. Implement log rotation and cleanup mechanisms
5. Create backups before modifying preference files

**Sources**:
- [Apple Developer: macOS Library Directory Details](https://developer.apple.com/library/archive/documentation/FileManagement/Conceptual/FileSystemProgrammingGuide/MacOSXDirectories/MacOSXDirectories.html)
- [Config dir on macOS should not be ~/Library/Preferences · Issue #62](https://github.com/dirs-dev/directories-rs/issues/62)
- [Where Should an Application Store Its Logs on macOS?](https://codingtechroom.com/question/macos-application-logs-storage)

---

## Linux XDG Base Directory Specification

### Overview

The XDG Base Directory Specification (by freedesktop.org) defines standard locations for user files on Linux systems. Most modern Linux applications follow this specification.

### Key Environment Variables

#### 1. `XDG_DATA_HOME`
**Purpose**: User-specific data files

**Default**: `$HOME/.local/share`

**Characteristics**:
- Persistent data files
- Application resources
- User data that should survive across sessions

**Graphiti Use**: Main installation directory for daemon binaries and frozen packages

#### 2. `XDG_CONFIG_HOME`
**Purpose**: User-specific configuration files

**Default**: `$HOME/.config`

**Characteristics**:
- Application configuration
- User preferences
- Settings files

**Graphiti Use**: Configuration files (`graphiti.config.json`)

#### 3. `XDG_STATE_HOME`
**Purpose**: User-specific state data

**Default**: `$HOME/.local/state`

**Characteristics**:
- Data that persists between application restarts
- Not critical or portable enough for XDG_DATA_HOME
- Examples: action history, logs, current state, undo history

**Graphiti Use**: Daemon PID files, version tracking, state files

#### 4. `XDG_CACHE_HOME` (Optional)
**Purpose**: Non-essential cached data

**Default**: `$HOME/.cache`

**Characteristics**:
- Can be deleted without data loss
- Regeneratable data

#### 5. `XDG_RUNTIME_DIR` (Optional)
**Purpose**: Runtime files (sockets, named pipes)

**Default**: Set by `pam_systemd(8)`, typically `/run/user/<uid>`

**Characteristics**:
- Only exists while user is logged in
- Automatically cleaned on logout
- Suitable for IPC mechanisms

### Directory Structure for Graphiti

```
$HOME/
├── .local/
│   ├── share/
│   │   └── graphiti/          # Main installation (install_dir)
│   │       ├── bin/
│   │       │   ├── graphiti_daemon
│   │       │   └── graphiti_mcp
│   │       └── frozen_packages/
│   └── state/
│       └── graphiti/          # State directory (state_dir)
│           ├── daemon.pid
│           ├── version.txt
│           └── logs/          # Or use separate log directory
│               └── daemon.log
└── .config/
    └── graphiti/              # Config directory (config_dir)
        └── graphiti.config.json
```

### Environment Variable Fallbacks

All XDG variables have standard fallbacks:

| Variable | Default Fallback |
|----------|------------------|
| `XDG_DATA_HOME` | `$HOME/.local/share` |
| `XDG_CONFIG_HOME` | `$HOME/.config` |
| `XDG_STATE_HOME` | `$HOME/.local/state` |
| `XDG_CACHE_HOME` | `$HOME/.cache` |

### Best Practices

1. **Always check environment variables first**, then fall back to defaults
2. Use `XDG_DATA_HOME` for application binaries and resources
3. Use `XDG_CONFIG_HOME` for configuration files
4. Use `XDG_STATE_HOME` for state/logs (persistent but not critical)
5. Respect user customization of XDG variables
6. Tools like `xdg-ninja` can detect non-compliant applications

**Sources**:
- [XDG Base Directory Specification (freedesktop.org)](https://specifications.freedesktop.org/basedir/latest/)
- [XDG Base Directory - ArchWiki](https://wiki.archlinux.org/title/XDG_Base_Directory)
- [Use the XDG Base Directory Specification!](https://xdgbasedirectoryspecification.com/)

---

## Cross-Platform Summary

### Unified Path Model

| Purpose | Windows | macOS | Linux (XDG) |
|---------|---------|-------|-------------|
| **Install Dir** | `%LOCALAPPDATA%\Programs\Graphiti` | `~/Library/Application Support/Graphiti` | `$XDG_DATA_HOME/graphiti` → `~/.local/share/graphiti` |
| **Config Dir** | `%LOCALAPPDATA%\Graphiti\config` | `~/Library/Application Support/Graphiti/config` | `$XDG_CONFIG_HOME/graphiti` → `~/.config/graphiti` |
| **State Dir** | `%LOCALAPPDATA%\Graphiti` | `~/Library/Application Support/Graphiti` | `$XDG_STATE_HOME/graphiti` → `~/.local/state/graphiti` |
| **Log Dir** | `%LOCALAPPDATA%\Graphiti\logs` | `~/Library/Logs/Graphiti` | `$XDG_STATE_HOME/graphiti/logs` → `~/.local/state/graphiti/logs` |

### Environment Variable Priority

**Windows**:
1. `%LOCALAPPDATA%` (primary)
2. `%USERPROFILE%\AppData\Local` (fallback)

**macOS**:
1. `$HOME` (only variable, no XDG support)

**Linux**:
1. `$XDG_DATA_HOME`, `$XDG_CONFIG_HOME`, `$XDG_STATE_HOME` (if set)
2. `$HOME/.local/share`, `$HOME/.config`, `$HOME/.local/state` (defaults)

### Implementation Recommendations

1. **Platform detection**: Use `sys.platform` (`win32`, `darwin`, `linux`)
2. **Environment variable lookup**: Check environment first, use fallbacks
3. **Return type**: Use `pathlib.Path` objects (not strings)
4. **Type safety**: Create `NamedTuple` or `dataclass` for structured paths
5. **Testing**: Verify paths on all three platforms
6. **Documentation**: Document all path structures and environment variables

---

## Implementation Checklist

For Story 1.i (Implementation Phase):

- [ ] Create `mcp_server/daemon/paths.py` module
- [ ] Implement `GraphitiPaths` NamedTuple with fields:
  - `install_dir: Path`
  - `config_dir: Path`
  - `state_dir: Path`
  - `config_file: Path`
  - `log_dir: Path`
- [ ] Implement `get_paths()` function with:
  - Platform detection via `sys.platform`
  - Windows: Check `%LOCALAPPDATA%`, fallback to `%USERPROFILE%\AppData\Local`
  - macOS: Use `$HOME/Library/...`
  - Linux: Check `XDG_*` vars, fallback to `$HOME/.local/...`, `$HOME/.config/...`
- [ ] Implement convenience functions:
  - `get_install_dir() -> Path`
  - `get_config_dir() -> Path`
  - `get_config_file() -> Path`
  - `get_log_dir() -> Path`
  - `get_state_dir() -> Path`
- [ ] Add comprehensive type hints and docstrings
- [ ] Add unit tests for all platforms

---

## References

### Windows
- [Microsoft Q&A: What is "%localappdata%\Programs"?](https://learn.microsoft.com/en-us/answers/questions/3235887/what-is-localappdataprograms)
- [Advanced Installer: AppData vs LocalAppData vs ProgramData](https://www.advancedinstaller.com/appdata-localappdata-programdata.html)

### macOS
- [Apple Developer: macOS Library Directory Details](https://developer.apple.com/library/archive/documentation/FileManagement/Conceptual/FileSystemProgrammingGuide/MacOSXDirectories/MacOSXDirectories.html)
- [GitHub Issue: Config dir on macOS should not be ~/Library/Preferences](https://github.com/dirs-dev/directories-rs/issues/62)
- [CodingTechRoom: Where Should an Application Store Its Logs on macOS?](https://codingtechroom.com/question/macos-application-logs-storage)

### Linux
- [XDG Base Directory Specification (freedesktop.org)](https://specifications.freedesktop.org/basedir/latest/)
- [XDG Base Directory - ArchWiki](https://wiki.archlinux.org/title/XDG_Base_Directory)
- [Use the XDG Base Directory Specification!](https://xdgbasedirectoryspecification.com/)
