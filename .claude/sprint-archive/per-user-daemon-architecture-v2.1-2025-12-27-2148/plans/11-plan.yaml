# Plan: 11
# Generated by: discovery:11.d
# Timestamp: 2025-12-25T09:30:00Z

story_id: "11"
title: "Implement v2.0 Installation Detection"
created: "2025-12-25T09:30:00Z"
created_by: "discovery:11.d"

# Analysis Summary
analysis:
  summary: "Create detection module to identify v2.0 installations (~/.graphiti/) and platform-specific service tasks for migration support"
  complexity: "medium"
  estimated_files: 2
  estimated_tokens: 8000
  risk_factors:
    - "Platform-specific service detection requires OS-specific commands"
    - "Permission errors when querying Task Scheduler/launchd/systemd"
    - "False negatives if v2.0 artifacts are partially removed"

# Files to Create
files_to_create:
  - path: "mcp_server/daemon/v2_detection.py"
    purpose: "Detect v2.0 installation artifacts (directory + service/task)"
    pattern_source: "mcp_server/daemon/manager.py"
    estimated_lines: 180
    details:
      - "detect_v2_0_installation() main function"
      - "Platform-specific service detection helpers"
      - "Windows: Query Task Scheduler for GraphitiBootstrap_* tasks"
      - "macOS: Check ~/Library/LaunchAgents/com.graphiti.bootstrap.plist"
      - "Linux: Check systemd user service graphiti-bootstrap.service"
      - "Return structured dict with detection results"

# Files to Modify
files_to_modify:
  - path: "mcp_server/daemon/manager.py"
    changes:
      - "Import v2_detection module"
      - "Add detect_v2_installation() method to DaemonManager"
      - "Call detection before install() to check for v2.0 -> v2.1 upgrade scenario"
    lines_affected: 20

# Integration Points
integration:
  - file: "mcp_server/daemon/manager.py"
    type: "import"
    description: "Import v2_detection module and expose detection method"

  - file: "mcp_server/daemon/manager.py"
    type: "method"
    description: "Add detect_v2_installation() method that calls v2_detection.detect_v2_0_installation()"

# Patterns to Follow
patterns:
  - source: "mcp_server/daemon/manager.py"
    pattern: "Platform detection using platform.system() and conditional logic for Windows/Darwin/Linux"

  - source: "mcp_server/daemon/launchd_service.py"
    pattern: "Service detection using _run_launchctl() helper and checking plist existence"

  - source: "mcp_server/daemon/systemd_service.py"
    pattern: "Service detection using systemctl --user commands and service file checks"

  - source: "mcp_server/daemon/windows_service.py"
    pattern: "NSSM/Task Scheduler detection using sc query or PowerShell commands"

  - source: "mcp_server/daemon/bootstrap.py"
    pattern: "Config path resolution with XDG_CONFIG_HOME support for Unix"

# Test Requirements
test_requirements:
  unit:
    - "Test detect_v2_0_installation() returns False on clean system"
    - "Test detect_v2_0_installation() returns True when ~/.graphiti/ exists"
    - "Test Windows: detection returns True when GraphitiBootstrap_* task exists"
    - "Test macOS: detection returns True when com.graphiti.bootstrap.plist exists"
    - "Test Linux: detection returns True when graphiti-bootstrap.service exists"
    - "Test graceful handling when service query fails (permissions)"
    - "Test correct platform detection (Windows/Darwin/Linux)"
    - "Test return structure contains expected keys (detected, home_dir, config_file, service_task)"

  integration:
    - "Test DaemonManager.detect_v2_installation() calls v2_detection module"
    - "Test detection integrates with install workflow (Story 12 dependency)"
    - "Test detection results can be used by migration module (Story 12)"

  security:
    - "Test no credential leakage in detection output"
    - "Test safe handling of permission denied errors"
    - "Test no arbitrary command execution via service names"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-11.d.1"
    text: "Define v2.0 detection criteria for each platform"
    implementation: "files_to_create[0]"
    tests: "test_requirements.unit[0-6]"
    details:
      - "Document detection logic in module docstring"
      - "Windows: ~/.graphiti/ + GraphitiBootstrap_* task"
      - "macOS: ~/.graphiti/ + com.graphiti.bootstrap LaunchAgent"
      - "Linux: ~/.graphiti/ + graphiti-bootstrap.service"

  - id: "AC-11.d.2"
    text: "Document Windows: ~/.graphiti/, GraphitiBootstrap_* task"
    implementation: "files_to_create[0]"
    tests: "test_requirements.unit[2]"
    details:
      - "Add function docstring explaining Windows detection"
      - "Use sc query or PowerShell to detect task"
      - "Handle task name variations (GraphitiBootstrap, GraphitiBootstrap_User)"

  - id: "AC-11.d.3"
    text: "Document macOS: ~/.graphiti/, com.graphiti.bootstrap LaunchAgent"
    implementation: "files_to_create[0]"
    tests: "test_requirements.unit[3]"
    details:
      - "Add function docstring explaining macOS detection"
      - "Check ~/Library/LaunchAgents/com.graphiti.bootstrap.plist"
      - "Use launchctl list to verify service is loaded"

  - id: "AC-11.d.4"
    text: "Document Linux: ~/.graphiti/, graphiti-bootstrap.service"
    implementation: "files_to_create[0]"
    tests: "test_requirements.unit[4]"
    details:
      - "Add function docstring explaining Linux detection"
      - "Check ~/.config/systemd/user/graphiti-bootstrap.service"
      - "Use systemctl --user status to verify service state"

# Implementation Strategy
implementation_strategy:
  phase_1_discovery:
    - "Define detection criteria for each platform"
    - "Document expected v2.0 artifact locations"
    - "Document service/task naming conventions"
    - "Create this plan artifact"

  phase_2_implementation:
    - "Create v2_detection.py module"
    - "Implement detect_v2_0_installation() function"
    - "Implement platform-specific helpers (_detect_windows_task, _detect_macos_launchagent, _detect_linux_service)"
    - "Integrate into DaemonManager"
    - "Handle permission errors gracefully"

  phase_3_testing:
    - "Unit tests for all detection scenarios"
    - "Integration tests with DaemonManager"
    - "Manual testing on each platform"
    - "Verify graceful error handling"

# Dependencies
dependencies:
  - story: "1"
    title: "Create Platform-Aware Path Resolution Module"
    status: "completed"
    reason: "Provides Path.home() resolution and platform detection patterns"

# Migration Notes
migration_notes:
  v2_0_artifacts:
    - "Directory: ~/.graphiti/"
    - "Config: ~/.graphiti/graphiti.config.json"
    - "Venv: ~/.graphiti/.venv/"
    - "Logs: ~/.graphiti/logs/"

  v2_0_services:
    windows:
      - "Task name: GraphitiBootstrap or GraphitiBootstrap_{username}"
      - "Query command: sc query GraphitiBootstrap"
      - "Alternative: Get-ScheduledTask -TaskName 'GraphitiBootstrap*'"

    macos:
      - "Plist: ~/Library/LaunchAgents/com.graphiti.bootstrap.plist"
      - "Query command: launchctl list | grep com.graphiti.bootstrap"

    linux:
      - "Service: ~/.config/systemd/user/graphiti-bootstrap.service"
      - "Query command: systemctl --user status graphiti-bootstrap"

  detection_return_format:
    ```python
    {
        "detected": bool,           # True if v2.0 installation found
        "home_dir": Path or None,   # ~/.graphiti/ if exists
        "config_file": Path or None,  # ~/.graphiti/graphiti.config.json if exists
        "service_task": str or None   # Service/task name if found
    }
    ```

# Token Budget Breakdown
token_budget:
  discovery_phase: 3500
  implementation_phase: 4000
  testing_phase: 2500
  total: 10000
