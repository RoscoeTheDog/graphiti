# Plan: 4
# Generated by: discovery:4.d
# Timestamp: 2025-12-23T23:45:00Z

story_id: "4"
title: "Fix NSSM service configuration"
created: "2025-12-23T23:45:00Z"
created_by: "discovery:4.d"

# Analysis Summary
analysis:
  summary: "Update NSSM service configuration to use module invocation (-m mcp_server.daemon.bootstrap) instead of direct script execution, and set AppDirectory to ~/.graphiti/ to fix relative import errors and ensure proper working directory."
  complexity: "low"
  estimated_files: 1
  estimated_tokens: 3000
  risk_factors:
    - "Service must be reinstalled to apply changes (requires admin rights)"
    - "Existing service instances may fail to start until reinstalled"
    - "AppDirectory change affects bootstrap.py path resolution"
    - "Must maintain backward compatibility with development scenarios"

# Files to Modify
files_to_modify:
  - path: "mcp_server/daemon/windows_service.py"
    changes:
      - "Modify install() method line ~121-126 to use module invocation: python -m mcp_server.daemon.bootstrap"
      - "Change AppParameters from bootstrap script path to '-m mcp_server.daemon.bootstrap'"
      - "Update AppDirectory from bootstrap_script.parent (mcp_server/daemon/) to ~/.graphiti/"
      - "Remove self.bootstrap_script usage from NSSM install command"
      - "Keep self.bootstrap_script for validation/display purposes (print statements)"
      - "Update working_dir variable (line ~147) to use Path.home() / '.graphiti'"
    lines_affected: 15
    context:
      - "Current implementation: nssm install GraphitiBootstrap {python_exe} {bootstrap_script}"
      - "New implementation: nssm install GraphitiBootstrap {python_exe} -m mcp_server.daemon.bootstrap"
      - "Current AppDirectory: mcp_server/daemon/ (relative to repository)"
      - "New AppDirectory: ~/.graphiti/ (standalone deployment location)"
      - "Reason for change: Module invocation ensures Python can resolve mcp_server package from deployed location"

# Integration Points
integration:
  - file: "mcp_server/daemon/bootstrap.py"
    type: "dependency"
    description: "bootstrap.py must support being invoked as a module (already supports this via if __name__ == '__main__')"

  - file: "mcp_server/daemon/package_deployer.py"
    type: "dependency"
    description: "Package deployer (Story 2) should have deployed mcp_server/ to ~/.graphiti/mcp_server/"

  - file: "mcp_server/daemon/venv_manager.py"
    type: "dependency"
    description: "Venv at ~/.graphiti/.venv/ must have mcp_server installed from requirements.txt (Story 3)"

# Patterns to Follow
patterns:
  - source: "mcp_server/daemon/windows_service.py"
    pattern: "Platform-agnostic path handling using Path.home() / '.graphiti'"

  - source: "mcp_server/daemon/windows_service.py"
    pattern: "NSSM parameter configuration using _run_nssm('set', service_name, parameter, value)"

  - source: "mcp_server/daemon/windows_service.py"
    pattern: "Subprocess execution with error handling and user-friendly messages"

# Test Requirements
test_requirements:
  unit:
    - "Test NSSM install command uses module invocation format"
    - "Test AppParameters is set to '-m mcp_server.daemon.bootstrap'"
    - "Test AppDirectory is set to ~/.graphiti/"
    - "Test service installation succeeds with new configuration"
    - "Test service can be started after installation"
    - "Mock NSSM commands to verify correct parameters"

  integration:
    - "Test service starts successfully with module invocation"
    - "Test service can access deployed package at ~/.graphiti/mcp_server/"
    - "Test service can import mcp_server.daemon.bootstrap without relative import errors"
    - "Test service working directory is ~/.graphiti/"
    - "Test service survives system reboot (manual test)"

  security:
    - "Test AppDirectory path validation (prevent path traversal)"
    - "Test command injection prevention in NSSM parameters"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-4.1"
    text: "(P0) NSSM AppParameters uses -m mcp_server.daemon.bootstrap"
    implementation: "files_to_modify[0] - Change NSSM install command parameters"
    tests: "test_requirements.unit[0,1], integration[0,2]"

  - id: "AC-4.2"
    text: "(P0) NSSM AppDirectory is set to ~/.graphiti/"
    implementation: "files_to_modify[0] - Update AppDirectory configuration"
    tests: "test_requirements.unit[2], integration[3]"

  - id: "AC-4.3"
    text: "(P0) Service starts successfully without relative import errors"
    implementation: "files_to_modify[0] - Module invocation enables proper import resolution"
    tests: "integration[0,2]"

  - id: "AC-4.4"
    text: "(P1) Service survives system reboot and auto-starts"
    implementation: "files_to_modify[0] - No changes needed (already configured with SERVICE_AUTO_START)"
    tests: "integration[4] - Manual test required"

  - id: "AC-4.5"
    text: "(P2) Service logs are written to ~/.graphiti/logs/"
    implementation: "files_to_modify[0] - No changes needed (already configured)"
    tests: "integration - Verify log paths unchanged"

# Implementation Notes
implementation_notes:
  nssm_install_command_change:
    current: "nssm install GraphitiBootstrap {python_exe} {bootstrap_script}"
    new: "nssm install GraphitiBootstrap {python_exe} -m mcp_server.daemon.bootstrap"
    reason: "Module invocation allows Python to resolve mcp_server package from site-packages (installed in venv)"

  app_directory_change:
    current: "{bootstrap_script.parent} (resolves to repository mcp_server/daemon/)"
    new: "Path.home() / '.graphiti'"
    reason: "Service should run from deployment location, not repository"

  module_invocation_benefits:
    - "Python resolves mcp_server from venv site-packages (installed via Story 3)"
    - "No relative import errors (mcp_server is a proper package)"
    - "Works with deployed package at ~/.graphiti/mcp_server/"
    - "Independent of repository location"

  backward_compatibility:
    - "Development scenarios: Developers should use 'python -m mcp_server.daemon.bootstrap' directly"
    - "Service installation still requires admin rights (no change)"
    - "Service uninstall/reinstall required to apply changes"

# Dependencies
dependencies:
  - "Story 2 (Deploy standalone package) MUST be completed first"
  - "Story 3 (Update venv_manager) MUST be completed first"
  - "Reason: Service expects mcp_server to be installed in venv and deployed to ~/.graphiti/"

# Migration Strategy
migration_strategy:
  existing_installations: "Users must uninstall and reinstall service to apply new configuration"
  upgrade_path: "graphiti-mcp daemon uninstall && graphiti-mcp daemon install"
  rollback: "Revert windows_service.py changes and reinstall service"

# Success Criteria
success_criteria:
  - "NSSM install command uses: {python_exe} -m mcp_server.daemon.bootstrap"
  - "NSSM AppDirectory set to: ~/.graphiti/"
  - "Service starts without relative import errors"
  - "Service working directory is ~/.graphiti/"
  - "Service auto-starts on system reboot"
  - "Service logs written to ~/.graphiti/logs/ (unchanged)"

# File Modification Details

## windows_service.py changes

### Current install() method structure (lines 95-177):
```
def install(self) -> bool:
    # 1. Check NSSM available
    # 2. Check if already installed
    # 3. Print installation info (python exe, bootstrap script)
    # 4. Install service: nssm install {service_name} {python_exe} {bootstrap_script}
    # 5. Set display name
    # 6. Set description
    # 7. Set startup type (SERVICE_AUTO_START)
    # 8. Set AppDirectory to {bootstrap_script.parent}
    # 9. Configure logging (stdout/stderr)
    # 10. Start service
```

### Specific code changes:

**Modify install command (lines ~121-126):**

Current:
```python
# Install service
print("Installing service...")
success, output = self._run_nssm(
    "install",
    self.service_name,
    str(self.python_exe),
    str(self.bootstrap_script),
)
```

New:
```python
# Install service with module invocation
print("Installing service...")
success, output = self._run_nssm(
    "install",
    self.service_name,
    str(self.python_exe),
    "-m",
    "mcp_server.daemon.bootstrap",
)
```

**Update AppDirectory (lines ~146-148):**

Current:
```python
# Set working directory to mcp_server/daemon/
working_dir = self.bootstrap_script.parent
self._run_nssm("set", self.service_name, "AppDirectory", str(working_dir))
```

New:
```python
# Set working directory to ~/.graphiti/
working_dir = Path.home() / ".graphiti"
working_dir.mkdir(parents=True, exist_ok=True)  # Ensure directory exists
self._run_nssm("set", self.service_name, "AppDirectory", str(working_dir))
```

**Keep bootstrap_script for display (lines ~114-116):** No changes needed
```python
print(f"Using NSSM: {self.nssm_path}")
print(f"Python: {self.python_exe}")
print(f"Bootstrap script: {self.bootstrap_script}")  # Keep for user info
```

**Note**: bootstrap_script is still calculated in __init__ and used for display purposes. Only the NSSM install command changes to use module invocation.

## Testing approach

### Unit tests (mock NSSM):
- Mock _run_nssm() calls
- Verify install command uses: {python_exe}, "-m", "mcp_server.daemon.bootstrap"
- Verify AppDirectory set to: Path.home() / ".graphiti"
- Verify other NSSM parameters unchanged (DisplayName, Description, Start, etc.)

### Integration tests (requires admin):
- Actually install service with new configuration
- Verify service can start
- Check service status shows SERVICE_RUNNING
- Verify no import errors in logs (~/.graphiti/logs/bootstrap-stderr.log)
- Verify working directory is ~/.graphiti/ (check via NSSM status or logs)

### Manual validation:
- Install service: `graphiti-mcp daemon install`
- Check NSSM registry entries:
  - HKLM\SYSTEM\CurrentControlSet\Services\GraphitiBootstrap
  - AppDirectory should be C:\Users\{user}\.graphiti
  - Application should be {python_exe}
  - AppParameters should be "-m mcp_server.daemon.bootstrap"
- Start service: `nssm start GraphitiBootstrap` or via Services app
- Verify no errors in logs
- Reboot system and verify service auto-starts
