# Story 7.5: Test API Alignment Remediation
**Status**: pending
**Parent**: Story 7
**Type**: remediation
**Priority**: P1
**Created**: 2025-11-27
**Target**: Raise test pass rate from 88.5% to >90%

**Description**: Fix test failures caused by API signature mismatches and outdated mock targets after refactoring. Tests were written against original API contracts that changed during implementation.

## Problem Analysis

**Root Cause**: Tests in `test_regression.py`, `test_performance.py`, and `test_security.py` were written against API signatures that were later refactored. The tests need updating to align with the current implementation.

**Current State**: 154/174 tests passing (88.5%)
**Target**: >156/174 tests passing (>90%)

**Failing Tests by Category**:

### 1. Regression Tests (9 failures)
| Test | Error | Fix Required |
|------|-------|--------------|
| `test_parser_reads_jsonl_format` | `JSONLParser.parse_session_file` doesn't exist | Use `parse_file()` method |
| `test_parser_handles_incremental_parsing` | `JSONLParser.parse_session_file` doesn't exist | Use `parse_file_incremental()` method |
| `test_filter_preserves_user_messages` | Missing `await` on async method | Add `await` to `filter_conversation()` |
| `test_filter_summarizes_tool_results` | Missing `await` on async method | Add `await` to `filter_conversation()` |
| `test_file_watcher_detects_new_sessions` | `SessionManager(watch_path=...)` invalid | Use `path_resolver` parameter |
| `test_file_watcher_discovers_existing_sessions` | `SessionManager(watch_path=...)` invalid | Use `path_resolver` parameter |
| `test_indexer_adds_episodes_to_graphiti` | `SessionIndexer.index_session(messages=...)` invalid | Use `context` parameter |
| `test_session_tracking_status_tool` | `bool.value` attribute error | Fix config access pattern |
| `test_path_resolver_normalizes_windows_paths` | `ClaudePathResolver.normalize_path` doesn't exist | Use `normalize_path_to_unix()` |

### 2. Performance Tests (6 failures)
| Test | Error | Fix Required |
|------|-------|--------------|
| `test_check_inactive_sessions_performance` | `ClaudePathResolver(hostname=..., pwd_hash=...)` invalid | Use `claude_dir` parameter |
| `test_discovery_with_many_sessions` | Same as above | Use `claude_dir` parameter |
| `test_mixed_file_types_performance` | Same as above | Use `claude_dir` parameter |
| `test_template_reads_cached` | `graphiti_core.llms.client` doesn't exist | Update import path |
| `test_filtering_performance_with_keep_length_days` | `ClaudePathResolver` signature | Use `claude_dir` parameter |
| `test_glob_pattern_performance` | `ClaudePathResolver` signature | Use `claude_dir` parameter |

### 3. Security Tests (5 failures)
| Test | Error | Fix Required |
|------|-------|--------------|
| `test_historical_sessions_not_indexed_on_startup` | `session_manager.watchdog` doesn't exist | Update mock target |
| `test_only_sessions_within_rolling_window_indexed` | Same as above | Update mock target |
| `test_watch_path_validation` | Same as above | Update mock target |
| `test_no_sensitive_data_in_logs` | Same as above | Update mock target |
| `test_group_id_isolation` | `PathResolver` class doesn't exist | Use `ClaudePathResolver` |

---

## Acceptance Criteria

- [x] **(P0) AC-7.5.1**: Analyze all 20 failing tests - COMPLETED
- [ ] **(P0) AC-7.5.2**: Fix regression test API mismatches (9 tests)
  - [ ] Update JSONLParser method calls (`parse_file`, `parse_file_incremental`)
  - [ ] Add `await` to async `filter_conversation()` calls
  - [ ] Update SessionManager constructor calls
  - [ ] Fix SessionIndexer.index_session() parameter
  - [ ] Fix session_tracking_status config access
  - [ ] Update ClaudePathResolver method call
- [ ] **(P0) AC-7.5.3**: Fix performance test API mismatches (6 tests)
  - [ ] Update ClaudePathResolver constructor (5 tests)
  - [ ] Fix LLM client import path (1 test)
- [ ] **(P0) AC-7.5.4**: Fix security test mock targets (5 tests)
  - [ ] Update watchdog mock path (4 tests)
  - [ ] Fix PathResolver import (1 test)
- [ ] **(P1) AC-7.5.5**: Run full test suite and verify >90% pass rate
- [ ] **(P1) AC-7.5.6**: Update validation story -7 with new metrics

---

## Implementation Plan

### Phase 1: Regression Test Fixes

**File**: `tests/session_tracking/test_regression.py`

```python
# FIX 1: JSONLParser method names
# OLD: parser.parse_session_file(session_file)
# NEW: parser.parse_file(session_file)

# FIX 2: Async filter calls
# OLD: filtered = filter.filter_conversation(messages)
# NEW: filtered = await filter.filter_conversation(context)

# FIX 3: SessionManager constructor
# OLD: SessionManager(watch_path=path, ...)
# NEW: SessionManager(path_resolver=resolver, ...)

# FIX 4: SessionIndexer.index_session
# OLD: indexer.index_session(messages=msgs)
# NEW: indexer.index_session(context=ctx)

# FIX 5: ClaudePathResolver method
# OLD: resolver.normalize_path(path)
# NEW: normalize_path_to_unix(path)  # module-level function
```

### Phase 2: Performance Test Fixes

**File**: `tests/session_tracking/test_performance.py`

```python
# FIX: ClaudePathResolver constructor
# OLD: ClaudePathResolver(hostname="testhost", pwd_hash="testhash")
# NEW: ClaudePathResolver(claude_dir=Path(tmpdir))

# FIX: LLM client import
# OLD: from graphiti_core.llms.client import LLMClient
# NEW: from graphiti_core.llm_client import LLMClient  # or correct path
```

### Phase 3: Security Test Fixes

**File**: `tests/session_tracking/test_security.py`

```python
# FIX: Mock target for watchdog
# OLD: patch('graphiti_core.session_tracking.session_manager.watchdog')
# NEW: patch('watchdog.observers.Observer')  # or correct import location

# FIX: PathResolver import
# OLD: from graphiti_core.session_tracking.path_resolver import PathResolver
# NEW: from graphiti_core.session_tracking.path_resolver import ClaudePathResolver
```

---

## Verification

After fixes, run:
```bash
pytest tests/session_tracking/ -v --tb=short
```

**Success Criteria**:
- Total tests: 174
- Passed: >156 (>90%)
- Failed: <18

---

## Dependencies

- Story 7 (parent) - completed
- Story 7.1 Integration Testing - completed

## Notes

This is a **P1 non-blocking** remediation. The core functionality works correctly; these are test maintenance issues caused by refactoring after tests were written.

The fixes are mechanical API alignment updates, not functional changes to the implementation.
