# Story 18.2: Add Network and Quota Error Factory Functions

**Type**: remediation
**Remediation Type**: bug_fix
**Parent**: Story 18
**Priority**: P1
**Status**: completed
**Created**: 2025-11-28
**Completed**: 2025-11-28

---

## Context

**Original Story**: 18 - MCP Tools Error Handling
**Current Status**: completed
**Issue**: AC-18.5 specifies actionable error messages for network errors ("Cannot reach LLM provider") and quota exceeded ("Check billing at {provider_url}"). These factory functions are missing.

**Codebase Analysis**:
- Current implementation: `mcp_server/responses.py`
- Existing pattern: `create_llm_unavailable_error()`, `create_llm_auth_error()`, `create_llm_rate_limit_error()`
- Missing: `create_network_error()`, `create_quota_error()`

---

## Remediation Goal

Add `create_network_error()` and `create_quota_error()` factory functions following the existing pattern in responses.py to complete AC-18.5 coverage.

---

## Remediation Actions

### 1. Add ErrorCategory Values (if missing)

**File**: `mcp_server/responses.py`
**Change**: Check if NETWORK and QUOTA_EXCEEDED categories exist, add if missing

```python
class ErrorCategory(Enum):
    """Error categories for actionable error messages."""

    LLM_UNAVAILABLE = "llm_unavailable"
    LLM_AUTHENTICATION = "llm_authentication"
    LLM_RATE_LIMIT = "llm_rate_limit"
    LLM_NETWORK = "llm_network"  # ADD THIS
    LLM_QUOTA_EXCEEDED = "llm_quota_exceeded"  # ADD THIS
    DATABASE_CONNECTION = "database_connection"
    DATABASE_QUERY = "database_query"
    VALIDATION = "validation"
    TIMEOUT = "timeout"
    INTERNAL = "internal"
    CONFIGURATION = "configuration"
```

### 2. Add create_network_error Factory Function

**File**: `mcp_server/responses.py`
**Location**: After `create_llm_rate_limit_error()` (around line 368)

```python
def create_network_error(
    provider: str | None = None,
    retry_after_seconds: float | None = None,
) -> ErrorResponse:
    """Create LLM network error with recovery suggestions (AC-18.5)."""
    provider_str = f" ({provider})" if provider else ""
    suggestion = (
        f"Cannot reach LLM provider{provider_str}. "
        "Check your network connection and verify the provider service is operational. "
        "If using a proxy, ensure it's correctly configured."
    )
    if retry_after_seconds:
        suggestion += f" Retry after {retry_after_seconds} seconds."

    return create_error(
        category=ErrorCategory.LLM_NETWORK,
        message=f"Cannot reach LLM provider{provider_str}",
        recoverable=True,
        suggestion=suggestion,
        retry_after_seconds=retry_after_seconds,
        provider=provider,
    )
```

### 3. Add create_quota_error Factory Function

**File**: `mcp_server/responses.py`
**Location**: After `create_network_error()`

```python
def create_quota_error(
    provider: str | None = None,
    provider_url: str | None = None,
) -> ErrorResponse:
    """Create LLM quota exceeded error with recovery suggestions (AC-18.5)."""
    provider_str = f" ({provider})" if provider else ""

    # Default billing URLs for common providers
    if provider_url is None:
        if provider and provider.lower() == "openai":
            provider_url = "https://platform.openai.com/account/billing"
        elif provider and provider.lower() == "anthropic":
            provider_url = "https://console.anthropic.com/settings/billing"
        else:
            provider_url = "your LLM provider's billing page"

    suggestion = (
        f"LLM quota exceeded{provider_str}. "
        f"Check your billing and usage limits at {provider_url}. "
        "You may need to upgrade your plan or wait for quota reset."
    )

    return create_error(
        category=ErrorCategory.LLM_QUOTA_EXCEEDED,
        message=f"LLM quota exceeded{provider_str}",
        recoverable=False,  # User action required
        suggestion=suggestion,
        provider=provider,
        provider_url=provider_url,
    )
```

### 4. Update __all__ Export List

**File**: `mcp_server/responses.py`
**Change**: Add new functions to exports (if __all__ is used)

```python
# At top of file or in __all__ list
from mcp_server.responses import (
    # ... existing exports ...
    create_network_error,
    create_quota_error,
)
```

---

## Testing

**File**: `tests/mcp_server/test_responses.py`
**Add to TestPreDefinedErrors class**:

```python
def test_create_network_error(self):
    """Test network error factory (AC-18.5)."""
    response = create_network_error(provider="openai")
    assert response.error.category == ErrorCategory.LLM_NETWORK
    assert response.error.recoverable is True
    assert "Cannot reach LLM provider" in response.error.message
    assert "openai" in response.error.message
    assert "network connection" in response.error.suggestion.lower()

def test_create_network_error_with_retry(self):
    """Test network error with retry time."""
    response = create_network_error(retry_after_seconds=30.0)
    assert response.error.retry_after_seconds == 30.0
    assert "30" in response.error.suggestion

def test_create_quota_error(self):
    """Test quota exceeded error factory (AC-18.5)."""
    response = create_quota_error(provider="openai")
    assert response.error.category == ErrorCategory.LLM_QUOTA_EXCEEDED
    assert response.error.recoverable is False
    assert "quota exceeded" in response.error.message.lower()
    assert "billing" in response.error.suggestion.lower()
    assert "platform.openai.com" in response.error.suggestion

def test_create_quota_error_anthropic(self):
    """Test quota error with Anthropic provider."""
    response = create_quota_error(provider="anthropic")
    assert "console.anthropic.com" in response.error.suggestion

def test_create_quota_error_custom_url(self):
    """Test quota error with custom billing URL."""
    response = create_quota_error(
        provider="custom",
        provider_url="https://custom.ai/billing"
    )
    assert "custom.ai/billing" in response.error.suggestion
```

**Update TestEnums class**:

```python
def test_error_category_values(self):
    """Test ErrorCategory enum values."""
    assert ErrorCategory.LLM_UNAVAILABLE.value == "llm_unavailable"
    assert ErrorCategory.LLM_AUTHENTICATION.value == "llm_authentication"
    assert ErrorCategory.LLM_NETWORK.value == "llm_network"  # ADD
    assert ErrorCategory.LLM_QUOTA_EXCEEDED.value == "llm_quota_exceeded"  # ADD
    assert ErrorCategory.DATABASE_CONNECTION.value == "database_connection"
    assert ErrorCategory.VALIDATION.value == "validation"
    assert ErrorCategory.TIMEOUT.value == "timeout"
    assert ErrorCategory.INTERNAL.value == "internal"
```

---

## Acceptance Criteria

- [x] **(P1) AC-18.2.1**: ErrorCategory includes LLM_NETWORK value
- [x] **(P1) AC-18.2.2**: ErrorCategory includes LLM_QUOTA_EXCEEDED value
- [x] **(P1) AC-18.2.3**: create_network_error() factory function exists
- [x] **(P1) AC-18.2.4**: create_quota_error() factory function exists with provider URL support
- [x] **(P1) AC-18.2.5**: All new tests pass

---

## Verification

1. Run `pytest tests/mcp_server/test_responses.py -v`
2. Verify all tests pass (existing + 5 new)
3. Check error messages match AC-18.5 requirements:
   - Network: "Cannot reach LLM provider. Check network connection."
   - Quota: "LLM quota exceeded. Check billing at {provider_url}."

---

## Notes

- **Remediation Type**: bug_fix (missing AC-18.5 error types)
- **Auto-Created**: 2025-11-28
- **Created From**: Validation Story -18 findings
- **Original AC**: AC-18.5 - Provide actionable error messages
