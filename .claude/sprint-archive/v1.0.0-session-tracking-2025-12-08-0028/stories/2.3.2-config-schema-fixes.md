# Story 2.3.2: Configuration Schema Mismatch Fixes

**Status**: completed
**Parent**: Story 2.3
**Created**: 2025-11-17 16:40
**Priority**: HIGH (blocks Story 2.3)
**Claimed**: 2025-11-18 10:56
**Completed**: 2025-11-18 11:03
**Depends on**: Story 2.3.1

## WHO
- **Affected**: All Graphiti users (config schema affects everyone)
- **Stakeholders**: MCP server operators, configuration maintainers

## WHAT
Fix schema mismatches between `graphiti.config.json` and Pydantic models in `mcp_server/unified_config.py` to ensure configuration files load correctly.

## WHEN
**Dependency**: After Story 2.3.1 (config path migration)
**Sequencing**: Second in Story 2.3.x series
**Blocks**: Story 2.3 (can't add filtering config to broken schema)

## WHERE
**Primary files**:
- `graphiti.config.json` (root) - Fix field names and types
- `mcp_server/unified_config.py:320-329` - SessionTrackingConfig class
- `CONFIGURATION.md` (session tracking section) - Update documentation

**Validation files**:
- Any config loading code that uses SessionTrackingConfig

## WHY

### Technical Problem
**Current Issue**: `graphiti.config.json` and `SessionTrackingConfig` have incompatible schemas:

**JSON Schema** (lines not found in current graphiti.config.json):
```json
{
  "session_tracking": {
    "enabled": true,
    "watch_directories": ["~/.claude/projects"],  // ❌ WRONG: array
    "inactivity_timeout_minutes": 30,             // ❌ WRONG: minutes
    "scan_interval_seconds": 2                    // ❌ WRONG: seconds
  }
}
```

**Pydantic Schema** (unified_config.py:320-329):
```python
class SessionTrackingConfig(BaseModel):
    enabled: bool = False
    watch_path: Optional[str] = None              // ✅ CORRECT: string
    inactivity_timeout: int = 300                 // ✅ CORRECT: seconds
    check_interval: int = 60                      // ✅ CORRECT: seconds
    auto_summarize: bool = True
    store_in_graph: bool = True
```

**Mismatch Summary**:
| Field | JSON (Docs) | Python (Code) | Issue |
|-------|-------------|---------------|-------|
| watch path | `watch_directories` (array) | `watch_path` (string) | ❌ Name + type mismatch |
| timeout | `inactivity_timeout_minutes` | `inactivity_timeout` (seconds) | ❌ Name + unit mismatch |
| scan | `scan_interval_seconds` | `check_interval` | ❌ Name mismatch |

### User Impact
- Configuration files fail to load (Pydantic validation error)
- Users confused by docs vs actual behavior
- Can't configure session tracking properly

### Business Value
- **Reliability**: Config files load without errors
- **Usability**: Field names match documentation
- **Maintainability**: Single source of truth for schema

## Description

### Current State (BROKEN)

**Evidence from codebase review**:
1. `graphiti.config.json` (root) has NO `session_tracking` section
2. `CONFIGURATION.md` documents incorrect field names (`watch_directories`, `inactivity_timeout_minutes`)
3. `unified_config.py` defines SessionTrackingConfig with different names

**Root Cause**: Documentation was written before implementation, never synced.

### Target State (FIXED)

**Decision**: Pydantic model is source of truth (it's what code uses)

**Fix Strategy**:
1. Add `session_tracking` section to `graphiti.config.json` using Pydantic field names
2. Update `CONFIGURATION.md` to match Pydantic schema
3. Add schema validation to catch future mismatches

## Acceptance Criteria

### Configuration File Fixes
- [ ] Add `session_tracking` section to `graphiti.config.json`:
  ```json
  {
    "session_tracking": {
      "enabled": false,
      "watch_path": null,
      "inactivity_timeout": 300,
      "check_interval": 60,
      "auto_summarize": true,
      "store_in_graph": true
    }
  }
  ```
- [ ] Verify JSON is valid (no syntax errors)
- [ ] Verify field names match `SessionTrackingConfig` exactly

### Documentation Fixes
- [ ] Update `CONFIGURATION.md` session tracking section:
  - [ ] Replace `watch_directories` → `watch_path`
  - [ ] Replace `inactivity_timeout_minutes` → `inactivity_timeout` (note: seconds, not minutes)
  - [ ] Replace `scan_interval_seconds` → `check_interval`
  - [ ] Add field descriptions matching Pydantic docstrings
  - [ ] Update all examples to use correct field names

### Pydantic Model Review
- [ ] Review `SessionTrackingConfig` (unified_config.py:320-329):
  - [ ] Add docstrings for each field
  - [ ] Add field descriptions for JSON schema generation
  - [ ] Consider: Should `watch_path` support multiple paths? (future Story 2.3.4?)
- [ ] Review other config classes for similar mismatches:
  - [ ] `DatabaseConfig`
  - [ ] `LLMConfig`
  - [ ] `EmbedderConfig`
  - [ ] `ResilienceConfig`
  - [ ] `MCPServerConfig`

### Testing
- [ ] Test config loading from `graphiti.config.json`:
  ```python
  config = GraphitiConfig.from_file("./graphiti.config.json")
  assert config.session_tracking.enabled == False
  assert config.session_tracking.watch_path is None
  assert config.session_tracking.inactivity_timeout == 300
  ```
- [ ] Test config loading with custom values:
  ```json
  {
    "session_tracking": {
      "enabled": true,
      "watch_path": "/custom/path",
      "inactivity_timeout": 600
    }
  }
  ```
- [ ] Test Pydantic validation rejects old field names:
  ```json
  {
    "session_tracking": {
      "watch_directories": ["~/.claude/projects"]
    }
  }
  ```
  Expected: ValidationError (unknown field)

### Validation
- [ ] Run config validator (Story 2.3.3 dependency)
- [ ] Check all config files in repo load successfully
- [ ] Verify no Pydantic validation errors in logs

## Implementation Notes

### Design Decisions

**Why Pydantic schema wins?**
- Code is source of truth (documentation can be wrong, code can't)
- Pydantic validation catches errors early
- Type safety ensures correctness

**Why not support both field names?**
- Increases complexity (field aliases, deprecation warnings)
- No users exist yet (session tracking is v0.4.0, not released)
- Clean break is simpler than migration path

**Field Name Rationale**:
- `watch_path` (string) simpler than `watch_directories` (array)
  - Future: Support multiple paths via Story 2.3.4 if needed
  - Current: Single path sufficient for MVP
- `inactivity_timeout` in seconds (standard for timeouts)
  - No need for `_minutes` suffix (units documented)
- `check_interval` shorter than `scan_interval_seconds`
  - Consistent with other `*_interval` fields

### Migration Impact

**Breaking Change?**
- NO: Session tracking not in any released version
- NO: `graphiti.config.json` in repo has no `session_tracking` section
- YES for documentation readers: Field names change

**Mitigation**:
- Update documentation immediately
- Add changelog entry: "Session tracking field names changed"

### Schema Validation (Story 2.3.3 Integration)

Once Story 2.3.3 is complete, add automated validation:
```python
# Validate JSON schema matches Pydantic schema
def test_config_schema_matches_json():
    with open("graphiti.config.json") as f:
        json_config = json.load(f)

    # Should not raise ValidationError
    config = GraphitiConfig.model_validate(json_config)
```

## Cross-Cutting Requirements

- [ ] **Type Safety**: Pydantic models enforce types at runtime
- [ ] **Error Handling**: Validation errors provide clear field names
- [ ] **Logging**: Log when config file has validation errors
- [ ] **Testing**: Unit tests verify schema compatibility
- [ ] **Documentation**: CONFIGURATION.md accurate and complete
- [ ] **Backward Compatibility**: N/A (feature not released yet)

## Success Metrics

- [ ] `graphiti.config.json` loads without Pydantic validation errors
- [ ] All field names in docs match Pydantic models
- [ ] Config validator (Story 2.3.3) passes all checks
- [ ] No schema mismatch warnings in logs

## Schema Mismatch Checklist

Run these checks to find ALL mismatches:

```bash
# 1. Find all Pydantic config classes
grep -n "class.*Config(BaseModel)" mcp_server/unified_config.py

# 2. For each class, list field names
grep -A 20 "class SessionTrackingConfig" mcp_server/unified_config.py | grep "^\s*[a-z_]*:"

# 3. Compare with graphiti.config.json
cat graphiti.config.json | jq '.session_tracking | keys'

# 4. Check CONFIGURATION.md examples
grep -A 10 "session_tracking" CONFIGURATION.md
```

**Known Mismatches** (to fix):
1. ✅ `session_tracking` section - Missing from graphiti.config.json
2. ✅ `watch_directories` → `watch_path` - Field name change
3. ✅ `inactivity_timeout_minutes` → `inactivity_timeout` - Field name + unit change
4. ✅ `scan_interval_seconds` → `check_interval` - Field name change

**Potential Mismatches** (to check):
- Other config sections in CONFIGURATION.md vs unified_config.py
- Environment variable names (e.g., `GRAPHITI_SESSION_TRACKING_WATCH_DIRECTORIES`)

## Related Stories

- **Depends on**: Story 2.3.1 (Config Architecture Fix)
- **Blocks**: Story 2.3 (Configurable Filtering System)
- **Enables**: Story 2.3.3 (Config Validator)
- **Future**: Story 2.3.4 (Multi-path session tracking) - if `watch_path` needs to become array

## Estimated Effort

- Config file updates: 30 minutes
- Documentation updates: 1-2 hours
- Pydantic model review: 1 hour
- Testing: 1 hour
- Schema mismatch audit: 1 hour
- Total: 4-5 hours
