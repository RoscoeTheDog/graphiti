# Story 18.1: Add episode_id and processing_time_ms to Response Types

**Type**: remediation
**Remediation Type**: bug_fix
**Parent**: Story 18
**Priority**: P0
**Status**: completed
**Created**: 2025-11-28
**Completed**: 2025-11-28

---

## Context

**Original Story**: 18 - MCP Tools Error Handling
**Current Status**: completed
**Issue**: AC-18.2 requires all responses to include `status`, `message`, `episode_id`, and `processing_time_ms`. Currently `episode_id` is only in QueuedResponse, and `processing_time_ms` is not implemented at all.

**Codebase Analysis**:
- Current implementation: `mcp_server/responses.py`
- Integration point: `mcp_server/graphiti_mcp_server.py` add_memory() function
- Pattern: Dataclass-based response types with `to_dict()` serialization

---

## Remediation Goal

Add `episode_id` and `processing_time_ms` fields to `SuccessResponse` and `DegradedResponse` classes so all response types include the required fields per AC-18.2.

---

## Remediation Actions

### 1. Add Fields to SuccessResponse

**File**: `mcp_server/responses.py`
**Change**: Add optional episode_id and processing_time_ms fields to SuccessResponse dataclass

```python
@dataclass
class SuccessResponse:
    """
    Full success response (AC-18.1).

    Indicates the operation completed successfully with full processing.
    """

    status: Literal[ResponseStatus.SUCCESS] = ResponseStatus.SUCCESS
    message: str = "Operation completed successfully"
    data: dict[str, Any] | None = None
    episode_id: str | None = None  # ADD THIS
    processing_time_ms: float | None = None  # ADD THIS
    timestamp: datetime = field(default_factory=lambda: datetime.now(timezone.utc))

    def to_dict(self) -> dict[str, Any]:
        """Convert to dictionary for JSON serialization."""
        result = {
            "status": self.status.value,
            "message": self.message,
            "timestamp": self.timestamp.isoformat(),
        }
        if self.data:
            result["data"] = self.data
        if self.episode_id:  # ADD THIS
            result["episode_id"] = self.episode_id
        if self.processing_time_ms is not None:  # ADD THIS
            result["processing_time_ms"] = self.processing_time_ms
        return result
```

**Rationale**: Follows existing pattern of optional fields with conditional serialization.

### 2. Add Fields to DegradedResponse

**File**: `mcp_server/responses.py`
**Change**: Add optional episode_id and processing_time_ms fields to DegradedResponse dataclass

```python
@dataclass
class DegradedResponse:
    """
    Degraded success response (AC-18.2).
    ...
    """

    status: Literal[ResponseStatus.DEGRADED] = ResponseStatus.DEGRADED
    message: str = "Operation completed with degraded functionality"
    reason: DegradationReason = DegradationReason.LLM_UNAVAILABLE
    data: dict[str, Any] | None = None
    limitations: list[str] | None = None
    episode_id: str | None = None  # ADD THIS
    processing_time_ms: float | None = None  # ADD THIS
    timestamp: datetime = field(default_factory=lambda: datetime.now(timezone.utc))

    def to_dict(self) -> dict[str, Any]:
        """Convert to dictionary for JSON serialization."""
        result = {
            "status": self.status.value,
            "message": self.message,
            "reason": self.reason.value,
            "timestamp": self.timestamp.isoformat(),
        }
        if self.data:
            result["data"] = self.data
        if self.limitations:
            result["limitations"] = self.limitations
        if self.episode_id:  # ADD THIS
            result["episode_id"] = self.episode_id
        if self.processing_time_ms is not None:  # ADD THIS
            result["processing_time_ms"] = self.processing_time_ms
        return result
```

### 3. Update Factory Functions

**File**: `mcp_server/responses.py`
**Change**: Update create_success and create_degraded to accept new parameters

```python
def create_success(
    message: str = "Operation completed successfully",
    episode_id: str | None = None,
    processing_time_ms: float | None = None,
    **data
) -> SuccessResponse:
    """Create a success response with optional data."""
    return SuccessResponse(
        message=message,
        data=data if data else None,
        episode_id=episode_id,
        processing_time_ms=processing_time_ms
    )


def create_degraded(
    reason: DegradationReason,
    message: str | None = None,
    limitations: list[str] | None = None,
    episode_id: str | None = None,
    processing_time_ms: float | None = None,
    **data,
) -> DegradedResponse:
    """Create a degraded response."""
    if message is None:
        message = f"Operation completed with degraded functionality: {reason.value}"
    return DegradedResponse(
        message=message,
        reason=reason,
        data=data if data else None,
        limitations=limitations,
        episode_id=episode_id,
        processing_time_ms=processing_time_ms,
    )
```

### 4. Update add_memory() to Track Processing Time

**File**: `mcp_server/graphiti_mcp_server.py`
**Change**: Track processing time and pass to response creation

In the add_memory() function, add timing at the start:
```python
import time

async def add_memory(...):
    start_time = time.perf_counter()
    # ... existing code ...
```

And update the response creation section (around line 1310-1340):
```python
    # Calculate processing time
    processing_time_ms = (time.perf_counter() - start_time) * 1000

    if is_degraded:
        response = create_degraded(
            reason=degradation_reason or DegradationReason.LLM_UNAVAILABLE,
            message=f"Episode '{name}' stored with degraded functionality",
            limitations=limitations,
            episode_name=name,
            group_id=group_id_str,
            saved_to=file_saved_path,
            processing_time_ms=processing_time_ms,  # ADD THIS
        )
        # ...
    else:
        # For success, we don't have episode_id yet (queued processing)
        # processing_time_ms reflects queue time only
        # ...
```

---

## Testing

**File**: `tests/mcp_server/test_responses.py`
**Add tests**:

```python
class TestResponseFields:
    """Tests for AC-18.2 response fields."""

    def test_success_response_with_episode_id(self):
        """Test success response with episode_id."""
        response = SuccessResponse(
            message="Episode added",
            episode_id="ep-123",
            processing_time_ms=150.5
        )
        result = response.to_dict()
        assert result["episode_id"] == "ep-123"
        assert result["processing_time_ms"] == 150.5

    def test_degraded_response_with_episode_id(self):
        """Test degraded response with episode_id."""
        response = DegradedResponse(
            message="Stored raw",
            episode_id="ep-456",
            processing_time_ms=200.0
        )
        result = response.to_dict()
        assert result["episode_id"] == "ep-456"
        assert result["processing_time_ms"] == 200.0

    def test_create_success_factory_with_fields(self):
        """Test create_success factory with new fields."""
        response = create_success(
            "Episode added",
            episode_id="ep-789",
            processing_time_ms=100.0,
            extra_data="value"
        )
        assert response.episode_id == "ep-789"
        assert response.processing_time_ms == 100.0
        assert response.data["extra_data"] == "value"

    def test_create_degraded_factory_with_fields(self):
        """Test create_degraded factory with new fields."""
        response = create_degraded(
            reason=DegradationReason.LLM_UNAVAILABLE,
            episode_id="ep-101",
            processing_time_ms=250.0
        )
        assert response.episode_id == "ep-101"
        assert response.processing_time_ms == 250.0
```

---

## Acceptance Criteria

- [x] **(P0) AC-18.1.1**: SuccessResponse includes optional episode_id field
- [x] **(P0) AC-18.1.2**: SuccessResponse includes optional processing_time_ms field
- [x] **(P0) AC-18.1.3**: DegradedResponse includes optional episode_id field
- [x] **(P0) AC-18.1.4**: DegradedResponse includes optional processing_time_ms field
- [x] **(P0) AC-18.1.5**: Factory functions accept new parameters
- [x] **(P0) AC-18.1.6**: All new tests pass

---

## Verification

1. Run `pytest tests/mcp_server/test_responses.py -v`
2. Verify all 38+ tests pass (existing + new)
3. Check response serialization includes new fields when provided

---

## Notes

- **Remediation Type**: bug_fix (missing required fields)
- **Auto-Created**: 2025-11-28
- **Created From**: Validation Story -18 findings
- **Original AC**: AC-18.2 - All responses include status, message, episode_id, processing_time_ms
