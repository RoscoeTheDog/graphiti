# Plan: R2
# Generated by: discovery:R2.d
# Timestamp: 2025-12-05T16:45:00Z

story_id: "R2"
title: "Remove session_tracking_start/stop MCP tools"
created: "2025-12-05T16:45:00Z"
created_by: "discovery:R2.d"

# Analysis Summary
analysis:
  summary: |
    Remove control-oriented MCP tools (session_tracking_start, session_tracking_stop) following
    the principle that session tracking is a background service, not client-controlled. The
    session tracking behavior should be determined by configuration (graphiti.config.json),
    not runtime MCP calls. This also removes the runtime_session_tracking_state variable and
    simplifies session_tracking_status to remove runtime_override references.
  complexity: "medium"
  estimated_files: 8
  estimated_tokens: 12000
  risk_factors:
    - "Breaking change for any clients using these MCP tools"
    - "Need to verify no other code depends on runtime_session_tracking_state"
    - "Documentation must be updated to reflect config-only control"

# Philosophy
philosophy: |
  Session tracking is a background SERVICE, not a client-controlled feature.
  MCP tools should be read-only (monitoring/diagnostics), not control operations.
  Control should come from:
  - Configuration file (graphiti.config.json)
  - CLI commands (for operators)
  NOT from:
  - MCP tool calls (client-side control)

# Files to Modify (Code)
files_to_modify:
  - path: "mcp_server/graphiti_mcp_server.py"
    changes:
      - "Remove session_tracking_start function (lines 1905-1993)"
      - "Remove session_tracking_stop function (lines 1996-2052)"
      - "Remove runtime_session_tracking_state variable (line 114)"
      - "Remove runtime_session_tracking_state from global declarations in session_tracking_status"
      - "Simplify session_tracking_status to remove runtime_override logic (lines 2124-2131)"
      - "Remove runtime check in on_session_closed callback (lines 2720-2724)"
    lines_affected: 200
    breaking_change: true

# Files to Modify (Tests)
files_to_modify_tests:
  - path: "tests/mcp/test_session_tracking_tools.py"
    changes:
      - "Remove TestSessionTrackingStart class entirely"
      - "Remove TestSessionTrackingStop class entirely"
      - "Keep TestSessionTrackingStatus (but update to not expect runtime_override)"
    lines_affected: 150

  - path: "tests/session_tracking/test_regression.py"
    changes:
      - "Remove test_session_tracking_start_tool test method (line 221+)"
    lines_affected: 20

  - path: "tests/test_backward_compatibility.py"
    changes:
      - "Remove any references to session_tracking_start/stop if present"
    lines_affected: 10

  - path: "tests/session_tracking/test_security.py"
    changes:
      - "Remove any references to session_tracking_start/stop if present"
    lines_affected: 10

# Files to Modify (Documentation)
files_to_modify_docs:
  - path: "docs/MCP_TOOLS.md"
    changes:
      - "Remove session_tracking_start section (lines 220-265)"
      - "Remove session_tracking_stop section (lines 268-310)"
      - "Update introduction to clarify tools are read-only/monitoring"
    lines_affected: 100

  - path: "docs/SESSION_TRACKING_USER_GUIDE.md"
    changes:
      - "Remove session_tracking_start example (lines 130-140)"
      - "Remove session_tracking_stop example (lines 141-145)"
      - "Update to emphasize config-based control"
    lines_affected: 30

  - path: "docs/API_REFERENCE.md"
    changes:
      - "Remove session_tracking_start section (lines 343-365)"
      - "Remove session_tracking_stop section (lines 368-380)"
    lines_affected: 40

  - path: "docs/ARCHITECTURE.md"
    changes:
      - "Remove session_tracking_start/stop from MCP tool list (lines 280-281)"
      - "Remove code example showing session_tracking_start (line 372)"
      - "Update architecture description to reflect config-only control"
    lines_affected: 20

  - path: "docs/SESSION_TRACKING_DEV_GUIDE.md"
    changes:
      - "Remove session_tracking_start/stop from tool list (lines 1060-1061)"
      - "Update developer documentation"
    lines_affected: 10

  - path: "docs/SESSION_TRACKING_MIGRATION.md"
    changes:
      - "Remove session_tracking_start example (line 303)"
      - "Update migration guide to reflect new config-only model"
    lines_affected: 10

# Integration Points
integration:
  - file: "mcp_server/graphiti_mcp_server.py"
    type: "removal"
    description: "Remove @mcp.tool() decorated functions"

  - file: "mcp_server/graphiti_mcp_server.py"
    type: "simplification"
    description: "Simplify session_tracking_status to remove runtime_override concept"

# Patterns to Follow
patterns:
  - source: "mcp_server/graphiti_mcp_server.py (existing read-only tools)"
    pattern: "session_tracking_status, session_tracking_health, get_failed_episodes are read-only tools - follow this pattern"

  - source: "CONFIGURATION.md"
    pattern: "Session tracking control via graphiti.config.json -> session_tracking.enabled"

# Acceptance Criteria
acceptance_criteria:
  - id: "AC-R2.1"
    text: "session_tracking_start MCP tool removed from graphiti_mcp_server.py"
    implementation: "files_to_modify[0] - remove function"
    tests: "Verify MCP server starts without the tool"

  - id: "AC-R2.2"
    text: "session_tracking_stop MCP tool removed from graphiti_mcp_server.py"
    implementation: "files_to_modify[0] - remove function"
    tests: "Verify MCP server starts without the tool"

  - id: "AC-R2.3"
    text: "runtime_session_tracking_state variable removed"
    implementation: "files_to_modify[0] - remove global variable"
    tests: "Verify no NameError when server runs"

  - id: "AC-R2.4"
    text: "Session callback runtime check removed (on_session_closed)"
    implementation: "files_to_modify[0] - simplify callback"
    tests: "Verify sessions index based on config only"

  - id: "AC-R2.5"
    text: "session_tracking_status simplified (no runtime_override)"
    implementation: "files_to_modify[0] - update function"
    tests: "test_session_tracking_status updated expectations"

  - id: "AC-R2.6"
    text: "All related tests removed or updated"
    implementation: "files_to_modify_tests[*]"
    tests: "pytest passes with test changes"

  - id: "AC-R2.7"
    text: "Documentation updated to remove references to removed tools"
    implementation: "files_to_modify_docs[*]"
    tests: "Manual doc review, no broken links"

# Test Requirements
test_requirements:
  unit:
    - "Remove TestSessionTrackingStart class tests"
    - "Remove TestSessionTrackingStop class tests"
    - "Update TestSessionTrackingStatus to not expect runtime_override field"
    - "Verify session_tracking_status returns valid JSON without runtime_override"

  integration:
    - "MCP server starts successfully without removed tools"
    - "Session tracking works based on config.session_tracking.enabled only"
    - "session_tracking_status tool returns correct config state"
    - "session_tracking_health tool still works correctly"
    - "Session indexing works without runtime state checks"

  regression:
    - "Existing session tracking functionality not broken"
    - "Config-based enable/disable still works"
    - "All other MCP tools still functional"

# Implementation Order
implementation_order:
  1: "Remove runtime_session_tracking_state variable declaration"
  2: "Remove session_tracking_start function"
  3: "Remove session_tracking_stop function"
  4: "Simplify session_tracking_status (remove runtime_override logic)"
  5: "Simplify on_session_closed callback (remove runtime check)"
  6: "Update test files"
  7: "Update documentation files"

# Breaking Changes
breaking_changes:
  - tool: "session_tracking_start"
    impact: "Clients calling this tool will get 'unknown tool' error"
    mitigation: "Use graphiti.config.json -> session_tracking.enabled instead"

  - tool: "session_tracking_stop"
    impact: "Clients calling this tool will get 'unknown tool' error"
    mitigation: "Use graphiti.config.json -> session_tracking.enabled instead"

# Rollback Plan
rollback:
  strategy: "Git revert of implementation commit"
  verification: "Run pytest to verify tools restored"
