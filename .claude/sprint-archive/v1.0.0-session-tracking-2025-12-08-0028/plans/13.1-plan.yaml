# Story 13.1 Implementation Plan
# Generated by /sprint:NEXT discovery phase
# Date: 2025-12-04

story_id: "13.1"
title: "MCP Tool Wiring for Manual Sync"
type: feature
status: plan_ready

discovery_summary:
  core_logic: "COMPLETE - mcp_server/manual_sync.py (274 lines)"
  mcp_wrapper: "EXISTS but MISSING @mcp.tool() decorator"
  documentation: "COMPLETE - docs/MCP_TOOLS.md line 370"
  tests: "PARTIAL - core logic tested, MCP wrapper not tested"

gap_analysis:
  - id: "GAP-1"
    severity: "critical"
    description: "Missing @mcp.tool() decorator on session_tracking_sync_history"
    location: "mcp_server/graphiti_mcp_server.py:2416"
    effort: "1 line"

  - id: "GAP-2"
    severity: "low"
    description: "No unit test for MCP tool wrapper"
    location: "tests/mcp/test_session_tracking_tools.py"
    effort: "~20 lines"

implementation_steps:
  - step: 1
    action: "Add @mcp.tool() decorator"
    file: "mcp_server/graphiti_mcp_server.py"
    line: 2416
    change: |
      Before line 2417 (async def session_tracking_sync_history):
      Add: @mcp.tool()

  - step: 2
    action: "Add MCP wrapper test"
    file: "tests/mcp/test_session_tracking_tools.py"
    change: |
      Add new test class:
      class TestSessionTrackingSyncHistory:
          - test_sync_history_not_initialized()
          - test_sync_history_dry_run()
          - test_sync_history_parameters()

testing_requirements:
  - "Verify tool appears in MCP tool list"
  - "Test dry_run=True returns preview"
  - "Test session_manager=None returns error"
  - "Test parameter validation (days, max_sessions)"

files_to_modify:
  - path: "mcp_server/graphiti_mcp_server.py"
    changes: 1
    description: "Add @mcp.tool() decorator at line 2416"

  - path: "tests/mcp/test_session_tracking_tools.py"
    changes: 1
    description: "Add TestSessionTrackingSyncHistory class"

estimated_effort:
  implementation: "10 minutes"
  testing: "20 minutes"
  total: "30 minutes"

acceptance_criteria_mapping:
  - ac: "Add session_tracking_sync_history tool to mcp_server/graphiti_mcp_server.py"
    status: "DONE - function exists, needs decorator"
    gap: "GAP-1"

  - ac: "Tool parameters: project, days, max_sessions, dry_run"
    status: "DONE - parameters already defined"
    gap: null

  - ac: "Tool returns JSON response matching existing function signature"
    status: "DONE - delegates to _session_tracking_sync_history"
    gap: null

  - ac: "Tool validates session_manager is initialized before calling"
    status: "DONE - handled in manual_sync.py"
    gap: null

  - ac: "Add unit test for MCP tool wrapper"
    status: "NOT DONE"
    gap: "GAP-2"

  - ac: "Update MCP_TOOLS.md documentation"
    status: "DONE - docs/MCP_TOOLS.md line 370"
    gap: null

notes:
  - "The vast majority of work is already complete"
  - "Core logic exists in manual_sync.py with comprehensive tests"
  - "MCP wrapper exists but was never decorated as a tool"
  - "Documentation was written proactively before tool was wired"
