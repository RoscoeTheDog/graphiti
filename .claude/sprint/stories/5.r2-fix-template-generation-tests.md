# Story 5.r2: Fix Template Generation Tests

**Type**: remediation
**Remediation Type**: bug_fix
**Parent**: Story 5
**Priority**: P0
**Created**: 2025-12-14T17:05:00Z

---

## Context

**Original Story**: 5 - Bootstrap Service Update
**Current Status**: unassigned
**Issue**: Template generation tests assume wrong method names - WindowsServiceManager doesn't have `_create_service_xml`, it uses NSSM directly

**Test Failures**:
- `test_windows_service_template_uses_venv_python` (FAILED - AttributeError: '_create_service_xml')
- `test_launchd_plist_uses_venv_python` (FAILED - assumes wrong method name)

**Codebase Analysis**:
- Current implementation: WindowsServiceManager uses NSSM commands, NOT XML templates
- Service installation: Lines 119-177 in `windows_service.py` - uses `_run_nssm()` to configure service
- No template methods exist: `_create_service_xml`, `_create_plist`, `_create_service_unit` don't exist
- Tests assume template-based approach but implementation uses direct command-line configuration

---

## Remediation Goal

Fix tests to match actual implementation - service managers use command-line tools (NSSM, launchctl, systemctl), not template files. Tests should verify venv Python path is passed to installation commands, not template content.

---

## Remediation Actions

### 1. Fix Windows Service Template Test

**File**: `tests/daemon/test_service_venv_integration.py`
**Change**: Update `test_windows_service_template_uses_venv_python` to test actual NSSM installation

**Current Test** (lines 233-250 - WRONG):
```python
def test_windows_service_template_uses_venv_python(self):
    """Windows service XML template uses venv Python path"""
    service_manager = WindowsServiceManager(venv_manager=mock_venv)

    # Mock _create_service_xml method (DOESN'T EXIST)
    with patch.object(service_manager, '_create_service_xml') as mock_create_xml:
        mock_create_xml.return_value = f'<python>{venv_python}</python>'
        xml_content = service_manager._create_service_xml()
        assert venv_python in xml_content
```

**Fixed Test**:
```python
def test_windows_service_template_uses_venv_python(self):
    """Windows service uses venv Python path in NSSM install command"""
    with patch('platform.system', return_value='Windows'):
        mock_venv = Mock(spec=VenvManager)
        venv_python = str(Path.home() / '.graphiti' / '.venv' / 'Scripts' / 'python.exe')
        mock_venv.get_python_executable.return_value = venv_python

        service_manager = WindowsServiceManager(venv_manager=mock_venv)

        # Mock NSSM execution to verify venv Python is used
        with patch.object(service_manager, '_run_nssm') as mock_nssm:
            with patch.object(service_manager, 'is_installed', return_value=False):
                mock_nssm.return_value = (True, "Service installed")

                # Call install() - should pass venv_python to NSSM
                service_manager.install()

                # Verify NSSM install command used venv Python (not sys.executable)
                install_call = mock_nssm.call_args_list[0]  # First call is 'install'
                assert 'install' in install_call[0]
                assert venv_python in str(install_call[0])
                assert sys.executable not in str(install_call[0])
```

**Rationale**: Test actual implementation (NSSM commands) instead of non-existent template methods.

### 2. Fix macOS Launchd Test

**File**: `tests/daemon/test_service_venv_integration.py`
**Change**: Update `test_launchd_plist_uses_venv_python` to test actual launchctl/plist generation

**Pattern**: Check if LaunchdServiceManager has template methods or uses direct command-line approach. If no `_create_plist` method exists, update test similar to Windows pattern.

**If plist IS generated**: Test plist content includes venv Python path
**If plist NOT generated**: Test installation command uses venv Python path

### 3. Check and Fix Systemd Test

**File**: `tests/daemon/test_service_venv_integration.py`
**Change**: Update `test_systemd_unit_uses_venv_python` if needed

**Pattern**: Same as above - verify SystemdServiceManager implementation, update test to match.

### 4. Update Test Documentation

**All three test methods**: Update docstrings to reflect actual testing approach:

```python
def test_windows_service_template_uses_venv_python(self):
    """Windows service NSSM install command uses venv Python path"""
```

---

## Testing

**Tests to Fix** (should pass after remediation):
- `test_windows_service_template_uses_venv_python`
- `test_launchd_plist_uses_venv_python`
- `test_systemd_unit_uses_venv_python` (if failing)

**Verification Pattern**:
1. Run template tests: `pytest tests/daemon/test_service_venv_integration.py::TestServiceTemplateGeneration -v`
2. Verify all tests pass (no AttributeError)
3. Verify tests check actual implementation (NSSM/launchctl/systemctl commands)

---

## Implementation Steps

1. **Inspect LaunchdServiceManager and SystemdServiceManager**:
   - Check if they have `_create_plist` / `_create_service_unit` methods
   - Identify actual installation mechanism (template files vs direct commands)

2. **Fix WindowsServiceManager test** (already analyzed):
   - Replace non-existent `_create_service_xml` with actual NSSM command verification
   - Test pattern: Mock `_run_nssm`, verify venv Python in install command

3. **Fix LaunchdServiceManager test** (check implementation first):
   - Read `mcp_server/daemon/launchd_service.py`
   - Update test to match actual plist generation or command-line approach

4. **Fix SystemdServiceManager test** (check implementation first):
   - Read `mcp_server/daemon/systemd_service.py`
   - Update test to match actual unit file generation or command-line approach

---

## Acceptance Criteria

- [ ] **(P0) AC-5.r2.1**: `test_windows_service_template_uses_venv_python` passes (tests NSSM install command)
- [ ] **(P0) AC-5.r2.2**: `test_launchd_plist_uses_venv_python` passes (tests actual implementation)
- [ ] **(P0) AC-5.r2.3**: `test_systemd_unit_uses_venv_python` passes (tests actual implementation)
- [ ] **(P1) AC-5.r2.4**: Test docstrings accurately describe what's being tested
- [ ] **(P1) AC-5.r2.5**: No AttributeError on non-existent methods

---

## Verification

1. Run template tests: `pytest tests/daemon/test_service_venv_integration.py::TestServiceTemplateGeneration -v`
2. Verify 3/3 tests pass (or 1/1 if only Windows test existed)
3. Verify tests mock actual service manager methods (not non-existent template methods)
4. Check test output shows venv Python path being used (not sys.executable)

---

## Notes

- **Remediation Type**: bug_fix (P0 - tests failing due to incorrect assumptions)
- **Auto-Created**: 2025-12-14T17:05:00Z
- **Created From**: Test failure analysis for Story 5.t
- **Original Request**: "Story 5.t failed - fix template generation tests"
- **Root Cause**: Tests assume template-based service installation, but implementation uses direct command-line configuration
- **Fix Strategy**: Update tests to verify actual implementation (NSSM/launchctl/systemctl commands)

---

**Created**: 2025-12-14T17:05:00Z
