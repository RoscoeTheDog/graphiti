# Story 5.r3: Fix Integration Test - Wrapper Generation Mocking

**Type**: remediation
**Remediation Type**: bug_fix
**Parent**: Story 5
**Priority**: P0
**Created**: 2025-12-14T17:10:00Z

---

## Context

**Original Story**: 5 - Bootstrap Service Update
**Current Status**: unassigned
**Issue**: DaemonManager.install() integration test fails because wrapper generation validates actual venv existence on disk, but test only mocks venv_manager methods

**Test Failure**:
- `test_daemon_manager_passes_venv_manager_to_service_manager` (FAILED)
- Error: "Wrapper generation failed: Venv does not exist at ~/.graphiti/.venv"

**Codebase Analysis**:
- Test mocks: `venv_manager.create_venv()` returns (True, "Venv created")
- Real behavior: WrapperGenerator validates venv path exists on disk (filesystem check)
- Mocking gap: VenvManager methods mocked, but WrapperGenerator still does filesystem validation
- Actual venv doesn't exist during test (no real ~/.graphiti/.venv directory)

---

## Remediation Goal

Fix test to properly mock wrapper generation step - either mock WrapperGenerator.generate_wrappers() or create actual venv directory during test. Test should focus on verifying service manager integration, not wrapper generation implementation.

---

## Remediation Actions

### 1. Option A: Mock WrapperGenerator (Recommended)

**File**: `tests/daemon/test_service_venv_integration.py`
**Change**: Add WrapperGenerator mock to bypass filesystem validation

**Current Test** (lines 294-314):
```python
def test_daemon_manager_passes_venv_manager_to_service_manager(self):
    """DaemonManager.install() passes venv_manager to service manager constructor"""
    with patch('platform.system', return_value='Linux'):
        from mcp_server.daemon.manager import DaemonManager

        with patch('mcp_server.daemon.manager.SystemdServiceManager') as mock_service_class:
            manager = DaemonManager()

            # Mock VenvManager
            with patch.object(manager, 'venv_manager') as mock_venv:
                mock_venv.validate_python_version.return_value = True
                mock_venv.create_venv.return_value = (True, "Venv created")
                mock_venv.install_package.return_value = (True, "Package installed")

                # Install daemon
                with patch.object(manager.service_manager, 'install', return_value=True):
                    result = manager.install()
                    assert result is True
```

**Fixed Test** (add WrapperGenerator mock):
```python
def test_daemon_manager_passes_venv_manager_to_service_manager(self):
    """DaemonManager.install() passes venv_manager to service manager constructor"""
    with patch('platform.system', return_value='Linux'):
        from mcp_server.daemon.manager import DaemonManager

        with patch('mcp_server.daemon.manager.SystemdServiceManager') as mock_service_class:
            manager = DaemonManager()

            # Mock VenvManager
            with patch.object(manager, 'venv_manager') as mock_venv:
                mock_venv.validate_python_version.return_value = True
                mock_venv.create_venv.return_value = (True, "Venv created")
                mock_venv.install_package.return_value = (True, "Package installed")

                # Mock WrapperGenerator to bypass filesystem validation
                with patch('mcp_server.daemon.manager.WrapperGenerator') as mock_wrapper_class:
                    mock_wrapper = mock_wrapper_class.return_value
                    mock_wrapper.generate_wrappers.return_value = (True, "Wrappers generated")

                    # Install daemon
                    with patch.object(manager.service_manager, 'install', return_value=True):
                        result = manager.install()

                        # Verify service manager was instantiated with venv_manager
                        assert result is True

                        # Verify wrapper generation was called (integration check)
                        mock_wrapper.generate_wrappers.assert_called_once()
```

**Rationale**: Test focuses on service manager integration, not wrapper generation implementation. WrapperGenerator is tested separately in its own test suite.

### 2. Option B: Create Temporary Venv (Alternative)

**File**: `tests/daemon/test_service_venv_integration.py`
**Change**: Use pytest tmpdir fixture to create actual venv structure

**Pattern**:
```python
def test_daemon_manager_passes_venv_manager_to_service_manager(self, tmp_path):
    """DaemonManager.install() passes venv_manager to service manager constructor"""
    # Create fake venv directory structure
    venv_path = tmp_path / '.graphiti' / '.venv'
    venv_bin = venv_path / 'bin'  # or 'Scripts' on Windows
    venv_bin.mkdir(parents=True, exist_ok=True)
    (venv_bin / 'python').touch()  # Create empty python executable

    with patch('platform.system', return_value='Linux'):
        with patch('pathlib.Path.home', return_value=tmp_path):
            # ... rest of test
```

**Trade-offs**:
- Option A (Mock WrapperGenerator): Faster, cleaner, focuses on integration point
- Option B (Real venv structure): More realistic, but slower and tests implementation details

**Recommendation**: Use Option A (mock WrapperGenerator) - cleaner unit test approach.

---

## Testing

**Test to Fix**:
- `test_daemon_manager_passes_venv_manager_to_service_manager`

**Verification Steps**:
1. Run integration test: `pytest tests/daemon/test_service_venv_integration.py::TestDaemonManagerServiceIntegration -v`
2. Verify test passes (no "Venv does not exist" error)
3. Verify test output shows success: `assert result is True`
4. Verify wrapper generation mock was called (proves integration point works)

**Expected Output**:
```
test_daemon_manager_passes_venv_manager_to_service_manager PASSED
```

---

## Acceptance Criteria

- [ ] **(P0) AC-5.r3.1**: Integration test passes without actual venv on disk
- [ ] **(P0) AC-5.r3.2**: Test properly mocks WrapperGenerator.generate_wrappers()
- [ ] **(P0) AC-5.r3.3**: DaemonManager.install() returns True in test
- [ ] **(P1) AC-5.r3.4**: Test verifies wrapper generation was called (integration check)
- [ ] **(P1) AC-5.r3.5**: Test doesn't create real venv (clean unit test)

---

## Verification

1. Run integration test: `pytest tests/daemon/test_service_venv_integration.py::TestDaemonManagerServiceIntegration::test_daemon_manager_passes_venv_manager_to_service_manager -v`
2. Verify PASSED status
3. Check test output for "Wrapper generation failed" error (should NOT appear)
4. Verify test execution time <1 second (proves no real venv creation)

---

## Notes

- **Remediation Type**: bug_fix (P0 - integration test failing)
- **Auto-Created**: 2025-12-14T17:10:00Z
- **Created From**: Test failure analysis for Story 5.t
- **Original Request**: "Story 5.t failed - fix integration test wrapper generation mocking"
- **Root Cause**: Test mocks VenvManager but not WrapperGenerator, which does actual filesystem validation
- **Fix Strategy**: Add WrapperGenerator mock to test (bypass filesystem checks in unit test)
- **Design Decision**: Use mocking (Option A) rather than real venv (Option B) for cleaner unit test

---

**Created**: 2025-12-14T17:10:00Z
