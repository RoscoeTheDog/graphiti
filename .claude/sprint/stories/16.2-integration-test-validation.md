# Story 16.2: Integration Test Validation

**Status**: unassigned
**Parent**: Story 16
**Created**: 2025-11-18 23:30
**Priority**: CRITICAL
**Estimated Effort**: 4 hours
**Phase**: 8.2 (Week 3, Day 5 - Week 4, Day 1)
**Depends on**: Story 16.1 (unit tests must pass first)

## Description

Implement integration tests validating full workflows across multiple components. Focus on end-to-end scenarios where features interact.

**Scope**:
- Full session lifecycle with periodic checker
- Manual sync command workflows (dry-run + actual)
- Template override behavior (project > global)
- MCP server startup with auto-generation

## Acceptance Criteria

### Session Lifecycle Integration
- [ ] Test full workflow: file created → detected → timeout → checker closes → callback fires
- [ ] Test periodic checker integrates with SessionManager correctly
- [ ] Test callback receives correct session metadata
- [ ] Test multiple overlapping session lifecycles

**File**: `tests/session_tracking/test_session_lifecycle_integration.py`

### Manual Sync Command Integration
- [ ] Test dry-run mode (preview without indexing)
- [ ] Test actual sync mode (indexes to Graphiti)
- [ ] Test session discovery with filters
- [ ] Test cost estimation accuracy
- [ ] Test max_sessions limit enforcement
- [ ] Test error handling (missing files, corrupt sessions)

**File**: `tests/session_tracking/test_manual_sync.py`

### Template Override Integration
- [ ] Test custom templates override defaults
- [ ] Test project templates override global templates
- [ ] Test template caching (avoid re-reads)
- [ ] Test template hot-reload (file changes detected)

**File**: `tests/session_tracking/test_template_integration.py`

### MCP Server Startup Integration
- [ ] Test config auto-generated on first run
- [ ] Test MCP server starts with valid config
- [ ] Test MCP server skips auto-gen if config exists
- [ ] Test error handling (invalid config, permission errors)

**File**: `tests/mcp/test_server_startup.py`

### Coverage Requirements
- [ ] All integration tests pass
- [ ] End-to-end workflows validated
- [ ] Error paths tested

## Implementation Details

### Key Integration Scenarios

**1. Full Session Lifecycle** (~50 LOC test):
```python
async def test_full_session_lifecycle_with_checker():
    """Test complete workflow from file creation to auto-close."""
    # Setup: Create watch directory, manager, checker
    # Action: Create session file
    # Verify: Session detected
    # Wait: inactivity_timeout + check_interval
    # Verify: Session closed via callback
```

**2. Manual Sync Workflow** (~80 LOC test):
```python
async def test_manual_sync_dry_run_then_actual():
    """Test dry-run preview followed by actual sync."""
    # Setup: Create historical sessions (5 days old)
    # Action: Run sync with dry_run=True
    # Verify: Preview returned, no indexing
    # Action: Run sync with dry_run=False
    # Verify: Sessions indexed to Graphiti
```

**3. Template Override Chain** (~60 LOC test):
```python
def test_template_override_chain():
    """Test project > global > built-in resolution."""
    # Setup: Create project + global templates
    # Action: Resolve template from project context
    # Verify: Project template used
    # Action: Delete project template
    # Verify: Global template used
```

### Test Count
- **Total new tests**: ~15 integration tests
- **Estimated runtime**: 1-2 minutes (async workflows)

## Dependencies

- Story 16.1 (Unit Test Validation) - REQUIRED (must pass first)
- Stories 9-15 (all implementation complete) - REQUIRED

## Cross-Cutting Requirements

See parent sprint `.claude/implementation/CROSS_CUTTING_REQUIREMENTS.md`:
- Testing: Integration tests cover happy path + error paths
- Platform-agnostic: Tests run on Windows + Unix
- Error handling: Validate graceful degradation
