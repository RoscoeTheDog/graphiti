# Story 2.t.r2: Fix Platform-Specific Test Mocks in test_venv_manager.py

**Type**: remediation
**Remediation Type**: bug_fix
**Parent**: Story 2.t
**Priority**: P0
**Created**: 2025-12-14T19:00:00Z

---

## Context

**Original Story**: 2.t - Testing: Package Installation to Dedicated Venv
**Current Status**: blocked (89.19% pass rate, 4 failing tests)
**Issue**: Platform-specific test mock issues on Windows

**Test Failure Summary**:
Story 2.t is at 89.19% pass rate (33 passed, 4 failed), just below the 90% threshold.

The 4 failing tests are all platform-specific mock issues on Windows:
1. `test_get_uv_executable_finds_uv_in_venv_unix` - Platform detection issue
2. `test_detect_repo_location_finds_mcp_server_from_venv_path` - Unix path mocks on Windows
3. `test_detect_repo_location_searches_upward_from_venv` - Unix path mocks on Windows
4. `test_install_package_constructs_correct_path` - Unix path construction on Windows

**Root Cause**:
Tests use Unix-style paths (`/opt/graphiti`, `/home/user/graphiti`) as mock values, but when running on Windows, `Path()` converts these to Windows format (`\opt\graphiti`), causing assertion mismatches.

**Codebase Analysis**:
- VenvManager implementation: `mcp_server/daemon/venv_manager.py` (uses `pathlib.Path` correctly)
- Test file: `tests/daemon/test_venv_manager.py` (uses hard-coded Unix paths in mocks)
- Platform detection: VenvManager uses `sys.platform` for platform-specific paths
- Path handling: All VenvManager code uses `pathlib.Path` (platform-agnostic)

---

## Remediation Goal

Fix all 4 platform-specific test failures by making test mocks platform-aware, ensuring tests pass on both Windows and Unix platforms without modifying VenvManager implementation.

Target: 100% pass rate (37/37 tests passing)

---

## Remediation Actions

### 1. Fix `test_get_uv_executable_finds_uv_in_venv_unix`

**File**: `tests/daemon/test_venv_manager.py`
**Line**: 332-340
**Issue**: Platform mock doesn't prevent VenvManager from using actual platform's path format

**Change**: Mock `sys.platform` instead of `platform.system()` to match VenvManager's platform detection:

```python
def test_get_uv_executable_finds_uv_in_venv_unix(self):
    """VenvManager.get_uv_executable() finds uv in venv on Unix"""
    # Mock Unix platform - use sys.platform instead of platform.system()
    with patch('sys.platform', 'linux'):
        manager = VenvManager()
        mock_uv_path = manager.venv_path / 'bin' / 'uv'
        with patch.object(Path, 'exists', return_value=True):
            result = manager.get_uv_executable()
            assert result == mock_uv_path
```

**Rationale**: VenvManager uses `sys.platform == "win32"` (line 279), not `platform.system()`, so mocking the correct attribute ensures proper platform behavior.

---

### 2. Fix `test_detect_repo_location_finds_mcp_server_from_venv_path`

**File**: `tests/daemon/test_venv_manager.py`
**Line**: 354-379
**Issue**: Unix-style paths converted to Windows format on Windows, causing path comparison failures

**Change**: Use platform-specific path construction or pytest `skipif` decorator:

```python
def test_detect_repo_location_finds_mcp_server_from_venv_path(self):
    """VenvManager.detect_repo_location() finds mcp_server directory from venv path"""
    manager = VenvManager()

    # Use platform-agnostic path construction
    if sys.platform == "win32":
        mock_repo_root = Path('C:/home/user/graphiti')
    else:
        mock_repo_root = Path('/home/user/graphiti')

    mock_venv_path = mock_repo_root / '.graphiti' / '.venv'

    with patch.object(manager, 'venv_path', mock_venv_path):
        # Mock pyproject.toml exists check
        expected_pyproject = mock_repo_root / "mcp_server" / "pyproject.toml"

        original_exists = Path.exists
        def exists_side_effect(self):
            # Return True only for the target pyproject.toml
            if self == expected_pyproject:
                return True
            # Use original exists for other paths
            return original_exists(self)

        with patch.object(Path, 'exists', exists_side_effect):
            result = manager.detect_repo_location()
            assert result == mock_repo_root
```

**Rationale**: Using platform-specific path construction ensures `Path()` objects match the OS format, avoiding conversion issues.

---

### 3. Fix `test_detect_repo_location_searches_upward_from_venv`

**File**: `tests/daemon/test_venv_manager.py`
**Line**: 390-410
**Issue**: Same as #2 - Unix-style paths on Windows

**Change**: Use platform-specific path construction:

```python
def test_detect_repo_location_searches_upward_from_venv(self):
    """VenvManager.detect_repo_location() searches upward from venv location"""
    manager = VenvManager()

    # Use platform-agnostic path construction
    if sys.platform == "win32":
        mock_venv_path = Path('C:/opt/projects/graphiti/.graphiti/.venv')
        mock_repo_root = Path('C:/opt/projects/graphiti')
    else:
        mock_venv_path = Path('/opt/projects/graphiti/.graphiti/.venv')
        mock_repo_root = Path('/opt/projects/graphiti')

    with patch.object(manager, 'venv_path', mock_venv_path):
        expected_pyproject = mock_repo_root / "mcp_server" / "pyproject.toml"

        original_exists = Path.exists
        def exists_side_effect(self):
            # Return True only for the target pyproject.toml
            if self == expected_pyproject:
                return True
            # Use original exists for other paths
            return original_exists(self)

        with patch.object(Path, 'exists', exists_side_effect):
            result = manager.detect_repo_location()
            assert result == mock_repo_root
```

**Rationale**: Ensures path objects are created in the correct platform format from the start.

---

### 4. Fix `test_install_package_constructs_correct_path`

**File**: `tests/daemon/test_venv_manager.py`
**Line**: 530-549
**Issue**: Unix-style paths on Windows + path assertion using string comparison

**Change**: Use platform-specific paths and improve assertion:

```python
def test_install_package_constructs_correct_path(self):
    """VenvManager.install_package() constructs correct install command with dynamic path"""
    manager = VenvManager()

    # Use platform-agnostic path construction
    if sys.platform == "win32":
        mock_repo_root = Path('C:/opt/graphiti')
        mock_pip = Path('C:/venv/bin/pip')
    else:
        mock_repo_root = Path('/opt/graphiti')
        mock_pip = Path('/venv/bin/pip')

    with patch.object(manager, 'detect_venv', return_value=True):
        with patch.object(manager, 'detect_repo_location', return_value=mock_repo_root):
            with patch.object(Path, 'exists', return_value=True):
                with patch.object(manager, 'get_uv_executable', return_value=None):
                    with patch.object(manager, 'get_pip_executable', return_value=mock_pip):
                        with patch.object(manager, 'validate_installation', return_value=True):
                            with patch('subprocess.run') as mock_run:
                                mock_run.return_value = Mock(returncode=0, stdout='', stderr='')

                                manager.install_package()

                                # Verify package path is included (use Path comparison)
                                call_args = mock_run.call_args[0][0]
                                expected_package_path = str(mock_repo_root / 'mcp_server')
                                # Check if any arg contains the package path
                                assert any(expected_package_path in str(arg) for arg in call_args), \
                                    f"Expected package path '{expected_package_path}' not found in {call_args}"
```

**Rationale**: Platform-specific paths + improved assertion that checks for substring match in any argument.

---

## Testing

**Test Execution**:
```bash
pytest tests/daemon/test_venv_manager.py -v
```

**Expected Results**:
- All 37 tests passing (100% pass rate)
- No platform-specific failures on Windows
- No regressions on Unix platforms

**Verification Commands**:
```bash
# Windows
pytest tests/daemon/test_venv_manager.py::TestGetUvExecutable::test_get_uv_executable_finds_uv_in_venv_unix -v
pytest tests/daemon/test_venv_manager.py::TestDetectRepoLocation::test_detect_repo_location_finds_mcp_server_from_venv_path -v
pytest tests/daemon/test_venv_manager.py::TestDetectRepoLocation::test_detect_repo_location_searches_upward_from_venv -v
pytest tests/daemon/test_venv_manager.py::TestInstallPackage::test_install_package_constructs_correct_path -v

# Full suite
pytest tests/daemon/test_venv_manager.py -v
```

---

## Acceptance Criteria

- [ ] **(P0) AC-2.t.r2.1**: `test_get_uv_executable_finds_uv_in_venv_unix` passes on Windows and Unix
- [ ] **(P0) AC-2.t.r2.2**: `test_detect_repo_location_finds_mcp_server_from_venv_path` passes on Windows and Unix
- [ ] **(P0) AC-2.t.r2.3**: `test_detect_repo_location_searches_upward_from_venv` passes on Windows and Unix
- [ ] **(P0) AC-2.t.r2.4**: `test_install_package_constructs_correct_path` passes on Windows and Unix
- [ ] **(P0) AC-2.t.r2.5**: All 37 tests in test_venv_manager.py passing (100% pass rate)
- [ ] **(P0) AC-2.t.r2.6**: Story 2.t test gate passes (>=90% pass rate achieved)

---

## Verification

1. **Run failing tests individually** on Windows:
   ```bash
   pytest tests/daemon/test_venv_manager.py::TestGetUvExecutable::test_get_uv_executable_finds_uv_in_venv_unix -v
   pytest tests/daemon/test_venv_manager.py::TestDetectRepoLocation::test_detect_repo_location_finds_mcp_server_from_venv_path -v
   pytest tests/daemon/test_venv_manager.py::TestDetectRepoLocation::test_detect_repo_location_searches_upward_from_venv -v
   pytest tests/daemon/test_venv_manager.py::TestInstallPackage::test_install_package_constructs_correct_path -v
   ```

2. **Run full test suite** to verify no regressions:
   ```bash
   pytest tests/daemon/test_venv_manager.py -v
   ```

3. **Verify pass rate**:
   - Count: 37 passed, 0 failed
   - Pass rate: 100% (37/37)
   - Threshold: >=90% (exceeded)

4. **Story 2.t unblocked**:
   - Status changes from `blocked` to ready for completion
   - Test gate requirement satisfied

---

## Notes

- **Remediation Type**: bug_fix
- **Auto-Created**: 2025-12-14T19:00:00Z
- **Created From**: Natural language request via /sprint:REMEDIATE
- **Original Request**: "Story 2.t is at 89.19% pass rate, just below the 90% threshold. The remaining 4 failures are platform-specific test mock issues on Windows"
- **Impact**: Unblocks Story 2.t completion, enables progress on dependent stories
- **Platform Testing**: Changes ensure cross-platform compatibility (Windows + Unix)
- **No Production Code Changes**: Only test file modifications (VenvManager implementation remains unchanged)

---

**Created**: 2025-12-14T19:00:00Z
