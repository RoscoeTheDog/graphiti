---
description: Fix E2E Test Fixtures VenvCreationError
---

# Story 4.1: Fix E2E Test Fixtures VenvCreationError

**Type**: Remediation
**Remediation Type**: bug_fix
**Status**: unassigned
**Parent**: Story 4 (Validation - End-to-End UX Test)
**Priority**: P0 (Blocking Story 4.t completion)
**Created**: 2025-12-17

---

## Remediation Purpose

This remediation story fixes test infrastructure issues blocking Story 4.t (E2E validation tests).

**Issue Category**: Test Fixture Bug
**Detected By**: /sprint:ORCHESTRATE (Story 4.t failure)
**Affects Stories**: 4, 4.t

---

## Issue Description

The `daemon_manager` fixture in `test_daemon_e2e_validation.py` fails with `VenvCreationError` before tests can run.

**Error**: `VenvCreationError: Venv does not exist at C:\Users\Admin\.graphiti\.venv. Call create_venv() first.`

**Root Cause**:
- `DaemonManager.__init__()` creates a `VenvManager()` instance
- When tests call `daemon_manager.status()` (incorrectly referenced as `get_status()`), it triggers venv validation
- The venv doesn't exist yet because E2E tests are meant to TEST the installation flow
- This creates a chicken-and-egg problem: fixtures need venv, but tests create venv

**Impact**: 6/7 E2E tests fail at fixture setup, blocking Story 4 validation (14.3% pass rate)

---

## Remediation Steps

### 1. Add Session-Scoped Venv Setup Fixture

**File**: `mcp_server/tests/test_daemon_e2e_validation.py`
**Location**: Add after line 22 (after pytestmark)

```python
@pytest.fixture(scope='session')
def ensure_venv_exists():
    """
    Session-scoped fixture to ensure venv exists before any daemon tests run.
    Creates venv if missing, does nothing if already exists.
    """
    from mcp_server.daemon.venv_manager import VenvManager

    venv_manager = VenvManager()
    if not venv_manager.detect_venv():
        # Create venv - this is a prerequisite for E2E tests
        result = venv_manager.create_venv()
        if not result.get('success'):
            pytest.skip(f"Could not create venv: {result.get('error')}")

    yield venv_manager

    # Don't clean up venv - other tests may need it
```

### 2. Update daemon_manager Fixture

**File**: `mcp_server/tests/test_daemon_e2e_validation.py`
**Location**: Lines 38-57

Replace with:
```python
@pytest.fixture
def daemon_manager(ensure_venv_exists):
    """
    Fixture for managing daemon state during tests.
    Ensures cleanup even if tests fail.

    Depends on ensure_venv_exists to guarantee venv is available.
    """
    from mcp_server.daemon.manager import DaemonManager

    manager = DaemonManager()
    initial_status = None

    try:
        initial_status = manager.status()
    except Exception:
        pass  # Status may fail if daemon never installed - that's OK

    yield manager

    # Cleanup: restore initial state
    try:
        if initial_status and initial_status.get('running'):
            pass  # Leave daemon running if it was running before
        else:
            manager.uninstall()
    except Exception:
        pass  # Best effort cleanup
```

### 3. Update clean_daemon_state Fixture

**File**: `mcp_server/tests/test_daemon_e2e_validation.py`
**Location**: Lines 60-79

Replace with:
```python
@pytest.fixture
def clean_daemon_state(daemon_manager, ensure_venv_exists):
    """
    Ensure daemon is uninstalled before test.
    Critical for fresh install tests.
    """
    try:
        status = daemon_manager.status()
        if status.get('running') or status.get('installed'):
            daemon_manager.uninstall()
            time.sleep(2)
    except Exception:
        pass  # Ignore errors if daemon not installed yet

    yield

    try:
        daemon_manager.uninstall()
    except Exception:
        pass
```

### 4. Fix API Method Name Mismatch

**File**: `mcp_server/tests/test_daemon_e2e_validation.py`
**Change**: Replace all `get_status()` → `status()`

Search and replace:
- Line 47: `initial_status = manager.get_status()` → `initial_status = manager.status()`
- Line 54: `current_status = manager.get_status()` → `current_status = manager.status()`
- Line 116: `status_before = daemon_manager.get_status()` → `status_before = daemon_manager.status()`
- Line 259: `status = daemon_manager.get_status()` → `status = daemon_manager.status()`
- Line 383: `api_status = daemon_manager.get_status()` → `api_status = daemon_manager.status()`

---

## Acceptance Criteria

- [ ] **(P0) AC-4.1.1**: `ensure_venv_exists` fixture creates venv if missing before tests run
- [ ] **(P0) AC-4.1.2**: `daemon_manager` fixture initializes without VenvCreationError
- [ ] **(P0) AC-4.1.3**: All 6 previously failing E2E tests now pass (or skip gracefully)
- [ ] **(P1) AC-4.1.4**: API method names corrected (`get_status` → `status`)
- [ ] **(P1) AC-4.1.5**: Test pass rate for Story 4.t reaches ≥90%

---

## Implementation Notes

### Root Cause

The `DaemonManager` class initializes `VenvManager` in its constructor (line 44). While this doesn't immediately fail, subsequent calls to methods that use the venv (like `status()`) trigger the `get_python_executable()` check which raises `VenvCreationError` if the venv doesn't exist.

### Fix Strategy

1. **Session-scoped venv creation**: Create venv once at test session start, not per-test
2. **Fixture dependency chain**: `ensure_venv_exists` → `daemon_manager` → test methods
3. **Graceful error handling**: Handle cases where daemon was never installed
4. **API alignment**: Fix method name mismatch (`get_status` vs `status`)

### Verification

```bash
# Run E2E tests after fix
cd mcp_server/tests
pytest test_daemon_e2e_validation.py -v --tb=short

# Expected results:
# - No VenvCreationError in output
# - 7/7 tests pass (or appropriate platform skip)
# - Pass rate ≥90%
```

---

## Metadata

**Blocks Stories**: 4 (cannot complete validation without passing tests)
**Priority**: P0
**Estimated Tokens**: ~3,000t (discovery) + ~4,000t (implementation) + ~2,000t (testing)

---

**Created**: 2025-12-17T17:51:27Z
