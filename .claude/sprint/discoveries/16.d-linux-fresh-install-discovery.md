# Discovery: Story 16.d - Linux Fresh Install Test

**Story**: 16 - Linux Fresh Install Test
**Phase**: Discovery (16.d)
**Created**: 2025-12-25
**Status**: Completed

## Executive Summary

This discovery phase defines the requirements, success criteria, and test checklist for performing end-to-end testing of the Graphiti v2.1 daemon fresh installation on Linux. The test validates XDG Base Directory Specification compliance, systemd user service functionality, and MCP server accessibility.

---

## 1. Test Environment Requirements

### 1.1 Linux Distribution

**Recommended Distribution**: Ubuntu 22.04 LTS or newer

**Alternative Supported Distributions**:
- Debian 11 (Bullseye) or newer
- Fedora 36 or newer
- Arch Linux (current)
- Any systemd-based distribution with Python 3.10+

**Critical Requirements**:
- systemd version 240+ (for user service reliability)
- Python 3.10 or newer
- Internet connection (for package downloads)
- User account (non-root, standard user privileges)

### 1.2 System Dependencies

**Pre-installation Requirements**:
```bash
# Check systemd version
systemd --version  # Must be >= 240

# Check Python version
python3 --version  # Must be >= 3.10

# Ensure systemd user services are enabled
loginctl show-user $USER | grep Linger
# If not enabled: loginctl enable-linger $USER
```

**Required System Packages** (usually pre-installed):
- `python3` (>= 3.10)
- `python3-venv` (for virtual environment creation)
- `systemd` (>= 240)
- `loginctl` (part of systemd)

### 1.3 User Service Persistence

**CRITICAL REQUIREMENT**: `loginctl enable-linger $USER`

**Why this matters**:
- User systemd services normally stop when the user logs out
- `enable-linger` allows user services to persist across logouts
- Required for daemon to run continuously (like production server)

**Verification**:
```bash
# Check if linger is enabled
loginctl show-user $USER | grep Linger=yes

# Enable linger (if not enabled)
loginctl enable-linger $USER

# Verify
loginctl user-status $USER
```

---

## 2. Expected File Locations (XDG Compliance)

### 2.1 Installation Directory

**Path**: `~/.local/share/graphiti/` (or `$XDG_DATA_HOME/graphiti/`)

**Structure**:
```
~/.local/share/graphiti/
├── .venv/                    # Dedicated Python virtual environment
│   ├── bin/
│   │   └── python3           # Python executable
│   ├── lib/
│   │   └── python3.X/site-packages/
│   └── pyvenv.cfg
├── lib/                      # Frozen packages (from repo)
│   ├── graphiti/
│   ├── mcp_server/
│   └── ...
└── mcp_server/               # MCP server executable
    └── graphiti_mcp_server.py
```

**Environment Variable Override**: `XDG_DATA_HOME` (defaults to `~/.local/share`)

### 2.2 Configuration Directory

**Path**: `~/.config/graphiti/` (or `$XDG_CONFIG_HOME/graphiti/`)

**Structure**:
```
~/.config/graphiti/
└── graphiti.config.json      # Main configuration file
```

**Expected Configuration** (after install):
```json
{
  "daemon": {
    "enabled": false,          # Disabled by default after fresh install
    "host": "127.0.0.1",
    "port": 8321,
    "config_poll_seconds": 5,
    "health_check_interval": 30
  },
  "llm": {
    "provider": "openai",
    "model": "gpt-4o-mini"
  },
  "neo4j": {
    "uri": "",
    "user": "",
    "password": ""
  }
}
```

**Environment Variable Override**: `XDG_CONFIG_HOME` (defaults to `~/.config`)

### 2.3 State Directory (Logs)

**Path**: `~/.local/state/graphiti/logs/` (or `$XDG_STATE_HOME/graphiti/logs/`)

**Structure**:
```
~/.local/state/graphiti/logs/
├── bootstrap-stdout.log      # Bootstrap service stdout
└── bootstrap-stderr.log      # Bootstrap service stderr
```

**Log Format**: Text logs with systemd service output (stdout/stderr)

**Environment Variable Override**: `XDG_STATE_HOME` (defaults to `~/.local/state`)

### 2.4 Systemd User Service

**Path**: `~/.config/systemd/user/graphiti-bootstrap.service` (or `$XDG_CONFIG_HOME/systemd/user/`)

**Expected Service Unit Content**:
```ini
[Unit]
Description=Graphiti MCP Bootstrap Service
Documentation=https://github.com/getzep/graphiti
After=network.target

[Service]
Type=simple
ExecStart=/home/USER/.local/share/graphiti/.venv/bin/python3 -m mcp_server.daemon.bootstrap
Restart=always
RestartSec=5
WorkingDirectory=/home/USER/.local/share/graphiti
Environment="PATH=/usr/local/bin:/usr/bin:/bin"
Environment="PYTHONPATH=/home/USER/.local/share/graphiti/lib"
StandardOutput=append:/home/USER/.local/state/graphiti/logs/bootstrap-stdout.log
StandardError=append:/home/USER/.local/state/graphiti/logs/bootstrap-stderr.log

[Install]
WantedBy=default.target
```

**Key Properties**:
- **ExecStart**: Module invocation (`python -m mcp_server.daemon.bootstrap`)
- **WorkingDirectory**: Install directory (`~/.local/share/graphiti/`)
- **PYTHONPATH**: Points to frozen packages (`{install_dir}/lib`)
- **Restart**: Always restart on failure (with 5-second delay)
- **StandardOutput/Error**: Append logs (not overwrite)

---

## 3. Test Success Criteria

### 3.1 XDG Compliance Verification

**Test Matrix**:

| Check | Command | Expected Result |
|-------|---------|-----------------|
| Install dir exists | `ls ~/.local/share/graphiti/` | Directory exists with `.venv/` and `lib/` |
| Config dir exists | `ls ~/.config/graphiti/` | Directory exists with `graphiti.config.json` |
| Log dir exists | `ls ~/.local/state/graphiti/logs/` | Directory exists (may be empty if service not started) |
| Venv valid | `~/.local/share/graphiti/.venv/bin/python3 --version` | Python 3.10+ |
| Config valid | `jq . ~/.config/graphiti/graphiti.config.json` | Valid JSON, contains `daemon`, `llm`, `neo4j` sections |

**XDG Override Test** (optional):
```bash
# Test with custom XDG paths
export XDG_DATA_HOME=/tmp/test-data
export XDG_CONFIG_HOME=/tmp/test-config
export XDG_STATE_HOME=/tmp/test-state

# Run install
graphiti-mcp daemon install

# Verify paths respect overrides
ls /tmp/test-data/graphiti/
ls /tmp/test-config/graphiti/
ls /tmp/test-state/graphiti/logs/
```

### 3.2 Systemd Service Verification

**Test Matrix**:

| Check | Command | Expected Result |
|-------|---------|-----------------|
| Service file exists | `ls ~/.config/systemd/user/graphiti-bootstrap.service` | File exists |
| Service recognized | `systemctl --user list-unit-files \| grep graphiti` | Shows `graphiti-bootstrap.service` |
| Service enabled | `systemctl --user is-enabled graphiti-bootstrap` | Returns `enabled` |
| Service status | `systemctl --user status graphiti-bootstrap` | Shows active/inactive (depends on daemon.enabled) |

**Expected Service States**:
- **After Install (daemon.enabled=false)**: Service running, MCP server NOT running
- **After Enable (daemon.enabled=true)**: Service running, MCP server running

### 3.3 MCP Server Functionality

**Test Matrix**:

| Check | Command/Action | Expected Result |
|-------|----------------|-----------------|
| Enable daemon | `graphiti-mcp daemon enable` | Config updated, MCP server starts within 5 seconds |
| Server running | `systemctl --user status graphiti-bootstrap` | Shows MCP server PID in logs |
| Port listening | `ss -tlnp \| grep 8321` | Shows listening on 127.0.0.1:8321 |
| Health check | `curl http://127.0.0.1:8321/health` | Returns HTTP 200 (or appropriate health response) |
| Logs written | `tail ~/.local/state/graphiti/logs/bootstrap-stdout.log` | Shows "Starting MCP server on 127.0.0.1:8321" |

### 3.4 Service Lifecycle Tests

**Restart Test**:
```bash
# Restart service
systemctl --user restart graphiti-bootstrap

# Verify it comes back up
sleep 10
systemctl --user status graphiti-bootstrap
```

**Reboot Test** (if linger enabled):
```bash
# Reboot system
sudo reboot

# After reboot, verify service auto-started
systemctl --user status graphiti-bootstrap
```

**Config Change Test**:
```bash
# Disable daemon
graphiti-mcp daemon disable

# Wait for config poll (default: 5 seconds)
sleep 10

# Verify MCP server stopped
ss -tlnp | grep 8321  # Should return nothing
```

---

## 4. Test Checklist (Manual Verification)

### 4.1 Pre-Installation

- [ ] Verify Python version >= 3.10
- [ ] Verify systemd version >= 240
- [ ] Verify loginctl enable-linger is set for user
- [ ] Clean state (no prior Graphiti installation)

### 4.2 Installation Phase

- [ ] Run `graphiti-mcp daemon install`
- [ ] No errors during installation
- [ ] Success message: "Service 'graphiti-bootstrap' started and enabled"

### 4.3 Directory Structure Verification

- [ ] `~/.local/share/graphiti/` exists
- [ ] `~/.local/share/graphiti/.venv/` exists and contains valid Python venv
- [ ] `~/.local/share/graphiti/lib/` exists and contains frozen packages
- [ ] `~/.config/graphiti/` exists
- [ ] `~/.config/graphiti/graphiti.config.json` exists and contains valid JSON
- [ ] `~/.local/state/graphiti/logs/` exists

### 4.4 Systemd Service Verification

- [ ] `~/.config/systemd/user/graphiti-bootstrap.service` exists
- [ ] `systemctl --user is-enabled graphiti-bootstrap` returns `enabled`
- [ ] `systemctl --user is-active graphiti-bootstrap` returns `active`
- [ ] Service file uses module invocation (`python -m mcp_server.daemon.bootstrap`)
- [ ] Service file sets PYTHONPATH to `{install_dir}/lib`

### 4.5 Service Functionality

- [ ] Run `graphiti-mcp daemon enable` (sets daemon.enabled=true)
- [ ] Wait 10 seconds for MCP server to start
- [ ] `ss -tlnp | grep 8321` shows listening socket
- [ ] `curl http://127.0.0.1:8321/health` returns success (or `graphiti-mcp health`)
- [ ] Logs show "Starting MCP server on 127.0.0.1:8321"

### 4.6 Service Lifecycle

- [ ] `systemctl --user restart graphiti-bootstrap` succeeds
- [ ] Service comes back up after restart
- [ ] MCP server restarts if daemon.enabled=true
- [ ] Run `graphiti-mcp daemon disable` (sets daemon.enabled=false)
- [ ] Wait 10 seconds
- [ ] MCP server stops (port 8321 no longer listening)

### 4.7 Reboot Test (Linger Verification)

- [ ] `loginctl show-user $USER | grep Linger=yes` returns true
- [ ] Reboot system
- [ ] After reboot, `systemctl --user status graphiti-bootstrap` shows active
- [ ] If daemon.enabled=true, MCP server is running without manual intervention

---

## 5. Potential Linux-Specific Issues

### 5.1 Systemd User Service Without Linger

**Issue**: Service stops when user logs out

**Symptom**:
```bash
# After logout/login
systemctl --user status graphiti-bootstrap
# Shows "inactive (dead)" or "failed to connect to bus"
```

**Root Cause**: User systemd services normally stop when all user sessions end

**Solution**:
```bash
loginctl enable-linger $USER
systemctl --user restart graphiti-bootstrap
```

**Detection in Test**:
- Verify linger is enabled BEFORE installation
- Test logout/login cycle
- Verify service persists after logout

### 5.2 XDG Variable Overrides

**Issue**: Non-standard XDG paths (custom user configs)

**Symptom**: Files created in unexpected locations

**Affected Users**:
- Users with custom `XDG_DATA_HOME`, `XDG_CONFIG_HOME`, `XDG_STATE_HOME`
- Users running custom shells (fish, zsh) with XDG overrides

**Solution**: `paths.py` already respects XDG environment variables

**Detection in Test**:
- Test with and without XDG overrides
- Verify paths.py uses environment variables correctly
- Document behavior in installation guide

### 5.3 Python Version Mismatch

**Issue**: System Python < 3.10

**Symptom**:
```
IncompatiblePythonVersionError: Python 3.10+ required, but running Python 3.9
```

**Affected Distributions**:
- Ubuntu 20.04 (Python 3.8 default)
- Debian 10 (Python 3.7 default)
- CentOS 7/RHEL 7 (Python 3.6 default)

**Solution**:
- Install Python 3.10+ from package manager (e.g., `python3.10` on Ubuntu)
- Use pyenv to install newer Python version
- Upgrade distribution to newer release

**Detection in Test**:
- Verify Python version check in installer
- Test on older distributions (Ubuntu 20.04)
- Document minimum distribution versions

### 5.4 Missing python3-venv Package

**Issue**: `python3 -m venv` fails due to missing package

**Symptom**:
```
Error: Command 'python3 -m venv' returned non-zero exit status 1
The virtual environment was not created successfully because ensurepip is not
available. On Debian/Ubuntu systems, you need to install the python3-venv package.
```

**Affected Distributions**: Debian/Ubuntu (python3-venv not installed by default)

**Solution**:
```bash
sudo apt-get update
sudo apt-get install python3-venv
```

**Detection in Test**:
- Test on minimal Debian/Ubuntu installation
- Verify error message is clear
- Document in installation guide

### 5.5 Systemd Daemon-Reload Required

**Issue**: Service file changes not recognized without daemon-reload

**Symptom**: Old service configuration still active after update

**Solution**: Already handled in `SystemdServiceManager.install()`:
```python
self._run_systemctl("daemon-reload")
```

**Detection in Test**:
- Verify daemon-reload is called during installation
- Test service update (reinstall over existing service)
- Check that changes are reflected immediately

### 5.6 Permission Errors on Log Files

**Issue**: Log directory not writable by service user

**Symptom**:
```
systemctl --user status graphiti-bootstrap
# Shows "Failed to open log file: Permission denied"
```

**Root Cause**: Log directory created with wrong permissions

**Solution**: Already handled in `SystemdServiceManager._create_service_unit()`:
```python
self.log_dir.mkdir(parents=True, exist_ok=True)
```

**Detection in Test**:
- Verify log directory is created with correct permissions (user-writable)
- Verify logs are written after service start
- Check log file ownership (`ls -la ~/.local/state/graphiti/logs/`)

### 5.7 SELinux/AppArmor Restrictions

**Issue**: Security policies block service execution

**Symptom**:
```
systemctl --user status graphiti-bootstrap
# Shows "Permission denied" or "Operation not permitted"

# dmesg output shows:
audit: type=1400 audit(...): apparmor="DENIED" operation="exec" ...
```

**Affected Distributions**:
- Fedora (SELinux enforcing by default)
- Ubuntu with AppArmor (less common)

**Solution**:
- Verify service runs in user context (not system-wide)
- User services typically have fewer restrictions
- If needed, create custom SELinux policy

**Detection in Test**:
- Test on Fedora with SELinux enforcing
- Check for audit denials in dmesg
- Document workarounds if needed

### 5.8 Network Binding Issues

**Issue**: Port 8321 already in use

**Symptom**:
```
Error: Address already in use (127.0.0.1:8321)
```

**Root Cause**: Another service using port 8321

**Solution**:
- Change port in config: `daemon.port` in graphiti.config.json
- Find conflicting service: `ss -tlnp | grep 8321`

**Detection in Test**:
- Verify error message is clear
- Test with port already in use
- Document how to change port

---

## 6. Test Execution Plan

### 6.1 Fresh Install Test (Primary)

**Environment**: Clean Ubuntu 22.04 LTS VM

**Steps**:
1. Verify pre-requisites (Python 3.10+, systemd 240+)
2. Enable linger: `loginctl enable-linger $USER`
3. Install Graphiti daemon: `graphiti-mcp daemon install`
4. Verify directory structure (XDG paths)
5. Verify systemd service installed and enabled
6. Enable daemon: `graphiti-mcp daemon enable`
7. Verify MCP server starts (port 8321 listening)
8. Run health check: `curl http://127.0.0.1:8321/health`
9. Check logs: `tail ~/.local/state/graphiti/logs/bootstrap-stdout.log`
10. Restart service: `systemctl --user restart graphiti-bootstrap`
11. Disable daemon: `graphiti-mcp daemon disable`
12. Verify MCP server stops

**Expected Duration**: 15-20 minutes

### 6.2 Reboot Persistence Test

**Environment**: Same VM from 6.1

**Steps**:
1. Enable daemon: `graphiti-mcp daemon enable`
2. Verify MCP server running
3. Reboot: `sudo reboot`
4. After reboot, verify service auto-started
5. Verify MCP server running without manual intervention

**Expected Duration**: 5-10 minutes (including reboot time)

### 6.3 XDG Override Test (Optional)

**Environment**: Same VM from 6.1, new test user

**Steps**:
1. Create test user: `sudo useradd -m testuser`
2. Set XDG overrides in `.bashrc`:
   ```bash
   export XDG_DATA_HOME=/tmp/test-data
   export XDG_CONFIG_HOME=/tmp/test-config
   export XDG_STATE_HOME=/tmp/test-state
   ```
3. Run installation as testuser
4. Verify files created in XDG override locations
5. Verify service still works correctly

**Expected Duration**: 10-15 minutes

---

## 7. Known Issues and Mitigations

### 7.1 Story 7 Blocker (Windows)

**Issue**: Story 7 (WindowsTaskSchedulerManager) is blocked - class does not exist

**Impact on Story 16**: None (Story 16 is Linux-only, depends on Story 9 which is complete)

**Status**: Story 16 can proceed independently

### 7.2 Python Version Compatibility

**Issue**: Older distributions may have Python < 3.10

**Mitigation**:
- Document minimum distribution versions
- Provide instructions for installing Python 3.10+
- Consider pyenv as alternative

### 7.3 Linger Not Enabled

**Issue**: User services stop after logout if linger not enabled

**Mitigation**:
- Document linger requirement prominently
- Add check in installer to warn if linger not enabled
- Provide clear instructions to enable linger

---

## 8. Documentation Requirements

### 8.1 Installation Guide Updates

**Required Sections**:
- Linux-specific pre-requisites (systemd, Python, linger)
- XDG Base Directory Specification explanation
- loginctl enable-linger instructions
- Troubleshooting section for common issues

### 8.2 Configuration Guide Updates

**Required Sections**:
- XDG environment variable overrides
- Custom installation locations
- Log file locations and rotation

### 8.3 Troubleshooting Guide

**Required Sections**:
- Service won't start after reboot (linger not enabled)
- Python version too old (distribution upgrade)
- Port already in use (changing port)
- Permission errors (file ownership)
- SELinux/AppArmor denials (security policies)

---

## 9. Next Steps

### 9.1 Implementation Phase (Story 16.i)

**Dependencies**: Story 9 and Story 10 (both completed)

**Tasks**:
- Provision Ubuntu 22.04 LTS VM
- Run full installation following test checklist
- Document any deviations from expected behavior
- Capture screenshots/logs for documentation

### 9.2 Testing Phase (Story 16.t)

**Dependencies**: Story 16.i completed

**Tasks**:
- Execute all test cases in section 4 (Test Checklist)
- Run reboot persistence test
- Test XDG overrides (optional)
- Validate against success criteria (section 3)

### 9.3 Documentation Updates (Story 19)

**Dependencies**: Story 16.t completed

**Tasks**:
- Update installation guide with Linux-specific instructions
- Add troubleshooting section
- Document XDG compliance and overrides

---

## 10. References

### 10.1 Code References

- `mcp_server/daemon/systemd_service.py` - SystemdServiceManager implementation
- `mcp_server/daemon/paths.py` - Platform-aware path resolution (XDG compliance)
- `mcp_server/daemon/bootstrap.py` - Bootstrap service implementation
- `mcp_server/daemon/venv_manager.py` - Virtual environment management

### 10.2 Specifications

- [XDG Base Directory Specification](https://specifications.freedesktop.org/basedir-spec/basedir-spec-latest.html)
- [systemd User Services](https://www.freedesktop.org/software/systemd/man/systemd.service.html)
- [loginctl enable-linger](https://www.freedesktop.org/software/systemd/man/loginctl.html#enable-linger%20USER%E2%80%A6)

### 10.3 Related Stories

- Story 9: Update SystemdServiceManager (Linux) - **COMPLETED**
- Story 10: Fix Bootstrap Module Invocation - **COMPLETED**
- Story 1: Create Platform-Aware Path Resolution Module - **COMPLETED**

---

## Appendix A: Quick Reference Commands

### A.1 Installation

```bash
# Install daemon
graphiti-mcp daemon install

# Enable linger (required for reboot persistence)
loginctl enable-linger $USER

# Enable daemon (start MCP server)
graphiti-mcp daemon enable
```

### A.2 Service Management

```bash
# Check service status
systemctl --user status graphiti-bootstrap

# View logs
journalctl --user -u graphiti-bootstrap -f

# Restart service
systemctl --user restart graphiti-bootstrap

# Stop service
systemctl --user stop graphiti-bootstrap
```

### A.3 Verification

```bash
# Check installation paths
ls -la ~/.local/share/graphiti/
ls -la ~/.config/graphiti/
ls -la ~/.local/state/graphiti/logs/

# Check service file
cat ~/.config/systemd/user/graphiti-bootstrap.service

# Check MCP server listening
ss -tlnp | grep 8321

# Health check
curl http://127.0.0.1:8321/health
```

### A.4 Troubleshooting

```bash
# Check linger status
loginctl show-user $USER | grep Linger

# View full logs
tail -f ~/.local/state/graphiti/logs/bootstrap-stdout.log
tail -f ~/.local/state/graphiti/logs/bootstrap-stderr.log

# Check Python version
~/.local/share/graphiti/.venv/bin/python3 --version

# Verify config
jq . ~/.config/graphiti/graphiti.config.json
```

---

**Discovery Status**: Completed
**Next Phase**: Implementation (Story 16.i)
**Approval Required**: No (discovery phase does not require approval)
