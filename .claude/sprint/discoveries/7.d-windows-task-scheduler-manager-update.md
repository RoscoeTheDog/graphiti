# Discovery: Update WindowsTaskSchedulerManager to v2.1 Paths

**Story**: 7 - Update WindowsTaskSchedulerManager
**Phase**: Discovery (7.d)
**Date**: 2025-12-25
**Status**: CRITICAL FINDING - WindowsTaskSchedulerManager Does Not Exist

---

## Executive Summary

**CRITICAL**: The WindowsTaskSchedulerManager class referenced in Story 7 **does not exist in the current codebase**. The current implementation uses `WindowsServiceManager` (NSSM-based) instead of the Task Scheduler-based approach specified in DAEMON_ARCHITECTURE_SPEC_v2.0.md.

**Finding**: Story 7 has a **dependency order issue**. The WindowsTaskSchedulerManager must be **created first** (from v2.0 spec) before it can be updated to v2.1 paths.

---

## Current State Analysis

### 1. What Exists

**File**: `mcp_server/daemon/windows_service.py`
**Class**: `WindowsServiceManager`
**Approach**: NSSM (Non-Sucking Service Manager)

**Current Implementation**:
```python
# mcp_server/daemon/windows_service.py (lines 25-46)
class WindowsServiceManager:
    """Manages Graphiti bootstrap service on Windows via NSSM."""

    def __init__(self, venv_manager: Optional[VenvManager] = None):
        self.venv_manager = venv_manager or VenvManager()
        self.python_exe = self.venv_manager.get_python_executable()  # venv Python
        self.bootstrap_script = self._get_bootstrap_path()          # bootstrap.py path
```

**Current Path Usage** (Already using v2.1 paths!):
```python
# Line 22: Already imports v2.1 paths module
from .paths import get_install_dir, get_log_dir

# Line 149: Working directory uses platform-specific install directory
working_dir = get_install_dir()
self._run_nssm("set", self.service_name, "AppDirectory", str(working_dir))

# Line 154: Logs use platform-specific log directory
log_dir = get_log_dir()
stdout_log = log_dir / "bootstrap-stdout.log"
stderr_log = log_dir / "bootstrap-stderr.log"
```

**IMPORTANT**: The current `WindowsServiceManager` **already uses v2.1 paths** correctly. It just uses NSSM instead of Task Scheduler.

---

### 2. What Does NOT Exist

**Missing File**: `mcp_server/daemon/windows_task_scheduler.py` (or similar)
**Missing Class**: `WindowsTaskSchedulerManager`

**Expected Location** (based on v2.0 spec):
```
mcp_server/daemon/
├── windows_service.py        # ✓ Exists (NSSM-based)
├── windows_task_scheduler.py # ✗ MISSING (Task Scheduler-based)
├── launchd_service.py        # ✓ Exists
└── systemd_service.py        # ✓ Exists
```

---

### 3. Specification Review

**DAEMON_ARCHITECTURE_SPEC_v2.0.md** (lines 163-300):

The spec defines a complete `WindowsTaskSchedulerManager` implementation:

**Key XML Template** (v2.0 spec):
```xml
<Actions Context="Author">
  <Exec>
    <Command>%USERPROFILE%\.graphiti\.venv\Scripts\pythonw.exe</Command>
    <Arguments>-m mcp_server.daemon.bootstrap</Arguments>
    <WorkingDirectory>%USERPROFILE%\.graphiti</WorkingDirectory>
  </Exec>
</Actions>
```

**Path Patterns in v2.0**:
- Command: `%USERPROFILE%\.graphiti\.venv\Scripts\pythonw.exe`
- WorkingDirectory: `%USERPROFILE%\.graphiti`
- Uses: `self.graphiti_home = Path.home() / ".graphiti"`

---

### 4. What Needs to Change for v2.1

**DAEMON_ARCHITECTURE_SPEC_v2.1.md** specifies:

**v2.1 Install Structure** (Windows):
```
%LOCALAPPDATA%\Programs\Graphiti\           # Install directory
├── bin\
│   ├── python.exe
│   ├── pythonw.exe                         # Frozen Python executable
│   └── graphiti-mcp.exe
├── lib\
│   ├── mcp_server\                         # Frozen package
│   └── site-packages\
└── VERSION

%LOCALAPPDATA%\Graphiti\                    # Config/State directory
├── config\
│   └── graphiti.config.json
└── logs\
    ├── bootstrap-stdout.log
    └── bootstrap-stderr.log
```

**Required Path Changes** (v2.0 → v2.1):

| Component | v2.0 Path | v2.1 Path |
|-----------|-----------|-----------|
| Python executable | `%USERPROFILE%\.graphiti\.venv\Scripts\pythonw.exe` | `{INSTALL_DIR}\bin\pythonw.exe` |
| Working directory | `%USERPROFILE%\.graphiti` | `{INSTALL_DIR}` |
| Arguments | `-m mcp_server.daemon.bootstrap` | `-m mcp_server.daemon.bootstrap` (unchanged) |
| Config file | `%USERPROFILE%\.graphiti\graphiti.config.json` | `{CONFIG_DIR}\graphiti.config.json` |
| Logs | `%USERPROFILE%\.graphiti\logs\` | `{STATE_DIR}\logs\` |

**Where**:
- `{INSTALL_DIR}` = `%LOCALAPPDATA%\Programs\Graphiti` (from `get_install_dir()`)
- `{CONFIG_DIR}` = `%LOCALAPPDATA%\Graphiti\config` (from `get_config_dir()`)
- `{STATE_DIR}` = `%LOCALAPPDATA%\Graphiti` (from `paths.get_paths().state_dir`)

---

## Required Changes for v2.1 (When WindowsTaskSchedulerManager Exists)

### 1. Update Command Path

**Current (v2.0 spec)**:
```python
self.venv_python = self.graphiti_home / ".venv" / "Scripts" / "pythonw.exe"
```

**Required (v2.1)**:
```python
from .paths import get_install_dir

install_dir = get_install_dir()
self.venv_python = install_dir / "bin" / "pythonw.exe"
```

### 2. Update Working Directory

**Current (v2.0 spec)**:
```python
self.graphiti_home = Path.home() / ".graphiti"
# ...
<WorkingDirectory>{self.graphiti_home}</WorkingDirectory>
```

**Required (v2.1)**:
```python
from .paths import get_install_dir

working_dir = get_install_dir()
# ...
<WorkingDirectory>{working_dir}</WorkingDirectory>
```

### 3. Update XML Template Generation

**Current (v2.0 spec, line 297-299)**:
```xml
<Command>{self.venv_python}</Command>
<Arguments>-m mcp_server.daemon.bootstrap</Arguments>
<WorkingDirectory>{self.graphiti_home}</WorkingDirectory>
```

**Required (v2.1)**:
```xml
<Command>{install_dir}\bin\pythonw.exe</Command>
<Arguments>-m mcp_server.daemon.bootstrap</Arguments>
<WorkingDirectory>{install_dir}</WorkingDirectory>
```

### 4. Update Log Paths

**Current (v2.0 would use)**:
```python
log_dir = self.graphiti_home / "logs"
```

**Required (v2.1)**:
```python
from .paths import get_log_dir

log_dir = get_log_dir()  # Returns platform-specific log directory
stdout_log = log_dir / "bootstrap-stdout.log"
stderr_log = log_dir / "bootstrap-stderr.log"
```

### 5. Import Statements

**Required imports**:
```python
from .paths import get_install_dir, get_log_dir
```

### 6. Task XML Storage Location

**Current (v2.0 spec)**:
```python
self.task_xml_path = self.graphiti_home / "graphiti-bootstrap-task.xml"
```

**Required (v2.1)**:
```python
from .paths import get_paths

state_dir = get_paths().state_dir
self.task_xml_path = state_dir / "graphiti-bootstrap-task.xml"
```

---

## Dependencies Identified

### Prerequisite Stories (Must Complete First)

1. **Create WindowsTaskSchedulerManager** (NOT in current sprint)
   - Based on DAEMON_ARCHITECTURE_SPEC_v2.0.md lines 163-300
   - Implements Task Scheduler approach (replaces NSSM)
   - Uses v2.0 paths (`~/.graphiti/`)

2. **Story 1**: Create Platform-Aware Path Resolution Module ✓ COMPLETE
   - `mcp_server/daemon/paths.py` exists
   - Provides `get_install_dir()`, `get_config_dir()`, `get_log_dir()`

3. **Story 2**: Migrate Daemon Modules to New Path System
   - Required to ensure path infrastructure is stable
   - Status: Unknown (need to verify)

### Blockers

**BLOCKER**: WindowsTaskSchedulerManager does not exist yet
- **Resolution**: Either:
  1. **Option A**: Create WindowsTaskSchedulerManager first (add to sprint queue as Story 0 or prerequisite)
  2. **Option B**: Re-scope Story 7 to update WindowsServiceManager to v2.1 paths (already mostly done!)
  3. **Option C**: Mark Story 7 as blocked until WindowsTaskSchedulerManager is created

---

## Risks & Considerations

### 1. Architecture Decision

**Question**: Should Graphiti use Task Scheduler or NSSM?

**Task Scheduler Pros** (v2.0 spec rationale):
- No external dependencies (built into Windows)
- True per-user execution (InteractiveToken)
- Correct `Path.home()` resolution
- No admin rights required

**NSSM Pros** (current implementation):
- Simpler service management
- Better logging control
- More familiar to developers
- Already implemented and working

**Current Status**: The codebase uses NSSM but the v2.0 spec advocates for Task Scheduler. This needs architectural alignment.

### 2. Migration Path

If switching from NSSM to Task Scheduler:
- Need migration logic in installer
- Need to detect and remove old NSSM service
- Need to register new Task Scheduler task
- Potential for users to have both running (conflict)

### 3. Path Resolution Verification

**Critical**: Ensure frozen Python executable location is correct
- v2.1 uses `{INSTALL_DIR}/bin/pythonw.exe`
- Need to verify this exists after package deployment
- Need to verify it's a frozen executable (not a venv symlink)

---

## Test Strategy (When Implementation Happens)

### 1. Unit Tests

```python
def test_task_xml_uses_v21_paths():
    """Verify generated Task XML uses v2.1 paths."""
    manager = WindowsTaskSchedulerManager()
    xml_content = manager._generate_task_xml()

    install_dir = get_install_dir()
    expected_command = str(install_dir / "bin" / "pythonw.exe")
    expected_working_dir = str(install_dir)

    assert expected_command in xml_content
    assert f"<WorkingDirectory>{expected_working_dir}</WorkingDirectory>" in xml_content
```

### 2. Integration Tests

- Verify task can be created with new paths
- Verify task runs under current user context
- Verify logs are written to correct location
- Verify config is read from correct location

### 3. Platform-Specific Tests

- Test on Windows 10
- Test on Windows 11
- Test on Windows Server (if applicable)
- Verify paths resolve correctly on different Windows versions

---

## Recommendations

### Immediate Action Required

**STOP**: Cannot proceed with Story 7.d implementation until architectural decision is made.

**Required Decisions**:

1. **Architecture Choice**:
   - [ ] **Option A**: Stick with NSSM, update WindowsServiceManager to v2.1 paths (EASY - mostly done)
   - [ ] **Option B**: Create WindowsTaskSchedulerManager first, then update to v2.1 paths (FOLLOWS SPEC)
   - [ ] **Option C**: Deprecate Task Scheduler approach, use NSSM for all Windows installs (DIVERGE FROM SPEC)

2. **Story Sequencing**:
   - [ ] **Option A**: Re-scope Story 7 to update WindowsServiceManager (rename story)
   - [ ] **Option B**: Add prerequisite story: "Create WindowsTaskSchedulerManager from v2.0 spec"
   - [ ] **Option C**: Mark Story 7 as blocked/deferred

### Next Steps (Based on Decision)

**IF Option B (Create WindowsTaskSchedulerManager first)**:
1. Add Story 0: "Create WindowsTaskSchedulerManager (v2.0 spec)"
2. Implement from DAEMON_ARCHITECTURE_SPEC_v2.0.md
3. Use v2.0 paths (`~/.graphiti/`)
4. Then proceed with Story 7 to update to v2.1 paths

**IF Option A (Update WindowsServiceManager)**:
1. Rename Story 7 to "Update WindowsServiceManager to v2.1 Paths"
2. Verify current path usage (already using `get_install_dir()`, `get_log_dir()`)
3. Add tests to verify v2.1 compliance
4. Mark as mostly complete

---

## Conclusion

**Discovery Status**: COMPLETE with CRITICAL FINDING

**Key Findings**:
1. WindowsTaskSchedulerManager does not exist (spec vs. reality mismatch)
2. WindowsServiceManager already uses v2.1 paths correctly
3. Architectural decision needed: Task Scheduler vs. NSSM
4. Story sequencing issue: cannot update what doesn't exist

**Recommendation**: **PAUSE Story 7 implementation** until architectural decision is made and communicated to the team.

**Estimated Effort** (if creating WindowsTaskSchedulerManager):
- Discovery: ✓ COMPLETE (this document)
- Implementation (v2.0 spec): ~4-6 hours
- Implementation (v2.1 update): ~2-3 hours
- Testing: ~2-4 hours
- **Total**: ~8-13 hours

**Estimated Effort** (if updating WindowsServiceManager):
- Discovery: ✓ COMPLETE (this document)
- Implementation (verify paths): ~1 hour
- Testing: ~2 hours
- **Total**: ~3 hours

---

**Prepared by**: Claude (Discovery Agent)
**Review Required**: Human/Architect
**Action Required**: Architectural decision before proceeding
