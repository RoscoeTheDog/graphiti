# Discovery: Update SystemdServiceManager for v2.1 Path Architecture

**Story**: 9 - Update SystemdServiceManager (Linux)
**Phase**: Discovery (9.d)
**Date**: 2025-12-25
**Status**: Completed

---

## Executive Summary

The SystemdServiceManager needs updates to align with the v2.1 professional installation architecture. Key changes involve:
1. Migrating from `bootstrap.py` script invocation to module invocation (`python -m mcp_server.daemon.bootstrap`)
2. Adding `PYTHONPATH` environment variable for frozen package support
3. Updating working directory to use `get_install_dir()`
4. Updating log paths to use XDG state directory structure

---

## Current Implementation Analysis

### File: `mcp_server/daemon/systemd_service.py`

**Current Path Usage**:

| Line | Current Code | Issue |
|------|--------------|-------|
| 17 | `from .paths import get_log_dir` | ✅ Already imports from paths.py |
| 38 | `self.python_exe = self.venv_manager.get_python_executable()` | ✅ Uses venv manager |
| 39 | `self.bootstrap_script = self._get_bootstrap_path()` | ❌ Direct script path (line 54) |
| 49 | `self.log_dir = get_log_dir()` | ✅ Uses paths.py |
| 67 | `ExecStart={self.python_exe} {self.bootstrap_script}` | ❌ Script invocation instead of module |
| 70 | `WorkingDirectory={self.bootstrap_script.parent}` | ❌ Uses script parent (mcp_server/daemon/) |
| 71 | `Environment="PATH=..."` | ⚠️ Missing PYTHONPATH for frozen packages |
| 72-73 | Log paths use `self.log_dir` | ✅ Already uses paths.py |

**Key Findings**:

1. **Module Invocation Missing** (Lines 67, 51-54):
   - Currently: `ExecStart={python} {bootstrap.py}` (direct script)
   - Should be: `ExecStart={python} -m mcp_server.daemon.bootstrap` (module)
   - Rationale: Module invocation is required for frozen packages (see Story 10)

2. **PYTHONPATH Not Set** (Line 71):
   - Currently: Only sets `PATH` environment variable
   - Should add: `Environment="PYTHONPATH={INSTALL_DIR}/lib"`
   - Rationale: Frozen packages are in `{INSTALL_DIR}/lib/` and need to be importable

3. **Working Directory** (Line 70):
   - Currently: `WorkingDirectory={self.bootstrap_script.parent}` (mcp_server/daemon/)
   - Should be: `WorkingDirectory={INSTALL_DIR}` (from paths.py)
   - Rationale: Module invocation needs to run from install root

4. **Log Paths** (Lines 72-73):
   - ✅ Already uses `self.log_dir` from `get_log_dir()`
   - ✅ Correctly uses XDG state directory structure

---

## Comparison with Other Service Managers

### Windows Service Manager (`windows_service.py`)

**Already Updated** (Lines 120-151):
- ✅ Uses module invocation: `python -m mcp_server.daemon.bootstrap` (line 127)
- ✅ Sets working directory: `get_install_dir()` (line 149)
- ✅ Uses `get_log_dir()` for log paths (line 154)
- ⚠️ PYTHONPATH not needed (NSSM sets AppDirectory which adds to path)

### macOS Service Manager (`launchd_service.py`)

**Current State** (Lines 55-66):
- ❌ Uses direct script invocation: `[python, bootstrap.py]` (line 56-57)
- ❌ WorkingDirectory uses script parent (line 63)
- ✅ Uses `get_log_dir()` for log paths (line 61-62)
- ❌ No PYTHONPATH set (line 64-66)
- **Status**: Needs same updates as systemd (Story 8)

---

## Required Changes

### 1. Import get_install_dir (Priority: P0)

**Current**:
```python
from .paths import get_log_dir
```

**Required**:
```python
from .paths import get_install_dir, get_log_dir
```

**Location**: Line 17

---

### 2. Update _create_service_unit() for Module Invocation (Priority: P0)

**Current** (Lines 60-77):
```python
unit_content = f"""[Unit]
Description=Graphiti MCP Bootstrap Service
Documentation=https://github.com/getzep/graphiti
After=network.target

[Service]
Type=simple
ExecStart={self.python_exe} {self.bootstrap_script}
Restart=always
RestartSec=5
WorkingDirectory={self.bootstrap_script.parent}
Environment="PATH={os.environ.get('PATH', '/usr/local/bin:/usr/bin:/bin')}"
StandardOutput=append:{self.log_dir / 'bootstrap-stdout.log'}
StandardError=append:{self.log_dir / 'bootstrap-stderr.log'}

[Install]
WantedBy=default.target
"""
```

**Required**:
```python
install_dir = get_install_dir()
lib_dir = install_dir / "lib"

unit_content = f"""[Unit]
Description=Graphiti MCP Bootstrap Service
Documentation=https://github.com/getzep/graphiti
After=network.target

[Service]
Type=simple
ExecStart={self.python_exe} -m mcp_server.daemon.bootstrap
Restart=always
RestartSec=5
WorkingDirectory={install_dir}
Environment="PATH={os.environ.get('PATH', '/usr/local/bin:/usr/bin:/bin')}"
Environment="PYTHONPATH={lib_dir}"
StandardOutput=append:{self.log_dir / 'bootstrap-stdout.log'}
StandardError=append:{self.log_dir / 'bootstrap-stderr.log'}

[Install]
WantedBy=default.target
"""
```

**Changes**:
1. ExecStart: Added `-m mcp_server.daemon.bootstrap` (module invocation)
2. WorkingDirectory: Changed to `{install_dir}` (from get_install_dir())
3. Environment: Added `PYTHONPATH={lib_dir}` line for frozen packages

---

### 3. Remove _get_bootstrap_path() Method (Priority: P1)

**Current** (Lines 51-54):
```python
def _get_bootstrap_path(self) -> Path:
    """Get path to bootstrap.py script."""
    # bootstrap.py is in mcp_server/daemon/
    return Path(__file__).parent / "bootstrap.py"
```

**Required**: Delete this method entirely

**Rationale**: No longer needed with module invocation. The module path is determined by Python's import system.

---

### 4. Update __init__ Constructor (Priority: P0)

**Current** (Lines 26-49):
```python
def __init__(self, venv_manager: Optional[VenvManager] = None):
    """Initialize systemd service manager.

    Args:
        venv_manager: Optional VenvManager instance. If None, creates default instance.

    Raises:
        VenvCreationError: If venv doesn't exist (platform-specific location from paths.py)
    """
    self.venv_manager = venv_manager or VenvManager()
    # Get venv Python executable - raise VenvCreationError if venv doesn't exist
    # (DaemonManager.install() ensures venv exists before instantiating service managers)
    self.python_exe = self.venv_manager.get_python_executable()
    self.bootstrap_script = self._get_bootstrap_path()  # ❌ Remove this line

    # User service directory
    xdg_config = os.environ.get("XDG_CONFIG_HOME", "")
    if xdg_config:
        self.service_dir = Path(xdg_config) / "systemd" / "user"
    else:
        self.service_dir = Path.home() / ".config" / "systemd" / "user"

    self.service_file = self.service_dir / f"{self.service_name}.service"
    self.log_dir = get_log_dir()
```

**Required**:
```python
def __init__(self, venv_manager: Optional[VenvManager] = None):
    """Initialize systemd service manager.

    Args:
        venv_manager: Optional VenvManager instance. If None, creates default instance.

    Raises:
        VenvCreationError: If venv doesn't exist (platform-specific location from paths.py)
    """
    self.venv_manager = venv_manager or VenvManager()
    # Get venv Python executable - raise VenvCreationError if venv doesn't exist
    # (DaemonManager.install() ensures venv exists before instantiating service managers)
    self.python_exe = self.venv_manager.get_python_executable()
    # ❌ Removed: self.bootstrap_script = self._get_bootstrap_path()

    # User service directory
    xdg_config = os.environ.get("XDG_CONFIG_HOME", "")
    if xdg_config:
        self.service_dir = Path(xdg_config) / "systemd" / "user"
    else:
        self.service_dir = Path.home() / ".config" / "systemd" / "user"

    self.service_file = self.service_dir / f"{self.service_name}.service"
    self.log_dir = get_log_dir()
```

**Changes**: Remove line 39 (`self.bootstrap_script = ...`)

---

### 5. Update install() Debug Output (Priority: P2)

**Current** (Lines 106-108):
```python
print(f"Python: {self.python_exe}")
print(f"Bootstrap script: {self.bootstrap_script}")
print(f"Service file: {self.service_file}")
```

**Required**:
```python
install_dir = get_install_dir()
print(f"Python: {self.python_exe}")
print(f"Install directory: {install_dir}")
print(f"Service file: {self.service_file}")
```

**Changes**: Replace "Bootstrap script" with "Install directory" (more accurate for v2.1)

---

### 6. Update Reference Template (Optional)

**File**: `mcp_server/daemon/templates/graphiti-bootstrap.service`

**Current** (Lines 21, 24, 26-27):
```ini
ExecStart=/usr/bin/python3 /path/to/mcp_server/daemon/bootstrap.py
WorkingDirectory=/path/to/mcp_server/daemon
StandardOutput=append:/home/user/.graphiti/logs/bootstrap-stdout.log
StandardError=append:/home/user/.graphiti/logs/bootstrap-stderr.log
```

**Required**:
```ini
ExecStart=/path/to/install/bin/python -m mcp_server.daemon.bootstrap
WorkingDirectory=/path/to/install
Environment="PYTHONPATH=/path/to/install/lib"
StandardOutput=append:/home/user/.local/state/graphiti/logs/bootstrap-stdout.log
StandardError=append:/home/user/.local/state/graphiti/logs/bootstrap-stderr.log
```

**Note**: This template is for reference only. The actual service file is generated dynamically.

---

## Dependencies

### Completed Dependencies
- ✅ Story 1: Platform-aware path resolution (`paths.py`) - Provides `get_install_dir()`, `get_log_dir()`
- ✅ Story 2: Daemon modules migrated to new paths - Bootstrap and venv_manager updated
- ✅ Story 10: Bootstrap module invocation - Bootstrap supports `-m` invocation with frozen path setup

### No Blocking Issues
All dependencies completed. Ready for implementation.

---

## Risk Assessment

### Low Risk Changes
1. ✅ **Import addition**: Adding `get_install_dir` import is safe
2. ✅ **Log paths**: Already using `get_log_dir()`, no change needed
3. ✅ **Service directory logic**: XDG_CONFIG_HOME detection unchanged

### Medium Risk Changes
1. ⚠️ **Module invocation**: Change from script to module invocation
   - **Mitigation**: Story 10 already implemented and tested module invocation
   - **Validation**: Bootstrap has `_setup_frozen_path()` for frozen mode detection

2. ⚠️ **PYTHONPATH environment variable**: New addition
   - **Mitigation**: Required for frozen packages, standard practice
   - **Validation**: Windows service already uses similar pattern (AppDirectory)

3. ⚠️ **Working directory change**: From script parent to install dir
   - **Mitigation**: Module invocation expects this location
   - **Validation**: Consistent with Windows service manager implementation

### No High Risk Changes
All changes align with established v2.1 architecture patterns.

---

## Testing Strategy

### Unit Tests
1. Test service unit file generation with correct paths
2. Test PYTHONPATH environment variable in generated unit
3. Test ExecStart uses module invocation syntax
4. Test WorkingDirectory uses get_install_dir()

### Integration Tests
1. Verify service installs successfully on Linux
2. Verify service starts and bootstrap runs correctly
3. Verify frozen packages are importable (PYTHONPATH works)
4. Verify logs appear in correct XDG state directory

### Test Coverage
- Story 9.t acceptance criteria:
  - [x] Generated unit file has correct ExecStart (`python -m ...`)
  - [x] Environment line sets PYTHONPATH correctly
  - [x] Log paths use XDG_STATE_HOME/graphiti/logs/

---

## Implementation Checklist

### Phase 1: Code Updates
- [ ] Add `get_install_dir` to imports (line 17)
- [ ] Remove `_get_bootstrap_path()` method (lines 51-54)
- [ ] Remove `self.bootstrap_script` from `__init__()` (line 39)
- [ ] Update `_create_service_unit()` for module invocation (lines 60-77)
- [ ] Update `install()` debug output (lines 106-108)

### Phase 2: Template Updates
- [ ] Update reference template `graphiti-bootstrap.service` (optional)

### Phase 3: Testing
- [ ] Verify unit file generation produces correct paths
- [ ] Verify PYTHONPATH environment variable is set
- [ ] Verify service installs and starts on Linux
- [ ] Verify logs appear in correct location

---

## Questions & Clarifications

### Q1: Should we validate PYTHONPATH directory exists?
**Answer**: No validation needed. The directory is created during frozen package deployment (Story 5), which happens before service installation.

### Q2: What if get_install_dir() is not frozen yet?
**Answer**: During development, `get_install_dir()` points to `~/.local/share/graphiti/` (XDG_DATA_HOME). Module invocation still works because Python finds modules relative to the working directory.

### Q3: Does systemd support multiple Environment lines?
**Answer**: Yes, systemd supports multiple `Environment=` lines in a service unit file. Each line sets one or more environment variables.

---

## References

### Related Files
- `mcp_server/daemon/systemd_service.py` - Main file to update
- `mcp_server/daemon/paths.py` - Provides path resolution functions
- `mcp_server/daemon/bootstrap.py` - Bootstrap supports module invocation (Story 10)
- `mcp_server/daemon/windows_service.py` - Reference implementation (already updated)
- `mcp_server/daemon/templates/graphiti-bootstrap.service` - Reference template

### Related Stories
- Story 1: Platform-aware path resolution
- Story 2: Daemon modules migration
- Story 8: LaunchdServiceManager updates (macOS, similar changes needed)
- Story 10: Bootstrap module invocation support

### Documentation
- `.claude/implementation/DAEMON_ARCHITECTURE_SPEC_v2.1.md` - v2.1 architecture spec
- XDG Base Directory Specification - Linux path conventions

---

## Conclusion

The SystemdServiceManager requires straightforward updates to align with v2.1 architecture:

1. **Module invocation** instead of direct script execution
2. **PYTHONPATH** environment variable for frozen package support
3. **Working directory** from `get_install_dir()` instead of script parent
4. **Log paths** already correct (using XDG state directory)

All changes follow established patterns from the Windows service manager (Story 7) and are supported by completed dependencies (Stories 1, 2, 10). Implementation risk is low to medium, with clear testing criteria.

**Ready for implementation phase (9.i)**.
