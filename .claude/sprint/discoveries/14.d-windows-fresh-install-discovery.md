# Discovery: Windows Fresh Install Test

**Story**: 14.d - Windows Fresh Install Test Discovery
**Created**: 2025-12-25
**Status**: Discovery Complete

## Executive Summary

This discovery phase identifies requirements, success criteria, and potential issues for end-to-end testing of fresh v2.1 installation on Windows. The test will verify the complete installation workflow including Task Scheduler registration, frozen package deployment, pythonw.exe invocation, and MCP server functionality.

**Key Finding**: Windows uses Task Scheduler for user-level services, with pythonw.exe (windowless Python) for daemon execution to prevent console windows during system operation.

---

## 1. Test Environment Requirements

### 1.1 Platform Requirements

**Minimum Configuration**:
- Windows Version: Windows 10 (version 1809+) or Windows 11
- Python Version: 3.10 or newer (compatible with graphiti-core)
- Architecture: x64 (AMD64/Intel 64-bit)
- User Privileges: Standard user (no admin required)

**Recommended Configuration**:
- Windows Version: Windows 11 23H2 or Windows 10 22H2
- Python Version: 3.11 or 3.12
- Architecture: x64 (test on both AMD64 and ARM64 if available)
- Disk Space: 1GB free (500MB for installation + overhead)

**Rationale**: Windows 10 1809+ provides consistent Task Scheduler behavior. Python 3.10+ required for graphiti-core dependencies. No admin privileges needed due to per-user installation architecture.

### 1.2 Pre-Test Environment Setup

**Clean State Verification**:
```powershell
# 1. Check for existing installation
Test-Path "$env:LOCALAPPDATA\Programs\Graphiti"
# Should return False on fresh install

# 2. Check for existing Task Scheduler task
schtasks /Query /TN "\Graphiti\GraphitiBootstrap" 2>$null
# Should return error "ERROR: The system cannot find the file specified." on fresh install

# 3. Check for old v2.0 installation (if testing migration)
Test-Path "$env:USERPROFILE\.graphiti"
# Should return False on fresh Windows test

# 4. Verify Python version
python --version
# Should be 3.10 or newer

# 5. Check available disk space
Get-PSDrive C | Select-Object Used,Free
# Should have at least 1GB free
```

**Test User Profile**:
- **Option 1 (Recommended)**: Create new Windows user account for isolated testing
- **Option 2**: Use existing account but manually clean Graphiti directories first
- **Option 3**: Use Windows VM snapshot for repeatable testing

**PowerShell Execution Policy** (if running PowerShell scripts):
```powershell
# Check current policy
Get-ExecutionPolicy

# If needed, set to RemoteSigned for current user (no admin required)
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

---

## 2. Expected File Locations (v2.1 Architecture)

### 2.1 Installation Directory (Frozen Packages)

**Location**: `%LOCALAPPDATA%\Programs\Graphiti\`

**Resolved Path**: `C:\Users\{user}\AppData\Local\Programs\Graphiti\`

**Purpose**: Executables, frozen packages, and runtime binaries

**Expected Structure**:
```
C:\Users\{user}\AppData\Local\Programs\Graphiti\
├── Scripts\
│   ├── python.exe                          # Python interpreter from venv
│   ├── pythonw.exe                         # No-console Python (critical for daemon)
│   ├── pip.exe                             # Package manager
│   ├── graphiti-mcp.exe                    # CLI wrapper
│   └── activate.bat                        # Venv activation script
├── lib\
│   ├── mcp_server\                         # Frozen mcp_server package
│   │   ├── __init__.py
│   │   ├── graphiti_mcp_server.py
│   │   ├── daemon\
│   │   │   ├── __init__.py
│   │   │   ├── bootstrap.py
│   │   │   ├── task_scheduler_service.py
│   │   │   ├── paths.py
│   │   │   └── installer.py
│   │   └── config\
│   │       └── __init__.py
│   ├── graphiti_core\                      # Frozen graphiti_core package
│   │   ├── __init__.py
│   │   └── [graphiti core modules]
│   └── PACKAGE_MANIFEST.json               # Package deployment metadata
├── VERSION                                  # Installed version (e.g., "0.24.3")
└── INSTALL_INFO                             # Installation metadata (JSON)
```

**Verification Commands**:
```powershell
# Check directory exists
Test-Path "$env:LOCALAPPDATA\Programs\Graphiti"

# Verify structure
tree /F "$env:LOCALAPPDATA\Programs\Graphiti" /A

# Check VERSION file
Get-Content "$env:LOCALAPPDATA\Programs\Graphiti\VERSION"

# Verify package manifest
Get-Content "$env:LOCALAPPDATA\Programs\Graphiti\lib\PACKAGE_MANIFEST.json" | ConvertFrom-Json

# Critical: Verify pythonw.exe exists (required for Task Scheduler)
Test-Path "$env:LOCALAPPDATA\Programs\Graphiti\Scripts\pythonw.exe"
```

### 2.2 Configuration Directory

**Location**: `%LOCALAPPDATA%\Graphiti\config\`

**Resolved Path**: `C:\Users\{user}\AppData\Local\Graphiti\config\`

**Purpose**: User-editable configuration files

**Expected Structure**:
```
C:\Users\{user}\AppData\Local\Graphiti\config\
└── graphiti.config.json          # Main configuration file
```

**Default Configuration Content** (from installer):
```json
{
  "daemon": {
    "enabled": false,
    "host": "127.0.0.1",
    "port": 8321,
    "config_poll_seconds": 5,
    "health_check_interval": 30
  },
  "neo4j": {
    "uri": "bolt://localhost:7687",
    "user": "neo4j",
    "password": ""
  },
  "openai": {
    "api_key": ""
  }
}
```

**Verification Commands**:
```powershell
# Check config directory
Test-Path "$env:LOCALAPPDATA\Graphiti\config"

# Verify config file
Get-Content "$env:LOCALAPPDATA\Graphiti\config\graphiti.config.json" | ConvertFrom-Json

# Check file permissions (should be user read/write)
Get-Acl "$env:LOCALAPPDATA\Graphiti\config\graphiti.config.json" | Format-List
```

### 2.3 Log Directory (State)

**Location**: `%LOCALAPPDATA%\Graphiti\logs\`

**Resolved Path**: `C:\Users\{user}\AppData\Local\Graphiti\logs\`

**Purpose**: Service logs and runtime data

**Expected Structure**:
```
C:\Users\{user}\AppData\Local\Graphiti\logs\
├── bootstrap-stdout.log          # Bootstrap service stdout
├── bootstrap-stderr.log          # Bootstrap service stderr
└── [future logs]
```

**Data Directory**: `%LOCALAPPDATA%\Graphiti\data\`

**Expected Structure**:
```
C:\Users\{user}\AppData\Local\Graphiti\data\
└── sessions\                     # Session storage (future)
```

**Verification Commands**:
```powershell
# Check log directory
Test-Path "$env:LOCALAPPDATA\Graphiti\logs"

# Tail bootstrap logs
Get-Content "$env:LOCALAPPDATA\Graphiti\logs\bootstrap-stdout.log" -Tail 50
Get-Content "$env:LOCALAPPDATA\Graphiti\logs\bootstrap-stderr.log" -Tail 50

# Watch logs in real-time (during testing)
Get-Content "$env:LOCALAPPDATA\Graphiti\logs\bootstrap-stdout.log" -Wait -Tail 10
```

### 2.4 Task Scheduler Task Definition

**Task Name**: `GraphitiBootstrap`

**Task Path**: `\Graphiti\GraphitiBootstrap`

**Purpose**: User-level scheduled task for bootstrap service

**Expected XML Configuration** (key elements):
```xml
<Task version="1.4">
  <RegistrationInfo>
    <Description>Graphiti MCP Bootstrap Service - Manages MCP server lifecycle</Description>
    <Author>{USERNAME}</Author>
  </RegistrationInfo>
  <Triggers>
    <LogonTrigger>
      <Enabled>true</Enabled>
      <UserId>{USERNAME}</UserId>
    </LogonTrigger>
  </Triggers>
  <Principals>
    <Principal id="Author">
      <UserId>{USERNAME}</UserId>
      <LogonType>InteractiveToken</LogonType>
      <RunLevel>LeastPrivilege</RunLevel>
    </Principal>
  </Principals>
  <Settings>
    <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy>
    <ExecutionTimeLimit>PT0S</ExecutionTimeLimit>
    <RestartOnFailure>
      <Interval>PT1M</Interval>
      <Count>3</Count>
    </RestartOnFailure>
  </Settings>
  <Actions Context="Author">
    <Exec>
      <Command>C:\Users\{user}\AppData\Local\Programs\Graphiti\Scripts\pythonw.exe</Command>
      <Arguments>-m mcp_server.daemon.bootstrap</Arguments>
      <WorkingDirectory>C:\Users\{user}\AppData\Local\Programs\Graphiti</WorkingDirectory>
    </Exec>
  </Actions>
</Task>
```

**Verification Commands**:
```powershell
# Check task exists
schtasks /Query /TN "\Graphiti\GraphitiBootstrap"

# View task details
schtasks /Query /TN "\Graphiti\GraphitiBootstrap" /V /FO LIST

# Export task XML for inspection
schtasks /Query /TN "\Graphiti\GraphitiBootstrap" /XML

# Check task status (Running/Ready/Disabled)
schtasks /Query /TN "\Graphiti\GraphitiBootstrap" /FO LIST | Select-String "Status"
```

**Critical Elements to Verify**:
1. **pythonw.exe** (not python.exe) - prevents console window popup
2. **-m mcp_server.daemon.bootstrap** - module invocation from frozen lib/
3. **WorkingDirectory** - set to install dir for PYTHONPATH resolution
4. **RestartOnFailure** - ensures service recovery
5. **LeastPrivilege** - runs as standard user (no admin)

---

## 3. Test Success Criteria

### 3.1 Installation Phase Success

**Criteria**:
1. ✅ All directories created successfully (install, config, logs, data)
2. ✅ Frozen packages deployed to `lib/` directory
3. ✅ pythonw.exe exists in Scripts/ (critical for daemon)
4. ✅ `VERSION` and `INSTALL_INFO` files created
5. ✅ `graphiti.config.json` created with valid JSON
6. ✅ Task Scheduler task created and enabled
7. ✅ No errors in installer output

**Verification Commands**:
```powershell
# 1. Verify directories exist
@(
    "$env:LOCALAPPDATA\Programs\Graphiti\Scripts",
    "$env:LOCALAPPDATA\Programs\Graphiti\lib",
    "$env:LOCALAPPDATA\Graphiti\config",
    "$env:LOCALAPPDATA\Graphiti\logs",
    "$env:LOCALAPPDATA\Graphiti\data"
) | ForEach-Object {
    if (Test-Path $_) { Write-Host "✓ $_" -ForegroundColor Green }
    else { Write-Host "✗ $_ missing" -ForegroundColor Red }
}

# 2. Verify frozen packages
@(
    "$env:LOCALAPPDATA\Programs\Graphiti\lib\mcp_server",
    "$env:LOCALAPPDATA\Programs\Graphiti\lib\graphiti_core"
) | ForEach-Object {
    if (Test-Path $_) { Write-Host "✓ $_" -ForegroundColor Green }
    else { Write-Host "✗ $_ missing" -ForegroundColor Red }
}

# 3. Verify critical executables
@(
    "$env:LOCALAPPDATA\Programs\Graphiti\Scripts\python.exe",
    "$env:LOCALAPPDATA\Programs\Graphiti\Scripts\pythonw.exe"
) | ForEach-Object {
    if (Test-Path $_) { Write-Host "✓ $_" -ForegroundColor Green }
    else { Write-Host "✗ $_ missing" -ForegroundColor Red }
}

# 4. Verify metadata files
@(
    "$env:LOCALAPPDATA\Programs\Graphiti\VERSION",
    "$env:LOCALAPPDATA\Programs\Graphiti\INSTALL_INFO"
) | ForEach-Object {
    if (Test-Path $_) { Write-Host "✓ $_" -ForegroundColor Green }
    else { Write-Host "✗ $_ missing" -ForegroundColor Red }
}

# 5. Verify config
if (Test-Path "$env:LOCALAPPDATA\Graphiti\config\graphiti.config.json") {
    try {
        Get-Content "$env:LOCALAPPDATA\Graphiti\config\graphiti.config.json" | ConvertFrom-Json | Out-Null
        Write-Host "✓ Config valid JSON" -ForegroundColor Green
    } catch {
        Write-Host "✗ Config invalid JSON" -ForegroundColor Red
    }
}

# 6. Verify Task Scheduler task
$task = schtasks /Query /TN "\Graphiti\GraphitiBootstrap" 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "✓ Task Scheduler task created" -ForegroundColor Green
} else {
    Write-Host "✗ Task Scheduler task not found" -ForegroundColor Red
}
```

### 3.2 Service Lifecycle Success

**Criteria**:
1. ✅ Task Scheduler task starts automatically on creation
2. ✅ Bootstrap service starts successfully (pythonw.exe process visible)
3. ✅ Bootstrap process visible in Task Manager
4. ✅ Logs written to expected location
5. ✅ Service restarts after manual stop (KeepAlive behavior)

**Verification Commands**:
```powershell
# 1. Check task status
schtasks /Query /TN "\Graphiti\GraphitiBootstrap" /FO LIST | Select-String "Status"

# 2. Check bootstrap process running
Get-Process pythonw -ErrorAction SilentlyContinue | Where-Object {
    $_.Path -like "*\Graphiti\Scripts\pythonw.exe"
}

# 3. Check process details in Task Manager
Get-Process pythonw | Select-Object Id,ProcessName,Path,StartTime

# 4. Verify logs exist and are recent
Get-ChildItem "$env:LOCALAPPDATA\Graphiti\logs\bootstrap-*.log" |
    Select-Object Name,LastWriteTime,Length

# 5. Test manual restart
schtasks /End /TN "\Graphiti\GraphitiBootstrap"
Start-Sleep -Seconds 5
schtasks /Run /TN "\Graphiti\GraphitiBootstrap"
Start-Sleep -Seconds 2
Get-Process pythonw -ErrorAction SilentlyContinue | Where-Object {
    $_.Path -like "*\Graphiti\Scripts\pythonw.exe"
}
```

### 3.3 MCP Server Functionality Success

**Criteria**:
1. ✅ MCP server starts when `daemon.enabled: true`
2. ✅ MCP server accessible on configured port (8321)
3. ✅ Health check endpoint responds (if implemented)
4. ✅ MCP server stops when `daemon.enabled: false`
5. ✅ No errors in MCP server logs

**Verification Commands**:
```powershell
# 1. Enable daemon in config
$config = Get-Content "$env:LOCALAPPDATA\Graphiti\config\graphiti.config.json" | ConvertFrom-Json
$config.daemon.enabled = $true
$config | ConvertTo-Json -Depth 10 | Set-Content "$env:LOCALAPPDATA\Graphiti\config\graphiti.config.json"

# 2. Wait for config poll (5 seconds) and check logs
Start-Sleep -Seconds 6
Get-Content "$env:LOCALAPPDATA\Graphiti\logs\bootstrap-stdout.log" -Tail 50 |
    Select-String "Starting MCP server"

# 3. Check MCP server process
Get-Process python -ErrorAction SilentlyContinue | Where-Object {
    $_.CommandLine -like "*graphiti_mcp_server*"
}

# 4. Test port accessibility
Test-NetConnection -ComputerName 127.0.0.1 -Port 8321 -InformationLevel Quiet

# 5. Test health endpoint (if implemented)
try {
    Invoke-WebRequest -Uri "http://127.0.0.1:8321/health" -UseBasicParsing
    Write-Host "✓ Health check passed" -ForegroundColor Green
} catch {
    Write-Host "✗ Health check failed: $_" -ForegroundColor Red
}

# 6. Disable daemon and verify shutdown
$config.daemon.enabled = $false
$config | ConvertTo-Json -Depth 10 | Set-Content "$env:LOCALAPPDATA\Graphiti\config\graphiti.config.json"
Start-Sleep -Seconds 6
Get-Content "$env:LOCALAPPDATA\Graphiti\logs\bootstrap-stdout.log" -Tail 50 |
    Select-String "Stopping MCP server"
```

---

## 4. Windows-Specific Considerations

### 4.1 User Account Control (UAC)

**Behavior**:
- LaunchAgents install to user-writable paths (`%LOCALAPPDATA%`)
- No admin elevation required for installation or service registration
- Task Scheduler tasks run with user privileges (LeastPrivilege)
- No UAC prompts during normal operation

**Risks**:
- None for per-user installation
- System-wide installation would require admin privileges (not supported in v2.1)

**Testing**:
- Verify installation completes without UAC prompts
- Verify service starts without admin privileges
- Test on standard user account (not administrator)

### 4.2 Task Scheduler Behavior

**Key Characteristics**:
- **User-Level Tasks**: Stored in user's task folder (`\Graphiti\`)
- **Trigger**: LogonTrigger for automatic start on user login
- **KeepAlive**: RestartOnFailure ensures service recovery
- **MultipleInstancesPolicy**: IgnoreNew prevents duplicate instances
- **RunLevel**: LeastPrivilege (standard user privileges)

**Common Issues**:
1. **Task not starting**: Check task status in Task Scheduler GUI
2. **pythonw.exe not found**: Verify Scripts\ directory exists
3. **Import errors**: Check WorkingDirectory is set to install dir
4. **Permissions**: Ensure task runs as current user

**Debugging Commands**:
```powershell
# View task history (requires Event Viewer)
Get-WinEvent -LogName Microsoft-Windows-TaskScheduler/Operational -MaxEvents 50 |
    Where-Object { $_.Message -like "*Graphiti*" }

# Check last run result
schtasks /Query /TN "\Graphiti\GraphitiBootstrap" /V /FO LIST |
    Select-String "Last Result"

# Manually run task for testing
schtasks /Run /TN "\Graphiti\GraphitiBootstrap"
```

### 4.3 pythonw.exe (Windowless Python)

**Purpose**: Prevents console window popup for daemon processes

**Behavior**:
- Same as python.exe but without console window
- Required for Task Scheduler background services
- Logs to stdout/stderr files instead of console

**Risks**:
- pythonw.exe missing: Installer must ensure venv includes it
- Console window appears: Indicates python.exe used instead of pythonw.exe
- Import errors: PYTHONPATH must include lib/ directory

**Verification**:
```powershell
# Verify pythonw.exe exists
Test-Path "$env:LOCALAPPDATA\Programs\Graphiti\Scripts\pythonw.exe"

# Check file properties
Get-Item "$env:LOCALAPPDATA\Programs\Graphiti\Scripts\pythonw.exe" |
    Select-Object FullName,Length,LastWriteTime

# Test pythonw.exe invocation
& "$env:LOCALAPPDATA\Programs\Graphiti\Scripts\pythonw.exe" --version
```

### 4.4 Path Resolution and Spaces

**Windows Path Characteristics**:
- Paths use backslashes (`\`)
- Common paths include spaces (e.g., "Application Data", "Programs")
- Environment variables: `%LOCALAPPDATA%`, `%USERPROFILE%`

**Task Scheduler Path Handling**:
- Paths in XML must NOT be quoted (Task Scheduler handles spaces)
- WorkingDirectory must be absolute path
- Command path must be absolute path to pythonw.exe

**Python Path Handling**:
- Use pathlib.Path for automatic path normalization
- Paths in Python code use forward slashes or backslashes interchangeably
- Environment variable expansion: `os.environ.get("LOCALAPPDATA")`

**Example**:
```xml
<!-- CORRECT (no quotes in XML) -->
<Command>C:\Users\Admin\AppData\Local\Programs\Graphiti\Scripts\pythonw.exe</Command>
<WorkingDirectory>C:\Users\Admin\AppData\Local\Programs\Graphiti</WorkingDirectory>

<!-- INCORRECT (quoted paths break Task Scheduler) -->
<Command>"C:\Users\Admin\AppData\Local\Programs\Graphiti\Scripts\pythonw.exe"</Command>
```

### 4.5 Service Persistence

**Automatic Start**:
- LogonTrigger: Task starts on user login
- RunAtLoad equivalent: Task runs immediately when loaded
- Survives user logout/login cycles
- Persists across system reboots

**Removal**:
- Uninstall must unload task: `schtasks /Delete /TN "\Graphiti\GraphitiBootstrap" /F`
- Task persists until explicitly deleted
- Removing files doesn't unregister task

**Testing**:
- Test logout/login cycle
- Test system reboot (service should auto-start)
- Verify task removal during uninstall

### 4.6 Logging and Debugging

**Log Locations**:
```powershell
# Bootstrap service logs (defined in task XML, redirected by pythonw.exe)
$env:LOCALAPPDATA\Graphiti\logs\bootstrap-stdout.log
$env:LOCALAPPDATA\Graphiti\logs\bootstrap-stderr.log

# Task Scheduler operational log
Get-WinEvent -LogName Microsoft-Windows-TaskScheduler/Operational -MaxEvents 100

# Windows Event Viewer (Application log)
Get-EventLog -LogName Application -Source "Task Scheduler" -Newest 50
```

**Common Issues**:
1. **Task not visible in scheduler**: Check `\Graphiti\` folder in Task Scheduler GUI
2. **Task failing silently**: Check stderr log for Python errors
3. **Import errors**: Verify PYTHONPATH or WorkingDirectory
4. **pythonw.exe not found**: Check Scripts\ directory path

**Debugging Tools**:
- Task Scheduler GUI: `taskschd.msc`
- Event Viewer: `eventvwr.msc`
- Process Explorer: Shows command-line arguments for pythonw.exe
- PowerShell Get-Process: Check running processes

---

## 5. Test Execution Checklist

### 5.1 Pre-Installation Checks

- [ ] Verify Python 3.10+ installed: `python --version`
- [ ] Check disk space: `Get-PSDrive C | Select-Object Free` (>1GB free)
- [ ] Verify no existing installation: `Test-Path "$env:LOCALAPPDATA\Programs\Graphiti"`
- [ ] Check for old v2.0 installation: `Test-Path "$env:USERPROFILE\.graphiti"`
- [ ] Document Windows version: `winver` or `systeminfo`
- [ ] Check user account type (standard vs admin)

### 5.2 Installation Phase

- [ ] Clone Graphiti repository to test location
- [ ] Navigate to repository root: `cd C:\path\to\graphiti`
- [ ] Run installer: `python -m mcp_server.daemon.installer`
- [ ] Verify no errors in installer output
- [ ] Check directories created (see 3.1)
- [ ] Verify frozen packages deployed (see 3.1)
- [ ] Check VERSION file exists and contains valid version
- [ ] Verify config file created with valid JSON
- [ ] Verify pythonw.exe exists in Scripts\

### 5.3 Service Registration Checks

- [ ] Verify task created: `schtasks /Query /TN "\Graphiti\GraphitiBootstrap"`
- [ ] Check task properties via Task Scheduler GUI (`taskschd.msc`)
- [ ] Verify task status is "Running" or "Ready"
- [ ] Check bootstrap process running: `Get-Process pythonw`
- [ ] Verify logs created: `Test-Path "$env:LOCALAPPDATA\Graphiti\logs\bootstrap-stdout.log"`
- [ ] Tail logs for startup messages: `Get-Content ... -Wait`

### 5.4 MCP Server Functionality

- [ ] Enable daemon in config: Set `daemon.enabled: true`
- [ ] Wait 6 seconds for config poll
- [ ] Verify MCP server started in logs
- [ ] Check MCP process running: `Get-Process python | Where CommandLine -like "*mcp*"`
- [ ] Test port accessibility: `Test-NetConnection -Port 8321`
- [ ] Test health endpoint: `Invoke-WebRequest http://127.0.0.1:8321/health`
- [ ] Test MCP tools via Claude Desktop (if available)
- [ ] Disable daemon: Set `daemon.enabled: false`
- [ ] Verify MCP server stopped in logs

### 5.5 Service Lifecycle Testing

- [ ] Test manual service stop: `schtasks /End /TN "\Graphiti\GraphitiBootstrap"`
- [ ] Verify service restarts (RestartOnFailure behavior)
- [ ] Test user logout/login (service should restart)
- [ ] Test system reboot (service should auto-start)
- [ ] Verify logs persist across restarts
- [ ] Check no console windows appear (pythonw.exe verification)

### 5.6 Cleanup Testing

- [ ] Run uninstaller (when implemented)
- [ ] Verify directories removed
- [ ] Check task unloaded and removed from Task Scheduler
- [ ] Confirm no orphaned processes
- [ ] Verify logs can be preserved if requested

---

## 6. Known Risks and Mitigation

### 6.1 pythonw.exe Missing

**Risk**: Virtual environment doesn't include pythonw.exe
**Impact**: Task Scheduler uses python.exe, causing console window popup
**Detection**: Console window appears when task runs
**Mitigation**: Installer must verify pythonw.exe exists before creating task
**Test**: Check `Scripts\pythonw.exe` exists post-install

### 6.2 PYTHONPATH Configuration

**Risk**: Frozen packages not in PYTHONPATH
**Impact**: `ImportError: No module named 'mcp_server'`
**Detection**: Check stderr log for import errors
**Mitigation**: Task XML sets WorkingDirectory to install dir (lib/ subdirectory)
**Test**: Manually run `pythonw.exe -m mcp_server.daemon.bootstrap` with same WorkingDirectory

### 6.3 Task Scheduler Permissions

**Risk**: Task created with wrong privileges (system vs user)
**Impact**: Service can't access user files or network resources
**Detection**: Permission errors in stderr log
**Mitigation**: Task XML specifies `<RunLevel>LeastPrivilege</RunLevel>` and `<UserId>{USERNAME}</UserId>`
**Test**: Verify task "Run As" matches current user in Task Scheduler GUI

### 6.4 Path Quoting in Task XML

**Risk**: Paths quoted in Task Scheduler XML
**Impact**: Task Scheduler fails to parse command
**Detection**: Task fails to start, error in Task Scheduler operational log
**Mitigation**: TaskSchedulerServiceManager uses unquoted paths in XML
**Test**: Export task XML and verify no quotes around Command/WorkingDirectory

### 6.5 Task Auto-Start Timing

**Risk**: Service starts before Neo4j/dependencies ready
**Impact**: MCP server fails health check
**Detection**: Connection errors in logs
**Mitigation**: Bootstrap service waits for config (daemon.enabled)
**Test**: Verify bootstrap starts but doesn't start MCP until enabled

### 6.6 UAC and Admin Privileges

**Risk**: User runs installer with admin privileges
**Impact**: Paths resolve to admin profile instead of user profile
**Detection**: Installation in wrong location (e.g., C:\Windows\System32)
**Mitigation**: Installer checks `%LOCALAPPDATA%` environment variable
**Test**: Verify installation works on standard user account (non-admin)

### 6.7 Antivirus/Security Software

**Risk**: Antivirus blocks pythonw.exe or freezes packages
**Impact**: Service fails to start or import errors
**Detection**: Access denied errors in stderr log
**Mitigation**: Installer logs file paths for user to whitelist
**Test**: Check logs for permission/access errors

---

## 7. Success Metrics

### 7.1 Installation Success

- **Time to Install**: <3 minutes (frozen packages already available)
- **Installer Errors**: 0 errors or exceptions
- **Directory Creation**: 100% of expected directories created
- **Package Deployment**: 100% of packages deployed correctly
- **pythonw.exe Verification**: 100% (critical for daemon)

### 7.2 Service Reliability

- **Service Load Success**: 100% (task created without error)
- **Bootstrap Startup**: 100% (pythonw.exe process starts and remains running)
- **MCP Server Startup**: 100% when `daemon.enabled: true`
- **Restart Success**: 100% (service recovers from manual stop)
- **No Console Windows**: 100% (pythonw.exe prevents popups)

### 7.3 User Experience

- **Manual Steps**: Minimal (ideally just run installer)
- **UAC Prompts**: 0 (per-user installation)
- **Configuration Clarity**: Config file location documented
- **Error Messages**: Clear and actionable
- **Log Accessibility**: Logs easy to find and tail

---

## 8. Test Environment Documentation

### 8.1 Test System Specification

**Example Test Configuration**:
```
Windows Version: Windows 11 23H2 (Build 22631.4602)
Hardware: Dell XPS 15 (Intel Core i7-13700H, 32GB RAM)
Python Version: 3.11.9
Architecture: AMD64 (x64)
Disk Space: 500GB free (SSD)
Test User: test-graphiti (standard user, non-admin)
Antivirus: Windows Defender (active)
```

### 8.2 Test Execution Log Template

```markdown
## Windows Fresh Install Test - Execution Log

**Date**: YYYY-MM-DD
**Tester**: [Name]
**Environment**: [Windows version, Python version, architecture]

### Pre-Installation
- [ ] Python version: [version]
- [ ] Windows version: [version]
- [ ] Disk space: [GB free]
- [ ] Existing installation: [yes/no]
- [ ] User account type: [standard/admin]

### Installation
- [ ] Installer command: [command]
- [ ] Installation duration: [seconds]
- [ ] Installer output: [success/errors]
- [ ] Directories created: [list]
- [ ] pythonw.exe verified: [yes/no]

### Service Registration
- [ ] Task created: [yes/no]
- [ ] Task status: [Running/Ready/Disabled]
- [ ] Bootstrap running: [PID]
- [ ] Logs present: [yes/no]
- [ ] No console windows: [verified]

### MCP Server Testing
- [ ] Daemon enabled: [timestamp]
- [ ] MCP server started: [timestamp]
- [ ] Health check: [pass/fail]
- [ ] Port accessible: [yes/no]
- [ ] Tools functional: [yes/no]

### Service Lifecycle
- [ ] Manual stop/restart: [pass/fail]
- [ ] Logout/login test: [pass/fail]
- [ ] Reboot test: [pass/fail]

### Issues Encountered
[List any issues, errors, or unexpected behavior]

### Overall Result
- [ ] PASS - All criteria met
- [ ] FAIL - [list failures]
- [ ] PARTIAL - [list incomplete items]
```

---

## 9. References

### 9.1 Code References

- **TaskSchedulerServiceManager**: `mcp_server\daemon\task_scheduler_service.py`
- **Path Resolution**: `mcp_server\daemon\paths.py`
- **Bootstrap Service**: `mcp_server\daemon\bootstrap.py`
- **GraphitiInstaller**: `mcp_server\daemon\installer.py`

### 9.2 Documentation References

- **Task Scheduler**: `schtasks /?` or Task Scheduler MMC (`taskschd.msc`)
- **PowerShell Task Scheduler**: `Get-Help *ScheduledTask*`
- **Microsoft Docs**: [Task Scheduler Overview](https://docs.microsoft.com/en-us/windows/win32/taskschd/task-scheduler-start-page)

### 9.3 Related Stories

- **Story 7**: Update WindowsTaskSchedulerManager - COMPLETED
- **Story 10**: Fix Bootstrap Module Invocation - COMPLETED
- **Story 15**: macOS Fresh Install Test - Discovery phase complete

---

## 10. Next Steps

**Post-Discovery Actions**:
1. ✅ Create this discovery document (14.d)
2. ⏭️ Schedule implementation testing (14.i)
3. ⏭️ Prepare test Windows environment (clean user or VM)
4. ⏭️ Execute test checklist and document results
5. ⏭️ Update story status based on test outcomes

**Dependencies for Testing**:
- Story 7 (TaskSchedulerServiceManager) - ✅ COMPLETED
- Story 10 (Bootstrap Module Invocation) - ✅ COMPLETED
- Windows test environment - ⏭️ PENDING SETUP

**Estimated Testing Duration**: 2-3 hours (including environment setup and documentation)

---

**Discovery Status**: ✅ Complete
**Ready for Implementation Testing**: Yes (pending test environment setup)
