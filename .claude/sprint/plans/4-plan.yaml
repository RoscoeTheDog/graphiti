# Plan: 4
# Generated by: discovery:4.d
# Timestamp: 2025-12-14T22:30:00Z

story_id: "4"
title: "PATH Integration"
created: "2025-12-14T22:30:00Z"
created_by: "discovery:4.d"

# Analysis Summary
analysis:
  summary: "Add PATH detection and instruction output to daemon install command, with optional Windows registry modification and Unix shell rc snippets"
  complexity: "medium"
  estimated_files: 3
  estimated_tokens: 8000
  risk_factors:
    - "Windows registry modification requires elevated permissions (mitigated by making it optional with user consent)"
    - "Shell detection on Unix requires identifying user's shell (bash vs zsh)"
    - "PATH detection must handle various formats (Unix-style, Windows environment variables)"

# Files to Create
files_to_create:
  - path: "mcp_server/daemon/path_integration.py"
    purpose: "Core module for PATH detection, instruction generation, and optional configuration"
    pattern_source: "mcp_server/daemon/wrapper_generator.py"
    estimated_lines: 250
    responsibilities:
      - "Detect if ~/.graphiti/bin/ is in current PATH"
      - "Generate platform-specific PATH instructions"
      - "Provide optional Windows registry modification (with consent)"
      - "Generate Unix shell rc snippets"
      - "Detect user's shell (bash/zsh) on Unix systems"

  - path: "tests/daemon/test_path_integration.py"
    purpose: "Unit and integration tests for PATH integration functionality"
    pattern_source: "tests/daemon/test_wrapper_generator.py"
    estimated_lines: 200
    responsibilities:
      - "Test PATH detection on various platforms"
      - "Test instruction generation for Windows/Unix"
      - "Mock registry operations for Windows tests"
      - "Test shell detection logic"
      - "Test error handling and edge cases"

# Files to Modify
files_to_modify:
  - path: "mcp_server/daemon/manager.py"
    changes:
      - "Import PathIntegration class from path_integration module"
      - "Add PathIntegration instantiation in DaemonManager.__init__"
      - "Add new step (2.7) in install() method after wrapper generation"
      - "Output PATH instructions using PathIntegration.display_instructions()"
      - "Handle optional Windows PATH configuration if user consents"
    lines_affected: 30

# Integration Points
integration:
  - file: "mcp_server/daemon/manager.py"
    type: "import"
    description: "Import PathIntegration class and integrate into install workflow"

  - file: "mcp_server/daemon/manager.py"
    type: "workflow"
    description: "Add PATH instruction step after wrapper generation (Step 2.7)"

# Patterns to Follow
patterns:
  - source: "mcp_server/daemon/wrapper_generator.py"
    pattern: "Platform detection using sys.platform, Path objects for cross-platform paths"

  - source: "mcp_server/daemon/wrapper_generator.py"
    pattern: "Custom exception classes (WrapperGenerationError -> PathIntegrationError)"

  - source: "mcp_server/daemon/venv_manager.py"
    pattern: "Logging with logger.debug/info/error, success/failure tuple returns"

  - source: "mcp_server/daemon/manager.py"
    pattern: "Step-by-step output with print statements, try/except with cleanup messages"

# Test Requirements
test_requirements:
  unit:
    - "Test PATH detection returns True when ~/.graphiti/bin in PATH"
    - "Test PATH detection returns False when ~/.graphiti/bin not in PATH"
    - "Test Windows instruction generation includes registry command"
    - "Test Unix instruction generation includes bash rc snippet"
    - "Test Unix instruction generation includes zsh rc snippet based on shell detection"
    - "Test shell detection on Unix (bash vs zsh)"
    - "Test error handling when PATH environment variable is empty/missing"
    - "Test idempotent PATH detection (multiple calls return same result)"

  integration:
    - "Test DaemonManager.install() outputs PATH instructions after wrapper generation"
    - "Test end-to-end install workflow includes PATH step"
    - "Test Windows registry modification (mocked) with user consent"
    - "Test Windows registry modification skipped without consent"
    - "Test Unix rc snippet generation for copy-paste"

  security:
    - "Test Windows registry modification requires explicit user consent"
    - "Test no automatic system modification without user approval"
    - "Test PATH detection doesn't expose sensitive information in logs"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-4.1"
    text: "(P0) daemon install outputs clear PATH instructions for user's platform"
    implementation: "files_to_create[0] + files_to_modify[0]"
    tests: "test_requirements.integration[0,1]"

  - id: "AC-4.2"
    text: "(P1) Windows: Optionally modifies user PATH via registry (with user consent)"
    implementation: "files_to_create[0] - PathIntegration.configure_windows_path()"
    tests: "test_requirements.integration[2,3] + test_requirements.security[0,1]"

  - id: "AC-4.3"
    text: "(P1) Unix: Outputs shell rc file snippet for copy-paste"
    implementation: "files_to_create[0] - PathIntegration.generate_unix_snippet()"
    tests: "test_requirements.unit[3,4,5] + test_requirements.integration[4]"

  - id: "AC-4.4"
    text: "(P2) Detects if PATH already includes ~/.graphiti/bin/"
    implementation: "files_to_create[0] - PathIntegration.detect_in_path()"
    tests: "test_requirements.unit[0,1,6,7]"

# Implementation Details
implementation_details:
  path_detection:
    - "Parse os.environ['PATH'] variable"
    - "Split by platform-specific delimiter (';' on Windows, ':' on Unix)"
    - "Normalize paths for comparison (resolve ~, handle symlinks)"
    - "Check if ~/.graphiti/bin/ exists in normalized paths"

  windows_instructions:
    - "Display GUI instructions (System Properties > Environment Variables)"
    - "Display PowerShell command for registry modification"
    - "Prompt user for consent before registry modification"
    - "Use winreg module for registry operations (if consent given)"

  unix_instructions:
    - "Detect shell using $SHELL environment variable"
    - "Generate appropriate rc file snippet (~/.bashrc or ~/.zshrc)"
    - "Display copy-pastable export command"
    - "Show source command to reload shell"

  shell_detection:
    - "Check $SHELL environment variable"
    - "Fallback to /etc/passwd entry for current user"
    - "Default to bash if detection fails"

  user_consent_flow:
    - "Display registry modification prompt on Windows"
    - "Explain what will be changed and why"
    - "Accept y/n input from user"
    - "Only proceed with registry modification on explicit 'y'"

# Edge Cases to Handle
edge_cases:
  - "PATH environment variable not set (should not crash)"
  - "Multiple instances of ~/.graphiti/bin/ in PATH (detect first occurrence)"
  - "PATH contains non-existent directories (ignore during comparison)"
  - "Windows: User lacks registry write permissions (graceful error)"
  - "Unix: Shell rc file doesn't exist (offer to create)"
  - "Unix: Shell rc file not writable (show manual instructions)"

# Dependencies
dependencies:
  external_libraries:
    - "winreg (Windows only, built-in)"
    - "os, sys, pathlib (built-in)"

  internal_modules:
    - "mcp_server.daemon.wrapper_generator (pattern reference)"
    - "mcp_server.daemon.manager (integration point)"

# Success Criteria
success_criteria:
  - "User sees clear PATH instructions after daemon install"
  - "Instructions are platform-specific and actionable"
  - "Windows users can optionally auto-configure PATH"
  - "Unix users get copy-pastable rc snippets"
  - "System detects if PATH is already configured"
  - "No system modifications without explicit user consent"
  - "All tests pass with >90% coverage"
