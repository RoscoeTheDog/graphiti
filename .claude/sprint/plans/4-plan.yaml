# Plan: 4
# Generated by: discovery:4.d
# Timestamp: 2025-12-18T18:15:00Z

story_id: "4"
title: "CLI Commands - list-projects, set-override, remove-override"
created: "2025-12-18T18:15:00Z"
created_by: "discovery:4.d"

# Analysis Summary
analysis:
  summary: "Create a new CLI module for project config management with three commands: list-projects (lists all project overrides), set-override (adds/updates override for a project+key), remove-override (removes specific override or all overrides for a project). Integrate with existing session_tracking_cli.py patterns and unified_config.py's project_overrides dict."
  complexity: "medium"
  estimated_files: 3
  estimated_tokens: 6000
  risk_factors:
    - "Key path validation must support nested keys (e.g., llm.default_model) and distinguish valid from invalid paths"
    - "Non-overridable section detection must provide helpful error messages with examples"
    - "Config file modifications must preserve existing structure and comments (use json.dumps with indent=2)"
    - "Project path normalization must work cross-platform (Windows vs Unix paths)"
    - "CLI must be accessible via console script entry point (pyproject.toml)"

# Dependencies
dependencies:
  - story_id: "2"
    status: "completed"
    provided: ["get_effective_config()", "project_overrides dict", "normalize_project_path()", "ProjectOverride schema"]

# Files to Create
files_to_create:
  - path: "mcp_server/config_cli.py"
    purpose: "CLI module for project config management commands"
    lines: 400
    key_functions:
      - "main() - CLI entry point with subparsers"
      - "cmd_list_projects() - List all projects with overrides"
      - "cmd_set_override() - Add/update override for project+key"
      - "cmd_remove_override() - Remove specific override or all for project"
      - "find_config_file() - Locate config file (project or global)"
      - "load_config_dict() - Load config as dict for manipulation"
      - "save_config_dict() - Save config dict to file"
      - "validate_key_path() - Validate key path is valid and overridable"
      - "set_nested_value() - Set value in nested dict using dot notation"
      - "delete_nested_value() - Delete value from nested dict using dot notation"

  - path: "tests/test_config_cli.py"
    purpose: "Tests for config CLI commands"
    lines: 600
    test_classes:
      - "TestListProjects - Tests for list-projects command"
      - "TestSetOverride - Tests for set-override command"
      - "TestRemoveOverride - Tests for remove-override command"
      - "TestKeyPathValidation - Tests for key path validation"
      - "TestConfigFileOperations - Tests for config load/save"

# Files to Modify
files_to_modify:
  - path: "mcp_server/pyproject.toml"
    changes:
      - "Add entry point: graphiti-mcp-config = mcp_server.config_cli:main"
    lines_affected: 1

# Key Implementation Details
implementation:
  cli_structure:
    command: "graphiti-mcp config"
    subcommands:
      - "list-projects - Lists all projects with overrides"
      - "set-override - Adds/updates override for project+key"
      - "remove-override - Removes specific override"

  list_projects_command:
    signature: "def cmd_list_projects(args: argparse.Namespace) -> None"
    algorithm:
      - "Load config file using find_config_file()"
      - "If no config file: print 'No config file found' and exit"
      - "Load config dict using load_config_dict()"
      - "Extract project_overrides dict"
      - "If empty: print 'No project overrides configured' and exit"
      - "For each (project_path, override) in project_overrides:"
      - "  Print project path (normalized)"
      - "  Print override sections (llm, embedder, extraction, session_tracking)"
      - "  Print sample values (e.g., llm.provider, llm.default_model)"
    output_format:
      - "Project: /c/Users/Admin/project1"
      - "  llm.provider: anthropic"
      - "  llm.default_model: claude-3-5-sonnet-latest"
      - ""
      - "Project: /home/user/project2"
      - "  session_tracking.enabled: false"

  set_override_command:
    signature: "def cmd_set_override(args: argparse.Namespace) -> None"
    arguments:
      - "--project PATH (required) - Project path (any format, will be normalized)"
      - "--key KEY (required) - Dot-notation key (e.g., llm.default_model)"
      - "--value VALUE (required) - Value to set (auto-detect type: string, int, float, bool)"
    algorithm:
      - "Normalize project path using normalize_project_path()"
      - "Validate key path using validate_key_path()"
      - "  If invalid: print error with examples and exit"
      - "Parse value to appropriate type (bool, int, float, string)"
      - "Load config file using find_config_file()"
      - "  If no config: create default config at global location"
      - "Load config dict using load_config_dict()"
      - "Ensure project_overrides dict exists"
      - "Ensure project entry exists in project_overrides"
      - "Set nested value using set_nested_value(project_override, key, value)"
      - "Save config dict using save_config_dict()"
      - "Print success message with normalized path and key"
    value_type_detection:
      - "true/false (case-insensitive) → bool"
      - "Integer string → int"
      - "Float string → float"
      - "Otherwise → string"

  remove_override_command:
    signature: "def cmd_remove_override(args: argparse.Namespace) -> None"
    arguments:
      - "--project PATH (required) - Project path"
      - "--key KEY (optional) - Specific key to remove"
      - "--all (optional) - Remove all overrides for project"
    algorithm:
      - "Normalize project path using normalize_project_path()"
      - "Validate arguments: --key XOR --all (exactly one must be provided)"
      - "Load config file using find_config_file()"
      - "  If no config: print error and exit"
      - "Load config dict using load_config_dict()"
      - "Check project exists in project_overrides"
      - "  If not: print error and exit"
      - "If --all:"
      - "  Delete project entry from project_overrides"
      - "  Print 'Removed all overrides for {project}'"
      - "Else if --key:"
      - "  Validate key path using validate_key_path()"
      - "  Delete nested value using delete_nested_value()"
      - "  If project override is now empty: delete project entry"
      - "  Print 'Removed {key} override for {project}'"
      - "Save config dict using save_config_dict()"

  key_path_validation:
    signature: "def validate_key_path(key: str) -> tuple[bool, str]"
    purpose: "Validate key path is valid and overridable"
    valid_sections:
      - "llm"
      - "embedder"
      - "extraction"
      - "session_tracking"
    valid_examples:
      - "llm.provider"
      - "llm.default_model"
      - "llm.temperature"
      - "llm.openai.api_key_env"
      - "embedder.provider"
      - "embedder.model"
      - "session_tracking.enabled"
      - "session_tracking.filter.tool_calls"
      - "extraction.max_reflexion_iterations"
    invalid_sections:
      - "database (global only)"
      - "daemon (global only)"
      - "resilience (global only)"
      - "mcp_server (global only)"
      - "logging (global only)"
      - "version (global only)"
      - "project (global only)"
      - "search (global only)"
      - "performance (global only)"
    algorithm:
      - "Split key by '.'"
      - "Extract root section (first part)"
      - "If root section not in valid_sections:"
      - "  Return (False, error_message_with_examples)"
      - "Return (True, '')"
    error_message_format:
      - "Invalid key path: '{key}'"
      - "Section '{section}' is not overridable."
      - ""
      - "Overridable sections:"
      - "  - llm (e.g., llm.provider, llm.default_model)"
      - "  - embedder (e.g., embedder.provider, embedder.model)"
      - "  - extraction (e.g., extraction.max_reflexion_iterations)"
      - "  - session_tracking (e.g., session_tracking.enabled)"
      - ""
      - "Non-overridable sections: database, daemon, resilience, mcp_server, logging"

  nested_value_operations:
    set_nested_value:
      signature: "def set_nested_value(obj: dict, key_path: str, value: Any) -> None"
      algorithm:
        - "Split key_path by '.'"
        - "Traverse dict using keys, creating nested dicts as needed"
        - "Set final key to value"
      example: "set_nested_value(override, 'llm.default_model', 'gpt-4.1-mini')"

    delete_nested_value:
      signature: "def delete_nested_value(obj: dict, key_path: str) -> None"
      algorithm:
        - "Split key_path by '.'"
        - "Traverse dict using keys"
        - "Delete final key from parent dict"
        - "Clean up empty parent dicts (optional)"
      example: "delete_nested_value(override, 'llm.default_model')"

  config_file_operations:
    find_config_file:
      signature: "def find_config_file() -> Optional[Path]"
      search_order:
        - "./graphiti.config.json (project root)"
        - "~/.graphiti/graphiti.config.json (global)"
      return: "Path to config file, or None if not found"

    load_config_dict:
      signature: "def load_config_dict(config_path: Path) -> dict"
      algorithm:
        - "Read file using config_path.read_text()"
        - "Parse JSON using json.loads()"
        - "Return dict"
      error_handling: "Catch JSONDecodeError, print error, sys.exit(1)"

    save_config_dict:
      signature: "def save_config_dict(config_path: Path, config: dict) -> None"
      algorithm:
        - "Write file using config_path.write_text(json.dumps(config, indent=2))"
        - "Print success message"
      error_handling: "Catch exceptions, print error, sys.exit(1)"

# Integration Points
integration:
  - file: "mcp_server/unified_config.py"
    type: "import"
    description: "Import normalize_project_path() for path normalization"

  - file: "mcp_server/unified_config.py"
    type: "reference"
    description: "ProjectOverride schema defines valid overridable sections"

  - file: "mcp_server/session_tracking_cli.py"
    type: "pattern"
    description: "Follow existing patterns for find_config_file(), load_config(), save_config()"

  - file: "mcp_server/pyproject.toml"
    type: "entry_point"
    description: "Add console script entry point for graphiti-mcp-config"

# Patterns to Follow
patterns:
  - source: "mcp_server/session_tracking_cli.py"
    pattern: "Use argparse for CLI structure with subparsers for commands"

  - source: "mcp_server/session_tracking_cli.py"
    pattern: "Load config as dict for manipulation (not Pydantic model)"

  - source: "mcp_server/session_tracking_cli.py"
    pattern: "Print helpful messages with [OK], [ERROR] prefixes"

  - source: "mcp_server/unified_config.py"
    pattern: "Use normalize_project_path() for consistent path representation"

  - source: "mcp_server/unified_config.py"
    pattern: "Use json.dumps(config, indent=2) for pretty formatting"

# Test Requirements
test_requirements:
  unit:
    - "test_list_projects_empty: No project_overrides → prints 'No project overrides configured'"
    - "test_list_projects_single: One project override → prints project path and override values"
    - "test_list_projects_multiple: Multiple project overrides → prints all projects"
    - "test_set_override_new_project: Project not in overrides → creates entry"
    - "test_set_override_existing_project: Project in overrides → updates entry"
    - "test_set_override_nested_key: Key 'llm.default_model' → sets nested value correctly"
    - "test_set_override_bool_value: Value 'true' → parses as bool True"
    - "test_set_override_int_value: Value '42' → parses as int 42"
    - "test_set_override_float_value: Value '0.5' → parses as float 0.5"
    - "test_set_override_string_value: Value 'gpt-4' → stores as string 'gpt-4'"
    - "test_set_override_creates_config: No config file → creates global config"
    - "test_remove_override_all: --all flag → removes project entry"
    - "test_remove_override_key: --key flag → removes specific key"
    - "test_remove_override_key_not_found: Key doesn't exist → error"
    - "test_remove_override_project_not_found: Project doesn't exist → error"
    - "test_remove_override_invalid_args: Neither --key nor --all → error"
    - "test_validate_key_path_valid_llm: 'llm.provider' → returns (True, '')"
    - "test_validate_key_path_valid_nested: 'llm.openai.api_key_env' → returns (True, '')"
    - "test_validate_key_path_invalid_database: 'database.backend' → returns (False, error_msg)"
    - "test_validate_key_path_invalid_daemon: 'daemon.enabled' → returns (False, error_msg)"
    - "test_set_nested_value_simple: 'llm.provider' → sets llm.provider"
    - "test_set_nested_value_deep: 'llm.openai.api_key_env' → creates nested structure"
    - "test_delete_nested_value_simple: 'llm.provider' → deletes llm.provider"
    - "test_delete_nested_value_deep: 'llm.openai.api_key_env' → deletes nested value"
    - "test_normalize_project_path_windows: 'C:\\Users\\Admin\\project' → '/c/Users/Admin/project'"
    - "test_normalize_project_path_unix: '/home/user/project' → '/home/user/project'"

  integration:
    - "test_set_override_end_to_end: Create config, set override, reload, verify in project_overrides"
    - "test_remove_override_end_to_end: Set override, remove it, reload, verify removed"
    - "test_list_projects_end_to_end: Set multiple overrides, list, verify output"

  edge_cases:
    - "test_set_override_empty_value: Value '' → stores as empty string"
    - "test_set_override_special_chars: Value with spaces/quotes → stores correctly"
    - "test_remove_override_cleans_empty_project: Remove last key → removes project entry"
    - "test_validate_key_path_empty: '' → returns (False, error)"
    - "test_validate_key_path_no_dot: 'llm' → returns (True, '') (section-level override)"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-1 (P0)"
    text: "graphiti-mcp config list-projects lists all projects with overrides"
    implementation: "cmd_list_projects() - Load project_overrides, print each project with override values"
    tests: "test_requirements.unit[0-2], test_requirements.integration[2]"

  - id: "AC-2 (P0)"
    text: "graphiti-mcp config set-override --project PATH --key KEY --value VALUE adds/updates override"
    implementation: "cmd_set_override() - Normalize path, validate key, set nested value, save config"
    tests: "test_requirements.unit[3-11], test_requirements.integration[0]"

  - id: "AC-3 (P0)"
    text: "graphiti-mcp config remove-override --project PATH --key KEY removes specific override"
    implementation: "cmd_remove_override() - Delete nested value, save config"
    tests: "test_requirements.unit[12-15], test_requirements.integration[1]"

  - id: "AC-4 (P1)"
    text: "--all flag for remove-override deletes all overrides for a project"
    implementation: "cmd_remove_override() - Handle --all flag, delete project entry"
    tests: "test_requirements.unit[12]"

  - id: "AC-5 (P1)"
    text: "Commands validate key paths (e.g., llm.default_model is valid)"
    implementation: "validate_key_path() - Check root section is overridable"
    tests: "test_requirements.unit[16-19]"

  - id: "AC-6 (P1)"
    text: "Commands reject non-overridable sections with helpful error"
    implementation: "validate_key_path() - Return error message with examples for invalid sections"
    tests: "test_requirements.unit[18-19]"

# Implementation Notes
implementation_notes:
  - "CLI entry point: graphiti-mcp-config (follows existing pattern of graphiti-mcp-session-tracking)"
  - "Use session_tracking_cli.py as template for CLI structure, config file operations"
  - "Manipulate config as dict (not Pydantic model) to preserve unknown fields and structure"
  - "Use normalize_project_path() from unified_config.py for consistent path representation"
  - "Value type detection: true/false → bool, numeric → int/float, else → string"
  - "Key path validation: root section must be in [llm, embedder, extraction, session_tracking]"
  - "Error messages should be helpful with examples (like AC-6)"
  - "Config file format: json.dumps(config, indent=2) for readability"
  - "Project path normalization: Windows C:\\ → /c/, Unix /home → /home (UNIX format for hashing)"
  - "Entry point in pyproject.toml: graphiti-mcp-config = mcp_server.config_cli:main"

# Edge Cases to Handle
edge_cases:
  - case: "No config file exists"
    handling: "set-override creates global config, list-projects/remove-override error"

  - case: "Project not in project_overrides"
    handling: "set-override creates entry, remove-override errors"

  - case: "Key path doesn't exist in override"
    handling: "remove-override errors with 'Key not found'"

  - case: "Removing last key from project"
    handling: "remove-override deletes entire project entry from project_overrides"

  - case: "Invalid key path (non-overridable section)"
    handling: "set-override/remove-override error with helpful message and examples"

  - case: "Value type ambiguity"
    handling: "Use type detection heuristics (bool > int > float > string)"

  - case: "Empty value"
    handling: "Store as empty string (valid use case)"

  - case: "Project path with spaces or special chars"
    handling: "normalize_project_path() handles via Path.resolve()"

# Success Criteria
success_criteria:
  - "All P0 acceptance criteria tests pass"
  - "All P1 acceptance criteria tests pass"
  - "Code passes type checking (pyright)"
  - "Code passes linting (ruff)"
  - "Test coverage >80% for new code"
  - "CLI commands are accessible via graphiti-mcp-config entry point"
  - "Error messages are helpful with examples"
  - "Config file structure is preserved (no data loss)"

# CLI Usage Examples
examples:
  list_projects:
    - command: "graphiti-mcp config list-projects"
      output: |
        Project: /c/Users/Admin/Documents/GitHub/myproject
          llm.provider: anthropic
          llm.default_model: claude-3-5-sonnet-latest

        Project: /home/user/anotherproject
          session_tracking.enabled: false
          session_tracking.filter.tool_calls: true

  set_override:
    - command: "graphiti-mcp config set-override --project ~/myproject --key llm.provider --value anthropic"
      output: "[OK] Set llm.provider = anthropic for project /c/Users/Admin/myproject"

    - command: "graphiti-mcp config set-override --project ~/myproject --key llm.default_model --value claude-3-5-sonnet-latest"
      output: "[OK] Set llm.default_model = claude-3-5-sonnet-latest for project /c/Users/Admin/myproject"

    - command: "graphiti-mcp config set-override --project ~/myproject --key session_tracking.enabled --value false"
      output: "[OK] Set session_tracking.enabled = False for project /c/Users/Admin/myproject"

  remove_override:
    - command: "graphiti-mcp config remove-override --project ~/myproject --key llm.provider"
      output: "[OK] Removed llm.provider override for project /c/Users/Admin/myproject"

    - command: "graphiti-mcp config remove-override --project ~/myproject --all"
      output: "[OK] Removed all overrides for project /c/Users/Admin/myproject"

  error_examples:
    - command: "graphiti-mcp config set-override --project ~/myproject --key database.backend --value neo4j"
      output: |
        [ERROR] Invalid key path: 'database.backend'
        Section 'database' is not overridable.

        Overridable sections:
          - llm (e.g., llm.provider, llm.default_model)
          - embedder (e.g., embedder.provider, embedder.model)
          - extraction (e.g., extraction.max_reflexion_iterations)
          - session_tracking (e.g., session_tracking.enabled)

        Non-overridable sections: database, daemon, resilience, mcp_server, logging
