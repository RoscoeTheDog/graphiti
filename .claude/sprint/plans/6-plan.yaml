# Plan: 6
# Generated by: discovery:6.d
# Timestamp: 2025-12-23T21:50:00Z

story_id: "6"
title: "Standalone uninstall scripts for all platforms"
created: "2025-12-23T21:50:00Z"
created_by: "discovery:6.d"

# Analysis Summary
analysis:
  summary: "Create comprehensive standalone uninstall scripts for Windows, macOS, and Linux that can fully remove the Graphiti MCP bootstrap daemon installation even when the repository or venv is corrupted/missing. Scripts must handle graceful failures and provide clear feedback."
  complexity: "medium"
  estimated_files: 6
  estimated_tokens: 15000
  risk_factors:
    - "Service must be stopped before uninstallation (race conditions if service auto-restarts)"
    - "Platform-specific service removal syntax (NSSM on Windows, launchctl on macOS, systemctl on Linux)"
    - "User may not have service files if manual deletion occurred"
    - "Wrapper scripts in PATH may require manual removal instructions (not all PATH modifications are scriptable)"
    - "MCP config in Claude Desktop requires manual removal (no API access to Claude config)"
    - "Need to preserve optional user data (.graphiti/data/, .graphiti/graphiti.config.json)"
  current_state:
    - "Uninstall is implemented in manager.py but requires Python + venv + repository access"
    - "Current uninstall only removes service and wrappers, preserves ~/.graphiti/"
    - "No standalone scripts exist that can run without Python dependencies"

# Files to Create
files_to_create:
  - path: "mcp_server/daemon/uninstall_windows.ps1"
    purpose: "Standalone PowerShell uninstall script for Windows (NSSM service removal)"
    pattern_source: "mcp_server/daemon/windows_service.py (uninstall method)"
    estimated_lines: 250
    details:
      - "Stop and remove NSSM service 'GraphitiBootstrap'"
      - "Remove service files even if NSSM is not available"
      - "Delete ~/.graphiti/.venv/ (virtual environment)"
      - "Delete ~/.graphiti/mcp_server/ (deployed package)"
      - "Delete ~/.graphiti/bin/ (wrapper scripts)"
      - "Delete ~/.graphiti/logs/ (service logs)"
      - "Prompt user about preserving ~/.graphiti/graphiti.config.json and data/"
      - "Provide instructions for removing from Claude Desktop MCP config"
      - "Provide instructions for removing ~/.graphiti/bin from PATH (if added)"
      - "Handle cases where service doesn't exist gracefully"
      - "Require elevation detection (admin rights for service removal)"
      - "Provide clear success/failure messages for each step"

  - path: "mcp_server/daemon/uninstall_macos.sh"
    purpose: "Standalone Bash uninstall script for macOS (launchd service removal)"
    pattern_source: "mcp_server/daemon/launchd_service.py (uninstall method)"
    estimated_lines: 200
    details:
      - "Unload and remove launchd plist: ~/Library/LaunchAgents/com.graphiti.bootstrap.plist"
      - "Delete ~/.graphiti/.venv/ (virtual environment)"
      - "Delete ~/.graphiti/mcp_server/ (deployed package)"
      - "Delete ~/.graphiti/bin/ (wrapper scripts)"
      - "Delete ~/.graphiti/logs/ (service logs)"
      - "Prompt user about preserving ~/.graphiti/graphiti.config.json and data/"
      - "Provide instructions for removing from Claude Desktop MCP config"
      - "Provide instructions for removing ~/.graphiti/bin from shell rc files (.zshrc, .bash_profile)"
      - "Handle cases where plist doesn't exist gracefully"
      - "Check if service is running before attempting unload"
      - "Provide clear success/failure messages for each step"

  - path: "mcp_server/daemon/uninstall_linux.sh"
    purpose: "Standalone Bash uninstall script for Linux (systemd service removal)"
    pattern_source: "mcp_server/daemon/systemd_service.py (uninstall method)"
    estimated_lines: 200
    details:
      - "Stop and disable systemd user service: graphiti-bootstrap.service"
      - "Remove service file: ~/.config/systemd/user/graphiti-bootstrap.service"
      - "Reload systemd daemon"
      - "Delete ~/.graphiti/.venv/ (virtual environment)"
      - "Delete ~/.graphiti/mcp_server/ (deployed package)"
      - "Delete ~/.graphiti/bin/ (wrapper scripts)"
      - "Delete ~/.graphiti/logs/ (service logs)"
      - "Prompt user about preserving ~/.graphiti/graphiti.config.json and data/"
      - "Provide instructions for removing from Claude Desktop MCP config"
      - "Provide instructions for removing ~/.graphiti/bin from shell rc files (.bashrc, .zshrc)"
      - "Handle cases where service doesn't exist gracefully"
      - "Check if service is running before attempting stop"
      - "Provide clear success/failure messages for each step"

  - path: "tests/daemon/test_uninstall_windows.py"
    purpose: "Unit tests for Windows uninstall script validation (does NOT execute script)"
    pattern_source: "tests/daemon/test_windows_service.py"
    estimated_lines: 100
    details:
      - "Test script file exists and has correct PowerShell shebang"
      - "Test script contains NSSM service removal commands"
      - "Test script contains directory cleanup logic"
      - "Test script contains user prompt for data preservation"
      - "Test script syntax is valid PowerShell (via powershell -File -WhatIf)"
      - "Validate elevation detection logic exists"
      - "Validate error handling for missing NSSM"

  - path: "tests/daemon/test_uninstall_unix.py"
    purpose: "Unit tests for macOS and Linux uninstall script validation"
    pattern_source: "tests/daemon/test_launchd_service.py"
    estimated_lines: 120
    details:
      - "Test macOS script contains launchctl unload commands"
      - "Test Linux script contains systemctl stop/disable commands"
      - "Test both scripts contain directory cleanup logic"
      - "Test both scripts contain user prompts for data preservation"
      - "Test script syntax is valid bash (via bash -n)"
      - "Validate service existence checks before removal"
      - "Validate error handling for missing service files"

  - path: "docs/UNINSTALL.md"
    purpose: "User-facing uninstall documentation"
    pattern_source: "README.md, claude-mcp-installer/instance/CLAUDE_INSTALL.md"
    estimated_lines: 150
    details:
      - "Platform-specific uninstall instructions (Windows, macOS, Linux)"
      - "Download script instructions (if user deleted repository)"
      - "Manual uninstall steps (if scripts fail)"
      - "What gets preserved vs deleted (data/, config file)"
      - "How to remove from Claude Desktop MCP config"
      - "How to remove from PATH (platform-specific)"
      - "Troubleshooting section for common issues"
      - "Complete uninstall (delete ~/.graphiti/ entirely)"

# Files to Modify
files_to_modify:
  - path: "mcp_server/daemon/manager.py"
    changes:
      - "Add helper method: _get_uninstall_script_path() to locate platform script"
      - "Optionally enhance uninstall() to suggest standalone script if manager.py unavailable"
    lines_affected: 10
    rationale: "Provide fallback to standalone script when Python environment is corrupted"

  - path: "README.md"
    changes:
      - "Add 'Uninstallation' section with link to docs/UNINSTALL.md"
      - "Add one-liner uninstall commands for each platform"
    lines_affected: 15
    rationale: "Make uninstall process discoverable from main README"

  - path: "claude-mcp-installer/instance/CLAUDE_INSTALL.md"
    changes:
      - "Add 'Uninstallation' section at end of guide"
      - "Link to docs/UNINSTALL.md for detailed instructions"
    lines_affected: 10
    rationale: "Installation guide should mention uninstall process"

# Integration Points
integration:
  - file: "mcp_server/daemon/windows_service.py"
    type: "reference"
    description: "Uninstall script replicates uninstall() logic without Python dependencies"
    optional: false

  - file: "mcp_server/daemon/launchd_service.py"
    type: "reference"
    description: "Uninstall script replicates uninstall() logic without Python dependencies"
    optional: false

  - file: "mcp_server/daemon/systemd_service.py"
    type: "reference"
    description: "Uninstall script replicates uninstall() logic without Python dependencies"
    optional: false

  - file: "mcp_server/daemon/manager.py"
    type: "enhancement"
    description: "Suggest standalone script if Python environment unavailable"
    optional: true

# Patterns to Follow
patterns:
  - source: "mcp_server/daemon/windows_service.py"
    pattern: "Service removal: nssm stop, nssm remove, fallback to sc.exe"

  - source: "mcp_server/daemon/launchd_service.py"
    pattern: "Service removal: launchctl unload, rm plist, graceful failure handling"

  - source: "mcp_server/daemon/systemd_service.py"
    pattern: "Service removal: systemctl stop, systemctl disable, rm service file, systemctl daemon-reload"

  - source: "mcp_server/daemon/manager.py"
    pattern: "Cleanup workflow: stop service → remove service → delete files → preserve config/data (opt-in)"

  - source: "claude-mcp-installer/instance/CLAUDE_INSTALL.md"
    pattern: "User-friendly documentation with step-by-step instructions, troubleshooting, platform detection"

# Test Requirements
test_requirements:
  unit:
    - "Test Windows script file exists at mcp_server/daemon/uninstall_windows.ps1"
    - "Test macOS script file exists at mcp_server/daemon/uninstall_macos.sh"
    - "Test Linux script file exists at mcp_server/daemon/uninstall_linux.sh"
    - "Test Windows script has valid PowerShell syntax (powershell -File uninstall_windows.ps1 -WhatIf)"
    - "Test macOS script has valid Bash syntax (bash -n uninstall_macos.sh)"
    - "Test Linux script has valid Bash syntax (bash -n uninstall_linux.sh)"
    - "Test Windows script contains 'nssm stop GraphitiBootstrap' command"
    - "Test Windows script contains 'nssm remove GraphitiBootstrap' command"
    - "Test macOS script contains 'launchctl unload ~/Library/LaunchAgents/com.graphiti.bootstrap.plist' command"
    - "Test Linux script contains 'systemctl --user stop graphiti-bootstrap' command"
    - "Test Linux script contains 'systemctl --user disable graphiti-bootstrap' command"
    - "Test all scripts contain directory deletion logic for ~/.graphiti/.venv/"
    - "Test all scripts contain directory deletion logic for ~/.graphiti/mcp_server/"
    - "Test all scripts contain directory deletion logic for ~/.graphiti/bin/"
    - "Test all scripts prompt user about preserving data/ and config file"
    - "Test docs/UNINSTALL.md exists and contains platform-specific sections"

  integration:
    - "Test Windows uninstall script can run without Python installed (pure PowerShell)"
    - "Test macOS uninstall script can run without Python installed (pure Bash)"
    - "Test Linux uninstall script can run without Python installed (pure Bash)"
    - "Test scripts handle missing service files gracefully (no fatal errors)"
    - "Test scripts provide clear error messages when service is not installed"
    - "Test scripts provide clear success messages when uninstall completes"
    - "Manually test on fresh Windows VM: install → uninstall → verify cleanup"
    - "Manually test on fresh macOS VM: install → uninstall → verify cleanup"
    - "Manually test on fresh Linux VM: install → uninstall → verify cleanup"

  security:
    - "Test scripts do not delete ~/.graphiti/data/ by default (user prompt required)"
    - "Test scripts do not delete ~/.graphiti/graphiti.config.json by default (user prompt required)"
    - "Test Windows script requires elevation for service removal (detect admin rights)"
    - "Test scripts do not expose sensitive information in error messages"
    - "Test scripts validate paths before deletion (prevent path traversal)"
    - "Test scripts do not follow symlinks when deleting directories"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-6.1"
    text: "(P0) Uninstall scripts exist for Windows, macOS, and Linux"
    implementation: "files_to_create[0,1,2]"
    tests: "test_requirements.unit[0,1,2]"

  - id: "AC-6.2"
    text: "(P0) Scripts stop and remove OS service"
    implementation: "files_to_create[0,1,2].service_removal"
    tests: "test_requirements.unit[6,7,8,9,10]"

  - id: "AC-6.3"
    text: "(P0) Scripts delete ~/.graphiti/.venv/, ~/.graphiti/mcp_server/, ~/.graphiti/bin/, ~/.graphiti/logs/"
    implementation: "files_to_create[0,1,2].directory_cleanup"
    tests: "test_requirements.unit[11,12,13]"

  - id: "AC-6.4"
    text: "(P1) Scripts preserve ~/.graphiti/data/ and ~/.graphiti/graphiti.config.json by default"
    implementation: "files_to_create[0,1,2].user_prompt_preservation"
    tests: "test_requirements.unit[14] + test_requirements.security[0,1]"

  - id: "AC-6.5"
    text: "(P1) Scripts can run without Python installed (standalone)"
    implementation: "files_to_create[0,1,2] (PowerShell/Bash only, no Python deps)"
    tests: "test_requirements.integration[0,1,2]"

  - id: "AC-6.6"
    text: "(P1) Scripts handle missing service files gracefully"
    implementation: "files_to_create[0,1,2].error_handling"
    tests: "test_requirements.integration[3,4,5]"

  - id: "AC-6.7"
    text: "(P2) User documentation exists at docs/UNINSTALL.md"
    implementation: "files_to_create[5]"
    tests: "test_requirements.unit[15]"

  - id: "AC-6.8"
    text: "(P2) README.md links to uninstall documentation"
    implementation: "files_to_modify[1]"
    tests: "Manual verification of README.md content"

# Implementation Notes
implementation_notes:
  - "Windows script must detect if running with admin rights (required for service removal)"
  - "macOS/Linux scripts should check if service is running before attempting stop (avoid error spam)"
  - "All scripts should provide --force flag to skip user prompts (for automation)"
  - "All scripts should provide --help flag with usage information"
  - "All scripts should be executable (chmod +x for Unix scripts)"
  - "Scripts should log actions to stdout for user transparency"
  - "Scripts should return non-zero exit code on failure for automation"
  - "Consider future enhancement: --dry-run flag to preview actions without executing"

# Dependencies
dependencies:
  external:
    windows:
      - "PowerShell 5.1+ (built-in on Windows 10+)"
      - "NSSM (if service was installed with NSSM) - optional, script handles absence"
    macos:
      - "Bash 3.2+ (built-in on macOS)"
      - "launchctl (built-in on macOS)"
    linux:
      - "Bash 4.0+ (standard on modern Linux)"
      - "systemctl (systemd-based distributions)"

  internal:
    - "None - standalone scripts with no Python dependencies"

# Deployment Notes
deployment:
  - "Scripts will be included in mcp_server/daemon/ directory in repository"
  - "Scripts will be deployed to ~/.graphiti/mcp_server/daemon/ during installation"
  - "Users can download scripts directly from GitHub if repository is deleted"
  - "Scripts are versioned with repository (consistent with installed version)"
  - "Future: Host scripts at stable URL for direct download (e.g., get.graphiti.sh/uninstall-macos.sh)"

# Manual Uninstall Steps (if scripts unavailable)
manual_uninstall:
  windows:
    - "Run: nssm stop GraphitiBootstrap"
    - "Run: nssm remove GraphitiBootstrap confirm"
    - "Delete directory: C:\\Users\\<username>\\.graphiti"
    - "Remove from Claude Desktop config: %APPDATA%\\Claude\\claude_desktop_config.json"
    - "Remove from PATH: Edit environment variables, remove C:\\Users\\<username>\\.graphiti\\bin"

  macos:
    - "Run: launchctl unload ~/Library/LaunchAgents/com.graphiti.bootstrap.plist"
    - "Delete file: ~/Library/LaunchAgents/com.graphiti.bootstrap.plist"
    - "Delete directory: ~/.graphiti"
    - "Remove from Claude Desktop config: ~/Library/Application Support/Claude/claude_desktop_config.json"
    - "Remove from PATH: Edit ~/.zshrc or ~/.bash_profile, remove ~/.graphiti/bin from PATH"

  linux:
    - "Run: systemctl --user stop graphiti-bootstrap"
    - "Run: systemctl --user disable graphiti-bootstrap"
    - "Delete file: ~/.config/systemd/user/graphiti-bootstrap.service"
    - "Run: systemctl --user daemon-reload"
    - "Delete directory: ~/.graphiti"
    - "Remove from Claude Desktop config: ~/.config/Claude/claude_desktop_config.json"
    - "Remove from PATH: Edit ~/.bashrc or ~/.zshrc, remove ~/.graphiti/bin from PATH"
