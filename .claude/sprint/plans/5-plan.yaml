# Plan: 5
# Generated by: discovery:5.d
# Timestamp: 2025-12-14T18:30:00Z

story_id: "5"
title: "Bootstrap Service Update"
created: "2025-12-14T18:30:00Z"
created_by: "discovery:5.d"

# Analysis Summary
analysis:
  summary: "Update service managers to use dedicated venv Python paths from VenvManager instead of sys.executable"
  complexity: "low"
  estimated_files: 3
  estimated_tokens: 3000
  risk_factors:
    - "Must ensure venv exists before service installation (already handled in DaemonManager.install())"
    - "Platform-specific path differences (Windows: Scripts/python.exe, Unix: bin/python)"

# Files to Create
files_to_create: []

# Files to Modify
files_to_modify:
  - path: "mcp_server/daemon/windows_service.py"
    changes:
      - "Import VenvManager class"
      - "Replace self.python_exe = sys.executable with venv_manager.get_python_executable()"
      - "Update __init__ to accept venv_manager parameter or instantiate it"
    lines_affected: 10

  - path: "mcp_server/daemon/launchd_service.py"
    changes:
      - "Import VenvManager class"
      - "Replace self.python_exe = sys.executable with venv_manager.get_python_executable()"
      - "Update __init__ to accept venv_manager parameter or instantiate it"
    lines_affected: 10

  - path: "mcp_server/daemon/systemd_service.py"
    changes:
      - "Import VenvManager class"
      - "Replace self.python_exe = sys.executable with venv_manager.get_python_executable()"
      - "Update __init__ to accept venv_manager parameter or instantiate it"
    lines_affected: 10

# Integration Points
integration:
  - file: "mcp_server/daemon/manager.py"
    type: "instantiation"
    description: "DaemonManager already instantiates service managers and venv_manager - need to pass venv_manager to service manager constructors"

# Patterns to Follow
patterns:
  - source: "mcp_server/daemon/venv_manager.py"
    pattern: "Use VenvManager.get_python_executable() to get dedicated venv Python path - handles platform differences (Windows: Scripts/python.exe, Unix: bin/python)"

  - source: "mcp_server/daemon/windows_service.py"
    pattern: "Service templates are already dynamically generated at install time (no hardcoded paths) - this is correct, just need to use correct Python source"

# Test Requirements
test_requirements:
  unit:
    - "Test WindowsServiceManager uses venv Python path (not sys.executable)"
    - "Test LaunchdServiceManager uses venv Python path (not sys.executable)"
    - "Test SystemdServiceManager uses venv Python path (not sys.executable)"
    - "Test service managers handle VenvCreationError gracefully if venv missing"

  integration:
    - "Test DaemonManager.install() creates venv then installs service with correct paths"
    - "Test Windows service creation with venv Python path"
    - "Test macOS plist creation with venv Python path"
    - "Test Linux systemd unit creation with venv Python path"
    - "Test service installation on all platforms (Windows/macOS/Linux)"

  security:
    - "Verify service files don't contain hardcoded credentials"
    - "Verify venv path resolution doesn't allow path traversal"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-5.1"
    text: "(P0) Windows service uses ~/.graphiti/.venv/Scripts/python.exe"
    implementation: "files_to_modify[0] - windows_service.py uses venv_manager.get_python_executable()"
    tests: "test_requirements.integration[1] - Test Windows service creation with venv Python path"

  - id: "AC-5.2"
    text: "(P0) macOS launchd plist uses ~/.graphiti/.venv/bin/python"
    implementation: "files_to_modify[1] - launchd_service.py uses venv_manager.get_python_executable()"
    tests: "test_requirements.integration[2] - Test macOS plist creation with venv Python path"

  - id: "AC-5.3"
    text: "(P0) Linux systemd unit uses ~/.graphiti/.venv/bin/python"
    implementation: "files_to_modify[2] - systemd_service.py uses venv_manager.get_python_executable()"
    tests: "test_requirements.integration[3] - Test Linux systemd unit creation with venv Python path"

  - id: "AC-5.4"
    text: "(P1) Service templates are dynamically generated (no hardcoded paths in repo)"
    implementation: "No changes needed - already implemented via _create_plist(), _create_service_unit() methods"
    tests: "test_requirements.integration[4] - Test service installation on all platforms"
