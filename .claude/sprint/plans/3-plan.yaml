# Plan: 3
# Generated by: discovery:3.d
# Timestamp: 2025-12-12T08:30:00Z

story_id: "3"
title: "Create Default Session Turn Template"
created: "2025-12-12T08:30:00Z"
created_by: "discovery:3.d"

# Analysis Summary
analysis:
  summary: "Create a session turn preprocessing template for entity/edge extraction with content prioritization, entity hints, and relationship guidance under 500 tokens"
  complexity: "low"
  estimated_files: 3
  estimated_tokens: 1200
  risk_factors:
    - "Token count must stay under 500 tokens for template content"
    - "Template must integrate with existing template resolution hierarchy"

# Files to Create
files_to_create:
  - path: "graphiti_core/session_tracking/prompts/default-session-turn.md"
    purpose: "Default preprocessing template for session turn extraction with prioritization guidance"
    pattern_source: "graphiti_core/session_tracking/prompts/default-tool-content.md"
    estimated_lines: 35

# Files to Modify
files_to_modify:
  - path: "graphiti_core/session_tracking/prompts.py"
    changes:
      - "Add DEFAULT_SESSION_TURN_TEMPLATE constant with template content"
      - "Add 'default-session-turn.md' entry to DEFAULT_TEMPLATES mapping"
    lines_affected: 10

  - path: "graphiti_core/extraction_config.py"
    changes:
      - "Update docstring examples to reference default-session-turn.md"
      - "Add usage example showing the new template"
    lines_affected: 8

# Integration Points
integration:
  - file: "graphiti_core/session_tracking/prompts.py"
    type: "config"
    description: "Register template in DEFAULT_TEMPLATES dict for built-in template resolution"

  - file: "graphiti_core/extraction_config.py"
    type: "config"
    description: "Update examples to show usage of new template"

# Patterns to Follow
patterns:
  - source: "graphiti_core/session_tracking/prompts/default-tool-content.md"
    pattern: "Use markdown format with bullet lists for guidance, template variables for content injection, structured sections with clear headers"

  - source: "graphiti_core/session_tracking/prompts.py"
    pattern: "Define template as string constant, add to DEFAULT_TEMPLATES mapping with .md filename as key"

  - source: "graphiti_core/prompts/extract_nodes.py"
    pattern: "Entity types and extraction prompts to understand what entities should be prioritized"

# Test Requirements
test_requirements:
  unit:
    - "Test template file exists in package resources"
    - "Test template is registered in DEFAULT_TEMPLATES"
    - "Test template content is under 500 tokens"
    - "Test template contains all required sections (HIGH/MEDIUM/LOW priorities)"
    - "Test template contains entity type hints"
    - "Test template contains relationship guidance"
  integration:
    - "Test template can be loaded via resolve_template_path()"
    - "Test template works with ExtractionConfig preprocessing_prompt"
    - "Test template resolves from built-in location when not overridden"
  security:
    - "Test template does not contain sensitive information"
    - "Test template cannot be used for prompt injection"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-3.1"
    text: "Template file exists at built-in location (package resources or fallback path)"
    implementation: "files_to_create[0], files_to_modify[0]"
    tests: "test_requirements.unit[0,1], test_requirements.integration[0]"

  - id: "AC-3.2"
    text: "Template contains HIGH/MEDIUM/LOW priority content guidance"
    implementation: "files_to_create[0]"
    tests: "test_requirements.unit[3]"

  - id: "AC-3.3"
    text: "Template contains entity type hints (File, Tool, Error, Decision, Concept)"
    implementation: "files_to_create[0]"
    tests: "test_requirements.unit[4]"

  - id: "AC-3.4"
    text: "Template contains relationship extraction guidance"
    implementation: "files_to_create[0]"
    tests: "test_requirements.unit[5]"

  - id: "AC-3.5"
    text: "Template is under 500 tokens to minimize prompt overhead"
    implementation: "files_to_create[0]"
    tests: "test_requirements.unit[2]"

# Template Content Design
template_design:
  sections:
    - name: "Content Prioritization"
      description: "HIGH/MEDIUM/LOW priority guidance for what to extract"
      token_budget: 150

    - name: "Entity Type Hints"
      description: "Suggest entity types: File, Tool, Error, Decision, Concept"
      token_budget: 100

    - name: "Relationship Guidance"
      description: "Guide relationship extraction between entities"
      token_budget: 150

    - name: "Template Variables"
      description: "Placeholder for content injection"
      token_budget: 50

  total_token_budget: 450
  safety_margin: 50

# Implementation Notes
notes:
  - "Template should be concise and actionable for LLM consumption"
  - "Use bullet points and clear headers for structure"
  - "Align entity types with existing extraction schemas in extract_nodes.py"
  - "Follow pattern from existing session tracking templates"
  - "Token count is critical - measure after implementation"
  - "Template file should be created in prompts/ directory alongside other templates"
