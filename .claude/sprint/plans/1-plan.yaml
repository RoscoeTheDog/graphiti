# Plan: 1
# Generated by: discovery:1.d
# Timestamp: 2025-12-18T17:35:00Z

story_id: "1"
title: "Add ProjectOverride Schema and Deep Merge Logic"
created: "2025-12-18T17:35:00Z"
created_by: "discovery:1.d"

# Analysis Summary
analysis:
  summary: "Add ProjectOverride Pydantic model to unified_config.py, implement normalize_project_path() for cross-platform path handling, and deep_merge() for nested dict merging. Leverages existing path normalization patterns from PathResolver in session_tracking."
  complexity: "medium"
  estimated_files: 3
  estimated_tokens: 8000
  risk_factors:
    - "Path normalization must work correctly on Windows (C:\ vs /c/), Unix, and MSYS environments"
    - "Deep merge logic must handle None values correctly (inherit vs delete semantics)"
    - "Pydantic validation must reject non-overridable sections (database, daemon, resilience)"

# Files to Create
files_to_create:
  - path: "tests/test_project_overrides.py"
    purpose: "Unit tests for ProjectOverride schema, path normalization, and deep merge"
    pattern_source: "tests/test_unified_config.py"
    estimated_lines: 250

# Files to Modify
files_to_modify:
  - path: "mcp_server/unified_config.py"
    changes:
      - "Add ProjectOverride Pydantic model (lines ~830-850)"
      - "Add project_overrides field to GraphitiConfig (line ~854)"
      - "Add normalize_project_path() function (lines ~1070-1100)"
      - "Add deep_merge() function (lines ~1100-1130)"
    lines_affected: 100

# Integration Points
integration:
  - file: "mcp_server/unified_config.py"
    type: "import"
    description: "Import Optional, Dict from typing for type hints"

  - file: "mcp_server/unified_config.py"
    type: "import"
    description: "Import Path, os, sys for path handling"

# Patterns to Follow
patterns:
  - source: "graphiti_core/session_tracking/path_resolver.py"
    pattern: "Use _normalize_path_for_hash() as reference for normalize_project_path() - already handles Windows C:/ -> /c/, Unix, MSYS paths with Path.resolve() and as_posix()"

  - source: "mcp_server/unified_config.py (existing BaseModel classes)"
    pattern: "Follow existing Pydantic model patterns: use Optional[] for nullable fields, Field() with descriptions, extra='forbid' for strict validation"

# Test Requirements
test_requirements:
  unit:
    - "test_normalize_project_path_windows: C:\\ → /c/, C:/ → /c/"
    - "test_normalize_project_path_unix: /home/user → /home/user"
    - "test_normalize_project_path_msys: /c/Users → /c/Users"
    - "test_normalize_project_path_expanduser: ~/project → /home/user/project"
    - "test_deep_merge_scalar_override: base[key]=1, override[key]=2 → result[key]=2"
    - "test_deep_merge_nested_dict: base[a][b]=1, override[a][c]=2 → result[a][b]=1, result[a][c]=2"
    - "test_deep_merge_none_inherits: base[key]=1, override[key]=None → result[key]=1 (inherits)"
    - "test_deep_merge_list_replaces: base[key]=[1,2], override[key]=[3] → result[key]=[3]"
    - "test_projectoverride_schema_valid: llm, embedder, extraction, session_tracking all valid"
    - "test_projectoverride_schema_rejects_database: database field rejected with ValidationError"
    - "test_projectoverride_schema_rejects_daemon: daemon field rejected with ValidationError"
    - "test_projectoverride_in_graphiticonfig: project_overrides: Dict[str, ProjectOverride] validates correctly"

  integration:
    - "test_project_overrides_end_to_end: Create config with override, verify path normalization and merge work together"
    - "test_project_overrides_from_file: Load graphiti.config.json with project_overrides section, validate schema"

  security:
    - "test_projectoverride_extra_forbid: Unknown fields in ProjectOverride rejected (prevent typos)"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-1 (P0)"
    text: "ProjectOverride model defined with overridable sections (llm, embedder, extraction, session_tracking)"
    implementation: "files_to_modify[0] - Add ProjectOverride class with Optional[LLMConfig], Optional[EmbedderConfig], Optional[ExtractionConfig], Optional[SessionTrackingConfig]"
    tests: "test_requirements.unit[8-11]"

  - id: "AC-2 (P0)"
    text: "project_overrides: Dict[str, ProjectOverride] added to GraphitiConfig"
    implementation: "files_to_modify[0] - Add field to GraphitiConfig with default_factory=dict"
    tests: "test_requirements.unit[11], test_requirements.integration[0-1]"

  - id: "AC-3 (P0)"
    text: "normalize_project_path() function handles Windows (C:\\ → /c/), Unix, and MSYS paths"
    implementation: "files_to_modify[0] - Add standalone function using Path.resolve(), as_posix(), platform detection (reference: PathResolver._normalize_path_for_hash)"
    tests: "test_requirements.unit[0-3]"

  - id: "AC-4 (P1)"
    text: "deep_merge() function correctly merges nested dicts, replaces scalars, inherits None"
    implementation: "files_to_modify[0] - Add recursive dict merge function with None inheritance semantics"
    tests: "test_requirements.unit[4-7]"

  - id: "AC-5 (P1)"
    text: "Unit tests for path normalization on all platforms"
    implementation: "files_to_create[0] - test_project_overrides.py with platform-specific path tests"
    tests: "test_requirements.unit[0-3]"

  - id: "AC-6 (P1)"
    text: "Unit tests for deep merge edge cases"
    implementation: "files_to_create[0] - test_project_overrides.py with merge edge case tests"
    tests: "test_requirements.unit[4-7]"

# Implementation Notes
implementation_notes:
  - "Use PathResolver._normalize_path_for_hash() from graphiti_core/session_tracking/path_resolver.py as the reference implementation"
  - "The function already handles: Windows (C:/ → /c/), Unix, MSYS, expanduser, resolve, as_posix"
  - "Extract and adapt the logic for normalize_project_path() - no need to reinvent"
  - "deep_merge() must be recursive and handle: scalars (replace), dicts (merge), lists (replace), None (inherit)"
  - "ProjectOverride.Config.extra = 'forbid' prevents typos in override keys (spec requirement)"
  - "Non-overridable sections: database, daemon, resilience, mcp_server, logging (spec section 'Overridable vs Non-Overridable Settings')"
  - "Version bump NOT included in this story (Story 1 only adds schema, Story 2 adds get_effective_config())"
