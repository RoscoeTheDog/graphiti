# Plan: 1
# Generated by: discovery:1.d
# Timestamp: 2025-12-17T20:00:00Z

story_id: "1"
title: "Auto-Enable Daemon on Install"
created: "2025-12-17T20:00:00Z"
created_by: "discovery:1.d"

# Analysis Summary
analysis:
  summary: "Modify daemon installer to automatically enable daemon.enabled=true in config, with user confirmation for existing configs."
  complexity: "medium"
  estimated_files: 3
  estimated_tokens: 8000
  risk_factors:
    - "User config override requires careful confirmation UX"
    - "Timing sensitivity - must ensure config write completes before bootstrap polls"
    - "Cross-platform config path handling (Windows vs Unix)"

# Files to Create
files_to_create: []

# Files to Modify
files_to_modify:
  - path: "mcp_server/daemon/manager.py"
    changes:
      - "Modify _create_default_config() to set enabled: true (line 374)"
      - "Add _update_existing_config() method to handle config updates with user prompts"
      - "Update install() method to call _update_existing_config() if config exists (after line 172)"
      - "Update success message to reflect daemon auto-start (lines 183-186)"
    lines_affected: 50

  - path: "tests/daemon/test_daemon_cli.py"
    changes:
      - "Add test for default config enabled=true"
      - "Add test for existing config update with user confirmation"
      - "Add test for user declining config update"
      - "Update existing install tests to expect enabled=true"
    lines_affected: 80

# Integration Points
integration:
  - file: "mcp_server/daemon/manager.py"
    type: "config"
    description: "Read existing config, prompt user if enabled=false, write updated config"

  - file: "mcp_server/daemon/manager.py"
    type: "user-interaction"
    description: "Pattern from path_integration.py line 306 for y/n prompts"

# Patterns to Follow
patterns:
  - source: "mcp_server/daemon/path_integration.py:306"
    pattern: "User confirmation prompt: input('Prompt? (y/n): ').strip().lower()"

  - source: "tests/daemon/test_daemon_cli.py:95-120"
    pattern: "Mock-based unit tests for install flow with capsys for output verification"

  - source: "mcp_server/daemon/manager.py:368-399"
    pattern: "Config file creation with JSON structure and helpful comments"

# Test Requirements
test_requirements:
  unit:
    - "Test _create_default_config() sets enabled=true by default"
    - "Test _update_existing_config() with existing enabled=false prompts user"
    - "Test _update_existing_config() with user saying 'y' updates config to enabled=true"
    - "Test _update_existing_config() with user saying 'n' preserves enabled=false"
    - "Test _update_existing_config() with existing enabled=true skips prompt"
    - "Test install() success message mentions daemon auto-start"
  integration:
    - "Test full install flow creates config with enabled=true"
    - "Test full install flow with existing config prompts and updates"
    - "Test daemon bootstrap detects enabled=true and starts MCP server within 5 seconds"
  security:
    - "Test config file permissions are user-only (no world-readable secrets)"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-1.1"
    text: "After successful daemon install, daemon.enabled is automatically set to true in graphiti.config.json"
    implementation: "files_to_modify[0] - _create_default_config() default value"
    tests: "unit[0], integration[0]"

  - id: "AC-1.2"
    text: "The MCP server starts within 5 seconds of install completion (bootstrap detects config change)"
    implementation: "files_to_modify[0] - enabled=true ensures bootstrap starts MCP on next poll"
    tests: "integration[2]"

  - id: "AC-1.3"
    text: "If config already exists with daemon.enabled: false, installer asks user before overwriting"
    implementation: "files_to_modify[0] - _update_existing_config() with user prompt"
    tests: "unit[1,2,3,4], integration[1]"

  - id: "AC-1.4"
    text: "Success message updated to reflect that daemon is now running (no manual step needed)"
    implementation: "files_to_modify[0] - install() success message (lines 183-186)"
    tests: "unit[5]"
