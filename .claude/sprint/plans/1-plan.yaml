# Plan: 1
# Generated by: discovery:1.d
# Timestamp: 2025-12-23T19:30:00Z

story_id: "1"
title: "Generate requirements.txt from pyproject.toml"
created: "2025-12-23T19:30:00Z"
created_by: "discovery:1.d"

# Analysis Summary
analysis:
  summary: "Create a standalone script that parses mcp_server/pyproject.toml and generates requirements.txt at ~/.graphiti/ for independent dependency installation during daemon deployment."
  complexity: "low"
  estimated_files: 2
  estimated_tokens: 8000
  risk_factors:
    - "TOML parsing compatibility across Python versions (need tomllib for 3.11+, toml package for 3.10)"
    - "Path handling must be platform-agnostic (Windows vs Unix)"
    - "Optional dependencies require configuration (include/exclude decision)"

# Files to Create
files_to_create:
  - path: "mcp_server/daemon/generate_requirements.py"
    purpose: "Standalone script to parse pyproject.toml and generate requirements.txt with proper version pinning"
    pattern_source: "mcp_server/daemon/venv_manager.py"
    estimated_lines: 150
    details:
      - "Use tomllib (Python 3.11+) or toml package (Python 3.10) for TOML parsing"
      - "Extract dependencies from [project.dependencies] section"
      - "Optionally include [project.optional-dependencies] based on configuration"
      - "Preserve version specifiers (>=, ==, ~=, etc.)"
      - "Write to ~/.graphiti/requirements.txt with platform-agnostic path handling"
      - "Include error handling for missing files, malformed TOML"
      - "CLI interface with --include-optional flag"

  - path: "tests/daemon/test_generate_requirements.py"
    purpose: "Unit and integration tests for requirements.txt generation"
    pattern_source: "mcp_server/tests/test_package_installation.py"
    estimated_lines: 200
    details:
      - "Test parsing of valid pyproject.toml"
      - "Test version spec preservation"
      - "Test optional dependencies handling"
      - "Test error handling (malformed TOML, missing sections)"
      - "Test output file creation and formatting"
      - "Integration test with real mcp_server/pyproject.toml"

# Files to Modify
files_to_modify:
  - path: "mcp_server/pyproject.toml"
    changes:
      - "Add toml package to dev dependencies (for Python 3.10 compatibility)"
    lines_affected: 1
    rationale: "tomllib is stdlib in 3.11+ but 3.10 needs external toml package"

# Integration Points
integration:
  - file: "mcp_server/daemon/venv_manager.py"
    type: "import"
    description: "Future integration: Call generate_requirements.py during install_package() to create standalone requirements.txt before installation"
    optional: true

  - file: "mcp_server/daemon/bootstrap.py"
    type: "validation"
    description: "Future integration: Validate installed dependencies match requirements.txt on startup"
    optional: true

# Patterns to Follow
patterns:
  - source: "mcp_server/daemon/venv_manager.py"
    pattern: "Platform-agnostic path handling using Path.home() and pathlib"

  - source: "mcp_server/daemon/venv_manager.py"
    pattern: "Error handling with custom exceptions and detailed logging"

  - source: "mcp_server/daemon/venv_manager.py"
    pattern: "Detection logic with fallback strategies (e.g., tomllib â†’ toml package)"

  - source: "mcp_server/tests/test_package_installation.py"
    pattern: "Integration test structure with temporary directories and cleanup"

# Test Requirements
test_requirements:
  unit:
    - "Test parse_pyproject_toml() successfully extracts dependencies from valid TOML"
    - "Test parse_pyproject_toml() raises error on malformed TOML file"
    - "Test parse_pyproject_toml() handles missing [project.dependencies] section gracefully"
    - "Test generate_requirements_txt() preserves version specifiers (>=, ==, ~=, etc.)"
    - "Test generate_requirements_txt() formats output as one dependency per line"
    - "Test generate_requirements_txt() optionally includes optional dependencies when --include-optional flag set"
    - "Test generate_requirements_txt() excludes optional dependencies by default"
    - "Test write_requirements_file() creates parent directory if missing"
    - "Test write_requirements_file() overwrites existing requirements.txt"
    - "Test CLI argument parsing (--input, --output, --include-optional flags)"
    - "Test Python version detection for tomllib vs toml import"

  integration:
    - "Test end-to-end: read mcp_server/pyproject.toml, write ~/.graphiti/requirements.txt"
    - "Test generated requirements.txt can be used by pip install -r"
    - "Test file permissions on created requirements.txt (readable by all users)"
    - "Test with actual mcp_server/pyproject.toml from repository"
    - "Test error recovery when output path is not writable"

  security:
    - "Test path traversal prevention in output path (reject paths like ../../../etc/passwd)"
    - "Test handling of malicious TOML content (e.g., extremely large dependency lists)"
    - "Test proper file permissions (no world-writable files created)"
    - "Test input validation for pyproject.toml path (reject non-.toml files)"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-1.1"
    text: "(P0) Script can parse mcp_server/pyproject.toml and extract all dependencies"
    implementation: "files_to_create[0].parse_pyproject_toml()"
    tests: "test_requirements.unit[0,1,2]"

  - id: "AC-1.2"
    text: "(P0) Generated requirements.txt includes pinned versions where available"
    implementation: "files_to_create[0].generate_requirements_txt()"
    tests: "test_requirements.unit[3,4]"

  - id: "AC-1.3"
    text: "(P1) Script handles optional dependencies appropriately"
    implementation: "files_to_create[0].generate_requirements_txt() with --include-optional flag"
    tests: "test_requirements.unit[5,6]"

  - id: "AC-1.4"
    text: "(P1) Output is written to ~/.graphiti/requirements.txt"
    implementation: "files_to_create[0].write_requirements_file() using Path.home() / '.graphiti' / 'requirements.txt'"
    tests: "test_requirements.unit[7,8] + test_requirements.integration[0,1,2,3]"

# Implementation Notes
implementation_notes:
  - "Use Python 3.11+ tomllib (stdlib) if available, fall back to toml package for Python 3.10"
  - "Add toml package to dev dependencies in pyproject.toml for testing on Python 3.10"
  - "Output format should match pip requirements.txt spec: one package per line with version spec"
  - "Include helpful error messages for common failures (file not found, parse errors)"
  - "Consider future extension: support for [dependency-groups] section (currently only in dev group)"

# Dependencies
dependencies:
  external:
    - "tomllib (Python 3.11+ stdlib) or toml package (Python 3.10)"
    - "pathlib (stdlib)"
    - "argparse (stdlib)"

  internal:
    - "None - standalone script"

# Deployment Notes
deployment:
  - "Script will be deployed as part of mcp_server package to ~/.graphiti/ during daemon installation"
  - "Generated requirements.txt enables standalone pip installs without access to pyproject.toml"
  - "Future: Integrate into daemon install workflow via venv_manager.py"
