# Plan: 1
# Generated by: discovery:1.d
# Timestamp: 2025-12-20T00:00:00Z

story_id: "1"
title: "Metadata Schema Extension"
created: "2025-12-20T00:00:00Z"
created_by: "discovery:1.d"

# Analysis Summary
analysis:
  summary: "Add test_reconciliation and reconciliation metadata schemas to queue story objects for remediation and validation story types. Non-breaking schema extension using existing metadata field infrastructure."
  complexity: "low"
  estimated_files: 3
  estimated_tokens: 8000
  risk_factors:
    - "Schema validation must be backwards compatible"
    - "Existing queue operations must not break with new fields"

# Files to Create
files_to_create:
  - path: "resources/commands/sprint/queue_helpers/test_reconciliation.py"
    purpose: "Define test_reconciliation metadata schema with validation helpers"
    pattern_source: "resources/commands/sprint/queue_helpers/supersession.py"
    estimated_lines: 200

# Files to Modify
files_to_modify:
  - path: "resources/commands/sprint/queue_helpers/core.py"
    changes:
      - "Import test_reconciliation schema validators"
      - "Add schema validation in set_metadata() for test_reconciliation fields"
      - "Add schema validation in set_metadata() for reconciliation fields"
    lines_affected: 20

  - path: "resources/commands/sprint/queue_helpers/__init__.py"
    changes:
      - "Export test_reconciliation schema functions"
      - "Export reconciliation schema functions"
    lines_affected: 5

# Integration Points
integration:
  - file: "resources/commands/sprint/queue_helpers/core.py"
    type: "import"
    description: "Import schema validators from test_reconciliation module"

  - file: "resources/commands/sprint/queue_helpers/core.py"
    type: "validation"
    description: "Call schema validators in set_metadata() before writing"

# Patterns to Follow
patterns:
  - source: "resources/commands/sprint/queue_helpers/supersession.py"
    pattern: "Schema definition with TypedDict and validation functions"

  - source: "resources/commands/sprint/queue_helpers/core.py"
    pattern: "Metadata field operations using dict access patterns"

# Test Requirements
test_requirements:
  unit:
    - "Test test_reconciliation schema validation accepts valid data"
    - "Test test_reconciliation schema validation rejects invalid data"
    - "Test reconciliation schema validation accepts valid data"
    - "Test reconciliation schema validation rejects invalid data"
    - "Test set_metadata() rejects invalid test_reconciliation schema"
    - "Test set_metadata() rejects invalid reconciliation schema"
    - "Test set_metadata() accepts valid schemas"
    - "Test backwards compatibility - existing stories without metadata work"

  integration:
    - "Test queue_helpers.py set-metadata command with test_reconciliation schema"
    - "Test queue_helpers.py set-metadata command with reconciliation schema"
    - "Test queue operations (get-next, update-status) work with new metadata"

  security:
    - "Test schema validation prevents code injection via metadata fields"
    - "Test schema validation rejects malformed data structures"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-1.1"
    text: "test_reconciliation schema added to remediation story metadata with all fields from spec"
    implementation: "files_to_create[0] - test_reconciliation.py defines schema"
    tests: "test_requirements.unit[0-2], test_requirements.integration[0]"

  - id: "AC-1.2"
    text: "reconciliation schema added to validation story metadata with all fields from spec"
    implementation: "files_to_create[0] - test_reconciliation.py defines both schemas"
    tests: "test_requirements.unit[3-4], test_requirements.integration[1]"

  - id: "AC-1.3"
    text: "Schema validation passes for new fields"
    implementation: "files_to_modify[0] - core.py validates in set_metadata()"
    tests: "test_requirements.unit[5-7]"

  - id: "AC-1.4"
    text: "Existing queue operations remain compatible (backwards compatibility)"
    implementation: "files_to_modify[0] - core.py preserves existing behavior"
    tests: "test_requirements.unit[7], test_requirements.integration[2]"

  - id: "AC-1.5"
    text: "Unit tests for schema validation"
    implementation: "Test file creation in testing phase"
    tests: "test_requirements.unit[all]"

# Schema Specifications
schemas:
  test_reconciliation:
    description: "Metadata for remediation stories linking to test failures"
    fields:
      failed_test_id:
        type: "string"
        required: true
        description: "ID of the test that failed (e.g., test-8.t-001)"
      test_file:
        type: "string"
        required: true
        description: "Path to test file relative to project root"
      failure_summary:
        type: "string"
        required: true
        description: "Brief summary of test failure"
      original_story_id:
        type: "string"
        required: true
        description: "ID of story that introduced the failing test"
      reconciliation_status:
        type: "string"
        required: false
        enum: ["pending", "fixed", "superseded", "deferred"]
        default: "pending"
        description: "Status of test reconciliation"

  reconciliation:
    description: "Metadata for validation stories tracking test reconciliation"
    fields:
      remediation_count:
        type: "integer"
        required: true
        description: "Number of remediation stories created for this validation"
      resolved_count:
        type: "integer"
        required: false
        default: 0
        description: "Number of remediation stories resolved"
      pending_tests:
        type: "array of strings"
        required: false
        default: []
        description: "List of test IDs still pending reconciliation"
