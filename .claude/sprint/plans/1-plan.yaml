# Plan: 1
# Generated by: discovery:1.d
# Timestamp: 2025-12-14T21:30:00Z

story_id: "1"
title: "Dedicated Venv Creation"
created: "2025-12-14T21:30:00Z"
created_by: "discovery:1.d"

# Analysis Summary
analysis:
  summary: "Create dedicated venv at ~/.graphiti/.venv/ using uv (preferred) or python -m venv (fallback), with idempotency checks and Python version validation (>=3.10)"
  complexity: "medium"
  estimated_files: 3
  estimated_tokens: 8000
  risk_factors:
    - "Cross-platform path handling (Windows backslash vs Unix forward slash)"
    - "uv availability detection may vary across environments"
    - "Python version validation must work across different Python installations"
    - "Subprocess error handling for venv creation failures"

# Files to Create
files_to_create:
  - path: "mcp_server/daemon/venv_manager.py"
    purpose: "Dedicated module for venv creation, detection, and validation logic"
    pattern_source: "mcp_server/daemon/manager.py"
    estimated_lines: 200
    details:
      - "Class: VenvManager with methods for create_venv(), detect_venv(), validate_python_version(), check_uv_available()"
      - "Platform-agnostic path handling using pathlib.Path"
      - "Subprocess handling for 'uv venv' and 'python -m venv' commands"
      - "Idempotency checks (skip creation if venv exists and is valid)"
      - "Logging for all operations"

# Files to Modify
files_to_modify:
  - path: "mcp_server/daemon/manager.py"
    changes:
      - "Import VenvManager from venv_manager module"
      - "Add venv creation step to install() method (before service installation)"
      - "Display venv creation status in status() method"
      - "Add venv path to config initialization"
    lines_affected: 20

  - path: "mcp_server/daemon/bootstrap.py"
    changes:
      - "Validate venv exists before starting MCP server"
      - "Log warning if venv is missing (defensive check)"
      - "Potentially auto-create venv if missing (recovery mode)"
    lines_affected: 15

# Integration Points
integration:
  - file: "mcp_server/daemon/manager.py"
    type: "import"
    description: "Import VenvManager and use in install() method"

  - file: "mcp_server/daemon/bootstrap.py"
    type: "config"
    description: "Reference venv path from config (future: may use dedicated venv for MCP server execution)"

  - file: "mcp_server/daemon/venv_manager.py"
    type: "export"
    description: "Export VenvManager class for use by manager.py and bootstrap.py"

# Patterns to Follow
patterns:
  - source: "mcp_server/daemon/manager.py"
    pattern: "Platform-agnostic path handling with Path.home() / '.graphiti' / 'subdir'"

  - source: "mcp_server/daemon/manager.py"
    pattern: "Config directory creation with parent.mkdir(parents=True, exist_ok=True)"

  - source: "mcp_server/daemon/windows_service.py"
    pattern: "Check for external tool availability (like _find_nssm()) before using"

  - source: "mcp_server/config_validator.py"
    pattern: "Environment variable checking pattern for validation"

# Test Requirements
test_requirements:
  unit:
    - "VenvManager.check_uv_available() returns True when uv is in PATH"
    - "VenvManager.check_uv_available() returns False when uv is not available"
    - "VenvManager.validate_python_version() accepts Python 3.10+"
    - "VenvManager.validate_python_version() rejects Python 3.9 and below"
    - "VenvManager.detect_venv() returns True for existing valid venv"
    - "VenvManager.detect_venv() returns False for non-existent venv"
    - "VenvManager.create_venv() uses uv when available"
    - "VenvManager.create_venv() falls back to python -m venv when uv unavailable"
    - "VenvManager.create_venv() is idempotent (skips if venv exists)"
    - "VenvManager path handling works on Windows (backslashes)"
    - "VenvManager path handling works on Unix (forward slashes)"

  integration:
    - "daemon install creates venv at ~/.graphiti/.venv/"
    - "daemon install skips venv creation if already exists"
    - "daemon install fails gracefully if Python version < 3.10"
    - "daemon install succeeds with uv when available"
    - "daemon install succeeds without uv (fallback to python -m venv)"
    - "daemon status displays venv status (exists/missing/invalid)"
    - "bootstrap validates venv exists before starting MCP server"

  security:
    - "Venv directory has appropriate permissions (user-only read/write/execute)"
    - "Subprocess commands are properly escaped (no shell injection)"
    - "Path traversal prevented (venv path is always ~/.graphiti/.venv)"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-1.1"
    text: "(P0) daemon install creates ~/.graphiti/.venv/ if it doesn't exist"
    implementation: "files_to_create[0] (venv_manager.py: create_venv()) + files_to_modify[0] (manager.py: install())"
    tests: "test_requirements.integration[0,1]"

  - id: "AC-1.2"
    text: "(P0) Uses uv venv if uv is available, falls back to python -m venv"
    implementation: "files_to_create[0] (venv_manager.py: check_uv_available() + create_venv())"
    tests: "test_requirements.unit[0,1,6,7] + test_requirements.integration[3,4]"

  - id: "AC-1.3"
    text: "(P1) Detects existing venv and skips creation (idempotent)"
    implementation: "files_to_create[0] (venv_manager.py: detect_venv())"
    tests: "test_requirements.unit[4,5,8] + test_requirements.integration[1]"

  - id: "AC-1.4"
    text: "(P1) Validates Python version compatibility (>=3.10)"
    implementation: "files_to_create[0] (venv_manager.py: validate_python_version())"
    tests: "test_requirements.unit[2,3] + test_requirements.integration[2]"

# Implementation Notes
implementation_notes:
  - "Use subprocess.run() with capture_output=True for command execution"
  - "Check subprocess returncode for success/failure detection"
  - "Log all subprocess commands and their output for debugging"
  - "Use shutil.which() to detect uv availability"
  - "Parse sys.version_info for Python version validation"
  - "Consider creating marker file (e.g., .venv/CREATED_BY_GRAPHITI) for validation"
  - "Future: Story 2 will install packages to this venv, so ensure venv is fully functional"

# Dependencies
dependencies:
  internal:
    - "Requires pathlib (standard library)"
    - "Requires subprocess (standard library)"
    - "Requires shutil (standard library)"
    - "Requires sys (standard library)"
    - "Requires logging (standard library)"
  external:
    - "Optional: uv (falls back to python -m venv if not available)"
  blocking_stories: []

# Performance Considerations
performance:
  - "Venv creation is one-time operation during install (negligible performance impact)"
  - "Idempotency check should be fast (<100ms) using Path.exists() + simple validation"
  - "Avoid expensive operations during status check (don't recreate venv)"

# Error Handling
error_scenarios:
  - scenario: "uv not available and python -m venv fails"
    handling: "Display clear error message with troubleshooting steps, exit with error code"

  - scenario: "Python version < 3.10"
    handling: "Display version requirement, suggest upgrading Python, exit with error code"

  - scenario: "Insufficient permissions to create ~/.graphiti/"
    handling: "Display permission error, suggest manual directory creation with proper permissions"

  - scenario: "Venv exists but is corrupted (missing activate script)"
    handling: "Log warning, remove corrupted venv, attempt recreation"

  - scenario: "Disk space insufficient for venv creation"
    handling: "Subprocess will fail, catch error, display disk space message"
