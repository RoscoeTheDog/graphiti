# Plan: 4.2
# Generated by: discovery:4.2.d
# Timestamp: 2025-12-18T16:47:00Z

story_id: "4.2"
title: "Fix E2E Test API Assertions"
created: "2025-12-18T16:47:00Z"
created_by: "discovery:4.2.d"

# Analysis Summary
analysis:
  summary: "Fix API contract mismatches in E2E tests - update assertions to handle bool return from install(), and ensure mcp_server package is importable in test venv"
  complexity: "low"
  estimated_files: 2
  estimated_tokens: 800
  risk_factors:
    - "Tests may reveal additional API mismatches not caught in static analysis"
    - "Package import fix may require additional test environment setup"

# Files to Create
files_to_create: []

# Files to Modify
files_to_modify:
  - path: "mcp_server/tests/test_daemon_e2e_validation.py"
    changes:
      - "Line 159: Change `assert install_result['success']` to `assert install_result` (bool assertion)"
      - "Line 284: Change `assert first_install['success']` to `assert first_install` (bool assertion)"
      - "Line 294: Change `assert second_install['success']` to `assert second_install` (bool assertion)"
      - "Lines 381-382: Remove dict-style error handling from install() calls, use try-except for exceptions"
      - "Fixture ensure_venv_exists: Add pip install of mcp_server package to make it importable"
    lines_affected: 8
  - path: "mcp_server/tests/conftest.py"
    changes:
      - "Add session-scoped fixture for installing mcp_server package in test venv (if not already present)"
      - "Ensure package import path is available for tests requiring 'import mcp_server'"
    lines_affected: 15

# Integration Points
integration:
  - file: "mcp_server/tests/test_daemon_e2e_validation.py"
    type: "fixture"
    description: "Update ensure_venv_exists fixture to install mcp_server package after venv creation"
  - file: "mcp_server/tests/conftest.py"
    type: "fixture"
    description: "Add global fixture for package installation if needed across multiple test files"

# Patterns to Follow
patterns:
  - source: "mcp_server/tests/test_daemon_e2e_validation.py"
    pattern: "Use pytest.mark.e2e for end-to-end tests, session-scoped fixtures for expensive setup"
  - source: "mcp_server/daemon/manager.py"
    pattern: "install() returns bool (True=success, False=failure), raises exceptions for unexpected errors"
  - source: "mcp_server/tests/test_daemon_e2e_validation.py"
    pattern: "Use pytest.skip() for graceful test skipping when preconditions fail"

# Test Requirements
test_requirements:
  unit:
    - "Verify install_result assertion type (bool, not dict)"
    - "Verify first_install assertion type (bool, not dict)"
    - "Verify second_install assertion type (bool, not dict)"
  integration:
    - "Run pytest mcp_server/tests/test_daemon_e2e_validation.py -v"
    - "Verify >= 90% pass rate (at least 6/7 tests passing)"
    - "Verify test_fresh_install_flow passes"
    - "Verify test_reinstall_idempotent passes"
    - "Verify test_health_check_timing passes"
    - "Verify test_daemon_status_command passes"
  security:
    - "N/A - test changes only"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-4.2.1"
    text: "All E2E tests pass (7/7) or skip gracefully"
    implementation: "files_to_modify[0] - Fix all 4 assertion errors"
    tests: "integration - Run full E2E test suite"
  - id: "AC-4.2.2"
    text: "Test pass rate >= 90%"
    implementation: "files_to_modify[0] - Fix API contract mismatches"
    tests: "integration - Verify pass rate calculation"
  - id: "AC-4.2.3"
    text: "No TypeError for install() return type"
    implementation: "files_to_modify[0] - Lines 159, 284, 294"
    tests: "integration - Verify no TypeError exceptions"
  - id: "AC-4.2.4"
    text: "mcp_server package importable in test environment"
    implementation: "files_to_modify[0] - Update ensure_venv_exists fixture"
    tests: "integration - Verify import mcp_server succeeds in tests"
  - id: "AC-4.2.5"
    text: "Story 4.1.t and 4.t unblocked"
    implementation: "All fixes above"
    tests: "integration - Verify >= 90% pass rate enables unblocking"

# Implementation Details
implementation_notes:
  api_mismatch_fix:
    - location: "test_daemon_e2e_validation.py:159"
      before: "assert install_result['success'], f\"Install failed: {install_result.get('error')}\""
      after: "assert install_result, \"Install failed\""
      rationale: "install() returns bool, not dict with 'success' key"
    - location: "test_daemon_e2e_validation.py:284"
      before: "assert first_install['success'], 'First install should succeed'"
      after: "assert first_install, 'First install should succeed'"
      rationale: "install() returns bool, not dict with 'success' key"
    - location: "test_daemon_e2e_validation.py:294"
      before: "assert second_install['success'], 'Reinstall should succeed without errors'"
      after: "assert second_install, 'Reinstall should succeed without errors'"
      rationale: "install() returns bool, not dict with 'success' key"

  package_import_fix:
    - location: "test_daemon_e2e_validation.py:ensure_venv_exists fixture"
      approach: "After venv creation, install mcp_server package in development mode"
      implementation: |
        # After venv creation succeeds:
        venv_python = venv_manager.venv_path / 'bin' / 'python'
        if platform.system() == 'Windows':
            venv_python = venv_manager.venv_path / 'Scripts' / 'python.exe'

        # Install mcp_server package in development mode
        import subprocess
        result = subprocess.run(
            [str(venv_python), '-m', 'pip', 'install', '-e', '.'],
            capture_output=True,
            text=True,
            cwd=Path(__file__).parent.parent  # graphiti root
        )
        if result.returncode != 0:
            pytest.skip(f"Package install failed: {result.stderr}")
      rationale: "Tests that import mcp_server need the package installed in test venv"

# Verification Strategy
verification:
  pre_implementation:
    - "Run tests to confirm current 42.9% pass rate (3/7 passing)"
    - "Confirm TypeError on lines 159, 284, 294"
    - "Confirm ModuleNotFoundError for mcp_server package"

  post_implementation:
    - "Run: pytest mcp_server/tests/test_daemon_e2e_validation.py -v"
    - "Verify: >= 90% pass rate (6/7 or 7/7 tests passing)"
    - "Verify: No TypeError exceptions"
    - "Verify: No ModuleNotFoundError exceptions"
    - "Verify: test_fresh_install_flow passes"
    - "Verify: test_reinstall_idempotent passes"
    - "Verify: test_health_check_timing passes"
    - "Verify: test_daemon_status_command passes"

  success_criteria:
    - "Pass rate >= 90%"
    - "All TypeError and ModuleNotFoundError eliminated"
    - "Story 4.1.t changes from blocked to unassigned"
    - "Story 4.t changes from blocked to unassigned"
