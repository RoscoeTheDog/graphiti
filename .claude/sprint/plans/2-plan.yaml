# Plan: 2
# Generated by: discovery:2.d
# Timestamp: 2025-12-12T00:00:00Z

story_id: "2"
title: "Extend GraphitiClients with Preprocessing Fields"
created: "2025-12-12T00:00:00Z"
created_by: "discovery:2.d"

# Analysis Summary
analysis:
  summary: "Add two new fields to GraphitiClients dataclass (preprocessing_prompt, preprocessing_mode) and wire through Graphiti.__init__ constructor, following existing pattern for other optional clients."
  complexity: "low"
  estimated_files: 2
  estimated_tokens: 3500
  risk_factors:
    - "Backward compatibility must be maintained for existing instantiation patterns"
    - "Type annotations must match ExtractionConfig schema (bool | str | None)"

# Files to Create
files_to_create: []

# Files to Modify
files_to_modify:
  - path: "graphiti_core/graphiti_types.py"
    changes:
      - "Add preprocessing_prompt field to GraphitiClients (type: str | None, default: None)"
      - "Add preprocessing_mode field to GraphitiClients (type: str, default: 'prepend')"
      - "Import Union and Literal from typing for type annotations"
    lines_affected: 8

  - path: "graphiti_core/graphiti.py"
    changes:
      - "Add preprocessing_prompt parameter to Graphiti.__init__ (type: str | None, default: None)"
      - "Add preprocessing_mode parameter to Graphiti.__init__ (type: str, default: 'prepend')"
      - "Pass preprocessing_prompt and preprocessing_mode to GraphitiClients constructor (line ~232)"
      - "Add preprocessing parameters to docstring with descriptions"
      - "Import Literal from typing for type annotation"
    lines_affected: 20

# Integration Points
integration:
  - file: "graphiti_core/graphiti.py"
    type: "constructor"
    description: "Wire preprocessing parameters from Graphiti.__init__ to GraphitiClients initialization"

  - file: "graphiti_core/extraction_config.py"
    type: "import"
    description: "Type annotations must match ExtractionConfig schema for consistency"

# Patterns to Follow
patterns:
  - source: "graphiti_core/graphiti.py (lines 204-224)"
    pattern: "Follow existing pattern for optional client parameters (llm_client, embedder, cross_encoder) - accept in constructor, assign with defaults"

  - source: "graphiti_core/graphiti_types.py (lines 26-33)"
    pattern: "Add new fields to GraphitiClients dataclass following existing field pattern with type annotations"

  - source: "graphiti_core/extraction_config.py (lines 49-65)"
    pattern: "Use matching type annotations (Union[bool, str, None] and Literal['prepend', 'append'])"

# Test Requirements
test_requirements:
  unit:
    - "Test GraphitiClients instantiation with default preprocessing values (None, 'prepend')"
    - "Test GraphitiClients instantiation with explicit preprocessing values"
    - "Test Graphiti.__init__ accepts preprocessing parameters"
    - "Test Graphiti.__init__ passes preprocessing parameters to GraphitiClients"
    - "Test backward compatibility: Graphiti instantiation without preprocessing params"
    - "Test type validation: preprocessing_prompt accepts None, str"
    - "Test type validation: preprocessing_mode accepts 'prepend', 'append'"
  integration:
    - "Test full Graphiti initialization with preprocessing parameters set"
    - "Test GraphitiClients can be accessed via Graphiti.clients with preprocessing fields"
  security: []

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-2.1"
    text: "(P0) GraphitiClients has preprocessing_prompt field (default: None)"
    implementation: "files_to_modify[0] - graphiti_core/graphiti_types.py"
    tests: "test_requirements.unit[0,1,5]"

  - id: "AC-2.2"
    text: "(P0) GraphitiClients has preprocessing_mode field (default: 'prepend')"
    implementation: "files_to_modify[0] - graphiti_core/graphiti_types.py"
    tests: "test_requirements.unit[0,1,6]"

  - id: "AC-2.3"
    text: "(P0) Graphiti.__init__ accepts and passes preprocessing params to GraphitiClients"
    implementation: "files_to_modify[1] - graphiti_core/graphiti.py"
    tests: "test_requirements.unit[2,3,7]"

  - id: "AC-2.4"
    text: "(P1) Existing Graphiti instantiation patterns continue to work (backward compatible)"
    implementation: "files_to_modify[1] - graphiti_core/graphiti.py (default parameter values)"
    tests: "test_requirements.unit[4]"
