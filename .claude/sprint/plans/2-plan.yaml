# Plan: 2
# Generated by: discovery:2.d
# Timestamp: 2025-12-17T16:30:00Z

story_id: "2"
title: "Clear Error Feedback for Connection Failures"
created: "2025-12-17T16:30:00Z"
created_by: "discovery:2.d"

# Analysis Summary
analysis:
  summary: "Enhance MCP server error messaging with actionable guidance when connection fails, including startup banner and improved health check endpoint."
  complexity: "low"
  estimated_files: 3
  estimated_tokens: 8000
  risk_factors:
    - "Must ensure error messages appear in Claude Code logs (stderr requirement)"
    - "Health check endpoint format change may affect monitoring tools"
    - "Startup banner timing must occur before MCP protocol initialization"

# Files to Create
files_to_create: []

# Files to Modify
files_to_modify:
  - path: "mcp_server/src/graphiti_mcp_server.py"
    changes:
      - "Add startup banner to stderr with connection URL and port"
      - "Enhance /health endpoint to include daemon state (enabled, config_path)"
      - "Add stderr logging for HTTP transport startup (already exists for other transports)"
    lines_affected: 30

  - path: "mcp_server/api/client.py"
    changes:
      - "Update _handle_connection_error to match new error template format"
      - "Add port conflict detection hint (check if port 8321 in use)"
      - "Ensure all error messages follow consistent format with emoji markers"
    lines_affected: 20

  - path: "mcp_server/daemon/bootstrap.py"
    changes:
      - "Add stderr logging when daemon.enabled changes state"
      - "Log daemon start/stop events with actionable context"
    lines_affected: 10

# Integration Points
integration:
  - file: "mcp_server/src/graphiti_mcp_server.py"
    type: "endpoint"
    description: "Enhance /health endpoint response schema to include daemon metadata"

  - file: "mcp_server/api/client.py"
    type: "error-handling"
    description: "Connection error handler consumes stderr output from server startup"

  - file: "mcp_server/daemon/bootstrap.py"
    type: "logging"
    description: "Bootstrap service logs appear in daemon logs (graphiti-mcp daemon logs)"

# Patterns to Follow
patterns:
  - source: "mcp_server/api/client.py:149-167"
    pattern: "Use sys.stderr for error output with structured format (header, causes, actions)"

  - source: "mcp_server/graphiti_mcp_server.py:2849-2860"
    pattern: "FastAPI health endpoint pattern - return JSON with status field"

  - source: "mcp_server/daemon/bootstrap.py:144-199"
    pattern: "Use logger.info/warning for state changes, logger.error for failures"

# Test Requirements
test_requirements:
  unit:
    - "Test startup banner contains connection URL (http://127.0.0.1:8321)"
    - "Test startup banner contains daemon install command"
    - "Test health endpoint returns daemon state (enabled: true/false)"
    - "Test health endpoint returns config file path"
    - "Test error message formatting matches template"

  integration:
    - "Test connection failure when port 8321 unreachable (daemon not running)"
    - "Test connection failure when daemon.enabled=false in config"
    - "Test error messages visible in stderr output"
    - "Test health endpoint accessible via curl http://127.0.0.1:8321/health"
    - "Test bootstrap logs show daemon state changes"

  security:
    - "Verify error messages don't expose Neo4j credentials"
    - "Verify error messages don't expose OpenAI API keys"
    - "Verify health endpoint doesn't expose sensitive config values"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-2.1"
    text: "(P0) When HTTP connection to :8321 fails, error message includes: 'Daemon not running. Run: graphiti-mcp daemon install'"
    implementation: "files_to_modify[1] (mcp_server/api/client.py)"
    tests: "test_requirements.integration[0]"

  - id: "AC-2.2"
    text: "(P0) When daemon is installed but not enabled, error message includes path to config file"
    implementation: "files_to_modify[1] (mcp_server/api/client.py)"
    tests: "test_requirements.integration[1]"

  - id: "AC-2.3"
    text: "(P1) Error messages are visible in Claude Code logs (stderr output)"
    implementation: "files_to_modify[0] (mcp_server/src/graphiti_mcp_server.py) + files_to_modify[1]"
    tests: "test_requirements.integration[2]"

  - id: "AC-2.4"
    text: "(P2) Add health check endpoint response that indicates daemon state for debugging"
    implementation: "files_to_modify[0] (mcp_server/src/graphiti_mcp_server.py)"
    tests: "test_requirements.integration[3]"
