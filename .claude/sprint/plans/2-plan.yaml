# Plan: 2
# Generated by: discovery:2.d
# Timestamp: 2025-12-23T22:30:00Z

story_id: "2"
title: "Deploy standalone package to ~/.graphiti/"
created: "2025-12-23T22:30:00Z"
created_by: "discovery:2.d"

# Analysis Summary
analysis:
  summary: "Implement package deployment during daemon installation by copying mcp_server/ to ~/.graphiti/mcp_server/ with version tracking and idempotent replacement logic"
  complexity: "medium"
  estimated_files: 3
  estimated_tokens: 8000
  risk_factors:
    - "Cross-platform path handling (Windows/Unix differences)"
    - "Shutil.copytree permissions on different filesystems"
    - "Bootstrap.py path resolution must work from both repo and deployed locations"
    - "Backup/replacement logic must handle incomplete previous deployments"

# Files to Create
files_to_create:
  - path: "mcp_server/daemon/package_deployer.py"
    purpose: "Dedicated module for deploying mcp_server package to ~/.graphiti/mcp_server/"
    pattern_source: "mcp_server/daemon/venv_manager.py"
    estimated_lines: 200
    details:
      - "PackageDeployer class with platform-agnostic path handling"
      - "Methods: deploy_package(), backup_existing(), verify_deployment()"
      - "Version file creation/reading (~/.graphiti/mcp_server/.version)"
      - "Idempotent operations (safe to run multiple times)"
      - "Uses shutil.copytree with dirs_exist_ok=True"
      - "Excludes .venv/, __pycache__/, tests/ during copy"

  - path: "mcp_server/daemon/tests/test_package_deployer.py"
    purpose: "Unit tests for package deployment functionality"
    pattern_source: "mcp_server/daemon/tests/test_venv_manager.py"
    estimated_lines: 150
    details:
      - "Test deploy_package() creates directory structure"
      - "Test idempotency (running twice is safe)"
      - "Test version marker creation"
      - "Test backup/replacement of existing deployment"
      - "Test exclusion patterns (venv, pycache, tests)"
      - "Test cross-platform path handling"

  - path: ".claude/sprint/plans/2-deployment-manifest.md"
    purpose: "Documentation of deployment structure and file list"
    pattern_source: "None (documentation artifact)"
    estimated_lines: 50
    details:
      - "List of all files/directories deployed to ~/.graphiti/mcp_server/"
      - "Version compatibility notes"
      - "Upgrade/downgrade implications"

# Files to Modify
files_to_modify:
  - path: "mcp_server/daemon/manager.py"
    changes:
      - "Import PackageDeployer class from package_deployer.py"
      - "Add step 2.4 in install() method: Deploy mcp_server package to ~/.graphiti/"
      - "Call deployer.deploy_package() after venv creation (step 2)"
      - "Add error handling and user-friendly troubleshooting messages"
      - "Position: After step 2 (venv creation), before step 2.5 (package install)"
    lines_affected: 15
    context:
      - "Currently install() has steps: 1) validate python, 2) create venv, 2.5) install package, 2.6) generate wrappers, 3) create config, 4) install service"
      - "New step 2.4 deploys package BEFORE step 2.5 installs it into venv"
      - "This ensures package is available at ~/.graphiti/mcp_server/ for bootstrap service to use"

  - path: "mcp_server/daemon/bootstrap.py"
    changes:
      - "Update _get_mcp_server_path() to prefer deployed location"
      - "Detection order: 1) Env var override, 2) ~/.graphiti/mcp_server/graphiti_mcp_server.py, 3) Relative path fallback"
      - "Add validation that deployed package exists before starting server"
      - "Log which path resolution method succeeded (for debugging)"
    lines_affected: 12
    context:
      - "Currently _get_mcp_server_path() uses: env var -> relative to __file__"
      - "After change: env var -> deployed location -> relative fallback"
      - "This allows bootstrap to work in both dev and production scenarios"

  - path: "mcp_server/daemon/venv_manager.py"
    changes:
      - "Update detect_repo_location() documentation to note package deployment"
      - "Add comment explaining deployment changes repository resolution strategy"
      - "No functional changes, documentation only"
    lines_affected: 3
    context:
      - "Documentation update to clarify relationship between deployed package and repo detection"
      - "Helps future maintainers understand the two-location architecture"

# Integration Points
integration:
  - file: "mcp_server/daemon/manager.py"
    type: "import"
    description: "Import PackageDeployer and call during install workflow"

  - file: "mcp_server/daemon/bootstrap.py"
    type: "config"
    description: "Update path resolution to use deployed package location"

  - file: "mcp_server/daemon/__init__.py"
    type: "export"
    description: "Export PackageDeployer if needed for external use (optional)"

# Patterns to Follow
patterns:
  - source: "mcp_server/daemon/venv_manager.py"
    pattern: "Platform-agnostic path handling using pathlib.Path and sys.platform checks"

  - source: "mcp_server/daemon/venv_manager.py"
    pattern: "Idempotent operations with detect-before-create logic"

  - source: "mcp_server/daemon/venv_manager.py"
    pattern: "Return Tuple[bool, str] for operation results with user-friendly messages"

  - source: "mcp_server/unified_config.py"
    pattern: "Use shutil.copy2() for file operations to preserve metadata"

  - source: "mcp_server/daemon/manager.py"
    pattern: "Step-numbered installation workflow with [OK]/[FAILED] output formatting"

# Test Requirements
test_requirements:
  unit:
    - "PackageDeployer.deploy_package() creates ~/.graphiti/mcp_server/ directory"
    - "PackageDeployer.deploy_package() copies all mcp_server/ files excluding .venv, __pycache__, tests"
    - "PackageDeployer.deploy_package() creates .version file with current version from pyproject.toml"
    - "PackageDeployer.deploy_package() is idempotent (running twice produces same result)"
    - "PackageDeployer.backup_existing() creates timestamped backup when deployment exists"
    - "PackageDeployer.verify_deployment() validates deployment structure and version file"
    - "PackageDeployer handles Windows backslash and Unix forward slash paths correctly"
    - "Bootstrap._get_mcp_server_path() returns deployed path when it exists"
    - "Bootstrap._get_mcp_server_path() falls back to relative path when deployed version missing"

  integration:
    - "DaemonManager.install() deploys package to ~/.graphiti/mcp_server/ during installation"
    - "DaemonManager.install() creates .version file matching pyproject.toml version"
    - "Bootstrap service starts successfully using deployed package path"
    - "Bootstrap service logs which path resolution succeeded (deployed vs relative)"
    - "Running install twice backs up old deployment and creates new one"
    - "Deployed package includes all required submodules (daemon/, config/, api/)"

  security:
    - "Deployment only writes to ~/.graphiti/ directory (no path traversal)"
    - "Backup directory names use safe timestamp format (no user input)"
    - "Version file contains only version string (no arbitrary content execution)"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-2.1"
    text: "(P0) mcp_server/ package is copied to ~/.graphiti/mcp_server/"
    implementation: "files_to_create[0] (package_deployer.py) - deploy_package() method"
    tests: "test_requirements.unit[0-2], integration[0-1]"

  - id: "AC-2.2"
    text: "(P0) All submodules (daemon/, etc.) are included in the deployment"
    implementation: "files_to_create[0] (package_deployer.py) - copytree with exclusions"
    tests: "test_requirements.integration[5]"

  - id: "AC-2.3"
    text: "(P1) Deployment is idempotent (can run multiple times safely)"
    implementation: "files_to_create[0] (package_deployer.py) - idempotent deploy_package()"
    tests: "test_requirements.unit[3], integration[4]"

  - id: "AC-2.4"
    text: "(P1) Old deployments are backed up or cleanly replaced"
    implementation: "files_to_create[0] (package_deployer.py) - backup_existing() method"
    tests: "test_requirements.unit[4], integration[4]"

  - id: "AC-2.5"
    text: "(P2) Deployment includes version marker for upgrade detection"
    implementation: "files_to_create[0] (package_deployer.py) - .version file creation"
    tests: "test_requirements.unit[2], integration[1]"

# Implementation Notes
implementation_notes:
  deployment_location: "~/.graphiti/mcp_server/"
  version_file_format: "Plain text file containing version from pyproject.toml (e.g., '1.0.1')"
  backup_format: "~/.graphiti/mcp_server.backup.{timestamp}/ where timestamp is YYYYMMDD-HHMMSS"
  exclusions:
    - ".venv/"
    - "__pycache__/"
    - "*.pyc"
    - "tests/"
    - ".pytest_cache/"
    - "*.egg-info/"

  platform_considerations:
    windows: "Use Path.home() which resolves to C:\\Users\\{username}\\"
    unix: "Use Path.home() which resolves to /home/{username}/"

  error_scenarios:
    no_write_permission: "Fail gracefully with message: 'Cannot write to ~/.graphiti/, check permissions'"
    disk_full: "Fail gracefully with message: 'Insufficient disk space for deployment'"
    partial_copy: "Use copytree with dirs_exist_ok=True to allow resume/retry"

# Dependencies
dependencies:
  - "Story 1 must be completed first (requirements.txt generation)"
  - "Reason: venv_manager.install_package() depends on requirements.txt existing"
  - "Note: Deployment happens BEFORE package installation into venv"

# Migration Strategy
migration_strategy:
  existing_installations: "First run with new deployment will create ~/.graphiti/mcp_server/"
  version_detection: "Check .version file to determine if upgrade/downgrade needed"
  rollback: "Manual: rename backup directory back to mcp_server/"

# Success Criteria
success_criteria:
  - "DaemonManager.install() successfully deploys package to ~/.graphiti/mcp_server/"
  - "Bootstrap service starts using deployed package (verified via logs)"
  - "Running install twice creates backup and updates deployment"
  - "All submodules present in deployment (daemon/, config/, api/, etc.)"
  - "Version file matches pyproject.toml version"
  - "Tests pass on Windows and Unix platforms"
