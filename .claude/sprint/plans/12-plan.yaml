# Plan: 12
# Generated by: discovery:12.d
# Timestamp: 2025-12-11T21:30:00Z

story_id: "12"
title: "Configuration Schema Updates"
created: "2025-12-11T21:30:00Z"
created_by: "discovery:12.d"

# Analysis Summary
analysis:
  summary: "Add SummarizationConfig Pydantic model and JSON schema definition to enable user customization of intelligent session summarization features"
  complexity: "low"
  estimated_files: 2
  estimated_tokens: 3500
  risk_factors:
    - "Breaking changes if schema structure not backward compatible"
    - "Validation errors if Pydantic model doesn't match JSON schema exactly"

# Files to Create
files_to_create: []

# Files to Modify
files_to_modify:
  - path: "mcp_server/unified_config.py"
    changes:
      - "Add SummarizationConfig Pydantic model after SessionTrackingConfig class (~line 683)"
      - "Add summarization field to SessionTrackingConfig model (~line 621)"
      - "Import Literal type for type_detection field"
    lines_affected: 70

  - path: "graphiti.config.schema.json"
    changes:
      - "Add SummarizationConfig definition to $defs section"
      - "Add summarization reference to SessionTrackingConfig properties"
      - "Ensure all field types match Pydantic model exactly"
    lines_affected: 50

# Integration Points
integration:
  - file: "mcp_server/unified_config.py"
    type: "model"
    description: "SessionTrackingConfig will have a new summarization field that references SummarizationConfig"

  - file: "graphiti.config.schema.json"
    type: "schema"
    description: "SessionTrackingConfig schema will reference new SummarizationConfig definition in $defs"

# Patterns to Follow
patterns:
  - source: "mcp_server/unified_config.py"
    pattern: "Follow existing Pydantic config model structure: BaseModel, Field with default/description, property methods for env vars"

  - source: "mcp_server/unified_config.py (lines 551-683)"
    pattern: "SessionTrackingConfig structure: nested config models, Field with default_factory for complex types, validators for custom logic"

  - source: "graphiti.config.schema.json ($defs section)"
    pattern: "JSON Schema structure: define in $defs with title/description/properties, reference with $ref from parent config"

  - source: "graphiti.config.schema.json (FilterConfig, RetryQueueConfig)"
    pattern: "Nested config schemas: define sub-configs in $defs first, then reference from parent with $ref"

# Test Requirements
test_requirements:
  unit:
    - "Test SummarizationConfig model instantiation with default values"
    - "Test SummarizationConfig field validation (extraction_threshold range 0.0-1.0)"
    - "Test SummarizationConfig field types (template as str|None, type_detection as Literal)"
    - "Test SessionTrackingConfig with and without summarization block"
    - "Test backward compatibility: config without summarization block uses defaults"
    - "Test JSON schema validation with valid summarization config"
    - "Test JSON schema validation rejects invalid values (threshold > 1.0, invalid type_detection)"

  integration:
    - "Test loading graphiti.config.json with new summarization block"
    - "Test loading graphiti.config.json without summarization block (backward compat)"
    - "Test GraphitiConfig.from_file() with summarization configuration"
    - "Test config validation with ConfigValidator against new schema"
    - "Test default values propagate correctly when summarization block omitted"

  security:
    - "Ensure tool_classification_cache path is validated/sanitized"
    - "Ensure template path is validated/sanitized to prevent path traversal"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-12.1"
    text: "(P0) SummarizationConfig Pydantic model with fields from spec"
    implementation: "files_to_modify[0] (unified_config.py)"
    tests: "test_requirements.unit[0-4]"

  - id: "AC-12.2"
    text: "(P0) JSON schema updated with summarization block under session_tracking"
    implementation: "files_to_modify[1] (graphiti.config.schema.json)"
    tests: "test_requirements.unit[5-6], test_requirements.integration[0-1]"

  - id: "AC-12.3"
    text: "(P0) extraction_threshold, include_decisions, include_errors_resolved configurable"
    implementation: "files_to_modify[0] (SummarizationConfig fields)"
    tests: "test_requirements.unit[1], test_requirements.integration[2]"

  - id: "AC-12.4"
    text: "(P1) tool_classification_cache path configurable"
    implementation: "files_to_modify[0] (SummarizationConfig tool_classification_cache field)"
    tests: "test_requirements.security[0]"

  - id: "AC-12.5"
    text: "(P1) Backward compatible with existing configs (new block optional)"
    implementation: "files_to_modify[0] (Field with default_factory), files_to_modify[1] (schema optional)"
    tests: "test_requirements.unit[4], test_requirements.integration[1,4]"

# Implementation Notes
implementation_notes:
  location_guidance:
    - "Add SummarizationConfig class after SessionTrackingResilienceConfig (line ~524) and before SessionTrackingConfig (line ~551)"
    - "Add summarization field in SessionTrackingConfig after resilience field (line ~621)"
    - "In JSON schema, add SummarizationConfig to $defs section alongside SessionTrackingConfig definition"

  field_specifications:
    template:
      type: "str | None"
      default: "None"
      description: "Custom summarization template path. If None, uses dynamic extraction."

    type_detection:
      type: "Literal['auto', 'manual']"
      default: "auto"
      description: "Activity detection mode. 'auto' infers from messages, 'manual' requires explicit config."

    extraction_threshold:
      type: "float"
      default: 0.3
      constraints: "ge=0.0, le=1.0"
      description: "Minimum priority score to include extraction field"

    include_decisions:
      type: "bool"
      default: "True"
      description: "Extract key_decisions (prevents repeated debates)"

    include_errors_resolved:
      type: "bool"
      default: "True"
      description: "Extract errors_resolved (debugging continuity)"

    tool_classification_cache:
      type: "str | None"
      default: "None"
      description: "Path to tool classification cache. Default: ~/.graphiti/tool_cache.json"

  backward_compatibility_strategy:
    - "Use Field(default_factory=SummarizationConfig) so omitted block creates default instance"
    - "All SummarizationConfig fields have sensible defaults"
    - "JSON schema does not require summarization property (optional in SessionTrackingConfig)"

  validation_strategy:
    - "Add field_validator for extraction_threshold to enforce 0.0-1.0 range"
    - "Pydantic Literal type enforces type_detection enum values"
    - "Path fields (template, tool_classification_cache) accept None or str"

# Dependencies
external_dependencies: []
internal_dependencies:
  - "graphiti_core.session_tracking.filter_config.FilterConfig (already imported)"
  - "pydantic.Field (already imported)"
  - "typing.Literal (needs import)"

# Schema Alignment Checklist
schema_alignment:
  - item: "Pydantic model field names match JSON schema property names exactly"
    status: "required"
  - item: "Pydantic Field defaults match JSON schema default values exactly"
    status: "required"
  - item: "Pydantic Field descriptions match JSON schema description strings exactly"
    status: "required"
  - item: "Pydantic validators align with JSON schema constraints"
    status: "required"
  - item: "JSON schema $ref points to correct $defs key"
    status: "required"
