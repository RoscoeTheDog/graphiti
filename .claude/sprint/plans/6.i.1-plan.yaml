# Plan: 6.i.1
# Generated by: discovery:6.i.1.d
# Timestamp: 2025-12-13T17:45:00Z

story_id: "6.i.1"
title: "Complete test cleanup for deprecated parameters"
created: "2025-12-13T17:45:00Z"
created_by: "discovery:6.i.1.d"

# Analysis Summary
analysis:
  summary: "Remove all references to deprecated inactivity_timeout and check_interval parameters from test files that instantiate SessionManager, while preserving backward compatibility tests that intentionally verify migration behavior."
  complexity: "medium"
  estimated_files: 9
  estimated_tokens: 8000
  risk_factors:
    - "Multiple test files affected across different test suites"
    - "Need to distinguish between deprecated usage vs intentional backward compatibility tests"
    - "SessionManager constructor signature changed in Story 2, tests lagging behind"
    - "Test coverage must remain ≥80% after cleanup"

# Files to Create
files_to_create: []  # No new files needed for cleanup task

# Files to Modify
files_to_modify:
  # Priority P0: Core test files identified in remediation story
  - path: "tests/mcp/test_session_tracking_tools.py"
    changes:
      - "Remove lines 40-41: mock_config.session_tracking.{inactivity_timeout,check_interval} assignments"
      - "Remove lines 57-58: Assertions checking these fields in global_config"
      - "Remove lines 79-80: Duplicate mock config assignments in second test"
      - "Remove lines 111-112: Duplicate mock config assignments in third test"
      - "Remove lines 131-132: Assertions checking field presence in global_config"
      - "Remove lines 160-161: Duplicate mock config assignments in fourth test"
    lines_affected: 12
    test_impact: "4 test methods affected - all should pass with removed assertions"

  - path: "tests/session_tracking/test_performance.py"
    changes:
      - "Remove lines 96-97: inactivity_timeout and check_interval from SessionManager constructor"
      - "Remove lines 108-109: Same parameters from second test"
      - "Remove lines 143-144: Same parameters from third test"
    lines_affected: 6
    test_impact: "3 performance test methods - verify SessionManager still initializes correctly"

  # Priority P1: Additional test files requiring analysis
  - path: "tests/test_backward_compatibility.py"
    changes:
      - "INVESTIGATE ONLY: File contains intentional backward compatibility tests"
      - "Lines 31-32, 49-50, 83, 136-141, 192: These test migration from old config"
      - "DECISION: Keep these references as they test deprecated field migration"
      - "Mark with comment: # Testing deprecated field for backward compatibility"
    lines_affected: 0  # No changes - intentional backward compat tests
    test_impact: "None - these tests verify migration behavior"

  - path: "tests/test_config_generation.py"
    changes:
      - "INVESTIGATE: Check if testing config schema or actual usage"
      - "Lines testing _inactivity_timeout_help and field values"
      - "DECISION REQUIRED: Determine if schema still includes deprecated fields for migration"
    lines_affected: "TBD"
    test_impact: "TBD based on investigation"

  - path: "tests/test_unified_config.py"
    changes:
      - "INVESTIGATE: Check usage context"
      - "Likely testing config validation or schema"
    lines_affected: "TBD"
    test_impact: "TBD based on investigation"

  - path: "tests/session_tracking/test_regression.py"
    changes:
      - "INVESTIGATE: Check usage context"
      - "Likely testing regression scenarios"
    lines_affected: "TBD"
    test_impact: "TBD based on investigation"

  - path: "tests/session_tracking/test_security.py"
    changes:
      - "INVESTIGATE: Check usage context"
      - "Likely testing security scenarios"
    lines_affected: "TBD"
    test_impact: "TBD based on investigation"

  - path: "tests/test_retry_queue.py"
    changes:
      - "INVESTIGATE: Check usage context"
    lines_affected: "TBD"
    test_impact: "TBD based on investigation"

  - path: "tests/test_session_tracking_cli.py"
    changes:
      - "INVESTIGATE: Check usage context"
    lines_affected: "TBD"
    test_impact: "TBD based on investigation"

# Integration Points
integration:
  - file: "graphiti_core/session_tracking/session_manager.py"
    type: "reference"
    description: "SessionManager.__init__ signature (current): path_resolver, on_session_closed (optional)"
  - file: "tests/conftest.py"
    type: "reference"
    description: "Check for shared fixtures that might use deprecated parameters"

# Patterns to Follow
patterns:
  - source: "Story 6 implementation (commit c0a9966)"
    pattern: "Cleaned test_config_validator.py by removing deprecated parameter usage"
  - source: "Story 2 implementation"
    pattern: "Removed time-based parameters from SessionManager constructor"
  - source: "tests/test_backward_compatibility.py (lines 31-50)"
    pattern: "When testing deprecated fields for migration, add comment: # Testing deprecated field for backward compatibility"

# Test Requirements
test_requirements:
  unit:
    - "All tests in test_session_tracking_tools.py pass after removing deprecated config fields"
    - "All tests in test_performance.py pass with updated SessionManager constructor calls"
    - "SessionManager instantiation works with only path_resolver (+ optional on_session_closed)"
    - "Mock config objects no longer reference deprecated fields in non-backward-compat tests"

  integration:
    - "Full test suite passes: pytest tests/ -v"
    - "No regressions in session tracking functionality"
    - "MCP tools tests still validate correct behavior"

  coverage:
    - "Test coverage for session_tracking modules remains ≥80%"
    - "No decrease in coverage after cleanup"

  validation:
    - "grep -r 'inactivity_timeout|check_interval' tests/ returns only intentional backward compat references"
    - "All intentional references have explanatory comments"
    - "No SessionManager constructor calls use deprecated parameters (except in backward compat tests)"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-6.i.1-P0-1"
    text: "Remove inactivity_timeout and check_interval from tests/mcp/test_session_tracking_tools.py"
    implementation: "files_to_modify[0]"
    tests: "test_requirements.unit[0]"

  - id: "AC-6.i.1-P0-2"
    text: "Remove inactivity_timeout and check_interval from tests/session_tracking/test_performance.py"
    implementation: "files_to_modify[1]"
    tests: "test_requirements.unit[1-2]"

  - id: "AC-6.i.1-P1-1"
    text: "Verify no other test files reference these deprecated parameters"
    implementation: "files_to_modify[2-8] (investigation phase)"
    tests: "test_requirements.validation[0]"

  - id: "AC-6.i.1-P1-2"
    text: "All affected tests pass after cleanup"
    implementation: "files_to_modify[0-1]"
    tests: "test_requirements.integration[0]"

  - id: "AC-6.i.1-P2-1"
    text: "Test coverage remains ≥80% for session tracking modules"
    implementation: "No file changes needed"
    tests: "test_requirements.coverage[0-1]"

# Implementation Strategy
implementation_strategy:
  phase_1_core_cleanup:
    - "Remove deprecated parameters from test_session_tracking_tools.py (12 lines)"
    - "Remove deprecated parameters from test_performance.py (6 lines)"
    - "Run affected tests to verify they pass"

  phase_2_investigation:
    - "Analyze each of the 7 additional test files"
    - "Determine which references are deprecated usage vs intentional backward compat tests"
    - "For deprecated usage: remove parameters"
    - "For intentional tests: add explanatory comments, keep parameters"

  phase_3_validation:
    - "Run full test suite"
    - "Verify grep shows only intentional references with comments"
    - "Check test coverage metrics"

# Notes
notes:
  - "Story 2 removed inactivity_timeout and check_interval from SessionManager constructor"
  - "Story 6.i attempted cleanup but missed test files in tests/mcp/ directory"
  - "Backward compatibility tests SHOULD keep deprecated field references to verify migration"
  - "Config schema tests may legitimately reference deprecated fields if schema supports migration"
  - "Total 68 references found across 9 files - not all are bugs, some are intentional"
  - "Core remediation: 18 lines across 2 files (P0), investigation needed for remaining 7 files"
