# Plan: 4.r1
# Generated by: discovery:4.r1.d
# Timestamp: 2025-12-14T19:35:00Z

story_id: "4.r1"
title: "Fix Test Failures in PATH Integration"
created: "2025-12-14T19:35:00Z"
created_by: "discovery:4.r1.d"

# Analysis Summary
analysis:
  summary: "Fix 6 failing tests in test_path_integration.py by correcting mock strategies for conditional imports (pwd, winreg) and handling empty print() calls in assertions"
  complexity: "low"
  estimated_files: 1
  estimated_tokens: 3000
  risk_factors:
    - "Platform-specific mocking requires testing on both Windows and Unix"
    - "Print assertion changes could affect test stability"

# Files to Create
files_to_create: []

# Files to Modify
files_to_modify:
  - path: "tests/daemon/test_path_integration.py"
    changes:
      - "Fix test_detect_shell_defaults_to_bash: Mock pwd.getpwuid with side_effect instead of patching module attribute"
      - "Fix test_configure_windows_path_with_consent: Patch individual winreg functions (OpenKey, QueryValueEx, SetValueEx, CloseKey) instead of module"
      - "Fix test_configure_windows_path_already_present: Apply same winreg mocking pattern as test_configure_windows_path_with_consent"
      - "Fix test_configure_windows_path_permission_error: Apply same winreg mocking pattern with PermissionError side_effect"
      - "Fix test_display_instructions_when_already_configured: Handle empty call[0] tuples in print assertion (line 301)"
      - "Fix test_display_windows_instructions_consent_declined: Handle empty call[0] tuples in print assertion (line 320)"
    lines_affected: 120

# Integration Points
integration:
  - file: "tests/daemon/test_path_integration.py"
    type: "test"
    description: "No integration changes needed - pure test file modifications"

# Patterns to Follow
patterns:
  - source: "tests/utils/search/search_utils_test.py"
    pattern: "Use context manager 'with patch()' pattern for multiple mocks"
  - source: "tests/daemon/test_path_integration.py (existing tests)"
    pattern: "Maintain existing test structure, docstrings, and assertion patterns"

# Test Requirements
test_requirements:
  unit:
    - "Run test_detect_shell_defaults_to_bash individually - should pass without AttributeError"
    - "Run test_configure_windows_path_with_consent individually - should pass without AttributeError (Windows only)"
    - "Run test_configure_windows_path_already_present individually - should pass without AttributeError (Windows only)"
    - "Run test_configure_windows_path_permission_error individually - should pass without AttributeError (Windows only)"
    - "Run test_display_instructions_when_already_configured individually - should pass without IndexError"
    - "Run test_display_windows_instructions_consent_declined individually - should pass without IndexError (Windows only)"
  integration:
    - "Run full test suite: pytest tests/daemon/test_path_integration.py -v"
    - "Verify test count: 14 passed, 8 skipped (on Windows) or 8 passed, 14 skipped (on Unix)"
    - "Run all daemon tests: pytest tests/daemon/ -v"
    - "Verify no new failures in related tests (test_venv_integration.py, test_wrapper_generator.py)"
  security: []

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-4.r1.1"
    text: "test_detect_shell_defaults_to_bash passes without AttributeError"
    implementation: "files_to_modify[0] - Mock pwd.getpwuid with ImportError side_effect"
    tests: "test_requirements.unit[0]"

  - id: "AC-4.r1.2"
    text: "All 3 Windows registry tests pass without AttributeError"
    implementation: "files_to_modify[0] - Mock individual winreg functions instead of module"
    tests: "test_requirements.unit[1,2,3]"

  - id: "AC-4.r1.3"
    text: "Both print assertion tests pass without IndexError"
    implementation: "files_to_modify[0] - Handle empty call[0] tuples with conditional"
    tests: "test_requirements.unit[4,5]"

  - id: "AC-4.r1.4"
    text: "Overall test pass rate for test_path_integration.py is 100% (14 of 14 non-skipped tests)"
    implementation: "files_to_modify[0] - All 6 test fixes combined"
    tests: "test_requirements.integration[0,1]"

  - id: "AC-4.r1.5"
    text: "No new test failures introduced"
    implementation: "files_to_modify[0] - Regression check via full daemon test suite"
    tests: "test_requirements.integration[2,3]"

# Implementation Details
implementation_details:
  # Fix 1: pwd module mocking
  fix_1:
    test_name: "test_detect_shell_defaults_to_bash"
    line_range: "163-169"
    current_approach: "patch('mcp_server.daemon.path_integration.pwd', None)"
    issue: "AttributeError - pwd is not an attribute of path_integration module (imported inside function)"
    solution: "patch('pwd.getpwuid', side_effect=ImportError('pwd module not available'))"
    rationale: "pwd is imported inside detect_shell() with try/except, so we mock the function call to raise ImportError"

  # Fix 2: winreg module mocking (3 tests)
  fix_2:
    test_names:
      - "test_configure_windows_path_with_consent"
      - "test_configure_windows_path_already_present"
      - "test_configure_windows_path_permission_error"
    line_ranges:
      - "215-233"
      - "246-267"
      - "268-283"
    current_approach: "@patch('mcp_server.daemon.path_integration.winreg')"
    issue: "AttributeError - winreg is not an attribute of path_integration module (imported inside function)"
    solution: "patch individual functions: patch('winreg.OpenKey'), patch('winreg.QueryValueEx'), patch('winreg.SetValueEx'), patch('winreg.CloseKey')"
    rationale: "winreg is imported inside configure_windows_path() with try/except, so we patch individual functions at import level"

  # Fix 3: Print call assertions (2 tests)
  fix_3:
    test_names:
      - "test_display_instructions_when_already_configured"
      - "test_display_windows_instructions_consent_declined"
    line_ranges:
      - "301"
      - "320"
    current_approach: "str(call[0][0]) for call in mock_print.call_args_list"
    issue: "IndexError - call[0] is empty tuple () when print() called without arguments"
    solution: "str(call[0][0]) if call[0] else '' for call in mock_print.call_args_list"
    rationale: "display_instructions() calls print() without arguments for blank lines, creating empty tuples"

# Verification Steps
verification:
  - step: 1
    description: "Run individual test: test_detect_shell_defaults_to_bash"
    command: "pytest tests/daemon/test_path_integration.py::TestShellDetection::test_detect_shell_defaults_to_bash -v"
    expected: "PASSED"

  - step: 2
    description: "Run individual test: test_configure_windows_path_with_consent (Windows only)"
    command: "pytest tests/daemon/test_path_integration.py::TestWindowsRegistry::test_configure_windows_path_with_consent -v"
    expected: "PASSED (Windows) or SKIPPED (Unix)"

  - step: 3
    description: "Run individual test: test_configure_windows_path_already_present (Windows only)"
    command: "pytest tests/daemon/test_path_integration.py::TestWindowsRegistry::test_configure_windows_path_already_present -v"
    expected: "PASSED (Windows) or SKIPPED (Unix)"

  - step: 4
    description: "Run individual test: test_configure_windows_path_permission_error (Windows only)"
    command: "pytest tests/daemon/test_path_integration.py::TestWindowsRegistry::test_configure_windows_path_permission_error -v"
    expected: "PASSED (Windows) or SKIPPED (Unix)"

  - step: 5
    description: "Run individual test: test_display_instructions_when_already_configured"
    command: "pytest tests/daemon/test_path_integration.py::TestInstructionDisplay::test_display_instructions_when_already_configured -v"
    expected: "PASSED"

  - step: 6
    description: "Run individual test: test_display_windows_instructions_consent_declined (Windows only)"
    command: "pytest tests/daemon/test_path_integration.py::TestInstructionDisplay::test_display_windows_instructions_consent_declined -v"
    expected: "PASSED (Windows) or SKIPPED (Unix)"

  - step: 7
    description: "Run full test suite for test_path_integration.py"
    command: "pytest tests/daemon/test_path_integration.py -v"
    expected: "14 passed, 8 skipped (Windows) or 8 passed, 14 skipped (Unix), 0 failures"

  - step: 8
    description: "Run all daemon tests for regression check"
    command: "pytest tests/daemon/ -v"
    expected: "All tests pass, no new failures"

# Notes
notes:
  - "Platform-specific tests are skipped on incompatible platforms using pytest.mark.skipif"
  - "Windows tests (winreg) skip on Unix, Unix tests (pwd) skip on Windows"
  - "Test count varies by platform: 14 passed + 8 skipped = 22 total"
  - "Conditional import pattern (import inside function with try/except) requires function-level mocking, not module-level patching"
  - "Empty print() calls create empty tuples in mock_print.call_args_list, must handle with conditional"
