# Plan: 1.r1
# Generated by: discovery:1.r1.d
# Timestamp: 2025-12-16T07:30:00Z

story_id: "1.r1"
title: "Fix Path Exclusion Logic Implementation"
created: "2025-12-16T07:30:00Z"
created_by: "discovery:1.r1.d"

# Analysis Summary
analysis:
  summary: "Fix path exclusion bugs in SessionManager._is_path_excluded() by implementing proper directory boundary checking, glob pattern matching with ** support, and adding debug logging."
  complexity: "medium"
  estimated_files: 1
  estimated_tokens: 8000
  risk_factors:
    - "Glob pattern matching with ** requires custom recursive algorithm"
    - "Windows path normalization must work correctly"
    - "Must not break existing functionality (regression risk)"

# Files to Create
files_to_create: []

# Files to Modify
files_to_modify:
  - path: "graphiti_core/session_tracking/session_manager.py"
    changes:
      - "Fix absolute path matching (lines 167-172): Add trailing slash for directory boundary checking"
      - "Fix relative path calculation (lines 174-193): Simplify logic and improve error handling"
      - "Replace PurePosixPath.match() with proper glob matching using fnmatch and custom ** handler"
      - "Add new helper method _glob_match_recursive() for ** pattern support"
      - "Add debug logging when paths are excluded"
    lines_affected: 60

# Integration Points
integration:
  - file: "graphiti_core/session_tracking/session_manager.py"
    type: "method"
    description: "New _glob_match_recursive() helper method called by _is_path_excluded()"

# Patterns to Follow
patterns:
  - source: "graphiti_core/session_tracking/path_resolver.py"
    pattern: "Platform-agnostic path handling using pathlib.Path and _normalize_path_for_hash()"
  - source: "tests/session_tracking/test_excluded_paths.py"
    pattern: "Test-driven approach - fix one test category at a time"

# Test Requirements
test_requirements:
  unit:
    - "test_absolute_path_exclusion_exact_match: Absolute paths match with directory boundaries"
    - "test_relative_path_exclusion: Relative paths resolve correctly against watch_path"
    - "test_glob_pattern_simple_wildcard: **/temporal-*/** pattern matches correctly"
    - "test_glob_pattern_multi_level: Complex ** patterns work"
    - "test_platform_specific_path_normalization_windows: Windows backslashes normalize"
    - "test_platform_specific_path_normalization_unix: Unix paths work"
    - "test_multiple_exclusion_patterns: All patterns evaluated correctly"
  integration:
    - "test_start_tracking_session_skips_excluded: Excluded paths not tracked"
    - "test_start_tracking_session_tracks_non_excluded: Non-excluded paths still tracked"
    - "test_excluded_session_logs_debug_message: Debug logging works with mocked logger"
  security: []

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-1.r1.1"
    text: "test_absolute_path_exclusion_exact_match passes (absolute paths match correctly)"
    implementation: "files_to_modify[0] lines 167-172 - directory boundary logic"
    tests: "unit[0]"

  - id: "AC-1.r1.2"
    text: "test_relative_path_exclusion passes (relative paths resolve and match)"
    implementation: "files_to_modify[0] lines 174-193 - relative path resolution"
    tests: "unit[1]"

  - id: "AC-1.r1.3"
    text: "test_glob_pattern_simple_wildcard passes (**/temporal-*/** pattern works)"
    implementation: "files_to_modify[0] new method _glob_match_recursive() + updated matching logic"
    tests: "unit[2]"

  - id: "AC-1.r1.4"
    text: "test_platform_specific_path_normalization_windows passes (Windows paths normalized)"
    implementation: "files_to_modify[0] verify _normalize_path_for_hash() usage"
    tests: "unit[4]"

  - id: "AC-1.r1.5"
    text: "test_multiple_exclusion_patterns passes (all patterns evaluated)"
    implementation: "files_to_modify[0] lines 162-194 - pattern iteration loop"
    tests: "unit[6]"

  - id: "AC-1.r1.6"
    text: "test_start_tracking_session_skips_excluded passes (integration works)"
    implementation: "files_to_modify[0] - all fixes enable correct integration"
    tests: "integration[0]"

  - id: "AC-1.r1.7"
    text: "test_excluded_session_logs_debug_message passes (logging works)"
    implementation: "files_to_modify[0] add logger.debug() call when path excluded"
    tests: "integration[2]"

  - id: "AC-1.r1.8"
    text: "Full test suite (15/15 tests) passes with 100% pass rate"
    implementation: "files_to_modify[0] - all fixes combined"
    tests: "all unit + integration tests"

  - id: "AC-1.r1.9"
    text: "No regression in other session_tracking tests"
    implementation: "files_to_modify[0] - careful refactoring without breaking changes"
    tests: "pytest tests/session_tracking/test_session_manager_integration.py"

# Implementation Details
implementation_details:
  root_causes:
    - issue: "Absolute path false positives"
      cause: "String startswith() without directory boundary - /projects/temporal-server-2/ matches /projects/temporal-server"
      fix: "Add trailing slash to pattern for directory boundary checking or use exact match"

    - issue: "Glob pattern matching fails"
      cause: "PurePosixPath.match() matches from rightmost part, not full path glob semantics"
      fix: "Replace with fnmatch for simple patterns and custom _glob_match_recursive() for ** patterns"

    - issue: "Relative path edge cases"
      cause: "Complex path calculation with insufficient error handling"
      fix: "Simplify logic, add better error handling and logging"

    - issue: "Logger patching fails in test"
      cause: "Test patches logger at module level but needs correct import path"
      fix: "Verify logger is imported at module level (already correct at line 21)"

  algorithm_design:
    helper_method:
      signature: "def _glob_match_recursive(self, path_parts: list[str], pattern_parts: list[str]) -> bool"
      purpose: "Match path parts against glob pattern parts with ** support"
      algorithm:
        - "Split pattern and path into parts (directory components)"
        - "Handle ** by trying all possible matching positions recursively"
        - "Use fnmatch for wildcard matching of individual components (* and ?)"
        - "Return True if any position matches, False otherwise"

    main_method_changes:
      absolute_path_logic:
        - "Check if pattern is absolute path"
        - "If absolute: Add directory boundary check (trailing slash or exact match)"
        - "Compare normalized paths with boundary awareness"

      relative_glob_logic:
        - "Calculate relative path from watch_path if applicable"
        - "Check if pattern contains ** (recursive wildcard)"
        - "If **: Use _glob_match_recursive() helper"
        - "If simple glob: Use fnmatch.fnmatch()"
        - "Add logging for successful matches"

  testing_strategy:
    approach: "Incremental fix with test verification after each step"
    steps:
      - "Step 1: Fix absolute paths (simplest) - test_absolute_path_exclusion_exact_match"
      - "Step 2: Add debug logging - test_excluded_session_logs_debug_message"
      - "Step 3: Fix relative path calculation - test_relative_path_exclusion"
      - "Step 4: Implement glob matching - test_glob_pattern_simple_wildcard, test_multiple_exclusion_patterns"
      - "Step 5: Verify platform normalization - test_platform_specific_path_normalization_windows"
      - "Step 6: Run full suite - 15/15 tests"
      - "Step 7: Regression tests - test_session_manager_integration.py"

# Dependencies
dependencies:
  external_libraries: []
  stdlib_modules:
    - "pathlib (Path, PurePosixPath)"
    - "fnmatch (fnmatch function)"
    - "logging (logger)"
  internal_modules:
    - "graphiti_core.session_tracking.path_resolver.ClaudePathResolver._normalize_path_for_hash()"

# Platform Testing
platform_requirements:
  primary: "Windows (development environment)"
  secondary: "Unix/macOS (CI/CD verification)"
  notes: "Must test on both platforms due to path normalization requirements"
