# Plan: 11
# Generated by: discovery:11.d
# Timestamp: 2025-12-11T19:35:00Z

story_id: "11"
title: "Summarizer Integration"
created: "2025-12-11T19:35:00Z"
created_by: "discovery:11.d"

# Analysis Summary
analysis:
  summary: |
    Integrate ActivityDetector, UnifiedToolClassifier, and dynamic prompt generation into SessionSummarizer
    for end-to-end intelligent summarization with activity-aware extraction.
  complexity: "medium"
  estimated_files: 2
  estimated_tokens: 18000
  risk_factors:
    - "Activity detection failure could break summarization if not handled gracefully"
    - "Dynamic prompt changes may affect LLM output quality - needs testing"
    - "Activity vector storage format needs to be compatible with markdown and metadata exports"

# Files to Create
files_to_create: []

# Files to Modify
files_to_modify:
  - path: "graphiti_core/session_tracking/summarizer.py"
    changes:
      - "Add activity_vector field to SessionSummary dataclass"
      - "Modify SessionSummarizer.__init__() to accept tool_classifier parameter and initialize ActivityDetector"
      - "Modify SessionSummarizer.summarize_session() to detect activity vector from messages"
      - "Replace static SUMMARIZATION_PROMPT with dynamic build_extraction_prompt() call"
      - "Set activity_vector in SessionSummary response"
      - "Update SessionSummary.to_markdown() to include activity vector in output"
      - "Update SessionSummary.to_metadata() to include activity_vector dict"
      - "Add graceful fallback for activity detection failures (use neutral ActivityVector)"
    lines_affected: 150

  - path: "tests/session_tracking/test_summarizer.py"
    changes:
      - "Add test_sessionsum marizer_init_with_tool_classifier"
      - "Add test_activity_vector_computed_from_messages"
      - "Add test_dynamic_prompt_used_for_extraction"
      - "Add test_activity_vector_included_in_summary"
      - "Add test_graceful_fallback_on_activity_detection_failure"
      - "Add test_activity_vector_in_markdown_output"
      - "Add test_activity_vector_in_metadata_output"
      - "Add test_end_to_end_debugging_session"
      - "Add test_end_to_end_exploration_session"
      - "Add test_integration_with_real_llm_client (marked as integration)"
    lines_affected: 400

# Integration Points
integration:
  - file: "graphiti_core/session_tracking/summarizer.py"
    type: "import"
    description: "Import ActivityDetector from activity_detector module"

  - file: "graphiti_core/session_tracking/summarizer.py"
    type: "import"
    description: "Import build_extraction_prompt from prompt_builder module"

  - file: "graphiti_core/session_tracking/summarizer.py"
    type: "import"
    description: "Import UnifiedToolClassifier from tool_classifier module"

  - file: "graphiti_core/session_tracking/summarizer.py"
    type: "import"
    description: "Import ActivityVector from activity_vector module"

  - file: "graphiti_core/session_tracking/summarizer.py"
    type: "initialization"
    description: "Initialize ActivityDetector in SessionSummarizer.__init__()"

  - file: "graphiti_core/session_tracking/summarizer.py"
    type: "workflow"
    description: "Call activity_detector.detect() in summarize_session()"

  - file: "graphiti_core/session_tracking/summarizer.py"
    type: "workflow"
    description: "Call build_extraction_prompt() instead of static SUMMARIZATION_PROMPT"

# Patterns to Follow
patterns:
  - source: "graphiti_core/session_tracking/activity_detector.py"
    pattern: "Graceful error handling with try-except for external component failures"

  - source: "graphiti_core/session_tracking/prompt_builder.py"
    pattern: "Threshold-based filtering (threshold=0.3 default)"

  - source: "tests/session_tracking/test_activity_detector.py"
    pattern: "Mock external dependencies (LLM client, tool classifier) for unit tests"

  - source: "graphiti_core/session_tracking/summarizer.py"
    pattern: "Convert message list to format expected by ActivityDetector (SessionMessage objects)"

# Test Requirements
test_requirements:
  unit:
    - "test_sessionsum marizer_init_with_tool_classifier - Verify SessionSummarizer accepts tool_classifier parameter and initializes ActivityDetector"
    - "test_activity_vector_computed_from_messages - Verify activity vector is computed with expected dimensions from messages"
    - "test_dynamic_prompt_used_for_extraction - Verify build_extraction_prompt is called with correct parameters"
    - "test_activity_vector_included_in_summary - Verify summary.activity_vector is set and is ActivityVector instance"
    - "test_graceful_fallback_on_activity_detection_failure - Verify summarization continues with neutral ActivityVector on error"
    - "test_activity_vector_in_markdown_output - Verify activity vector dimensions are formatted correctly in markdown"
    - "test_activity_vector_in_metadata_output - Verify activity_vector dict is included in metadata"

  integration:
    - "test_end_to_end_debugging_session - Full session with error-fixing messages, verify activity_vector.fixing > 0.5"
    - "test_end_to_end_exploration_session - Full session with exploratory messages, verify activity_vector.exploring > 0.5"
    - "test_integration_with_real_llm_client - Use actual LLM client to verify structured output parsing works"

  security: []

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-11.1"
    text: "(P0) SessionSummarizer uses ActivityDetector to compute activity vector"
    implementation: "files_to_modify[0].changes[1,2]"
    tests: "test_requirements.unit[0,1]"

  - id: "AC-11.2"
    text: "(P0) SessionSummarizer uses dynamic prompt based on activity"
    implementation: "files_to_modify[0].changes[3]"
    tests: "test_requirements.unit[2]"

  - id: "AC-11.3"
    text: "(P0) Output includes activity_vector in summary"
    implementation: "files_to_modify[0].changes[0,4,5,6]"
    tests: "test_requirements.unit[3,5,6]"

  - id: "AC-11.4"
    text: "(P1) Falls back gracefully if activity detection fails"
    implementation: "files_to_modify[0].changes[7]"
    tests: "test_requirements.unit[4]"

  - id: "AC-11.5"
    text: "(P1) End-to-end integration test with full session"
    implementation: "N/A (testing only)"
    tests: "test_requirements.integration[0,1]"

# Implementation Steps
implementation_steps:
  - id: 1
    description: "Add activity_vector field to SessionSummary dataclass"
    files:
      - "graphiti_core/session_tracking/summarizer.py"
    details: |
      Add field after 'activity_profile':
        activity_vector: ActivityVector | None = None
      Update to_markdown() to format activity_vector dimensions if present
      Update to_metadata() to include activity_vector.to_dict() if present

  - id: 2
    description: "Add imports to SessionSummarizer"
    files:
      - "graphiti_core/session_tracking/summarizer.py"
    details: |
      Add at top of file:
        from graphiti_core.session_tracking.activity_detector import ActivityDetector
        from graphiti_core.session_tracking.activity_vector import ActivityVector
        from graphiti_core.session_tracking.prompt_builder import build_extraction_prompt
        from graphiti_core.session_tracking.tool_classifier import UnifiedToolClassifier

  - id: 3
    description: "Modify SessionSummarizer.__init__() to accept tool_classifier"
    files:
      - "graphiti_core/session_tracking/summarizer.py"
    details: |
      Change signature:
        def __init__(self, llm_client: LLMClient, tool_classifier: UnifiedToolClassifier | None = None):
      Add initialization:
        self.activity_detector = ActivityDetector(tool_classifier)
      Update docstring to document tool_classifier parameter

  - id: 4
    description: "Modify summarize_session() to detect activity vector"
    files:
      - "graphiti_core/session_tracking/summarizer.py"
    details: |
      Add at beginning of summarize_session():
        # Detect activity vector
        try:
            activity = await self.activity_detector.detect(context.messages)
        except Exception as e:
            logger.warning(f'Activity detection failed: {e}, using neutral activity')
            activity = ActivityVector()  # Fallback to neutral

  - id: 5
    description: "Replace static prompt with dynamic build_extraction_prompt()"
    files:
      - "graphiti_core/session_tracking/summarizer.py"
    details: |
      Replace:
        prompt = self.SUMMARIZATION_PROMPT.format(...)
      With:
        # Build dynamic prompt based on activity
        prompt = build_extraction_prompt(
            activity=activity,
            content=filtered_content[:15000],
            threshold=0.3,
        )
      Remove old SUMMARIZATION_PROMPT formatting code

  - id: 6
    description: "Set activity_vector in SessionSummary response"
    files:
      - "graphiti_core/session_tracking/summarizer.py"
    details: |
      In SessionSummary construction, add:
        activity_vector=activity,
      Ensure activity object from step 4 is available

  - id: 7
    description: "Write unit tests for SessionSummarizer integration"
    files:
      - "tests/session_tracking/test_summarizer.py"
    details: |
      Add 7 unit tests covering:
      - Initialization with tool_classifier
      - Activity vector computation
      - Dynamic prompt usage
      - Activity vector in output
      - Graceful fallback
      - Markdown formatting
      - Metadata formatting

  - id: 8
    description: "Write integration tests for end-to-end scenarios"
    files:
      - "tests/session_tracking/test_summarizer.py"
    details: |
      Add 3 integration tests covering:
      - Debugging session (fixing activity)
      - Exploration session (exploring activity)
      - Real LLM client integration

# Dependencies
dependencies:
  internal:
    - "Story 3: Activity Detection from Messages - ActivityDetector class"
    - "Story 7: Unified Tool Classifier - UnifiedToolClassifier class"
    - "Story 9: Dynamic Prompt Generation - build_extraction_prompt function"
    - "Story 1: Enhanced Session Summary Schema - SessionSummary fields"
    - "Story 2: Activity Vector Model - ActivityVector class"

  external:
    - "Python asyncio for async/await pattern"
    - "logging for graceful error handling"

# Risks
risks:
  - risk: "Activity detection may fail for edge case message formats"
    mitigation: "Graceful fallback to neutral ActivityVector with try-except"
    impact: "low"

  - risk: "Dynamic prompts may produce different LLM outputs than static prompt"
    mitigation: "Extensive testing with real sessions, validate output quality"
    impact: "medium"

  - risk: "Activity vector may not serialize correctly to markdown/metadata"
    mitigation: "Use ActivityVector.to_dict() for metadata, format nicely for markdown"
    impact: "low"

  - risk: "Tool classifier initialization may be expensive if done per-session"
    mitigation: "Accept tool_classifier as parameter, allow reuse across sessions"
    impact: "low"

# Estimated Complexity
estimated_complexity: "medium"
estimated_effort: "4-6 hours"

# Notes
notes:
  - "Activity vector enables activity-aware dynamic prompts, reducing token usage by 30-60%"
  - "Graceful fallback ensures summarization never fails due to activity detection"
  - "Activity vector in output enables downstream analytics and visualization"
  - "Integration builds on all previous stories (1-10), bringing system together"
  - "End-to-end tests validate full pipeline from messages to summary with activity awareness"
