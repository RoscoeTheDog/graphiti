story_id: "9"
title: "Dynamic Prompt Generation"
discovery_date: "2025-12-11"
status: "approved"

overview:
  purpose: |
    Build extraction prompts dynamically based on activity vector, including only high-priority
    fields. This reduces token usage by omitting irrelevant extraction instructions and focuses
    LLM attention on what matters most for the session type.

  key_insights:
    - Story 8 provides get_extraction_priorities(activity, threshold) which returns (field, priority) tuples
    - SessionSummarySchema has 10 extractable fields (completed_tasks, key_decisions, errors_resolved, etc.)
    - Current SUMMARIZATION_PROMPT in summarizer.py is static and includes all fields
    - Dynamic prompts can reduce token usage by 30-60% depending on session type
    - Field-specific instructions should guide LLM on what to extract for each field
    - Activity profile context helps LLM understand session type for better extraction

architecture:
  components:
    - name: "PromptBuilder"
      location: "graphiti_core/session_tracking/prompt_builder.py"
      responsibility: "Build dynamic prompts based on activity vector and priority"
      interfaces:
        - "build_extraction_prompt(activity: ActivityVector, content: str, threshold: float) -> str"
        - "PromptTemplate protocol for custom override"

    - name: "FIELD_INSTRUCTIONS"
      location: "graphiti_core/session_tracking/prompt_builder.py"
      responsibility: "Mapping of field names to extraction instructions"
      type: "constant dict"

    - name: "DEFAULT_PROMPT_TEMPLATE"
      location: "graphiti_core/session_tracking/prompt_builder.py"
      responsibility: "Base template for prompt structure"
      type: "string template"

  data_flow: |
    1. SessionSummarizer calls build_extraction_prompt(activity, content, threshold)
    2. PromptBuilder calls get_extraction_priorities(activity, threshold) from Story 8
    3. PromptBuilder retrieves field instructions for prioritized fields
    4. PromptBuilder formats activity profile (top 3 dimensions)
    5. PromptBuilder builds ordered field list with instructions
    6. PromptBuilder injects content and returns complete prompt
    7. SessionSummarizer passes prompt to LLM client

implementation_plan:
  files_to_create:
    - path: "graphiti_core/session_tracking/prompt_builder.py"
      description: "Dynamic prompt generation module"
      size_estimate: "~300 lines"

    - path: "tests/session_tracking/test_prompt_builder.py"
      description: "Unit tests for prompt builder"
      size_estimate: "~400 lines"

  files_to_modify:
    - path: "graphiti_core/session_tracking/__init__.py"
      changes: "Add build_extraction_prompt export"
      lines_affected: 1

  steps:
    - id: 1
      description: "Create FIELD_INSTRUCTIONS mapping"
      files:
        - "graphiti_core/session_tracking/prompt_builder.py"
      details: |
        Define constant dict mapping each SessionSummarySchema field to extraction instructions:
        - completed_tasks: "List specific tasks that were accomplished"
        - key_decisions: "For each decision provide: decision, rationale, alternatives"
        - errors_resolved: "For each error provide: error, root_cause, fix, verification"
        - discoveries: "Key insights or learnings from exploration"
        - config_changes: "List config file changes with before/after values"
        - test_results: "Summarize test execution results and failures"
        - files_modified: "List file paths created or modified"
        - next_steps: "List next actions to continue this work"
        - blocked_items: "List blockers preventing progress"
        - documentation_referenced: "List documentation paths referenced"

    - id: 2
      description: "Create DEFAULT_PROMPT_TEMPLATE"
      files:
        - "graphiti_core/session_tracking/prompt_builder.py"
      details: |
        Define template with placeholders:
        - {activity_profile}: Top 3 activity dimensions with values
        - {prioritized_fields}: Numbered list of fields with instructions and priorities
        - {content}: Session content
        Template structure:
          "You are analyzing a session to create a structured summary.

          **Session Activity Profile**: {activity_profile}

          Extract the following information (in order of importance):

          {prioritized_fields}

          ## Session Content

          {content}

          ## Response Format
          Respond with a JSON object matching the SessionSummarySchema."

    - id: 3
      description: "Implement _format_activity_profile(activity) helper"
      files:
        - "graphiti_core/session_tracking/prompt_builder.py"
      details: |
        Format activity vector as human-readable string showing top 3 dimensions:
        - Get top 3 dimensions with values > 0.1
        - Format as: "fixing (0.8), configuring (0.7), testing (0.5)"
        - Return "general session" if all dimensions < 0.1

    - id: 4
      description: "Implement _format_prioritized_fields(priorities) helper"
      files:
        - "graphiti_core/session_tracking/prompt_builder.py"
      details: |
        Format prioritized fields as numbered list:
        - Accept list of (field, priority) tuples from get_extraction_priorities()
        - For each field: lookup instruction in FIELD_INSTRUCTIONS
        - Format as: "1. **errors_resolved** (priority: 0.92): [instruction]"
        - Include priority score to help LLM understand importance

    - id: 5
      description: "Implement build_extraction_prompt() main function"
      files:
        - "graphiti_core/session_tracking/prompt_builder.py"
      details: |
        Signature: build_extraction_prompt(activity: ActivityVector, content: str, threshold: float = 0.3) -> str
        Steps:
        1. Call get_extraction_priorities(activity, threshold)
        2. Format activity profile with _format_activity_profile()
        3. Format prioritized fields with _format_prioritized_fields()
        4. Substitute into DEFAULT_PROMPT_TEMPLATE
        5. Return complete prompt

    - id: 6
      description: "Implement PromptTemplate protocol for custom override"
      files:
        - "graphiti_core/session_tracking/prompt_builder.py"
      details: |
        Define Protocol class with method:
          def build_prompt(self, activity: ActivityVector, content: str, threshold: float) -> str
        Add optional custom_template parameter to build_extraction_prompt():
          - If provided, delegate to custom_template.build_prompt()
          - Otherwise, use DEFAULT_PROMPT_TEMPLATE
        This enables future customization without modifying core logic.

    - id: 7
      description: "Add module exports to __init__.py"
      files:
        - "graphiti_core/session_tracking/__init__.py"
      details: |
        Add to __all__:
          - build_extraction_prompt
          - PromptTemplate (protocol)

dependencies:
  internal:
    - "Story 8: Extraction Priority Algorithm (get_extraction_priorities())"
    - "Story 2: Activity Vector Model (ActivityVector class)"
    - "Story 1: Enhanced Session Summary Schema (field names)"

  external:
    - "Python typing.Protocol for template interface"

risks:
  - risk: "LLM may ignore low-priority fields entirely"
    mitigation: "Include minimum threshold (0.3) to ensure reasonable coverage"
    impact: "medium"

  - risk: "Activity profile format may not be clear to LLM"
    mitigation: "Use natural language format with dimension names and values"
    impact: "low"

  - risk: "Field instructions may be too verbose, increasing token usage"
    mitigation: "Keep instructions concise (1 sentence per field), focus on key requirements"
    impact: "low"

  - risk: "Custom template interface may be unused in v3.0.0"
    mitigation: "Mark as P1 (nice-to-have), implement with Protocol for zero runtime cost"
    impact: "minimal"

testing_requirements:
  unit_tests:
    - test: "test_field_instructions_complete"
      description: "Verify all SessionSummarySchema fields have instructions"
      location: "tests/session_tracking/test_prompt_builder.py"

    - test: "test_format_activity_profile_top_3"
      description: "Verify activity profile shows top 3 dimensions"
      location: "tests/session_tracking/test_prompt_builder.py"

    - test: "test_format_activity_profile_low_activity"
      description: "Verify 'general session' when all dimensions < 0.1"
      location: "tests/session_tracking/test_prompt_builder.py"

    - test: "test_format_prioritized_fields_ordering"
      description: "Verify fields ordered by priority (highest first)"
      location: "tests/session_tracking/test_prompt_builder.py"

    - test: "test_format_prioritized_fields_includes_priority"
      description: "Verify priority scores included in output"
      location: "tests/session_tracking/test_prompt_builder.py"

    - test: "test_build_prompt_debugging_session"
      description: "Verify prompt structure for debugging session (fixing=0.9)"
      location: "tests/session_tracking/test_prompt_builder.py"
      assertions:
        - "Prompt includes activity profile"
        - "errors_resolved appears before discoveries"
        - "Priority scores are formatted correctly"
        - "Content is included"
        - "Response format instructions present"

    - test: "test_build_prompt_exploration_session"
      description: "Verify prompt structure for exploration session (exploring=0.9)"
      location: "tests/session_tracking/test_prompt_builder.py"
      assertions:
        - "discoveries appears before errors_resolved"
        - "documentation_referenced is included"

    - test: "test_build_prompt_threshold_filtering"
      description: "Verify threshold filters low-priority fields"
      location: "tests/session_tracking/test_prompt_builder.py"
      assertions:
        - "High threshold (0.7) includes fewer fields"
        - "Low threshold (0.1) includes more fields"

    - test: "test_custom_template_override"
      description: "Verify custom template integration point"
      location: "tests/session_tracking/test_prompt_builder.py"
      assertions:
        - "Custom template is called when provided"
        - "Default template used when custom_template=None"

    - test: "test_prompt_token_reduction"
      description: "Verify dynamic prompt reduces tokens vs static"
      location: "tests/session_tracking/test_prompt_builder.py"
      method: |
        Compare token count (chars/4 estimate):
        - Static prompt with all 10 fields
        - Dynamic prompt with threshold=0.3 (typically 4-6 fields)
        Assert: Dynamic prompt is 30-60% shorter

  integration_tests:
    - test: "test_integration_with_extraction_priority"
      description: "Verify correct integration with get_extraction_priorities()"
      location: "tests/session_tracking/test_prompt_builder.py"
      method: "Use real ActivityVector and verify field ordering matches priorities"

    - test: "test_integration_with_activity_vector"
      description: "Verify correct handling of ActivityVector.to_dict() format"
      location: "tests/session_tracking/test_prompt_builder.py"

acceptance_criteria_mapping:
  - criteria: "(P0) build_extraction_prompt(activity, content, threshold) -> str function"
    implementation: "Step 5 - Main function with correct signature"
    test: "test_build_prompt_debugging_session, test_build_prompt_exploration_session"

  - criteria: "(P0) Prompt includes field-specific instructions ordered by priority"
    implementation: "Step 1 (FIELD_INSTRUCTIONS) + Step 4 (_format_prioritized_fields)"
    test: "test_format_prioritized_fields_ordering, test_field_instructions_complete"

  - criteria: "(P0) Prompt includes activity profile context for LLM"
    implementation: "Step 3 (_format_activity_profile)"
    test: "test_format_activity_profile_top_3, test_format_activity_profile_low_activity"

  - criteria: "(P1) Template integration point for custom override"
    implementation: "Step 6 (PromptTemplate protocol)"
    test: "test_custom_template_override"

  - criteria: "(P1) Unit tests verify prompt structure for different activity profiles"
    implementation: "All testing_requirements steps"
    test: "All tests listed above"

estimated_complexity: "medium"
estimated_effort: "3-4 hours"

notes:
  - "Token reduction estimate: 30-60% depending on session type and threshold"
  - "Debugging session (fixing=0.9): ~4-5 fields vs 10 in static prompt"
  - "Exploration session (exploring=0.9): ~5-6 fields vs 10 in static prompt"
  - "Priority scores help LLM prioritize extraction effort"
  - "Custom template interface enables future extension without modifying core"
  - "Protocol pattern has zero runtime cost (type-checking only)"
