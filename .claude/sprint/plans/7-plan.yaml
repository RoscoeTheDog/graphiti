# Plan: 7
# Generated by: implementation:7
# Timestamp: 2025-12-12T08:45:00Z

story_id: "7"
title: "Wire Preprocessing in MCP Server Initialization"
created: "2025-12-12T08:45:00Z"
created_by: "implementation:7"
status: "completed"

# Analysis Summary
analysis:
  summary: "Update initialize_graphiti() in MCP server to resolve preprocessing config from unified config and pass resolved values to Graphiti constructor, with comprehensive startup logging"
  complexity: "low"
  estimated_files: 1
  estimated_tokens: 2000
  risk_factors:
    - "Config reload mechanism must trigger re-resolution (satisfied by design)"
    - "Backward compatibility maintained (preprocessing disabled by default)"
    - "Dependency on Story 6 resolve_prompt() stub (full resolution in Story 8)"

# Files to Create
files_to_create: []

# Files to Modify
files_to_modify:
  - path: "mcp_server/graphiti_mcp_server.py"
    changes:
      - "Add preprocessing config resolution (lines 738-747)"
      - "Read extraction_config from unified_config.extraction"
      - "Check if preprocessing is enabled using is_enabled()"
      - "Resolve preprocessing prompt via resolve_prompt() with fallback to raw value"
      - "Pass preprocessing_prompt to Graphiti constructor (line 757)"
      - "Pass preprocessing_mode to Graphiti constructor (line 758)"
      - "Add startup logging for preprocessing status (lines 787-799)"
      - "Log template filename and mode for template-based preprocessing"
      - "Log truncated preview and mode for inline preprocessing"
      - "Log disabled status when preprocessing is off"
    lines_affected: 25

# Integration Points
integration:
  - file: "graphiti_core/extraction_config.py"
    type: "config"
    description: "Read extraction config from unified_config.extraction, use is_enabled() and resolve_prompt() methods"

  - file: "graphiti_core/graphiti.py"
    type: "constructor"
    description: "Pass preprocessing_prompt and preprocessing_mode to Graphiti constructor (Story 2 dependency)"

  - file: "config/unified_config.py"
    type: "config"
    description: "Read unified_config.extraction for ExtractionConfig instance (Story 6 dependency)"

# Patterns to Follow
patterns:
  - source: "mcp_server/graphiti_mcp_server.py (lines 738-747)"
    pattern: "Read config from unified_config, check is_enabled(), resolve prompt with fallback to raw value, handle stub behavior from Story 6"

  - source: "mcp_server/graphiti_mcp_server.py (lines 787-799)"
    pattern: "Log configuration details after successful initialization using logger.info(), differentiate template vs inline modes, show useful preview information"

  - source: "mcp_server/graphiti_mcp_server.py (lines 757-758)"
    pattern: "Pass optional parameters to Graphiti constructor using keyword arguments with resolved values or None"

# Test Requirements
test_requirements:
  unit:
    - "Test MCP server reads extraction_config from unified_config.extraction"
    - "Test preprocessing_prompt resolution when enabled (calls resolve_prompt())"
    - "Test preprocessing_prompt is None when disabled"
    - "Test fallback to raw prompt value when resolve_prompt() returns empty string"
    - "Test Graphiti constructor receives resolved preprocessing_prompt"
    - "Test Graphiti constructor receives preprocessing_mode from config"
    - "Test backward compatibility: preprocessing disabled by default"
  integration:
    - "Test full MCP server initialization with preprocessing enabled"
    - "Test full MCP server initialization with preprocessing disabled"
    - "Test startup logs show correct preprocessing status for template mode"
    - "Test startup logs show correct preprocessing status for inline mode"
    - "Test startup logs show disabled status when preprocessing is off"
    - "Test config reload triggers re-resolution via initialize_graphiti() call"
  security:
    - "Test inline prompt preview truncation prevents log overflow"
    - "Test no sensitive information exposed in startup logs"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-7.1"
    text: "(P0) MCP server reads extraction config from unified config"
    implementation: "files_to_modify[0] - lines 738-747 (read unified_config.extraction)"
    tests: "test_requirements.unit[0], test_requirements.integration[0,1]"

  - id: "AC-7.2"
    text: "(P0) Resolved preprocessing_prompt passed to Graphiti constructor"
    implementation: "files_to_modify[0] - line 757 (preprocessing_prompt parameter)"
    tests: "test_requirements.unit[1,3,4], test_requirements.integration[0]"

  - id: "AC-7.3"
    text: "(P1) Config reload triggers preprocessing prompt re-resolution"
    implementation: "Satisfied by design: initialize_graphiti() reads from unified_config at runtime"
    tests: "test_requirements.integration[5]"

  - id: "AC-7.4"
    text: "(P2) Startup logs indicate preprocessing status (enabled/disabled, template name)"
    implementation: "files_to_modify[0] - lines 787-799 (startup logging)"
    tests: "test_requirements.integration[2,3,4]"

# Implementation Details
implementation_details:
  preprocessing_resolution:
    description: "Read extraction_config, check is_enabled(), resolve prompt with fallback"
    lines: "738-747"
    logic:
      - "Get extraction_config from unified_config.extraction"
      - "Initialize resolved_preprocessing_prompt to None"
      - "If is_enabled(), call resolve_prompt() to get resolved value"
      - "Fallback to raw preprocessing_prompt value if resolve_prompt() returns empty string"
      - "Pass resolved value (or None) to Graphiti constructor"

  graphiti_constructor:
    description: "Pass preprocessing parameters to Graphiti constructor"
    lines: "757-758"
    parameters:
      - name: "preprocessing_prompt"
        value: "resolved_preprocessing_prompt (str | None)"
      - name: "preprocessing_mode"
        value: "extraction_config.preprocessing_mode (str)"

  startup_logging:
    description: "Log preprocessing status with mode-specific details"
    lines: "787-799"
    log_variants:
      - condition: "is_enabled() and prompt ends with .md"
        message: "Preprocessing: enabled (template: {filename}, mode: {mode})"
      - condition: "is_enabled() and inline prompt"
        message: "Preprocessing: enabled (inline prompt, mode: {mode}, preview: {truncated})"
      - condition: "not is_enabled()"
        message: "Preprocessing: disabled"

# Config Reload Mechanism
config_reload:
  design: "Satisfied by design"
  rationale: "initialize_graphiti() reads from unified_config.extraction at runtime, so any future config reload mechanism that calls initialize_graphiti() will automatically re-resolve preprocessing config"
  no_explicit_handler_needed: true

# Dependencies
dependencies:
  - story: "Story 2"
    requirement: "Graphiti constructor accepts preprocessing_prompt and preprocessing_mode parameters"
    status: "completed"

  - story: "Story 6"
    requirement: "ExtractionConfig provides is_enabled() and resolve_prompt() methods"
    status: "completed (resolve_prompt() is stub, full implementation in Story 8)"

# Notes
notes:
  - "Story 6 resolve_prompt() is currently a stub (returns empty string), so fallback to raw value is necessary"
  - "Full template resolution will be implemented in Story 8"
  - "Backward compatible: preprocessing is disabled by default in ExtractionConfig"
  - "Config reload is satisfied by design - no explicit reload handler needed"
  - "Startup logging differentiates template mode (shows filename) vs inline mode (shows preview)"
  - "Preview truncation (50 chars) prevents log overflow for long inline prompts"
