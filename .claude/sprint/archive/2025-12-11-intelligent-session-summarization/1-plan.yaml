# Plan: Story 1 - Enhanced Session Summary Schema
# Generated: 2025-12-11
# Status: ready_for_implementation

story:
  id: "1"
  title: "Enhanced Session Summary Schema"
  parent_file: "stories/1-enhanced-session-summary-schema.md"

discovery_summary:
  findings:
    - Current SessionSummarySchema has `key_decisions: list[str]` but needs `list[DecisionRecord]`
    - SUMMARIZATION_PROMPT exists at line 164 but only asks for simple key decisions
    - `to_markdown()` method exists at line 77-136 and already handles key_decisions (simple format)
    - No `errors_resolved` field exists currently
    - File location confirmed: graphiti_core/session_tracking/summarizer.py

  existing_patterns:
    - BaseModel used for schema definitions (Pydantic v2)
    - Field() with descriptions used for documentation
    - default_factory=list used for optional list fields
    - SessionSummary class inherits from SessionSummarySchema

implementation_plan:
  phase_1_models:
    description: "Add new Pydantic models for structured records"
    tasks:
      - task: "Create DecisionRecord model"
        location: "graphiti_core/session_tracking/summarizer.py"
        insert_after: "import statements / before SessionSummarySchema"
        code_snippet: |
          class DecisionRecord(BaseModel):
              decision: str = Field(description='The decision that was made')
              rationale: str = Field(description='Why this decision was made')
              alternatives: list[str] | None = Field(
                  default=None, description='Alternative options considered'
              )

      - task: "Create ErrorResolution model"
        location: "graphiti_core/session_tracking/summarizer.py"
        insert_after: "DecisionRecord"
        code_snippet: |
          class ErrorResolution(BaseModel):
              error: str = Field(description='The error that occurred')
              root_cause: str = Field(description='Root cause analysis')
              fix: str = Field(description='How the error was fixed')
              verification: str = Field(description='How the fix was verified')

  phase_2_schema_update:
    description: "Update SessionSummarySchema with structured fields"
    tasks:
      - task: "Replace key_decisions type"
        location: "graphiti_core/session_tracking/summarizer.py:45"
        change_type: "modify"
        original: "key_decisions: list[str]"
        replacement: "key_decisions: list[DecisionRecord]"

      - task: "Add errors_resolved field"
        location: "graphiti_core/session_tracking/summarizer.py"
        insert_after: "key_decisions field"
        code_snippet: |
          errors_resolved: list[ErrorResolution] = Field(
              default_factory=list, description='Errors encountered and how they were resolved'
          )

  phase_3_prompt_update:
    description: "Update SUMMARIZATION_PROMPT for structured extraction"
    tasks:
      - task: "Update key decisions extraction"
        location: "graphiti_core/session_tracking/summarizer.py:190"
        change_type: "replace"
        original: "7. **Key Decisions**: What important decisions were made during the session?"
        replacement: |
          7. **Key Decisions**: What important decisions were made during the session?
             For each decision, provide:
             - decision: The actual decision (e.g., "Used RS256 over HS256 for JWT signing")
             - rationale: Why this was chosen (e.g., "RS256 is more secure for production")
             - alternatives: Other options considered (e.g., ["HS256", "EdDSA"]) or null

      - task: "Add errors resolved extraction"
        location: "graphiti_core/session_tracking/summarizer.py"
        insert_after: "Key Decisions section in prompt"
        code_snippet: |
          8. **Errors Resolved**: What errors were encountered and fixed during the session?
             For each error, provide:
             - error: The error message or description
             - root_cause: What caused the error
             - fix: How it was resolved
             - verification: How the fix was verified to work

      - task: "Renumber MCP Tools and Duration"
        notes: "MCP Tools becomes 9, Duration becomes 10"

  phase_4_markdown_update:
    description: "Update to_markdown() for structured rendering"
    tasks:
      - task: "Update key_decisions rendering"
        location: "graphiti_core/session_tracking/summarizer.py:105-107"
        change_type: "replace"
        original: |
          for decision in self.key_decisions:
              markdown += f'- {decision}\n'
        replacement: |
          for decision in self.key_decisions:
              markdown += f'- **{decision.decision}**\n'
              markdown += f'  - Rationale: {decision.rationale}\n'
              if decision.alternatives:
                  markdown += f'  - Alternatives: {", ".join(decision.alternatives)}\n'

      - task: "Add errors_resolved section"
        location: "graphiti_core/session_tracking/summarizer.py"
        insert_after: "key_decisions section"
        code_snippet: |
          if self.errors_resolved:
              markdown += '\n---\n\n## Errors Resolved\n\n'
              for err in self.errors_resolved:
                  markdown += f'### {err.error}\n'
                  markdown += f'- **Root Cause**: {err.root_cause}\n'
                  markdown += f'- **Fix**: {err.fix}\n'
                  markdown += f'- **Verification**: {err.verification}\n\n'

testing_requirements:
  unit_tests:
    - test: "DecisionRecord serialization/deserialization"
      location: "tests/test_summarizer.py"

    - test: "ErrorResolution serialization/deserialization"
      location: "tests/test_summarizer.py"

    - test: "SessionSummarySchema with new fields"
      location: "tests/test_summarizer.py"

    - test: "to_markdown() renders new sections correctly"
      location: "tests/test_summarizer.py"

acceptance_criteria_mapping:
  P0:
    - criteria: "SessionSummarySchema includes key_decisions: list[DecisionRecord]"
      implementation: "phase_2_schema_update"

    - criteria: "SessionSummarySchema includes errors_resolved: list[ErrorResolution]"
      implementation: "phase_2_schema_update"

    - criteria: "SUMMARIZATION_PROMPT extracts key_decisions with rationale"
      implementation: "phase_3_prompt_update"

  P1:
    - criteria: "to_markdown() renders new sections"
      implementation: "phase_4_markdown_update"

    - criteria: "Unit tests verify serialization"
      implementation: "testing_requirements"

risks:
  - risk: "Backward compatibility with existing summaries"
    mitigation: "Use default_factory=list for new fields, ensure None handling"

  - risk: "LLM output parsing for structured data"
    mitigation: "Use Pydantic's model_json_schema() for LLM guidance"

estimated_complexity: "low"
estimated_effort: "2-3 hours"
